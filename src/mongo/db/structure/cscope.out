cscope 15 $HOME/mongo-fork/src/mongo/db/structure               0000399725
	@btree/btree_builder_test.cpp

34 
	~"mÚgo/db/š¡ªû.h
"

35 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt_noİ.h
"

36 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_‹¡_h–p.h
"

37 
	~"mÚgo/un™‹¡/un™‹¡.h
"

39 
Çme¥aû
 
	gmÚgo
 {

41 şas 
	cMockO³¿tiÚCÚ‹xtKÏbË
 : 
public
 
O³¿tiÚCÚ‹xtNoİ
 {

42 
public
:

43 
MockO³¿tiÚCÚ‹xtKÏbË
()

44 : 
_klP’dšg
(
çl£
) {

47 
vœtu®
 
checkFÜIÁ”ru±
(
boŞ
 
h“dMu‹x
 = 
Œue
) const {

48 ià(
_klP’dšg
) {

49 
throw
 
U£rExû±iÚ
(
E¼ÜCodes
::
IÁ”ru±ed
, "interrupted");

53 
vœtu®
 
kl
() {

54 
	g_klP’dšg
 = 
Œue
;

57 
	g´iv©e
:

58 
boŞ
 
_klP’dšg
;

64 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

65 şas 
	cIÁ”ru±Comm™
 {

66 
	gpublic
:

67 
ty³Çme
 
	tBŒ“Logic
<
	tOnDiskFÜm©
>::
	tBud”
 Builder;

69 
IÁ”ru±Comm™
Ğ
boŞ
 
mayIÁ”ru±
 ) :

70 
_mayIÁ”ru±
Ğ
mayIÁ”ru±
 ),

71 
_h–³r
(
BSON
( "a" << 1 )) {

74 
run
() {

76 
MockO³¿tiÚCÚ‹xtKÏbË
 
	gtxn
;

77 
Bud”
* 
	gbud”
 = 
_h–³r
.
bŒ“
.
ÃwBud”
(&
txn
, 
çl£
);

81 
št32_t
 
	gnKeys
 = 1000;

82  
št32_t
 
	gi
 = 0; i < 
	gnKeys
; ++i ) {

83 
BSONObj
 
	gkey
 = 
BSON
Ğ"a" << 
i
 );

84 
	gbud”
->
addKey
Ğ
key
, 
DiskLoc
() );

88 
ASSERT
Ğ
_h–³r
.
h—dMªag”
.
g‘H—d
().
isNuÎ
() );

90 
	gtxn
.
kl
();

91 iàĞ
	g_mayIÁ”ru±
 ) {

93 
ASSERT_THROWS
Ğ
bud”
->
comm™
Ğ
_mayIÁ”ru±
 ), 
U£rExû±iÚ
 );

95 
ASSERT
Ğ
_h–³r
.
h—dMªag”
.
g‘H—d
().
isNuÎ
() );

100 
	gbud”
->
comm™
Ğ
_mayIÁ”ru±
 );

102 
ASSERT
Ğ!
_h–³r
.
h—dMªag”
.
g‘H—d
().
isNuÎ
() );

106 
	g´iv©e
:

107 
boŞ
 
_mayIÁ”ru±
;

108 
	gBŒ“LogicTe¡H–³r
<
	gOnDiskFÜm©
> 
	g_h–³r
;

116 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

117 şas 
	cBŒ“Bud”Te¡Su™e
 : 
public
 
un™‹¡
::
Su™e
 {

118 
public
:

119 
BŒ“Bud”Te¡Su™e
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
è: 
Su™e
(name) {

123 
£tupTe¡s
() {

125 
add
< 
IÁ”ru±Comm™
<
OnDiskFÜm©
> >Ğ
çl£
 );

126 
	gadd
< 
	gIÁ”ru±Comm™
<
	gOnDiskFÜm©
> >Ğ
	gŒue
 );

131 
	gBŒ“Bud”Te¡Su™e
<
	gBŒ“LayoutV0
> 
SUITE_V0
("BtreeBuilderTests V0");

132 
	gBŒ“Bud”Te¡Su™e
<
	gBŒ“LayoutV1
> 
SUITE_V1
("BtreeBuilderTests V1");

	@btree/btree_interface.cpp

29 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_š‹rçû.h
"

31 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

32 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_logic.h
"

35 
Çme¥aû
 
	gmÚgo
 {

37 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

38 şas 
	cBŒ“Bud”IÁ”çûIm¶
 : 
public
 
BŒ“Bud”IÁ”çû
 {

39 
public
:

40 
BŒ“Bud”IÁ”çûIm¶
(
O³¿tiÚCÚ‹xt
* 
Œªs
,

41 
ty³Çme
 
BŒ“Logic
<
OnDiskFÜm©
>::
Bud”
* 
bud”
)

42 : 
_bud”
(
bud”
), 
_Œªs
(
Œªs
) { }

44 
	gvœtu®
 ~
BŒ“Bud”IÁ”çûIm¶
() { }

46 
Stus
 
addKey
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) {

47  
	g_bud”
->
addKey
(
key
, 
loc
);

50 
comm™
(
boŞ
 
mayIÁ”ru±
) {

51  
	g_bud”
->
comm™
(
mayIÁ”ru±
);

54 
	g´iv©e
:

55 
ty³Çme
 
BŒ“Logic
<
OnDiskFÜm©
>::
Bud”
* 
_bud”
;

58 
O³¿tiÚCÚ‹xt
* 
	g_Œªs
;

61 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

62 şas 
	cBŒ“IÁ”çûIm¶
 : 
public
 
BŒ“IÁ”çû
 {

63 
public
:

64 
BŒ“IÁ”çûIm¶
(
H—dMªag”
* 
h—dMªag”
,

65 
RecÜdStÜe
* 
»cÜdStÜe
,

66 cÚ¡ 
Ord”šg
& 
Üd”šg
,

67 cÚ¡ 
¡ršg
& 
šdexName
,

68 
Buck‘D–‘iÚNÙifiÿtiÚ
* 
buck‘D–‘iÚNÙifiÿtiÚ
) {

70 
	g_bŒ“
.
»£t
(
Ãw
 
BŒ“Logic
<
OnDiskFÜm©
>(
h—dMªag”
,

71 
»cÜdStÜe
,

72 
Üd”šg
,

73 
šdexName
,

74 
buck‘D–‘iÚNÙifiÿtiÚ
));

77 
	gvœtu®
 ~
BŒ“IÁ”çûIm¶
() { }

79 
vœtu®
 
BŒ“Bud”IÁ”çû
* 
g‘BulkBud”
(
O³¿tiÚCÚ‹xt
* 
txn
,

80 
boŞ
 
dupsAÎowed
) {

82  
Ãw
 
	gBŒ“Bud”IÁ”çûIm¶
<
	gOnDiskFÜm©
>(

83 
	gtxn
, 
	g_bŒ“
->
ÃwBud”
(
txn
, 
dupsAÎowed
));

86 
vœtu®
 
Stus
 
š£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

87 cÚ¡ 
BSONObj
& 
key
,

88 cÚ¡ 
DiskLoc
& 
loc
,

89 
boŞ
 
dupsAÎowed
) {

91  
	g_bŒ“
->
š£¹
(
txn
, 
key
, 
loc
, 
dupsAÎowed
);

94 
vœtu®
 
boŞ
 
unšdex
(
O³¿tiÚCÚ‹xt
* 
txn
,

95 cÚ¡ 
BSONObj
& 
key
,

96 cÚ¡ 
DiskLoc
& 
loc
) {

98  
	g_bŒ“
->
unšdex
(
txn
, 
key
, 
loc
);

101 
vœtu®
 
fuÎV®id©e
(*
numKeysOut
) {

102 *
	gnumKeysOut
 = 
_bŒ“
->
fuÎV®id©e
(
NULL
, 
çl£
, false, 0);

105 
vœtu®
 
Stus
 
dupKeyCheck
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) {

106  
	g_bŒ“
->
dupKeyCheck
(
key
, 
loc
);

109 
vœtu®
 
boŞ
 
isEm±y
() {

110  
	g_bŒ“
->
isEm±y
();

113 şas 
	cCursÜ
 : 
public
 
BŒ“IÁ”çû
::
CursÜ
 {

114 
public
:

115 
CursÜ
(cÚ¡ 
BŒ“Logic
<
OnDiskFÜm©
>* 
bŒ“
, 
dœeùiÚ
)

116 : 
_bŒ“
(
bŒ“
),

117 
_dœeùiÚ
(
dœeùiÚ
),

118 
_buck‘
(
bŒ“
->
g‘H—d
()),

119 
_ofs
(0) {

122 
vœtu®
 
g‘DœeùiÚ
(ècÚ¡ {  
	g_dœeùiÚ
; }

124 
vœtu®
 
boŞ
 
isEOF
(ècÚ¡ {  
	g_buck‘
.
isNuÎ
(); }

126 
vœtu®
 
boŞ
 
poštsToSamePÏûAs
(cÚ¡ 
BŒ“IÁ”çû
::
CursÜ
& 
Ùh”Ba£
) const {

127 cÚ¡ 
CursÜ
& 
Ùh”
 = 
¡©ic_ÿ¡
<cÚ¡ CursÜ&>(
Ùh”Ba£
);

128 ià(
isEOF
())

129  
	gÙh”
.
isEOF
();

131  
	g_buck‘
 =ğ
Ùh”
.
_buck‘
 && 
_ofs
 == other._ofs;

135 
vœtu®
 
aboutToD–‘eBuck‘
(cÚ¡ 
DiskLoc
& 
buck‘
) {

136 ià(
	g_buck‘
 =ğ
buck‘
)

137 
_ofs
 = -1;

140 
vœtu®
 
boŞ
 
loÿ‹
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) {

141  
	g_bŒ“
->
loÿ‹
(
key
, 
loc
, 
_dœeùiÚ
, &
_ofs
, &
_buck‘
);

144 
vœtu®
 
cu¡omLoÿ‹
(cÚ¡ 
BSONObj
& 
keyBegš
,

145 
keyBegšL’
,

146 
boŞ
 
aá”Key
,

147 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

148 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
) {

150 
	g_bŒ“
->
cu¡omLoÿ‹
(&
_buck‘
,

151 &
_ofs
,

152 
keyBegš
,

153 
keyBegšL’
,

154 
aá”Key
,

155 
keyEnd
,

156 
keyEndInşusive
,

157 
_dœeùiÚ
);

160 
advªûTo
(cÚ¡ 
BSONObj
 &
keyBegš
,

161 
keyBegšL’
,

162 
boŞ
 
aá”Key
,

163 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

164 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
) {

166 
	g_bŒ“
->
advªûTo
(&
_buck‘
,

167 &
_ofs
,

168 
keyBegš
,

169 
keyBegšL’
,

170 
aá”Key
,

171 
keyEnd
,

172 
keyEndInşusive
,

173 
_dœeùiÚ
);

176 
vœtu®
 
BSONObj
 
g‘Key
() const {

177  
	g_bŒ“
->
g‘Key
(
_buck‘
, 
_ofs
);

180 
vœtu®
 
DiskLoc
 
g‘DiskLoc
() const {

181  
	g_bŒ“
->
g‘DiskLoc
(
_buck‘
, 
_ofs
);

184 
vœtu®
 
advªû
() {

185 
	g_bŒ“
->
advªû
(&
_buck‘
, &
_ofs
, 
_dœeùiÚ
);

188 
vœtu®
 
§vePos™iÚ
(
SavedPos™iÚD©a
* 
§vedOut
) const {

189 
	g§vedOut
->
	gkey
 = 
g‘Key
().
g‘OwÃd
();

190 
	g§vedOut
->
	gloc
 = 
g‘DiskLoc
();

193 
vœtu®
 
»¡ÜePos™iÚ
(cÚ¡ 
SavedPos™iÚD©a
& 
§ved
) {

194 
	g_bŒ“
->
»¡ÜePos™iÚ
(
§ved
.
key
,

195 
§ved
.
loc
,

196 
_dœeùiÚ
,

197 &
_buck‘
,

198 &
_ofs
);

201 
	g´iv©e
:

202 cÚ¡ 
BŒ“Logic
<
OnDiskFÜm©
>* cÚ¡ 
_bŒ“
;

203 cÚ¡ 
	g_dœeùiÚ
;

205 
DiskLoc
 
	g_buck‘
;

206 
	g_ofs
;

209 
vœtu®
 
CursÜ
* 
ÃwCursÜ
(
dœeùiÚ
) const {

210  
Ãw
 
CursÜ
(
_bŒ“
.
g‘
(), 
dœeùiÚ
);

213 
vœtu®
 
Stus
 
š™AsEm±y
(
O³¿tiÚCÚ‹xt
* 
txn
) {

214  
	g_bŒ“
->
š™AsEm±y
(
txn
);

217 
	g´iv©e
:

218 
scİed_±r
<
BŒ“Logic
<
OnDiskFÜm©
> > 
_bŒ“
;

222 
BŒ“IÁ”çû
* 
	gBŒ“IÁ”çû
::
	$g‘IÁ”çû
(
H—dMªag”
* 
h—dMªag”
,

223 
RecÜdStÜe
* 
»cÜdStÜe
,

224 cÚ¡ 
Ord”šg
& 
Üd”šg
,

225 cÚ¡ 
¡ršg
& 
šdexName
,

226 
v”siÚ
,

227 
Buck‘D–‘iÚNÙifiÿtiÚ
* 
buck‘D–‘iÚ
) {

229 ià(0 =ğ
v”siÚ
) {

230  
Ãw
 
BŒ“IÁ”çûIm¶
<
BŒ“LayoutV0
>(
h—dMªag”
,

231 
»cÜdStÜe
,

232 
Üd”šg
,

233 
šdexName
,

234 
buck‘D–‘iÚ
);

237 
	`šv¬ŸÁ
(1 =ğ
v”siÚ
);

238  
Ãw
 
BŒ“IÁ”çûIm¶
<
BŒ“LayoutV1
>(
h—dMªag”
,

239 
»cÜdStÜe
,

240 
Üd”šg
,

241 
šdexName
,

242 
buck‘D–‘iÚ
);

244 
	}
}

	@btree/btree_interface.h

29 
	~"mÚgo/bsÚ/Üd”šg.h
"

30 
	~"mÚgo/db/diskloc.h
"

31 
	~"mÚgo/db/jsobj.h
"

32 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

33 
	~"mÚgo/db/¡ruùu»/h—d_mªag”.h
"

34 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

36 #´agm¨
Úû


38 
Çme¥aû
 
	gmÚgo
 {

40 
şass
 
	gBuck‘D–‘iÚNÙifiÿtiÚ
;

45 şas 
	cBŒ“Bud”IÁ”çû
 {

46 
	gpublic
:

47 
vœtu®
 ~
BŒ“Bud”IÁ”çû
() { }

55 
vœtu®
 
Stus
 
addKey
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) = 0;

63 
vœtu®
 
comm™
(
boŞ
 
mayIÁ”ru±
) = 0;

70 şas 
	cBŒ“IÁ”çû
 {

71 
	gpublic
:

72 
	sSavedPos™iÚD©a
 {

73 
BSONObj
 
key
;

74 
DiskLoc
 
	gloc
;

77 
	gvœtu®
 ~
BŒ“IÁ”çû
() { }

86 
BŒ“IÁ”çû
* 
g‘IÁ”çû
(
H—dMªag”
* 
h—dMªag”
,

87 
RecÜdStÜe
* 
»cÜdStÜe
,

88 cÚ¡ 
Ord”šg
& 
Üd”šg
,

89 cÚ¡ 
¡ršg
& 
šdexName
,

90 
v”siÚ
,

91 
Buck‘D–‘iÚNÙifiÿtiÚ
* 
buck‘D–‘iÚ
);

101 
vœtu®
 
BŒ“Bud”IÁ”çû
* 
g‘BulkBud”
(
O³¿tiÚCÚ‹xt
* 
txn
,

102 
boŞ
 
dupsAÎowed
) = 0;

104 
vœtu®
 
Stus
 
š£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

105 cÚ¡ 
BSONObj
& 
key
,

106 cÚ¡ 
DiskLoc
& 
loc
,

107 
boŞ
 
dupsAÎowed
) = 0;

109 
vœtu®
 
boŞ
 
unšdex
(
O³¿tiÚCÚ‹xt
* 
txn
,

110 cÚ¡ 
BSONObj
& 
key
,

111 cÚ¡ 
DiskLoc
& 
loc
) = 0;

114 
vœtu®
 
Stus
 
dupKeyCheck
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) = 0;

121 
vœtu®
 
fuÎV®id©e
(* 
numKeysOut
) = 0;

123 
vœtu®
 
boŞ
 
isEm±y
() = 0;

129 şas 
	cCursÜ
 {

130 
	gpublic
:

131 
vœtu®
 ~
CursÜ
() {}

133 
vœtu®
 
g‘DœeùiÚ
() const = 0;

135 
vœtu®
 
boŞ
 
isEOF
() const = 0;

141 
vœtu®
 
boŞ
 
poštsToSamePÏûAs
(cÚ¡ 
CursÜ
& 
Ùh”
) const = 0;

148 
vœtu®
 
aboutToD–‘eBuck‘
(cÚ¡ 
DiskLoc
& 
buck‘
) = 0;

150 
vœtu®
 
boŞ
 
loÿ‹
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) = 0;

152 
vœtu®
 
advªûTo
(cÚ¡ 
BSONObj
 &
keyBegš
,

153 
keyBegšL’
,

154 
boŞ
 
aá”Key
,

155 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

156 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
) = 0;

162 
vœtu®
 
cu¡omLoÿ‹
(cÚ¡ 
BSONObj
& 
keyBegš
,

163 
keyBegšL’
,

164 
boŞ
 
aá”V”siÚ
,

165 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

166 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
) = 0;

172 
vœtu®
 
BSONObj
 
g‘Key
() const = 0;

174 
vœtu®
 
DiskLoc
 
g‘DiskLoc
() const = 0;

176 
vœtu®
 
advªû
() = 0;

181 
vœtu®
 
§vePos™iÚ
(
SavedPos™iÚD©a
* 
§vedOut
) const = 0;

183 
vœtu®
 
»¡ÜePos™iÚ
(cÚ¡ 
SavedPos™iÚD©a
& 
§ved
) = 0;

189 
vœtu®
 
CursÜ
* 
ÃwCursÜ
(
dœeùiÚ
) const = 0;

195 
vœtu®
 
Stus
 
š™AsEm±y
(
O³¿tiÚCÚ‹xt
* 
txn
) = 0;

	@btree/btree_logic.cpp

29 
	~"mÚgo/db/diskloc.h
"

30 
	~"mÚgo/db/jsobj.h
"

31 
	~"mÚgo/db/¡Üage/»cÜd.h
"

32 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

33 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_logic.h
"

34 
	~"mÚgo/db/¡ruùu»/bŒ“/key.h
"

35 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

38 
Çme¥aû
 
	gmÚgo
 {

44 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

45 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Bud”
*

46 
BŒ“Logic
<
BŒ“Layout
>::
ÃwBud”
(
O³¿tiÚCÚ‹xt
* 
txn
, 
boŞ
 
dupsAÎowed
) {

47  
Ãw
 
Bud”
(
this
, 
txn
, 
dupsAÎowed
);

50 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

51 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Bud”
::Bud”(
BŒ“Logic
* 
logic
,

52 
O³¿tiÚCÚ‹xt
* 
txn
,

53 
boŞ
 
dupsAÎowed
)

54 : 
_logic
(
logic
),

55 
_dupsAÎowed
(
dupsAÎowed
),

56 
_numAdded
(0),

57 
_txn
(
txn
) {

59 
	g_fœ¡
 = 
_cur
 = 
_logic
->
_addBuck‘
(
txn
);

60 
	g_b
 = 
_g‘ModifŸbËBuck‘
(
_cur
);

61 
	g_comm™‹d
 = 
çl£
;

64 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

65 
Stus
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Bud”
::
addKey
(cÚ¡ 
BSONObj
& 
keyObj
, cÚ¡ 
DiskLoc
& 
loc
) {

66 
	gauto_±r
<
	gKeyD©aOwÃdTy³
> 
key
(
Ãw
 
KeyD©aOwÃdTy³
(
keyObj
));

68 ià(
	gkey
->
d©aSize
(è> 
	gBŒ“Layout
::
KeyMax
) {

69 
¡ršg
 
msg
 = 
¡r
::
¡»am
() << "Btree::insert: keyoo†argeo index, failing "

70 << 
_logic
->
_šdexName


71 << ' ' << 
key
->
d©aSize
(è<< ' ' << key->
toSŒšg
();

72 
log
(è<< 
	gmsg
 << 
	g’dl
;

73  
Stus
(
E¼ÜCodes
::
KeyTooLÚg
, 
msg
);

77 ià(
	g_numAdded
 > 0) {

78 
	gcmp
 = 
_keyLa¡
->
woCom·»
(*
key
, 
_logic
->
_Üd”šg
);

81 ià(
	gcmp
 > 0) {

82  
Stus
(
E¼ÜCodes
::
IÁ”ÇlE¼Ü
, "Bad key order in btree builder");

86 ià(!
	g_dupsAÎowed
 && (
	gcmp
 == 0)) {

87  
Stus
(
E¼ÜCodes
::
Du¶iÿ‹Key
, 
_logic
->
dupKeyE¼Ü
(*
_keyLa¡
));

91 ià(!
	g_logic
->
_pushBack
(
_b
, 
loc
, *
key
, 
DiskLoc
())) {

93 
ÃwBuck‘
();

94 
	g_logic
->
pushBack
(
_b
, 
loc
, *
key
, 
DiskLoc
());

97 
	g_keyLa¡
 = 
key
;

98 
	g_numAdded
++;

99 
mayComm™Prog»ssDu¿bly
();

100  
	gStus
::
OK
();

103 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

104 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Bud”
::
comm™
(
boŞ
 
mayIÁ”ru±
) {

105 
budNextLev–
(
_fœ¡
, 
mayIÁ”ru±
);

106 
	g_comm™‹d
 = 
Œue
;

107  
	g_numAdded
;

114 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

115 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Bud”
::
ÃwBuck‘
() {

116 
DiskLoc
 
ÃwBuck‘Loc
 = 
_logic
->
_addBuck‘
(
_txn
);

117 
	g_b
->
	g·»Á
 = 
ÃwBuck‘Loc
;

118 
	g_cur
 = 
ÃwBuck‘Loc
;

119 
	g_b
 = 
_g‘ModifŸbËBuck‘
(
_cur
);

122 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

123 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Bud”
::
budNextLev–
(
DiskLoc
 
loc
, 
boŞ
 
mayIÁ”ru±
) {

125 ià(
_g‘Buck‘
(
loc
)->
	g·»Á
.
isNuÎ
()) {

127 
	g_logic
->
	g_h—dMªag”
->
£tH—d
(
_txn
, 
loc
);

131 
DiskLoc
 
	gupLoc
 = 
_logic
->
_addBuck‘
(
_txn
);

132 
DiskLoc
 
	gupS¹
 = 
upLoc
;

133 
Buck‘Ty³
* 
	gup
 = 
_g‘ModifŸbËBuck‘
(
upLoc
);

135 
DiskLoc
 
	gxloc
 = 
loc
;

136 !
	gxloc
.
isNuÎ
()) {

137 ià(
	g_txn
->
»cov”yUn™
()->
comm™IfN“ded
()) {

138 
	g_b
 = 
_g‘ModifŸbËBuck‘
(
_cur
);

139 
	gup
 = 
_g‘ModifŸbËBuck‘
(
upLoc
);

142 ià(
	gmayIÁ”ru±
) {

143 
	g_txn
->
checkFÜIÁ”ru±
();

146 
Buck‘Ty³
* 
	gx
 = 
_g‘ModifŸbËBuck‘
(
xloc
);

147 
KeyD©aTy³
 
	gk
;

148 
DiskLoc
 
	gr
;

149 
	g_logic
->
pİBack
(
x
, &
r
, &
k
);

150 
boŞ
 
	gk“pX
 = (
x
->
n
 != 0);

151 
DiskLoc
 
	gk“pLoc
 = 
k“pX
 ? 
xloc
 : 
x
->
ÃxtChd
;

153 ià(!
	g_logic
->
_pushBack
(
up
, 
r
, 
k
, 
k“pLoc
)) {

155 
DiskLoc
 
	gn
 = 
_logic
->
_addBuck‘
(
_txn
);

156 
	gup
->
	g·»Á
 = 
n
;

157 
	gupLoc
 = 
n
;

158 
	gup
 = 
_g‘ModifŸbËBuck‘
(
upLoc
);

159 
	g_logic
->
pushBack
(
up
, 
r
, 
k
, 
k“pLoc
);

162 
DiskLoc
 
	gÃxtLoc
 = 
x
->
·»Á
;

163 ià(
	gk“pX
) {

164 
	gx
->
	g·»Á
 = 
upLoc
;

167 ià(!
	gx
->
	gÃxtChd
.
isNuÎ
()) {

168 
DiskLoc
 
	gÎ
 = 
x
->
ÃxtChd
;

169 
_g‘ModifŸbËBuck‘
(
Î
)->
	g·»Á
 = 
upLoc
;

171 
	g_logic
->
d—ÎocBuck‘
(
_txn
, 
x
, 
xloc
);

173 
	gxloc
 = 
ÃxtLoc
;

176 
	gloc
 = 
upS¹
;

177 
mayComm™Prog»ssDu¿bly
();

181 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

182 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Bud”
::
mayComm™Prog»ssDu¿bly
() {

183 ià(
_txn
->
»cov”yUn™
()->
comm™IfN“ded
()) {

184 
_b
 = 
_g‘ModifŸbËBuck‘
(
_cur
);

188 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

189 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Buck‘Ty³
*

190 
BŒ“Logic
<
BŒ“Layout
>::
Bud”
::
_g‘ModifŸbËBuck‘
(
DiskLoc
 
loc
) {

191  
_logic
->
bŒ“mod
(
_txn
, _logic->
g‘Buck‘
(
loc
));

194 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

195 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Buck‘Ty³
*

196 
BŒ“Logic
<
BŒ“Layout
>::
Bud”
::
_g‘Buck‘
(
DiskLoc
 
loc
) {

197  
_logic
->
g‘Buck‘
(
loc
);

205 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

206 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
FuÎKey


207 
BŒ“Logic
<
BŒ“Layout
>::
g‘FuÎKey
(cÚ¡ 
Buck‘Ty³
* 
buck‘
, 
i
) {

208 ià(
	gi
 >ğ
buck‘
->
n
) {

209 
code
 = 13000;

210 
mas£¹
(
code
,

211 (
¡ršg
)"šv®id keyNode: " + 
BSON
Ğ"i" << 
i
 << "n" << 
buck‘
->
n
 ).
jsÚSŒšg
(),

212 
i
 < 
buck‘
->
n
 );

214  
FuÎKey
(
buck‘
, 
i
);

218 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

219 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
KeyH—d”Ty³
&

220 
BŒ“Logic
<
BŒ“Layout
>::
g‘KeyH—d”
(
Buck‘Ty³
* 
buck‘
, 
i
) {

221  ((
	gKeyH—d”Ty³
*)
	gbuck‘
->
	gd©a
)[
i
];

225 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

226 cÚ¡ 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
KeyH—d”Ty³
&

227 
BŒ“Logic
<
BŒ“Layout
>::
g‘KeyH—d”
(cÚ¡ 
Buck‘Ty³
* 
buck‘
, 
i
) {

228  ((cÚ¡ 
	gKeyH—d”Ty³
*)
	gbuck‘
->
	gd©a
)[
i
];

231 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

232 
	gBŒ“Logic
<
	gBŒ“Layout
>::
m¬kUnu£d
(
Buck‘Ty³
* 
buck‘
, 
keyPos
) {

233 
šv¬ŸÁ
(
keyPos
 >ğ0 && keyPo < 
buck‘
->
n
);

234 
g‘KeyH—d”
(
buck‘
, 
keyPos
).
£tUnu£d
();

237 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

238 * 
	gBŒ“Logic
<
	gBŒ“Layout
>::
d©aAt
(
Buck‘Ty³
* 
buck‘
, 
ofs
) {

239  
	gbuck‘
->
	gd©a
 + 
	gofs
;

242 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

243 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Buck‘Ty³
*

244 
BŒ“Logic
<
BŒ“Layout
>::
bŒ“mod
(
O³¿tiÚCÚ‹xt
* 
txn
, 
Buck‘Ty³
* 
buck‘
) {

245 
	gtxn
->
»cov”yUn™
()->
wr™šgPŒ
(
buck‘
, 
BŒ“Layout
::
Buck‘Size
);

246  
	gbuck‘
;

249 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

250 
	gBŒ“Logic
<
	gBŒ“Layout
>::
tÙ®D©aSize
(
Buck‘Ty³
* 
buck‘
) {

251  (è(
BŒ“Layout
::
Buck‘Size
 - (
buck‘
->
d©a
 - (*)bucket));

270 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

271 
	gBŒ“Logic
<
	gBŒ“Layout
>::
lowW©”M¬k
() {

272  
BŒ“Layout
::
Buck‘BodySize
 / 2 - BŒ“Layout::
KeyMax
 - (
KeyH—d”Ty³
) + 1;

275 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

276 
	gBŒ“Logic
<
	gBŒ“Layout
>::
š™
(
Buck‘Ty³
* 
buck‘
) {

277 
BŒ“Layout
::
š™Buck‘
(
buck‘
);

278 
	gbuck‘
->
	g·»Á
.
NuÎ
();

279 
	gbuck‘
->
	gÃxtChd
.
NuÎ
();

280 
	gbuck‘
->
	gæags
 = 
Packed
;

281 
	gbuck‘
->
	gn
 = 0;

282 
	gbuck‘
->
	gem±ySize
 = 
tÙ®D©aSize
(
buck‘
);

283 
	gbuck‘
->
	gtİSize
 = 0;

286 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

287 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_uÇÎoc
(
Buck‘Ty³
* 
buck‘
, 
by‹s
) {

288 
	gbuck‘
->
	gtİSize
 -ğ
by‹s
;

289 
	gbuck‘
->
	gem±ySize
 +ğ
by‹s
;

295 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

296 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_®loc
(
Buck‘Ty³
* 
buck‘
, 
by‹s
) {

297 
šv¬ŸÁ
(
buck‘
->
em±ySize
 >ğ
by‹s
);

298 
	gbuck‘
->
	gtİSize
 +ğ
by‹s
;

299 
	gbuck‘
->
	gem±ySize
 -ğ
by‹s
;

300 
	gofs
 = 
tÙ®D©aSize
(
buck‘
è- buck‘->
tİSize
;

301 
šv¬ŸÁ
(
ofs
 > 0);

302  
	gofs
;

305 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

306 
	gBŒ“Logic
<
	gBŒ“Layout
>::
£tNÙPacked
(
Buck‘Ty³
* 
buck‘
) {

307 
buck‘
->
æags
 &ğ~
Packed
;

310 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

311 
	gBŒ“Logic
<
	gBŒ“Layout
>::
£tPacked
(
Buck‘Ty³
* 
buck‘
) {

312 
buck‘
->
æags
 |ğ
Packed
;

315 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

316 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_d–KeyAtPos
(
Buck‘Ty³
* 
buck‘
, 
keypos
, 
boŞ
 
mayEm±y
) {

317 
šv¬ŸÁ
(
keypos
 >ğ0 && keypo <ğ
buck‘
->
n
);

318 
šv¬ŸÁ
(
chdLocFÜPos
(
buck‘
, 
keypos
).
isNuÎ
());

319 
šv¬ŸÁ
((
mayEm±y
 && 
buck‘
->
n
 > 0è|| buck‘->À> 1 || buck‘->
ÃxtChd
.
isNuÎ
());

321 
	gbuck‘
->
	gem±ySize
 +ğ(
KeyH—d”Ty³
);

322 
	gbuck‘
->
	gn
--;

324 
	gj
 = 
keypos
; j < 
	gbuck‘
->
	gn
; j++) {

325 
g‘KeyH—d”
(
buck‘
, 
j
) = getKeyHeader(bucket, j + 1);

328 
£tNÙPacked
(
buck‘
);

335 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

336 
	gBŒ“Logic
<
	gBŒ“Layout
>::
pİBack
(
Buck‘Ty³
* 
buck‘
,

337 
DiskLoc
* 
»cÜdLocOut
,

338 
KeyD©aTy³
 *
keyD©aOut
) {

340 
mas£¹
(17435, "n==0 iÀbŒ“…İBack()", 
buck‘
->
n
 > 0 );

342 
šv¬ŸÁ
(
g‘KeyH—d”
(
buck‘
, buck‘->
n
 - 1).
isU£d
());

344 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
buck‘
, buck‘->
n
 - 1);

345 *
	g»cÜdLocOut
 = 
kn
.
»cÜdLoc
;

346 
	gkeyD©aOut
->
assign
(
kn
.
d©a
);

347 
	gkeysize
 = 
kn
.
d©a
.
d©aSize
();

349 
mas£¹
(17436, "rchd‚Ù‚uÎ iÀbŒ“…İBack()", 
buck‘
->
ÃxtChd
.
isNuÎ
());

353 
	gbuck‘
->
	gÃxtChd
 = 
kn
.
´evChdBuck‘
;

354 
	gbuck‘
->
	gn
--;

358 
	gbuck‘
->
	gem±ySize
 +ğ(
KeyH—d”Ty³
);

359 
_uÇÎoc
(
buck‘
, 
keysize
);

365 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

366 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_pushBack
(
Buck‘Ty³
* 
buck‘
,

367 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

368 cÚ¡ 
KeyD©aTy³
& 
key
,

369 cÚ¡ 
DiskLoc
 
´evChd
) {

371 
	gby‹sN“ded
 = 
key
.
d©aSize
(è+ (
KeyH—d”Ty³
);

372 ià(
	gby‹sN“ded
 > 
	gbuck‘
->
	gem±ySize
) {

373  
	gçl£
;

375 
šv¬ŸÁ
(
by‹sN“ded
 <ğ
buck‘
->
em±ySize
);

377 ià(
	gbuck‘
->
	gn
) {

378 cÚ¡ 
FuÎKey
 
	gkÏ¡
 = 
g‘FuÎKey
(
buck‘
, buck‘->
n
 - 1);

379 ià(
	gkÏ¡
.
	gd©a
.
woCom·»
(
key
, 
_Üd”šg
) > 0) {

380 
log
() << "btree bucket corrupt? "

381 "cÚsid”„ešdexšg o¸ruÂšg v®id©commªd" << 
	g’dl
;

382 
log
(è<< " kÏ¡: " << 
	gkÏ¡
.
	gd©a
.
toSŒšg
(è<< 
	g’dl
;

383 
log
(è<< " key: " << 
	gkey
.
toSŒšg
(è<< 
	g’dl
;

384 
šv¬ŸÁ
(
çl£
);

388 
	gbuck‘
->
	gem±ySize
 -ğ(
KeyH—d”Ty³
);

389 
	gKeyH—d”Ty³
& 
	gkn
 = 
g‘KeyH—d”
(
buck‘
, buck‘->
n
++);

390 
	gkn
.
	g´evChdBuck‘
 = 
´evChd
;

391 
	gkn
.
	g»cÜdLoc
 = 
»cÜdLoc
;

392 
	gkn
.
£tKeyD©aOfs
(()
_®loc
(
buck‘
, 
key
.
d©aSize
()));

393 
	gofs
 = 
kn
.
keyD©aOfs
();

394 *
	gp
 = 
d©aAt
(
buck‘
, 
ofs
);

395 
memıy
(
p
, 
key
.
d©a
(), key.
d©aSize
());

396  
	gŒue
;

411 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

412 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
basicIn£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

413 
Buck‘Ty³
* 
buck‘
,

414 cÚ¡ 
DiskLoc
 
buck‘Loc
,

415 & 
keypos
,

416 cÚ¡ 
KeyD©aTy³
& 
key
,

417 cÚ¡ 
DiskLoc
 
»cÜdLoc
) {

418 
šv¬ŸÁ
(
buck‘
->
n
 < 1024);

419 
šv¬ŸÁ
(
keypos
 >ğ0 && keypo <ğ
buck‘
->
n
);

421 
	gby‹sN“ded
 = 
key
.
d©aSize
(è+ (
KeyH—d”Ty³
);

422 ià(
	gby‹sN“ded
 > 
	gbuck‘
->
	gem±ySize
) {

423 
_·ck
(
txn
, 
buck‘
, 
buck‘Loc
, 
keypos
);

424 ià(
	gby‹sN“ded
 > 
	gbuck‘
->
	gem±ySize
) {

425  
	gçl£
;

429 
šv¬ŸÁ
(
g‘Buck‘
(
buck‘Loc
è=ğ
buck‘
);

433 * 
	g¡¬t
 = 
»š‹½»t_ÿ¡
<*>(&
g‘KeyH—d”
(
buck‘
, 
keypos
));

434 * 
	g’d
 = 
»š‹½»t_ÿ¡
<*>(&
g‘KeyH—d”
(
buck‘
, buck‘->
n
 + 1));

437 
	gtxn
->
»cov”yUn™
()->
wr™šgPŒ
(
¡¬t
, 
’d
 - start);

442 
	gj
 = 
buck‘
->
n
; j > 
	gkeypos
; j--) {

443 
g‘KeyH—d”
(
buck‘
, 
j
) = getKeyHeader(bucket, j - 1);

446 
size_t
 
	gwr™eL’
 = (
buck‘
->
em±ySize
è+ (buck‘->
tİSize
è+ (buck‘->
n
);

447 
	gtxn
->
»cov”yUn™
()->
wr™šgPŒ
(&
buck‘
->
em±ySize
, 
wr™eL’
);

448 
	gbuck‘
->
	gem±ySize
 -ğ(
KeyH—d”Ty³
);

449 
	gbuck‘
->
	gn
++;

452 
	gKeyH—d”Ty³
& 
	gkn
 = 
g‘KeyH—d”
(
buck‘
, 
keypos
);

453 
	gkn
.
	g´evChdBuck‘
.
NuÎ
();

454 
	gkn
.
	g»cÜdLoc
 = 
»cÜdLoc
;

455 
	gkn
.
£tKeyD©aOfs
((è
_®loc
(
buck‘
, 
key
.
d©aSize
()));

456 *
	gp
 = 
d©aAt
(
buck‘
, 
kn
.
keyD©aOfs
());

457 
	gtxn
->
»cov”yUn™
()->
wr™šgPŒ
(
p
, 
key
.
d©aSize
());

458 
memıy
(
p
, 
key
.
d©a
(), key.
d©aSize
());

459  
	gŒue
;

466 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

467 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
mayDrİKey
(
Buck‘Ty³
* 
buck‘
, 
šdex
, 
»fPos
) {

468  
	gšdex
 > 0

469 && (
	gšdex
 !ğ
»fPos
)

470 && 
g‘KeyH—d”
(
buck‘
, 
šdex
).
isUnu£d
()

471 && 
g‘KeyH—d”
(
buck‘
, 
šdex
).
	g´evChdBuck‘
.
isNuÎ
();

474 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

475 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_·ckedD©aSize
(
Buck‘Ty³
* 
buck‘
, 
»fPos
) {

476 ià(
	gbuck‘
->
	gæags
 & 
	gPacked
) {

477  
	gBŒ“Layout
::
Buck‘Size
 - 
buck‘
->
em±ySize
 - 
Buck‘Ty³
::
H—d”Size
;

480 
	gsize
 = 0;

481 
	gj
 = 0; j < 
	gbuck‘
->
	gn
; ++j) {

482 ià(
mayDrİKey
(
buck‘
, 
j
, 
»fPos
)) {

485 
	gsize
 +ğ
g‘FuÎKey
(
buck‘
, 
j
).
	gd©a
.
d©aSize
(è+ (
	gKeyH—d”Ty³
);

488  
	gsize
;

495 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

496 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_·ck
(
O³¿tiÚCÚ‹xt
* 
txn
,

497 
Buck‘Ty³
* 
buck‘
,

498 cÚ¡ 
DiskLoc
 
thisLoc
,

499 &
»fPos
) {

501 
šv¬ŸÁ
(
g‘Buck‘
(
thisLoc
è=ğ
buck‘
);

503 ià(
	gbuck‘
->
	gæags
 & 
	gPacked
) {

507 
_·ckR—dyFÜMod
(
bŒ“mod
(
txn
, 
buck‘
), 
»fPos
);

513 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

514 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_·ckR—dyFÜMod
(
Buck‘Ty³
* 
buck‘
, &
»fPos
) {

515 ià(
	gbuck‘
->
	gæags
 & 
	gPacked
) {

519 
	gtdz
 = 
tÙ®D©aSize
(
buck‘
);

520 
	g‹mp
[
BŒ“Layout
::
Buck‘Size
];

521 
	gofs
 = 
tdz
;

522 
	gbuck‘
->
	gtİSize
 = 0;

524 
	gi
 = 0;

525 
	gj
 = 0; j < 
	gbuck‘
->
	gn
; j++) {

526 ià(
mayDrİKey
(
buck‘
, 
j
, 
»fPos
)) {

531 ià(
	gi
 !ğ
j
) {

532 ià(
»fPos
 =ğ
j
) {

534 
»fPos
 = 
i
;

536 
g‘KeyH—d”
(
buck‘
, 
i
èğg‘KeyH—d”(buck‘, 
j
);

539 
	gofsŞd
 = 
g‘KeyH—d”
(
buck‘
, 
i
).
keyD©aOfs
();

540 
	gsz
 = 
g‘FuÎKey
(
buck‘
, 
i
).
	gd©a
.
d©aSize
();

541 
	gofs
 -ğ
sz
;

542 
	gbuck‘
->
	gtİSize
 +ğ
sz
;

543 
memıy
(
‹mp
 + 
ofs
, 
d©aAt
(
buck‘
, 
ofsŞd
), 
sz
);

544 
g‘KeyH—d”
(
buck‘
, 
i
).
£tKeyD©aOfsSavšgU£
(
ofs
);

545 ++
	gi
;

548 ià(
	g»fPos
 =ğ
buck‘
->
n
) {

549 
»fPos
 = 
i
;

552 
	gbuck‘
->
	gn
 = 
i
;

553 
	gd©aU£d
 = 
tdz
 - 
ofs
;

554 
memıy
(
buck‘
->
d©a
 + 
ofs
, 
‹mp
 + ofs, 
d©aU£d
);

556 
	gbuck‘
->
	gem±ySize
 = 
tdz
 - 
d©aU£d
 - 
buck‘
->
n
 * (
KeyH—d”Ty³
);

558 
	gfoo
 = 
buck‘
->
em±ySize
;

559 
šv¬ŸÁ
Ğ
foo
 >= 0 );

561 
£tPacked
(
buck‘
);

562 
as£¹V®id
(
_šdexName
, 
buck‘
, 
_Üd”šg
);

565 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

566 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Œunÿ‹To
(
Buck‘Ty³
* 
buck‘
,

567 
N
,

568 &
»fPos
) {

569 
	gbuck‘
->
	gn
 = 
N
;

570 
£tNÙPacked
(
buck‘
);

571 
_·ckR—dyFÜMod
(
buck‘
, 
»fPos
);

589 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

590 
	gBŒ“Logic
<
	gBŒ“Layout
>::
¥l™Pos
(
Buck‘Ty³
* 
buck‘
, 
keypos
) {

591 
šv¬ŸÁ
(
buck‘
->
n
 > 2);

592 
	g¥l™
 = 0;

593 
	grightSize
 = 0;

598 
	grightSizeLim™
 = (
buck‘
->
tİSize
 + (
KeyH—d”Ty³
è* buck‘->
n
)

599 / (
keypos
 =ğ
buck‘
->
n
 ? 10 : 2);

601 
	gi
 = 
buck‘
->
n
 - 1; i > -1; --i) {

602 
	grightSize
 +ğ
g‘FuÎKey
(
buck‘
, 
i
).
	gd©a
.
d©aSize
(è+ (
	gKeyH—d”Ty³
);

603 ià(
	grightSize
 > 
	grightSizeLim™
) {

604 
	g¥l™
 = 
i
;

610 ià(
	g¥l™
 < 1) {

611 
	g¥l™
 = 1;

613 ià(
	g¥l™
 > 
	gbuck‘
->
	gn
 - 2) {

614 
	g¥l™
 = 
buck‘
->
n
 - 2;

617  
	g¥l™
;

620 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

621 
	gBŒ“Logic
<
	gBŒ“Layout
>::
»£rveKeysFrÚt
(
Buck‘Ty³
* 
buck‘
, 
nAdd
) {

622 
šv¬ŸÁ
(
buck‘
->
em±ySize
 >ğ((
KeyH—d”Ty³
è* 
nAdd
));

623 
	gbuck‘
->
	gem±ySize
 -ğ(
KeyH—d”Ty³
è* 
nAdd
;

624 
	gi
 = 
buck‘
->
n
 - 1; i > -1; --i) {

625 
g‘KeyH—d”
(
buck‘
, 
i
 + 
nAdd
) = getKeyHeader(bucket, i);

627 
	gbuck‘
->
	gn
 +ğ
nAdd
;

630 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

631 
	gBŒ“Logic
<
	gBŒ“Layout
>::
£tKey
(
Buck‘Ty³
* 
buck‘
,

632 
i
,

633 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

634 cÚ¡ 
KeyD©aTy³
& 
key
,

635 cÚ¡ 
DiskLoc
 
´evChdBuck‘
) {

636 
	gKeyH—d”Ty³
 &
	gkn
 = 
g‘KeyH—d”
(
buck‘
, 
i
);

637 
	gkn
.
	g»cÜdLoc
 = 
»cÜdLoc
;

638 
	gkn
.
	g´evChdBuck‘
 = 
´evChdBuck‘
;

639 
	gofs
 = (è
_®loc
(
buck‘
, 
key
.
d©aSize
());

640 
	gkn
.
£tKeyD©aOfs
(
ofs
);

641 *
	gp
 = 
d©aAt
(
buck‘
, 
ofs
);

642 
memıy
(
p
, 
key
.
d©a
(), key.
d©aSize
());

645 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

646 
	gBŒ“Logic
<
	gBŒ“Layout
>::
drİFrÚt
(
Buck‘Ty³
* 
buck‘
,

647 
nDrİ
,

648 &
»åos
) {

649 
	gi
 = 
nDrİ
; i < 
	gbuck‘
->
	gn
; ++i) {

650 
g‘KeyH—d”
(
buck‘
, 
i
 - 
nDrİ
) = getKeyHeader(bucket, i);

652 
	gbuck‘
->
	gn
 -ğ
nDrİ
;

653 
£tNÙPacked
(
buck‘
);

654 
_·ckR—dyFÜMod
(
buck‘
, 
»åos
 );

657 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

658 
	gBŒ“Logic
<
	gBŒ“Layout
>::
cu¡omLoÿ‹
(
DiskLoc
* 
locInOut
,

659 * 
keyOfsInOut
,

660 cÚ¡ 
BSONObj
& 
keyBegš
,

661 
keyBegšL’
,

662 
boŞ
 
aá”Key
,

663 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

664 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

665 
dœeùiÚ
) const {

666 
	g·œ
<
	gDiskLoc
, > 
	gunu£d
;

668 
cu¡omLoÿ‹
(
locInOut
,

669 
keyOfsInOut
,

670 
keyBegš
,

671 
keyBegšL’
,

672 
aá”Key
,

673 
keyEnd
,

674 
keyEndInşusive
,

675 
dœeùiÚ
,

676 
unu£d
);

678 
skUnu£dKeys
(
locInOut
, 
keyOfsInOut
, 
dœeùiÚ
);

681 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

682 
	gBŒ“Logic
<
	gBŒ“Layout
>::
advªû
(
DiskLoc
* 
buck‘LocInOut
,

683 * 
posInOut
,

684 
dœeùiÚ
) const {

686 *
	gbuck‘LocInOut
 = 
advªû
(*
buck‘LocInOut
, 
posInOut
, 
dœeùiÚ
);

687 
skUnu£dKeys
(
buck‘LocInOut
, 
posInOut
, 
dœeùiÚ
);

690 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

691 
	gBŒ“Logic
<
	gBŒ“Layout
>::
skUnu£dKeys
(
DiskLoc
* 
loc
, * 
pos
, 
dœeùiÚ
) const {

692 !
	gloc
->
isNuÎ
(è&& !
keyIsU£d
(*
loc
, *
pos
)) {

693 *
	gloc
 = 
advªû
(*
loc
, 
pos
, 
dœeùiÚ
);

697 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

698 
	gBŒ“Logic
<
	gBŒ“Layout
>::
advªûTo
(
DiskLoc
* 
thisLocInOut
,

699 * 
keyOfsInOut
,

700 cÚ¡ 
BSONObj
 &
keyBegš
,

701 
keyBegšL’
,

702 
boŞ
 
aá”Key
,

703 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

704 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

705 
dœeùiÚ
) const {

707 
advªûToIm¶
(
thisLocInOut
,

708 
keyOfsInOut
,

709 
keyBegš
,

710 
keyBegšL’
,

711 
aá”Key
,

712 
keyEnd
,

713 
keyEndInşusive
,

714 
dœeùiÚ
);

716 
skUnu£dKeys
(
thisLocInOut
, 
keyOfsInOut
, 
dœeùiÚ
);

728 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

729 
	gBŒ“Logic
<
	gBŒ“Layout
>::
advªûToIm¶
(
DiskLoc
* 
thisLocInOut
,

730 * 
keyOfsInOut
,

731 cÚ¡ 
BSONObj
 &
keyBegš
,

732 
keyBegšL’
,

733 
boŞ
 
aá”Key
,

734 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

735 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

736 
dœeùiÚ
) const {

738 
Buck‘Ty³
* 
	gbuck‘
 = 
g‘Buck‘
(*
thisLocInOut
);

740 
	gl
, 
	gh
;

741 
boŞ
 
	gdÚtGoUp
;

743 ià(
	gdœeùiÚ
 > 0) {

744 
	gl
 = *
keyOfsInOut
;

745 
	gh
 = 
buck‘
->
n
 - 1;

746 
	gcmpResuÉ
 = 
cu¡omBSONCmp
(
g‘FuÎKey
(
buck‘
, 
h
).
d©a
.
toBsÚ
(),

747 
keyBegš
,

748 
keyBegšL’
,

749 
aá”Key
,

750 
keyEnd
,

751 
keyEndInşusive
,

752 
_Üd”šg
,

753 
dœeùiÚ
);

754 
	gdÚtGoUp
 = (
cmpResuÉ
 >= 0);

757 
	gl
 = 0;

758 
	gh
 = *
keyOfsInOut
;

759 
	gcmpResuÉ
 = 
cu¡omBSONCmp
(
g‘FuÎKey
(
buck‘
, 
l
).
d©a
.
toBsÚ
(),

760 
keyBegš
,

761 
keyBegšL’
,

762 
aá”Key
,

763 
keyEnd
,

764 
keyEndInşusive
,

765 
_Üd”šg
,

766 
dœeùiÚ
);

767 
	gdÚtGoUp
 = (
cmpResuÉ
 <= 0);

770 
	g·œ
<
	gDiskLoc
, > 
	gbe¡P¬’t
;

772 ià(
	gdÚtGoUp
) {

774 ià(!
cu¡omFšd
(
l
,

775 
h
,

776 
keyBegš
,

777 
keyBegšL’
,

778 
aá”Key
,

779 
keyEnd
,

780 
keyEndInşusive
,

781 
_Üd”šg
,

782 
dœeùiÚ
,

783 
thisLocInOut
,

784 
keyOfsInOut
,

785 
be¡P¬’t
)) {

791 !
	gbuck‘
->
	g·»Á
.
isNuÎ
()) {

792 *
	gthisLocInOut
 = 
buck‘
->
·»Á
;

793 
	gbuck‘
 = 
g‘Buck‘
(*
thisLocInOut
);

795 ià(
	gdœeùiÚ
 > 0) {

796 ià(
cu¡omBSONCmp
(
g‘FuÎKey
(
buck‘
, buck‘->
n
 - 1).
d©a
.
toBsÚ
(),

797 
keyBegš
,

798 
keyBegšL’
,

799 
aá”Key
,

800 
keyEnd
,

801 
keyEndInşusive
,

802 
_Üd”šg
,

803 
dœeùiÚ
) >= 0 ) {

808 ià(
cu¡omBSONCmp
(
g‘FuÎKey
(
buck‘
, 0).
d©a
.
toBsÚ
(),

809 
keyBegš
,

810 
keyBegšL’
,

811 
aá”Key
,

812 
keyEnd
,

813 
keyEndInşusive
,

814 
_Üd”šg
,

815 
dœeùiÚ
) <= 0) {

822 
cu¡omLoÿ‹
(
thisLocInOut
,

823 
keyOfsInOut
,

824 
keyBegš
,

825 
keyBegšL’
,

826 
aá”Key
,

827 
keyEnd
,

828 
keyEndInşusive
,

829 
dœeùiÚ
,

830 
be¡P¬’t
);

833 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

834 
	gBŒ“Logic
<
	gBŒ“Layout
>::
cu¡omLoÿ‹
(
DiskLoc
* 
locInOut
,

835 * 
keyOfsInOut
,

836 cÚ¡ 
BSONObj
& 
keyBegš
,

837 
keyBegšL’
,

838 
boŞ
 
aá”Key
,

839 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

840 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

841 
dœeùiÚ
,

842 
·œ
<
DiskLoc
, >& 
be¡P¬’t
) const {

844 
Buck‘Ty³
* 
	gbuck‘
 = 
g‘Buck‘
(*
locInOut
);

846 ià(0 =ğ
buck‘
->
n
) {

847 *
locInOut
 = 
DiskLoc
();

853 
	gl
 = 0;

854 
	gh
 = 
buck‘
->
n
 - 1;

857 
	gz
 = (
dœeùiÚ
 > 0è? 0 : 
h
;

860 
	g»s
 = 
cu¡omBSONCmp
(
g‘FuÎKey
(
buck‘
, 
z
).
d©a
.
toBsÚ
(),

861 
keyBegš
,

862 
keyBegšL’
,

863 
aá”Key
,

864 
keyEnd
,

865 
keyEndInşusive
,

866 
_Üd”šg
,

867 
dœeùiÚ
);

870 ià(
dœeùiÚ
 * 
	g»s
 >= 0) {

871 
DiskLoc
 
Ãxt
;

872 *
	gkeyOfsInOut
 = 
z
;

874 ià(
	gdœeùiÚ
 > 0) {

875 
das£¹
(
z
 == 0);

876 
	gÃxt
 = 
g‘KeyH—d”
(
buck‘
, 0).
	g´evChdBuck‘
;

879 
	gÃxt
 = 
buck‘
->
ÃxtChd
;

882 ià(!
	gÃxt
.
isNuÎ
()) {

883 
	gbe¡P¬’t
 = 
·œ
<
DiskLoc
, >(*
	glocInOut
, *
	gkeyOfsInOut
);

884 *
	glocInOut
 = 
Ãxt
;

885 
	gbuck‘
 = 
g‘Buck‘
(*
locInOut
);

893 
	g»s
 = 
cu¡omBSONCmp
(
g‘FuÎKey
(
buck‘
, 
h
 - 
z
).
d©a
.
toBsÚ
(),

894 
keyBegš
,

895 
keyBegšL’
,

896 
aá”Key
,

897 
keyEnd
,

898 
keyEndInşusive
,

899 
_Üd”šg
,

900 
dœeùiÚ
);

902 ià(
dœeùiÚ
 * 
	g»s
 < 0) {

903 
DiskLoc
 
	gÃxt
;

904 ià(
	gdœeùiÚ
 > 0) {

905 
	gÃxt
 = 
buck‘
->
ÃxtChd
;

908 
	gÃxt
 = 
g‘KeyH—d”
(
buck‘
, 0).
	g´evChdBuck‘
;

911 ià(
	gÃxt
.
isNuÎ
()) {

913 *
	glocInOut
 = 
be¡P¬’t
.
fœ¡
;

914 *
	gkeyOfsInOut
 = 
be¡P¬’t
.
£cÚd
;

918 *
	glocInOut
 = 
Ãxt
;

919 
	gbuck‘
 = 
g‘Buck‘
(*
locInOut
);

924 ià(!
cu¡omFšd
(
l
,

925 
h
,

926 
keyBegš
,

927 
keyBegšL’
,

928 
aá”Key
,

929 
keyEnd
,

930 
keyEndInşusive
,

931 
_Üd”šg
,

932 
dœeùiÚ
,

933 
locInOut
,

934 
keyOfsInOut
,

935 
be¡P¬’t
)) {

939 
	gbuck‘
 = 
g‘Buck‘
(*
locInOut
);

943 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

944 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
cu¡omFšd
(
low
,

945 
high
,

946 cÚ¡ 
BSONObj
& 
keyBegš
,

947 
keyBegšL’
,

948 
boŞ
 
aá”Key
,

949 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

950 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

951 cÚ¡ 
Ord”šg
& 
Üd”
,

952 
dœeùiÚ
,

953 
DiskLoc
* 
thisLocInOut
,

954 * 
keyOfsInOut
,

955 
·œ
<
DiskLoc
, >& 
be¡P¬’t
) const {

957 cÚ¡ 
Buck‘Ty³
* 
	gbuck‘
 = 
g‘Buck‘
(*
thisLocInOut
);

960 ià(
	glow
 + 1 =ğ
high
) {

961 *
keyOfsInOut
 = (
dœeùiÚ
 > 0è? 
high
 : 
low
;

962 
DiskLoc
 
	gÃxt
 = 
g‘KeyH—d”
(
buck‘
, 
high
).
	g´evChdBuck‘
;

963 ià(!
	gÃxt
.
isNuÎ
()) {

964 
	gbe¡P¬’t
 = 
make_·œ
(*
thisLocInOut
, *
keyOfsInOut
);

965 *
	gthisLocInOut
 = 
Ãxt
;

966  
	gŒue
;

969  
	gçl£
;

973 
	gmiddË
 = 
low
 + (
high
 -†ow) / 2;

975 
	gcmp
 = 
cu¡omBSONCmp
(
g‘FuÎKey
(
buck‘
, 
middË
).
d©a
.
toBsÚ
(),

976 
keyBegš
,

977 
keyBegšL’
,

978 
aá”Key
,

979 
keyEnd
,

980 
keyEndInşusive
,

981 
Üd”
,

982 
dœeùiÚ
);

984 ià(
	gcmp
 < 0) {

985 
	glow
 = 
middË
;

987 ià(
	gcmp
 > 0) {

988 
	ghigh
 = 
middË
;

991 ià(
	gdœeùiÚ
 < 0) {

992 
	glow
 = 
middË
;

995 
	ghigh
 = 
middË
;

1014 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1015 
	gBŒ“Logic
<
	gBŒ“Layout
>::
cu¡omBSONCmp
(cÚ¡ 
BSONObj
& 
l
,

1016 cÚ¡ 
BSONObj
& 
rBegš
,

1017 
rBegšL’
,

1018 
boŞ
 
rSup
,

1019 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
rEnd
,

1020 cÚ¡ 
veùÜ
<
boŞ
>& 
rEndInşusive
,

1021 cÚ¡ 
Ord”šg
& 
o
,

1022 
dœeùiÚ
) const {

1024 
BSONObjI‹¿tÜ
 
Î
Ğ
l
 );

1025 
BSONObjI‹¿tÜ
 
¼
Ğ
rBegš
 );

1026 
	gveùÜ
< cÚ¡ 
	gBSONEËm’t
 * >::
cÚ¡_™”©Ü
 
¼2
 = 
rEnd
.
begš
();

1027 
	gveùÜ
< 
	gboŞ
 >::
cÚ¡_™”©Ü
 
šc
 = 
rEndInşusive
.
begš
();

1028 
	gmask
 = 1;

1029  
	gi
 = 0; i < 
	grBegšL’
; ++i, 
	gmask
 <<= 1 ) {

1030 
BSONEËm’t
 
Îl
 = 
Î
.
Ãxt
();

1031 
BSONEËm’t
 
	g¼r
 = 
¼
.
Ãxt
();

1032 ++
	g¼2
;

1033 ++
	gšc
;

1035 
	gx
 = 
Îl
.
woCom·»
Ğ
¼r
, 
çl£
 );

1036 iàĞ
	go
.
desûndšg
Ğ
mask
 ) )

1037 
	gx
 = -
x
;

1038 iàĞ
	gx
 != 0 )

1039  
x
;

1041 iàĞ
	grSup
 ) {

1042  -
	gdœeùiÚ
;

1044  ; 
	gÎ
.
mÜe
(); 
	gmask
 <<= 1 ) {

1045 
BSONEËm’t
 
Îl
 = 
Î
.
Ãxt
();

1046 
BSONEËm’t
 
	g¼r
 = **
¼2
;

1047 ++
	g¼2
;

1048 
	gx
 = 
Îl
.
woCom·»
Ğ
¼r
, 
çl£
 );

1049 iàĞ
	go
.
desûndšg
Ğ
mask
 ) )

1050 
	gx
 = -
x
;

1051 iàĞ
	gx
 != 0 )

1052  
x
;

1053 iàĞ!*
	gšc
 ) {

1054  -
	gdœeùiÚ
;

1056 ++
	gšc
;

1061 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1062 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
exi¡s
(cÚ¡ 
KeyD©aTy³
& 
key
) const {

1063 
pos™iÚ
 = 0;

1066 
boŞ
 
	gfound
;

1067 
DiskLoc
 
	gbuck‘
 = 
_loÿ‹
(
g‘RoÙLoc
(), 
key
, &
pos™iÚ
, &
found
, 
mšDiskLoc
, 1);

1069 !
	gbuck‘
.
isNuÎ
()) {

1070 
FuÎKey
 
	gfuÎKey
 = 
g‘FuÎKey
(
g‘Buck‘
(
buck‘
), 
pos™iÚ
);

1071 ià(
	gfuÎKey
.
	gh—d”
.
isU£d
()) {

1072  
	gfuÎKey
.
	gd©a
.
woEqu®
(
key
);

1074 
	gbuck‘
 = 
advªû
(
buck‘
, &
pos™iÚ
, 1);

1077  
	gçl£
;

1080 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1081 
Stus
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
dupKeyCheck
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) const {

1082 
KeyD©aOwÃdTy³
 
theKey
(
key
);

1083 ià(!
wouldC»©eDup
(
theKey
, 
loc
)) {

1084  
	gStus
::
OK
();

1087  
Stus
(
E¼ÜCodes
::
Du¶iÿ‹Key
, 
dupKeyE¼Ü
(
theKey
));

1090 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1091 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
wouldC»©eDup
(cÚ¡ 
KeyD©aTy³
& 
key
,

1092 cÚ¡ 
DiskLoc
 
£lf
) const {

1093 
	gpos™iÚ
;

1094 
boŞ
 
	gfound
;

1095 
DiskLoc
 
	gposLoc
 = 
_loÿ‹
(
g‘RoÙLoc
(), 
key
, &
pos™iÚ
, &
found
, 
mšDiskLoc
, 1);

1097 !
	gposLoc
.
isNuÎ
()) {

1098 
FuÎKey
 
	gfuÎKey
 = 
g‘FuÎKey
(
g‘Buck‘
(
posLoc
), 
pos™iÚ
);

1099 ià(
	gfuÎKey
.
	gh—d”
.
isU£d
()) {

1102 ià(
	gfuÎKey
.
	gd©a
.
woEqu®
(
key
)) {

1103  
	gfuÎKey
.
	g»cÜdLoc
 !ğ
£lf
;

1108 
	gposLoc
 = 
advªû
(
posLoc
, &
pos™iÚ
, 1);

1110  
	gçl£
;

1113 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1114 
¡ršg
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
dupKeyE¼Ü
(cÚ¡ 
KeyD©aTy³
& 
key
) const {

1115 
¡ršg¡»am
 
ss
;

1116 
	gss
 << "E11000 duplicate keyƒrror ";

1117 
	gss
 << "šdex: " << 
	g_šdexName
 << " ";

1118 
	gss
 << "du°key: " << 
	gkey
.
toSŒšg
();

1119  
	gss
.
¡r
();

1136 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1137 
Stus
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_fšd
(
Buck‘Ty³
* 
buck‘
,

1138 cÚ¡ 
KeyD©aTy³
& 
key
,

1139 cÚ¡ 
DiskLoc
& 
»cÜdLoc
,

1140 
boŞ
 
”rÜIfDup
,

1141 * 
keyPos™iÚOut
,

1142 
boŞ
* 
foundOut
) const {

1145 
LocTy³
 
	gg’”icRecÜdLoc
;

1146 
	gg’”icRecÜdLoc
 = 
»cÜdLoc
;

1148 
boŞ
 
	gdupsChecked
 = 
çl£
;

1150 
	glow
 = 0;

1151 
	ghigh
 = 
buck‘
->
n
 - 1;

1152 
	gmiddË
 = (
low
 + 
high
) / 2;

1154 
	glow
 <ğ
high
) {

1155 
FuÎKey
 
fuÎKey
 = 
g‘FuÎKey
(
buck‘
, 
middË
);

1156 
	gcmp
 = 
key
.
woCom·»
(
fuÎKey
.
d©a
, 
_Üd”šg
);

1159 ià(0 =ğ
cmp
) {

1161 ià(
”rÜIfDup
) {

1162 ià(
fuÎKey
.
h—d”
.
isUnu£d
()) {

1167 ià(!
dupsChecked
) {

1170 
dupsChecked
 = 
Œue
;

1171 ià(
exi¡s
(
key
)) {

1172 ià(
wouldC»©eDup
(
key
, 
g’”icRecÜdLoc
)) {

1173  
Stus
(
E¼ÜCodes
::
Du¶iÿ‹Key
, 
dupKeyE¼Ü
(
key
), 11000);

1176  
Stus
(
E¼ÜCodes
::
UniqueIndexViŞ©iÚ
, "FIXME");

1182 ià(
	gfuÎKey
.
	g»cÜdLoc
 =ğ
»cÜdLoc
) {

1183  
Stus
(
E¼ÜCodes
::
UniqueIndexViŞ©iÚ
, "FIXME");

1186  
Stus
(
E¼ÜCodes
::
Du¶iÿ‹Key
, 
dupKeyE¼Ü
(
key
), 11000);

1192 
LocTy³
 
	g»cÜdLocCİy
 = 
fuÎKey
.
»cÜdLoc
;

1197 
	g»cÜdLocCİy
.
GETOFS
() &= ~1;

1200 
	gcmp
 = 
»cÜdLoc
.
com·»
(
»cÜdLocCİy
);

1203 ià(
	gcmp
 < 0) {

1204 
	ghigh
 = 
middË
 - 1;

1206 ià(
	gcmp
 > 0) {

1207 
	glow
 = 
middË
 + 1;

1211 *
	gkeyPos™iÚOut
 = 
middË
;

1212 *
	gfoundOut
 = 
Œue
;

1213  
	gStus
::
OK
();

1216 
	gmiddË
 = (
low
 + 
high
) / 2;

1220 *
	gkeyPos™iÚOut
 = 
low
;

1223 ià(
	glow
 !ğ
buck‘
->
n
) {

1224 
was£¹
(
key
.
woCom·»
(
g‘FuÎKey
(
buck‘
, 
low
).
d©a
, 
_Üd”šg
) <= 0);

1226 ià(
	glow
 > 0) {

1227 ià(
g‘FuÎKey
(
buck‘
, 
low
 - 1).
	gd©a
.
woCom·»
(
key
, 
_Üd”šg
) > 0) {

1228 
	gDEV
 {

1229 
log
(è<< 
	gkey
.
toSŒšg
(è<< 
	g’dl
;

1230 
log
(è<< 
g‘FuÎKey
(
buck‘
, 
low
 - 1).
	gd©a
.
toSŒšg
(è<< 
	g’dl
;

1232 
was£¹
(
çl£
);

1237 *
	gfoundOut
 = 
çl£
;

1238  
	gStus
::
OK
();

1241 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1242 
	gBŒ“Logic
<
	gBŒ“Layout
>::
d–Buck‘
(
O³¿tiÚCÚ‹xt
* 
txn
,

1243 
Buck‘Ty³
* 
buck‘
,

1244 cÚ¡ 
DiskLoc
 
buck‘Loc
) {

1245 
šv¬ŸÁ
(
buck‘Loc
 !ğ
g‘RoÙLoc
());

1247 
	g_buck‘D–‘iÚ
->
aboutToD–‘eBuck‘
(
buck‘Loc
);

1249 
Buck‘Ty³
* 
	gp
 = 
g‘Buck‘
(
buck‘
->
·»Á
);

1250 
	g·»ÁIdx
 = 
šdexInP¬’t
(
buck‘
, 
buck‘Loc
);

1251 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
chdLocFÜPos
(
p
, 
·»ÁIdx
)èğ
DiskLoc
();

1252 
d—ÎocBuck‘
(
txn
, 
buck‘
, 
buck‘Loc
);

1255 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1256 
	gBŒ“Logic
<
	gBŒ“Layout
>::
d—ÎocBuck‘
(
O³¿tiÚCÚ‹xt
* 
txn
,

1257 
Buck‘Ty³
* 
buck‘
,

1258 cÚ¡ 
DiskLoc
 
buck‘Loc
) {

1259 
	gbuck‘
->
	gn
 = 
BŒ“Layout
::
INVALID_N_SENTINEL
;

1260 
	gbuck‘
->
	g·»Á
.
NuÎ
();

1261 
	g_»cÜdStÜe
->
d–‘eRecÜd
(
txn
, 
buck‘Loc
);

1264 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1265 
	gBŒ“Logic
<
	gBŒ“Layout
>::
»¡ÜePos™iÚ
(cÚ¡ 
BSONObj
& 
§vedKey
,

1266 cÚ¡ 
DiskLoc
& 
§vedLoc
,

1267 
dœeùiÚ
,

1268 
DiskLoc
* 
buck‘LocInOut
,

1269 * 
keyOff£tInOut
) const {

1275 ià(-1 =ğ*
keyOff£tInOut
) {

1276 
loÿ‹
(
§vedKey
, 
§vedLoc
, 
dœeùiÚ
, 
keyOff£tInOut
, 
buck‘LocInOut
);

1280 
šv¬ŸÁ
(*
keyOff£tInOut
 >= 0);

1282 
Buck‘Ty³
* 
	gbuck‘
 = 
g‘Buck‘
(*
buck‘LocInOut
);

1283 
šv¬ŸÁ
(
buck‘
);

1284 
šv¬ŸÁ
(
BŒ“Layout
::
INVALID_N_SENTINEL
 !ğ
buck‘
->
n
);

1286 ià(
_keyIsAt
(
§vedKey
, 
§vedLoc
, 
buck‘
, *
keyOff£tInOut
)) {

1287 
skUnu£dKeys
(
buck‘LocInOut
, 
keyOff£tInOut
, 
dœeùiÚ
);

1291 ià(*
	gkeyOff£tInOut
 > 0) {

1292 (*
	gkeyOff£tInOut
)--;

1293 ià(
_keyIsAt
(
§vedKey
, 
§vedLoc
, 
buck‘
, *
keyOff£tInOut
)) {

1294 
skUnu£dKeys
(
buck‘LocInOut
, 
keyOff£tInOut
, 
dœeùiÚ
);

1299 
loÿ‹
(
§vedKey
, 
§vedLoc
, 
dœeùiÚ
, 
keyOff£tInOut
, 
buck‘LocInOut
);

1302 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1303 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_keyIsAt
(cÚ¡ 
BSONObj
& 
§vedKey
,

1304 cÚ¡ 
DiskLoc
& 
§vedLoc
,

1305 
Buck‘Ty³
* 
buck‘
,

1306 
keyPos
) const {

1307 ià(
	gkeyPos
 >ğ
buck‘
->
n
) {

1308  
çl£
;

1311 
FuÎKey
 
	gkey
 = 
g‘FuÎKey
(
buck‘
, 
keyPos
);

1312 ià(!
	gkey
.
	gd©a
.
toBsÚ
().
bš¬yEqu®
(
§vedKey
)) {

1313  
	gçl£
;

1315  
	gkey
.
	gh—d”
.
	g»cÜdLoc
 =ğ
§vedLoc
;

1321 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1322 
	gBŒ“Logic
<
	gBŒ“Layout
>::
d–KeyAtPos
(
O³¿tiÚCÚ‹xt
* 
txn
,

1323 
Buck‘Ty³
* 
buck‘
,

1324 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1325 
p
) {

1326 
šv¬ŸÁ
(
buck‘
->
n
 > 0);

1327 
DiskLoc
 
	gËá
 = 
chdLocFÜPos
(
buck‘
, 
p
);

1329 ià(
	gbuck‘
->
	gn
 == 1) {

1330 ià(
Ëá
.
isNuÎ
(è&& 
buck‘
->
ÃxtChd
.isNull()) {

1331 
_d–KeyAtPos
(
buck‘
, 
p
);

1332 ià(
isH—d
(
buck‘
)) {

1336 ià(!
mayB®ªûW™hNeighbÜs
(
txn
, 
buck‘
, 
buck‘Loc
)) {

1340 
d–Buck‘
(
txn
, 
buck‘
, 
buck‘Loc
);

1345 
d–‘eIÁ”ÇlKey
(
txn
, 
buck‘
, 
buck‘Loc
, 
p
);

1349 ià(
	gËá
.
isNuÎ
()) {

1350 
_d–KeyAtPos
(
buck‘
, 
p
);

1351 
mayB®ªûW™hNeighbÜs
(
txn
, 
buck‘
, 
buck‘Loc
);

1354 
d–‘eIÁ”ÇlKey
(
txn
, 
buck‘
, 
buck‘Loc
, 
p
);

1381 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1382 
	gBŒ“Logic
<
	gBŒ“Layout
>::
d–‘eIÁ”ÇlKey
(
O³¿tiÚCÚ‹xt
* 
txn
,

1383 
Buck‘Ty³
* 
buck‘
,

1384 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1385 
keypos
) {

1386 
DiskLoc
 
	glchd
 = 
chdLocFÜPos
(
buck‘
, 
keypos
);

1387 
DiskLoc
 
	grchd
 = 
chdLocFÜPos
(
buck‘
, 
keypos
 + 1);

1388 
šv¬ŸÁ
(!
lchd
.
isNuÎ
(è|| !
rchd
.isNull());

1389 
	gadvªûDœeùiÚ
 = 
lchd
.
isNuÎ
() ? 1 : -1;

1390 
	gadvªûKeyOfs
 = 
keypos
;

1391 
DiskLoc
 
	gadvªûLoc
 = 
advªû
(
buck‘Loc
, &
advªûKeyOfs
, 
advªûDœeùiÚ
);

1395 
Buck‘Ty³
* 
	gadvªûBuck‘
 = 
g‘Buck‘
(
advªûLoc
);

1397 ià(!
chdLocFÜPos
(
advªûBuck‘
, 
advªûKeyOfs
).
isNuÎ
()

1398 || !
chdLocFÜPos
(
advªûBuck‘
, 
advªûKeyOfs
 + 1).
isNuÎ
()) {

1400 
m¬kUnu£d
(
buck‘
, 
keypos
);

1404 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
advªûBuck‘
, 
advªûKeyOfs
);

1408 
£tIÁ”ÇlKey
(
txn
, 
buck‘
, 
buck‘Loc
, 
keypos
, 
kn
.
»cÜdLoc
, kn.
d©a
,

1409 
chdLocFÜPos
(
buck‘
, 
keypos
),

1410 
chdLocFÜPos
(
buck‘
, 
keypos
 + 1));

1411 
d–KeyAtPos
(
txn
, 
bŒ“mod
Ñxn, 
advªûBuck‘
), 
advªûLoc
, 
advªûKeyOfs
);

1414 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1415 
	gBŒ“Logic
<
	gBŒ“Layout
>::
»¶aûW™hNextChd
(
O³¿tiÚCÚ‹xt
* 
txn
,

1416 
Buck‘Ty³
* 
buck‘
,

1417 cÚ¡ 
DiskLoc
 
buck‘Loc
) {

1419 
šv¬ŸÁ
(
buck‘
->
n
 =ğ0 && !buck‘->
ÃxtChd
.
isNuÎ
() );

1420 ià(
	gbuck‘
->
	g·»Á
.
isNuÎ
()) {

1421 
šv¬ŸÁ
(
g‘RoÙLoc
(è=ğ
buck‘Loc
);

1422 
	g_h—dMªag”
->
£tH—d
(
txn
, 
buck‘
->
ÃxtChd
);

1425 
Buck‘Ty³
* 
	g·»ÁBuck‘
 = 
g‘Buck‘
(
buck‘
->
·»Á
);

1426 
	gbuck‘IndexInP¬’t
 = 
šdexInP¬’t
(
buck‘
, 
buck‘Loc
);

1427 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
chdLocFÜPos
(
·»ÁBuck‘
, 
buck‘IndexInP¬’t
)) =

1428 
buck‘
->
ÃxtChd
;

1431 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
g‘Buck‘
(
buck‘
->
ÃxtChd
)->
·»Á
) = bucket->parent;

1432 
	g_buck‘D–‘iÚ
->
aboutToD–‘eBuck‘
(
buck‘Loc
);

1433 
d—ÎocBuck‘
(
txn
, 
buck‘
, 
buck‘Loc
);

1436 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1437 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
ÿnM”geChd»n
(
Buck‘Ty³
* 
buck‘
,

1438 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1439 cÚ¡ 
ËáIndex
) {

1440 
šv¬ŸÁ
(
ËáIndex
 >ğ0 &&†eáIndex < 
buck‘
->
n
);

1442 
DiskLoc
 
	gËáNodeLoc
 = 
chdLocFÜPos
(
buck‘
, 
ËáIndex
);

1443 
DiskLoc
 
	grightNodeLoc
 = 
chdLocFÜPos
(
buck‘
, 
ËáIndex
 + 1);

1445 ià(
	gËáNodeLoc
.
isNuÎ
(è|| 
	grightNodeLoc
.isNull()) {

1446  
	gçl£
;

1449 
	gpos
 = 0;

1451 
Buck‘Ty³
* 
	gËáBuck‘
 = 
g‘Buck‘
(
ËáNodeLoc
);

1452 
Buck‘Ty³
* 
	grightBuck‘
 = 
g‘Buck‘
(
rightNodeLoc
);

1454 
	gsum
 = 
Buck‘Ty³
::
H—d”Size


1455 + 
_·ckedD©aSize
(
ËáBuck‘
, 
pos
)

1456 + 
_·ckedD©aSize
(
rightBuck‘
, 
pos
)

1457 + 
g‘FuÎKey
(
buck‘
, 
ËáIndex
).
	gd©a
.
d©aSize
()

1458 + (
	gKeyH—d”Ty³
);

1460  
	gsum
 <ğ
BŒ“Layout
::
Buck‘Size
;

1467 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1468 
	gBŒ“Logic
<
	gBŒ“Layout
>::
_»b®ªûdS•¬©ÜPos
(
Buck‘Ty³
* 
buck‘
, 
ËáIndex
) {

1469 
	g¥l™
 = -1;

1470 
	grightSize
 = 0;

1471 cÚ¡ 
Buck‘Ty³
* 
	gl
 = 
chdFÜPos
(
buck‘
, 
ËáIndex
);

1472 cÚ¡ 
Buck‘Ty³
* 
	gr
 = 
chdFÜPos
(
buck‘
, 
ËáIndex
 + 1);

1474 
	gKNS
 = (
KeyH—d”Ty³
);

1475 
	grightSizeLim™
 = ( 
l
->
tİSize


1476 + 
l
->
n
 * 
KNS


1477 + 
g‘FuÎKey
(
buck‘
, 
ËáIndex
).
	gd©a
.
d©aSize
()

1478 + 
	gKNS


1479 + 
	gr
->
	gtİSize


1480 + 
	gr
->
n
 * 
	gKNS
 ) / 2;

1484 
šv¬ŸÁ
(
rightSizeLim™
 < 
BŒ“Layout
::
Buck‘BodySize
);

1486 
	gi
 = 
r
->
n
 - 1; i > -1; --i) {

1487 
	grightSize
 +ğ
g‘FuÎKey
(
r
, 
i
).
	gd©a
.
d©aSize
(è+ 
	gKNS
;

1488 ià(
	grightSize
 > 
	grightSizeLim™
) {

1489 
	g¥l™
 = 
l
->
n
 + 1 + 
i
;

1494 ià(
	g¥l™
 == -1) {

1495 
rightSize
 +ğ
g‘FuÎKey
(
buck‘
, 
ËáIndex
).
	gd©a
.
d©aSize
(è+ 
	gKNS
;

1496 ià(
	grightSize
 > 
	grightSizeLim™
) {

1497 
	g¥l™
 = 
l
->
n
;

1501 ià(
	g¥l™
 == -1) {

1502 
i
 = 
l
->
n
 - 1; 
	gi
 > -1; --i) {

1503 
	grightSize
 +ğ
g‘FuÎKey
(
l
, 
i
).
	gd©a
.
d©aSize
(è+ 
	gKNS
;

1504 ià(
	grightSize
 > 
	grightSizeLim™
) {

1505 
	g¥l™
 = 
i
;

1512 ià(
	g¥l™
 < 1) {

1513 
	g¥l™
 = 1;

1515 ià(
	g¥l™
 > 
	gl
->
	gn
 + 1 + 
	gr
->n - 2) {

1516 
	g¥l™
 = 
l
->
n
 + 1 + 
r
->n - 2;

1519  
	g¥l™
;

1522 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1523 
	gBŒ“Logic
<
	gBŒ“Layout
>::
doM”geChd»n
(
O³¿tiÚCÚ‹xt
* 
txn
,

1524 
Buck‘Ty³
* 
buck‘
,

1525 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1526 
ËáIndex
) {

1528 
DiskLoc
 
	gËáNodeLoc
 = 
chdLocFÜPos
(
buck‘
, 
ËáIndex
);

1529 
DiskLoc
 
	grightNodeLoc
 = 
chdLocFÜPos
(
buck‘
, 
ËáIndex
 + 1);

1530 
Buck‘Ty³
* 
	gl
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
ËáNodeLoc
));

1531 
Buck‘Ty³
* 
	gr
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
rightNodeLoc
));

1533 
	gpos
 = 0;

1534 
_·ckR—dyFÜMod
(
l
, 
pos
);

1535 
_·ckR—dyFÜMod
(
r
, 
pos
);

1538 
	gŞdLNum
 = 
l
->
n
;

1540 
FuÎKey
 
	gknLeá
 = 
g‘FuÎKey
(
buck‘
, 
ËáIndex
);

1541 
pushBack
(
l
, 
knLeá
.
»cÜdLoc
, knLeá.
d©a
,†->
ÃxtChd
);

1543 
	gi
 = 0; i < 
	gr
->
	gn
; ++i) {

1544 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
r
, 
i
);

1545 
pushBack
(
l
, 
kn
.
»cÜdLoc
, kn.
d©a
, kn.
´evChdBuck‘
);

1548 
	gl
->
	gÃxtChd
 = 
r
->
ÃxtChd
;

1549 
fixP¬’tPŒs
(
txn
, 
l
, 
ËáNodeLoc
, 
ŞdLNum
);

1550 
d–Buck‘
(
txn
, 
r
, 
rightNodeLoc
);

1552 
chdLocFÜPos
(
buck‘
, 
ËáIndex
 + 1èğ
ËáNodeLoc
;

1553 
chdLocFÜPos
(
buck‘
, 
ËáIndex
èğ
DiskLoc
();

1554 
_d–KeyAtPos
(
buck‘
, 
ËáIndex
, 
Œue
);

1556 ià(
	gbuck‘
->
	gn
 == 0) {

1561 
»¶aûW™hNextChd
(
txn
, 
buck‘
, 
buck‘Loc
);

1564 
mayB®ªûW™hNeighbÜs
(
txn
, 
buck‘
, 
buck‘Loc
);

1568 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1569 
	gBŒ“Logic
<
	gBŒ“Layout
>::
šdexInP¬’t
(
Buck‘Ty³
* 
buck‘
,

1570 cÚ¡ 
DiskLoc
 
buck‘Loc
) const {

1571 
šv¬ŸÁ
(!
buck‘
->
·»Á
.
isNuÎ
());

1572 cÚ¡ 
Buck‘Ty³
* 
	gp
 = 
g‘Buck‘
(
buck‘
->
·»Á
);

1573 ià(
	gp
->
	gÃxtChd
 =ğ
buck‘Loc
) {

1574  
p
->
n
;

1577 
	gi
 = 0; i < 
	gp
->
	gn
; ++i) {

1578 ià(
g‘KeyH—d”
(
p
, 
i
).
	g´evChdBuck‘
 =ğ
buck‘Loc
) {

1579  
i
;

1583 
log
() << "ERROR: can't find„efo child bucket.\n";

1584 
log
(è<< "chd: " << 
	gbuck‘Loc
 << "\n";

1586 
log
(è<< "P¬’t: " << 
	gbuck‘
->
	g·»Á
 << "\n";

1588 
šv¬ŸÁ
(
çl£
);

1592 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1593 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
ŒyB®ªûChd»n
(
O³¿tiÚCÚ‹xt
* 
txn
,

1594 
Buck‘Ty³
* 
buck‘
,

1595 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1596 
ËáIndex
) {

1600 ià(
ÿnM”geChd»n
(
buck‘
, 
buck‘Loc
, 
ËáIndex
)) {

1601  
	gçl£
;

1604 
doB®ªûChd»n
(
txn
, 
bŒ“mod
Ñxn, 
buck‘
), 
buck‘Loc
, 
ËáIndex
);

1605  
	gŒue
;

1608 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1609 
	gBŒ“Logic
<
	gBŒ“Layout
>::
doB®ªûLeáToRight
(
O³¿tiÚCÚ‹xt
* 
txn
,

1610 
Buck‘Ty³
* 
buck‘
,

1611 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1612 
ËáIndex
,

1613 
¥l™
,

1614 
Buck‘Ty³
* 
l
,

1615 cÚ¡ 
DiskLoc
 
lchd
,

1616 
Buck‘Ty³
* 
r
,

1617 cÚ¡ 
DiskLoc
 
rchd
) {

1623 
	grAdd
 = 
l
->
n
 - 
¥l™
;

1624 
»£rveKeysFrÚt
(
r
, 
rAdd
);

1626 
	gi
 = 
¥l™
 + 1, 
	gj
 = 0; i < 
	gl
->
	gn
; ++i, ++j) {

1627 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
l
, 
i
);

1628 
£tKey
(
r
, 
j
, 
kn
.
»cÜdLoc
, kn.
d©a
, kn.
´evChdBuck‘
);

1631 
FuÎKey
 
	gËáIndexKN
 = 
g‘FuÎKey
(
buck‘
, 
ËáIndex
);

1632 
£tKey
(
r
, 
rAdd
 - 1, 
ËáIndexKN
.
»cÜdLoc
,†eáIndexKN.
d©a
, 
l
->
ÃxtChd
);

1634 
fixP¬’tPŒs
(
txn
, 
r
, 
rchd
, 0, 
rAdd
 - 1);

1636 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
l
, 
¥l™
);

1637 
	gl
->
	gÃxtChd
 = 
kn
.
´evChdBuck‘
;

1641 
£tIÁ”ÇlKey
(
txn
, 
buck‘
, 
buck‘Loc
, 
ËáIndex
, 
kn
.
»cÜdLoc
, kn.
d©a
, 
lchd
, 
rchd
);

1645 
	gz”İos
 = 0;

1646 
Œunÿ‹To
(
l
, 
¥l™
, 
z”İos
);

1649 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1650 
	gBŒ“Logic
<
	gBŒ“Layout
>::
doB®ªûRightToLeá
(
O³¿tiÚCÚ‹xt
* 
txn
,

1651 
Buck‘Ty³
* 
buck‘
,

1652 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1653 
ËáIndex
,

1654 
¥l™
,

1655 
Buck‘Ty³
* 
l
,

1656 cÚ¡ 
DiskLoc
 
lchd
,

1657 
Buck‘Ty³
* 
r
,

1658 cÚ¡ 
DiskLoc
 
rchd
) {

1663 
	glN
 = 
l
->
n
;

1667 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
buck‘
, 
ËáIndex
);

1668 
pushBack
(
l
, 
kn
.
»cÜdLoc
, kn.
d©a
,†->
ÃxtChd
);

1671 
	gi
 = 0; i < 
	g¥l™
 - 
	glN
 - 1; ++i) {

1672 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
r
, 
i
);

1673 
pushBack
(
l
, 
kn
.
»cÜdLoc
, kn.
d©a
, kn.
´evChdBuck‘
);

1677 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
r
, 
¥l™
 - 
lN
 - 1);

1678 
	gl
->
	gÃxtChd
 = 
kn
.
´evChdBuck‘
;

1680 
fixP¬’tPŒs
(
txn
, 
l
, 
lchd
, 
lN
 + 1,†->
n
);

1684 
£tIÁ”ÇlKey
(
txn
, 
buck‘
, 
buck‘Loc
, 
ËáIndex
, 
kn
.
»cÜdLoc
, kn.
d©a
, 
lchd
, 
rchd
);

1689 
	gz”İos
 = 0;

1690 
drİFrÚt
(
r
, 
¥l™
 - 
lN
, 
z”İos
);

1693 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1694 
	gBŒ“Logic
<
	gBŒ“Layout
>::
doB®ªûChd»n
(
O³¿tiÚCÚ‹xt
* 
txn
,

1695 
Buck‘Ty³
* 
buck‘
,

1696 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1697 
ËáIndex
) {

1699 
DiskLoc
 
	glchd
 = 
chdLocFÜPos
(
buck‘
, 
ËáIndex
);

1700 
DiskLoc
 
	grchd
 = 
chdLocFÜPos
(
buck‘
, 
ËáIndex
 + 1);

1702 
	gz”İos
 = 0;

1703 
Buck‘Ty³
* 
	gl
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
lchd
));

1704 
_·ckR—dyFÜMod
(
l
, 
z”İos
);

1706 
Buck‘Ty³
* 
	gr
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
rchd
));

1707 
_·ckR—dyFÜMod
(
r
, 
z”İos
);

1709 
	g¥l™
 = 
_»b®ªûdS•¬©ÜPos
(
buck‘
, 
ËáIndex
);

1713 
šv¬ŸÁ
(
¥l™
 !ğ
l
->
n
);

1714 ià(
	g¥l™
 < 
	gl
->
	gn
) {

1715 
doB®ªûLeáToRight
(
txn
, 
buck‘
, 
buck‘Loc
, 
ËáIndex
, 
¥l™
, 
l
, 
lchd
, 
r
, 
rchd
);

1718 
doB®ªûRightToLeá
(
txn
, 
buck‘
, 
buck‘Loc
, 
ËáIndex
, 
¥l™
, 
l
, 
lchd
, 
r
, 
rchd
);

1722 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1723 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
mayB®ªûW™hNeighbÜs
(
O³¿tiÚCÚ‹xt
* 
txn
,

1724 
Buck‘Ty³
* 
buck‘
,

1725 cÚ¡ 
DiskLoc
 
buck‘Loc
) {

1726 ià(
	gbuck‘
->
	g·»Á
.
isNuÎ
()) {

1727  
	gçl£
;

1730 ià(
_·ckedD©aSize
(
buck‘
, 0è>ğ
lowW©”M¬k
()) {

1731  
çl£
;

1734 
Buck‘Ty³
* 
	gp
 = 
g‘Buck‘
(
buck‘
->
·»Á
);

1735 
	g·»ÁIdx
 = 
šdexInP¬’t
(
buck‘
, 
buck‘Loc
);

1739 
boŞ
 
	gmayB®ªûRight
 = (
·»ÁIdx
 < 
p
->
n
è&& !
chdLocFÜPos
Õ,…¬’tIdx + 1).
isNuÎ
();

1740 
boŞ
 
	gmayB®ªûLeá
 = ( 
·»ÁIdx
 > 0 ) && !
chdLocFÜPos
(
p
,…¬’tIdx - 1).
isNuÎ
();

1745 ià(
	gmayB®ªûRight
 && 
ŒyB®ªûChd»n
(
txn
, 
p
, 
buck‘
->
·»Á
, 
·»ÁIdx
)) {

1746  
	gŒue
;

1749 ià(
	gmayB®ªûLeá
 && 
ŒyB®ªûChd»n
(
txn
, 
p
, 
buck‘
->
·»Á
, 
·»ÁIdx
 - 1)) {

1750  
	gŒue
;

1753 
Buck‘Ty³
* 
	gpm
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
buck‘
->
·»Á
));

1754 ià(
	gmayB®ªûRight
) {

1755 
doM”geChd»n
(
txn
, 
pm
, 
buck‘
->
·»Á
, 
·»ÁIdx
);

1756  
	gŒue
;

1758 ià(
	gmayB®ªûLeá
) {

1759 
doM”geChd»n
(
txn
, 
pm
, 
buck‘
->
·»Á
, 
·»ÁIdx
 - 1);

1760  
	gŒue
;

1763  
	gçl£
;

1766 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1767 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
unšdex
(
O³¿tiÚCÚ‹xt
* 
txn
,

1768 cÚ¡ 
BSONObj
& 
key
,

1769 cÚ¡ 
DiskLoc
& 
»cÜdLoc
) {

1770 
	gpos
;

1771 
boŞ
 
	gfound
 = 
çl£
;

1772 
KeyD©aOwÃdTy³
 
owÃdKey
(
key
);

1773 
DiskLoc
 
	gloc
 = 
_loÿ‹
(
g‘RoÙLoc
(), 
owÃdKey
, &
pos
, &
found
, 
»cÜdLoc
, 1);

1774 ià(
	gfound
) {

1775 
Buck‘Ty³
* 
	gbuck‘
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
loc
));

1776 
d–KeyAtPos
(
txn
, 
buck‘
, 
loc
, 
pos
);

1777 
as£¹V®id
(
_šdexName
, 
g‘RoÙ
(), 
_Üd”šg
);

1779  
	gfound
;

1782 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1783 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
isEm±y
() const {

1784  
g‘RoÙ
()->
n
 == 0;

1791 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1792 
	gBŒ“Logic
<
	gBŒ“Layout
>::
fixP¬’tPŒs
(
O³¿tiÚCÚ‹xt
* 
txn
,

1793 
Buck‘Ty³
* 
buck‘
,

1794 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1795 
fœ¡Index
,

1796 
Ï¡Index
) {

1798 
šv¬ŸÁ
(
g‘Buck‘
(
buck‘Loc
è=ğ
buck‘
);

1800 ià(
	gÏ¡Index
 == -1) {

1801 
Ï¡Index
 = 
buck‘
->
n
;

1804 
	gi
 = 
fœ¡Index
; i <ğ
Ï¡Index
; i++) {

1805 cÚ¡ 
DiskLoc
 
	gchdLoc
 = 
chdLocFÜPos
(
buck‘
, 
i
);

1806 ià(!
	gchdLoc
.
isNuÎ
()) {

1807 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
g‘Buck‘
(
chdLoc
)->
·»Á
èğ
buck‘Loc
;

1812 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1813 
	gBŒ“Logic
<
	gBŒ“Layout
>::
£tIÁ”ÇlKey
(
O³¿tiÚCÚ‹xt
* 
txn
,

1814 
Buck‘Ty³
* 
buck‘
,

1815 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1816 
keypos
,

1817 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

1818 cÚ¡ 
KeyD©aTy³
& 
key
,

1819 cÚ¡ 
DiskLoc
 
lchd
,

1820 cÚ¡ 
DiskLoc
 
rchd
) {

1821 
chdLocFÜPos
(
buck‘
, 
keypos
).
NuÎ
();

1825 
_d–KeyAtPos
(
buck‘
, 
keypos
, 
Œue
);

1828 
šv¬ŸÁ
(
chdLocFÜPos
(
buck‘
, 
keypos
 ) =ğ
rchd
);

1831 
chdLocFÜPos
(
buck‘
, 
keypos
èğ
lchd
;

1833 
š£¹H”e
(
txn
, 
buck‘Loc
, 
keypos
, 
key
, 
»cÜdLoc
, 
lchd
, 
rchd
);

1846 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1847 
	gBŒ“Logic
<
	gBŒ“Layout
>::
š£¹H”e
(
O³¿tiÚCÚ‹xt
* 
txn
,

1848 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1849 
pos
,

1850 cÚ¡ 
KeyD©aTy³
& 
key
,

1851 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

1852 cÚ¡ 
DiskLoc
 
ËáChdLoc
,

1853 cÚ¡ 
DiskLoc
 
rightChdLoc
) {

1855 
Buck‘Ty³
* 
	gbuck‘
 = 
g‘Buck‘
(
buck‘Loc
);

1857 ià(!
basicIn£¹
(
txn
, 
buck‘
, 
buck‘Loc
, 
pos
, 
key
, 
»cÜdLoc
)) {

1859 
¥l™
(
txn
, 
bŒ“mod
Ñxn, 
buck‘
), 
buck‘Loc
, 
pos
, 
»cÜdLoc
, 
key
, 
ËáChdLoc
, 
rightChdLoc
);

1863 
KeyH—d”Ty³
* 
	gkn
 = &
g‘KeyH—d”
(
buck‘
, 
pos
);

1864 ià(
	gpos
 + 1 =ğ
buck‘
->
n
) {

1866 ià(
buck‘
->
ÃxtChd
 !ğ
ËáChdLoc
) {

1868 
šv¬ŸÁ
(
çl£
);

1870 
	gkn
->
	g´evChdBuck‘
 = 
buck‘
->
ÃxtChd
;

1871 
šv¬ŸÁ
(
kn
->
´evChdBuck‘
 =ğ
ËáChdLoc
);

1872 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
buck‘
->
ÃxtChd
èğ
rightChdLoc
;

1873 ià(!
	grightChdLoc
.
isNuÎ
()) {

1874 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
g‘Buck‘
(
rightChdLoc
)->
·»Á
èğ
buck‘Loc
;

1878 
	gkn
->
	g´evChdBuck‘
 = 
ËáChdLoc
;

1879 ià(
g‘KeyH—d”
(
buck‘
, 
pos
 + 1).
	g´evChdBuck‘
 !ğ
ËáChdLoc
) {

1881 
šv¬ŸÁ
(
çl£
);

1883 cÚ¡ 
LocTy³
 *
	gpc
 = &
g‘KeyH—d”
(
buck‘
, 
pos
 + 1).
	g´evChdBuck‘
;

1885 *
	gcÚ¡_ÿ¡
<
	gLocTy³
*>(
	gpc
èğ
rightChdLoc
;

1886 ià(!
	grightChdLoc
.
isNuÎ
()) {

1887 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
g‘Buck‘
(
rightChdLoc
)->
·»Á
èğ
buck‘Loc
;

1892 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1893 
	gBŒ“Logic
<
	gBŒ“Layout
>::
¥l™
(
O³¿tiÚCÚ‹xt
* 
txn
,

1894 
Buck‘Ty³
* 
buck‘
,

1895 cÚ¡ 
DiskLoc
 
buck‘Loc
,

1896 
keypos
,

1897 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

1898 cÚ¡ 
KeyD©aTy³
& 
key
,

1899 cÚ¡ 
DiskLoc
 
lchd
,

1900 cÚ¡ 
DiskLoc
 
rchd
) {

1902 
	g¥l™
 = 
¥l™Pos
(
buck‘
, 
keypos
);

1903 
DiskLoc
 
	grLoc
 = 
_addBuck‘
(
txn
);

1904 
Buck‘Ty³
* 
	gr
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
rLoc
));

1906 
	gi
 = 
¥l™
 + 1; i < 
	gbuck‘
->
	gn
; i++) {

1907 
FuÎKey
 
	gkn
 = 
g‘FuÎKey
(
buck‘
, 
i
);

1908 
pushBack
(
r
, 
kn
.
»cÜdLoc
, kn.
d©a
, kn.
´evChdBuck‘
);

1910 
	gr
->
	gÃxtChd
 = 
buck‘
->
ÃxtChd
;

1911 
as£¹V®id
(
_šdexName
, 
r
, 
_Üd”šg
);

1913 
	gr
 = 
NULL
;

1914 
fixP¬’tPŒs
(
txn
, 
g‘Buck‘
(
rLoc
),„Loc);

1916 
FuÎKey
 
	g¥l™key
 = 
g‘FuÎKey
(
buck‘
, 
¥l™
);

1918 
	gbuck‘
->
	gÃxtChd
 = 
¥l™key
.
´evChdBuck‘
;

1923 ià(
	gbuck‘
->
	g·»Á
.
isNuÎ
()) {

1925 
DiskLoc
 
	gL
 = 
_addBuck‘
(
txn
);

1926 
Buck‘Ty³
* 
	gp
 = 
bŒ“mod
(
txn
, 
g‘Buck‘
(
L
));

1927 
pushBack
(
p
, 
¥l™key
.
»cÜdLoc
, s¶™key.
d©a
, 
buck‘Loc
);

1928 
	gp
->
	gÃxtChd
 = 
rLoc
;

1929 
as£¹V®id
(
_šdexName
, 
p
, 
_Üd”šg
);

1930 
	gbuck‘
->
	g·»Á
 = 
L
;

1931 
	g_h—dMªag”
->
£tH—d
(
txn
, 
L
);

1932 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
g‘Buck‘
(
rLoc
)->
·»Á
èğ
buck‘
->parent;

1937 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
g‘Buck‘
(
rLoc
)->
·»Á
èğ
buck‘
->parent;

1938 
_š£¹
(
txn
,

1939 
g‘Buck‘
(
buck‘
->
·»Á
),

1940 
buck‘
->
·»Á
,

1941 
¥l™key
.
d©a
,

1942 
¥l™key
.
»cÜdLoc
,

1943 
Œue
,

1944 
buck‘Loc
,

1945 
rLoc
);

1948 
	gÃwpos
 = 
keypos
;

1950 
Œunÿ‹To
(
buck‘
, 
¥l™
, 
Ãwpos
);

1953 ià(
	gkeypos
 <ğ
¥l™
) {

1954 
š£¹H”e
(
txn
, 
buck‘Loc
, 
Ãwpos
, 
key
, 
»cÜdLoc
, 
lchd
, 
rchd
);

1957 
	gkp
 = 
keypos
 - 
¥l™
 - 1;

1958 
šv¬ŸÁ
(
kp
 >= 0);

1959 
š£¹H”e
(
txn
, 
rLoc
, 
kp
, 
key
, 
»cÜdLoc
, 
lchd
, 
rchd
);

1963 şas 
	cDummyDocWr™”
 : 
public
 
DocWr™”
 {

1964 
public
:

1965 
DummyDocWr™”
(
size_t
 
sz
è: 
_sz
(sz) { }

1966 
vœtu®
 
wr™eDocum’t
(* 
buf
) const { }

1967 
vœtu®
 
size_t
 
docum’tSize
(ècÚ¡ {  
_sz
; }

1968 
	g´iv©e
:

1969 
size_t
 
_sz
;

1972 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1973 
Stus
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$š™AsEm±y
(
O³¿tiÚCÚ‹xt
* 
txn
) {

1974 ià(!
_h—dMªag”
->
	`g‘H—d
().
	`isNuÎ
()) {

1975  
	`Stus
(
E¼ÜCodes
::
IÁ”ÇlE¼Ü
, "index‡lready initialized");

1978 
_h—dMªag”
->
	`£tH—d
(
txn
, 
	`_addBuck‘
(txn));

1979  
Stus
::
	`OK
();

1980 
	}
}

1982 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1983 
DiskLoc
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$_addBuck‘
(
O³¿tiÚCÚ‹xt
* 
txn
) {

1984 
DummyDocWr™”
 
	`docWr™”
(
BŒ“Layout
::
Buck‘Size
);

1985 
StusW™h
<
DiskLoc
> 
loc
 = 
_»cÜdStÜe
->
	`š£¹RecÜd
(
txn
, &
docWr™”
, 0);

1987 
	`uas£¹StusOK
(
loc
.
	`g‘Stus
());

1988 
Buck‘Ty³
* 
b
 = 
	`bŒ“mod
(
txn
, 
	`g‘Buck‘
(
loc
.
	`g‘V®ue
()));

1989 
	`š™
(
b
);

1990  
loc
.
	`g‘V®ue
();

1991 
	}
}

1994 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

1995 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$dumpBuck‘
(cÚ¡ 
Buck‘Ty³
* 
buck‘
, 
šd’tL’gth
) {

1996 
	`log
(è<< "BUCKET‚:" << 
buck‘
->
n
 << ",…¬’t:" << 
hex
 << buck‘->
·»Á
.
	`g‘Ofs
(è<< 
dec
;

1998 cÚ¡ 
¡ršg
 
šd’t
 = 
	`¡ršg
(
šd’tL’gth
, ' ');

2000 
i
 = 0; i < 
buck‘
->
n
; i++) {

2001 
	`log
(è<< '\n' << 
šd’t
;

2002 
FuÎKey
 
k
 = 
	`g‘FuÎKey
(
buck‘
, 
i
);

2003 
¡ršg
 
ks
 = 
k
.
d©a
.
	`toSŒšg
();

2004 
	`log
(è<< " " << 
hex
 << 
k
.
´evChdBuck‘
.
	`g‘Ofs
(è<< "<--…»vChdBuck‘ fÜ " << 
i
 << '\n';

2005 
	`log
(è<< 
šd’t
 << " " << 
i
 << ' ' << 
ks
.
	`sub¡r
(0, 30)

2006 << " Loc:" << 
k
.
»cÜdLoc
.
	`toSŒšg
(è<< 
dec
;

2007 ià(
	`g‘KeyH—d”
(
buck‘
, 
i
).
	`isUnu£d
()) {

2008 
	`log
() << " UNUSED";

2012 
	`log
(è<< "\n" << 
šd’t
 << " " << 
hex
 << 
buck‘
->
ÃxtChd
.
	`g‘Ofs
(è<< 
dec
 << 
’dl
;

2013 
	}
}

2015 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2016 
DiskLoc
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$g‘DiskLoc
(cÚ¡ 
DiskLoc
& 
buck‘Loc
, cÚ¡ 
keyOff£t
) const {

2017 
	`šv¬ŸÁ
(!
buck‘Loc
.
	`isNuÎ
());

2018 
Buck‘Ty³
* 
buck‘
 = 
	`g‘Buck‘
(
buck‘Loc
);

2019  
	`g‘KeyH—d”
(
buck‘
, 
keyOff£t
).
»cÜdLoc
;

2020 
	}
}

2022 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2023 
BSONObj
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$g‘Key
(cÚ¡ 
DiskLoc
& 
buck‘Loc
, cÚ¡ 
keyOff£t
) const {

2024 
	`šv¬ŸÁ
(!
buck‘Loc
.
	`isNuÎ
());

2025 
Buck‘Ty³
* 
buck‘
 = 
	`g‘Buck‘
(
buck‘Loc
);

2026 
n
 = 
buck‘
->n;

2027 
	`šv¬ŸÁ
(
n
 !ğ
BŒ“Layout
::
INVALID_N_SENTINEL
);

2028 
	`šv¬ŸÁ
(
n
 >= 0);

2029 
	`šv¬ŸÁ
(
n
 < 10000);

2030 
	`šv¬ŸÁ
(
n
 != 0xffff);

2032 
	`šv¬ŸÁ
(
keyOff£t
 >= 0);

2033 
	`šv¬ŸÁ
(
keyOff£t
 < 
n
);

2036 ià(
keyOff£t
 >ğ
n
) {

2037  
	`BSONObj
();

2040  
	`g‘FuÎKey
(
buck‘
, 
keyOff£t
).
d©a
.
	`toBsÚ
();

2042 
	}
}

2044 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2045 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$fuÎV®id©e
(*
unu£dCouÁ
,

2046 
boŞ
 
¡riù
,

2047 
boŞ
 
dumpBuck‘s
,

2048 
d•th
) {

2049  
	`_fuÎV®id©e
(
	`g‘RoÙLoc
(), 
unu£dCouÁ
, 
¡riù
, 
dumpBuck‘s
, 
d•th
);

2050 
	}
}

2052 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2053 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$_fuÎV®id©e
(cÚ¡ 
DiskLoc
 
buck‘Loc
,

2054 *
unu£dCouÁ
,

2055 
boŞ
 
¡riù
,

2056 
boŞ
 
dumpBuck‘s
,

2057 
d•th
) {

2058 
Buck‘Ty³
* 
buck‘
 = 
	`g‘Buck‘
(
buck‘Loc
);

2059 
	`as£¹V®id
(
_šdexName
, 
buck‘
, 
_Üd”šg
, 
Œue
);

2061 ià(
dumpBuck‘s
) {

2062 
	`log
(è<< 
buck‘Loc
.
	`toSŒšg
() << ' ';

2063 
	`dumpBuck‘
(
buck‘
, 
d•th
);

2066 
keyCouÁ
 = 0;

2068 
i
 = 0; i < 
buck‘
->
n
; i++) {

2069 
KeyH—d”Ty³
& 
kn
 = 
	`g‘KeyH—d”
(
buck‘
, 
i
);

2071 ià(
kn
.
	`isU£d
()) {

2072 
keyCouÁ
++;

2074 ià(
NULL
 !ğ
unu£dCouÁ
) {

2075 ++(*
unu£dCouÁ
);

2078 ià(!
kn
.
´evChdBuck‘
.
	`isNuÎ
()) {

2079 
DiskLoc
 
Ëá
 = 
kn
.
´evChdBuck‘
;

2080 
Buck‘Ty³
* 
b
 = 
	`g‘Buck‘
(
Ëá
);

2082 ià(
¡riù
) {

2083 
	`šv¬ŸÁ
(
b
->
·»Á
 =ğ
buck‘Loc
);

2086 
	`was£¹
(
b
->
·»Á
 =ğ
buck‘Loc
);

2089 
keyCouÁ
 +ğ
	`_fuÎV®id©e
(
Ëá
, 
unu£dCouÁ
, 
¡riù
, 
dumpBuck‘s
, 
d•th
 + 1);

2093 ià(!
buck‘
->
ÃxtChd
.
	`isNuÎ
()) {

2094 
Buck‘Ty³
* 
b
 = 
	`g‘Buck‘
(
buck‘
->
ÃxtChd
);

2095 ià(
¡riù
) {

2096 
	`šv¬ŸÁ
(
b
->
·»Á
 =ğ
buck‘Loc
);

2099 
	`was£¹
(
b
->
·»Á
 =ğ
buck‘Loc
);

2102 
keyCouÁ
 +ğ
	`_fuÎV®id©e
(
buck‘
->
ÃxtChd
, 
unu£dCouÁ
, 
¡riù
, 
dumpBuck‘s
, 
d•th
 + 1);

2105  
keyCouÁ
;

2106 
	}
}

2109 
	gnDum³d
 = 0;

2112 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2113 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$as£¹V®id
(cÚ¡ 
¡d
::
¡ršg
& 
ns
,

2114 
Buck‘Ty³
* 
buck‘
,

2115 cÚ¡ 
Ord”šg
& 
Üd”šg
,

2116 
boŞ
 
fÜû
) {

2117 ià(!
fÜû
) {

2123 
_k
;

2124 ià(++
_k
 % 128) {

2129 
DEV
 {

2131 
i
 = 0; i < 
buck‘
->
n
 - 1; i++) {

2132 
FuÎKey
 
fœ¡Key
 = 
	`g‘FuÎKey
(
buck‘
, 
i
);

2133 
FuÎKey
 
£cÚdKey
 = 
	`g‘FuÎKey
(
buck‘
, 
i
 + 1);

2134 
z
 = 
fœ¡Key
.
d©a
.
	`woCom·»
(
£cÚdKey
.d©a, 
Üd”šg
);

2135 ià(
z
 > 0) {

2136 
	`log
(è<< "ERROR: bŒ“ key ord” cÜru±. Keys:" << 
’dl
;

2137 ià(++
nDum³d
 < 5) {

2138 
j
 = 0; j < 
buck‘
->
n
; j++) {

2139 
	`log
(è<< " " << 
	`g‘FuÎKey
(
buck‘
, 
j
).
d©a
.
	`toSŒšg
(è<< 
’dl
;

2141 
	`dumpBuck‘
(
buck‘
);

2143 
	`was£¹
(
çl£
);

2146 ià(
z
 == 0) {

2147 ià(!(
fœ¡Key
.
h—d”
.
»cÜdLoc
 < 
£cÚdKey
.header.recordLoc)) {

2148 
	`log
(è<< "ERROR: bŒ“ key ord” cÜru± (»cÜdloc wrÚg):" << 
’dl
;

2149 
	`log
(è<< " k(" << 
i
 << ")" << 
fœ¡Key
.
d©a
.
	`toSŒšg
()

2150 << " RL:" << 
fœ¡Key
.
h—d”
.
»cÜdLoc
.
	`toSŒšg
(è<< 
’dl
;

2151 
	`log
(è<< " k(" << 
i
 + 1 << ")" << 
£cÚdKey
.
d©a
.
	`toSŒšg
()

2152 << " RL:" << 
£cÚdKey
.
h—d”
.
»cÜdLoc
.
	`toSŒšg
(è<< 
’dl
;

2153 
	`was£¹
(
fœ¡Key
.
h—d”
.
»cÜdLoc
 < 
£cÚdKey
.header.recordLoc);

2160 ià(
buck‘
->
n
 > 1) {

2161 
FuÎKey
 
k1
 = 
	`g‘FuÎKey
(
buck‘
, 0);

2162 
FuÎKey
 
k2
 = 
	`g‘FuÎKey
(
buck‘
, buck‘->
n
 - 1);

2163 
z
 = 
k1
.
d©a
.
	`woCom·»
(
k2
.d©a, 
Üd”šg
);

2165 ià(
z
 > 0) {

2166 
	`log
(è<< "BŒ“ key ouˆoàÜd” iÀcŞËùiÚ " << 
ns
;

2167 
ONCE
 {

2168 
	`dumpBuck‘
(
buck‘
);

2170 
	`šv¬ŸÁ
(
çl£
);

2174 
	}
}

2176 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2177 
Stus
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$š£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

2178 cÚ¡ 
BSONObj
& 
¿wKey
,

2179 cÚ¡ 
DiskLoc
& 
v®ue
,

2180 
boŞ
 
dupsAÎowed
) {

2181 
KeyD©aOwÃdTy³
 
	`key
(
¿wKey
);

2183 ià(
key
.
	`d©aSize
(è> 
BŒ“Layout
::
KeyMax
) {

2184 
¡ršg
 
msg
 = 
¡r
::
	`¡»am
() << "Btree::insert: keyoo†argeo index, failing "

2185 << 
_šdexName
 << ' '

2186 << 
key
.
	`d©aSize
(è<< ' ' << key.
	`toSŒšg
();

2187  
	`Stus
(
E¼ÜCodes
::
KeyTooLÚg
, 
msg
);

2190 
Stus
 
¡©us
 = 
	`_š£¹
(
txn
,

2191 
	`g‘RoÙ
(),

2192 
	`g‘RoÙLoc
(),

2193 
key
,

2194 
v®ue
,

2195 
dupsAÎowed
,

2196 
	`DiskLoc
(),

2197 
	`DiskLoc
());

2199 
	`as£¹V®id
(
_šdexName
, 
	`g‘RoÙ
(), 
_Üd”šg
);

2200  
¡©us
;

2201 
	}
}

2203 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2204 
Stus
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$_š£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

2205 
Buck‘Ty³
* 
buck‘
,

2206 cÚ¡ 
DiskLoc
 
buck‘Loc
,

2207 cÚ¡ 
KeyD©aTy³
& 
key
,

2208 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

2209 
boŞ
 
dupsAÎowed
,

2210 cÚ¡ 
DiskLoc
 
ËáChd
,

2211 cÚ¡ 
DiskLoc
 
rightChd
) {

2212 
	`šv¬ŸÁ
Ğ
key
.
	`d©aSize
() > 0 );

2214 
pos
;

2215 
boŞ
 
found
;

2216 
Stus
 
fšdStus
 = 
	`_fšd
(
buck‘
, 
key
, 
»cÜdLoc
, !
dupsAÎowed
, &
pos
, &
found
);

2217 ià(!
fšdStus
.
	`isOK
()) {

2218  
fšdStus
;

2221 ià(
found
) {

2222 
KeyH—d”Ty³
& 
h—d”
 = 
	`g‘KeyH—d”
(
buck‘
, 
pos
);

2223 ià(
h—d”
.
	`isUnu£d
()) {

2224 
	`LOG
(4è<< "bŒ“ _š£¹:„eusšg unu£d key" << 
’dl
;

2225 
	`mas£¹
(17433, "_š£¹:„eu£ key buˆlchd i nÙ‚uÎ", 
ËáChd
.
	`isNuÎ
());

2226 
	`mas£¹
(17434, "_š£¹:„eu£ key buˆrchd i nÙ‚uÎ", 
rightChd
.
	`isNuÎ
());

2227 
txn
->
	`»cov”yUn™
()->
	`wr™šg
(&
h—d”
)->
	`£tU£d
();

2228  
Stus
::
	`OK
();

2230  
	`Stus
(
E¼ÜCodes
::
UniqueIndexViŞ©iÚ
, "FIXME");

2233 
DiskLoc
 
chdLoc
 = 
	`chdLocFÜPos
(
buck‘
, 
pos
);

2238 ià(
chdLoc
.
	`isNuÎ
(è|| !
rightChd
.isNull()) {

2239 
	`š£¹H”e
(
txn
, 
buck‘Loc
, 
pos
, 
key
, 
»cÜdLoc
, 
ËáChd
, 
rightChd
);

2240  
Stus
::
	`OK
();

2243  
	`_š£¹
(
txn
,

2244 
	`g‘Buck‘
(
chdLoc
),

2245 
chdLoc
,

2246 
key
,

2247 
»cÜdLoc
,

2248 
dupsAÎowed
,

2249 
	`DiskLoc
(),

2250 
	`DiskLoc
());

2252 
	}
}

2254 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2255 
DiskLoc
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$advªû
(cÚ¡ 
DiskLoc
& 
buck‘Loc
,

2256 * 
posInOut
,

2257 
dœeùiÚ
) const {

2258 
Buck‘Ty³
* 
buck‘
 = 
	`g‘Buck‘
(
buck‘Loc
);

2260 ià(*
posInOut
 < 0 || *posInOuˆ>ğ
buck‘
->
n
 ) {

2261 
	`log
(è<< "ASSERT fau»‡dvªcšg bŒ“ buck‘" << 
’dl
;

2262 
	`log
(è<< "hisLoc: " << 
buck‘Loc
.
	`toSŒšg
(è<< 
’dl
;

2263 
	`log
(è<< " keyOfs: " << *
posInOut
 << "‚:" << 
buck‘
->
n
 << " dœeùiÚ: " << 
dœeùiÚ
 << 
’dl
;

2265 
	`šv¬ŸÁ
(
çl£
);

2269 
adj
 = 
dœeùiÚ
 < 0 ? 1 : 0;

2270 
ko
 = *
posInOut
 + 
dœeùiÚ
;

2273 
DiskLoc
 
ÃxtDownLoc
 = 
	`chdLocFÜPos
(
buck‘
, 
ko
 + 
adj
);

2274 
Buck‘Ty³
* 
ÃxtDown
 = 
	`g‘Buck‘
(
ÃxtDownLoc
);

2275 ià(
NULL
 !ğ
ÃxtDown
) {

2277 ià(
dœeùiÚ
 > 0) {

2278 *
posInOut
 = 0;

2281 *
posInOut
 = 
ÃxtDown
->
n
 - 1;

2283 
DiskLoc
 
ÃwNextDownLoc
 = 
	`chdLocFÜPos
(
ÃxtDown
, *
posInOut
 + 
adj
);

2284 
Buck‘Ty³
* 
ÃwNextDownBuck‘
 = 
	`g‘Buck‘
(
ÃwNextDownLoc
);

2285 ià(
NULL
 =ğ
ÃwNextDownBuck‘
) {

2288 
ÃxtDownLoc
 = 
ÃwNextDownLoc
;

2289 
ÃxtDown
 = 
ÃwNextDownBuck‘
;

2291  
ÃxtDownLoc
;

2295 ià(
ko
 < 
buck‘
->
n
 && ko >= 0) {

2296 *
posInOut
 = 
ko
;

2297  
buck‘Loc
;

2301 
DiskLoc
 
chdLoc
 = 
buck‘Loc
;

2302 
DiskLoc
 
ªû¡Ü
 = 
	`g‘Buck‘
(
buck‘Loc
)->
·»Á
;

2304 ià(
ªû¡Ü
.
	`isNuÎ
()) {

2307 
Buck‘Ty³
* 
ª
 = 
	`g‘Buck‘
(
ªû¡Ü
);

2308 
i
 = 0; i < 
ª
->
n
; i++) {

2309 ià(
	`chdLocFÜPos
(
ª
, 
i
 + 
adj
è=ğ
chdLoc
) {

2310 *
posInOut
 = 
i
;

2311  
ªû¡Ü
;

2314 
	`šv¬ŸÁ
(
dœeùiÚ
 < 0 || 
ª
->
ÃxtChd
 =ğ
chdLoc
);

2316 
chdLoc
 = 
ªû¡Ü
;

2317 
ªû¡Ü
 = 
ª
->
·»Á
;

2320  
	`DiskLoc
();

2321 
	}
}

2323 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2324 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$keyIsU£d
(cÚ¡ 
DiskLoc
& 
loc
, cÚ¡ & 
pos
) const {

2325  
	`g‘KeyH—d”
(
	`g‘Buck‘
(
loc
), 
pos
).
	`isU£d
();

2326 
	}
}

2328 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2329 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$loÿ‹
(cÚ¡ 
BSONObj
& 
key
,

2330 cÚ¡ 
DiskLoc
& 
»cÜdLoc
,

2331 cÚ¡ 
dœeùiÚ
,

2332 * 
posOut
,

2333 
DiskLoc
* 
buck‘LocOut
) const {

2335 *
posOut
 = 0;

2336 *
buck‘LocOut
 = 
	`DiskLoc
();

2338 
boŞ
 
found
 = 
çl£
;

2339 
KeyD©aOwÃdTy³
 
	`owÃd
(
key
);

2341 *
buck‘LocOut
 = 
	`_loÿ‹
(
	`g‘RoÙLoc
(), 
owÃd
, 
posOut
, &
found
, 
»cÜdLoc
, 
dœeùiÚ
);

2343 ià(!
found
) {

2344  
çl£
;

2347 
	`skUnu£dKeys
(
buck‘LocOut
, 
posOut
, 
dœeùiÚ
);

2349  
found
;

2350 
	}
}

2352 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2353 
DiskLoc
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$_loÿ‹
(cÚ¡ 
DiskLoc
& 
buck‘Loc
,

2354 cÚ¡ 
KeyD©aTy³
& 
key
,

2355 * 
posOut
,

2356 
boŞ
* 
foundOut
,

2357 cÚ¡ 
DiskLoc
& 
»cÜdLoc
,

2358 cÚ¡ 
dœeùiÚ
) const {

2359 
pos™iÚ
;

2360 
Buck‘Ty³
* 
buck‘
 = 
	`g‘Buck‘
(
buck‘Loc
);

2362 
	`_fšd
(
buck‘
, 
key
, 
»cÜdLoc
, 
çl£
, &
pos™iÚ
, 
foundOut
);

2365 ià(*
foundOut
) {

2366 *
posOut
 = 
pos™iÚ
;

2367  
buck‘Loc
;

2371 
DiskLoc
 
chdLoc
 = 
	`chdLocFÜPos
(
buck‘
, 
pos™iÚ
);

2373 ià(!
chdLoc
.
	`isNuÎ
()) {

2374 
DiskLoc
 
šChd
 = 
	`_loÿ‹
(
chdLoc
, 
key
, 
posOut
, 
foundOut
, 
»cÜdLoc
, 
dœeùiÚ
);

2375 ià(!
šChd
.
	`isNuÎ
()) {

2376  
šChd
;

2380 *
posOut
 = 
pos™iÚ
;

2382 ià(
dœeùiÚ
 < 0) {

2384 (*
posOut
)--;

2385 ià(-1 =ğ*
posOut
) {

2387  
	`DiskLoc
();

2390  
buck‘Loc
;

2395 ià(
buck‘
->
n
 =ğ*
posOut
) {

2396  
	`DiskLoc
();

2400  
buck‘Loc
;

2403 
	}
}

2406 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2407 
boŞ
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$isH—d
(
Buck‘Ty³
* 
buck‘
) {

2408  
buck‘
->
·»Á
.
	`isNuÎ
();

2409 
	}
}

2411 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2412 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Buck‘Ty³
*

2413 
BŒ“Logic
<
BŒ“Layout
>::
	$g‘Buck‘
(cÚ¡ 
DiskLoc
 
dl
) const {

2414 ià(
dl
.
	`isNuÎ
()) {

2415  
NULL
;

2418 
RecÜd
* 
»cÜd
 = 
_»cÜdStÜe
->
	`»cÜdFÜ
(
dl
);

2419  
»š‹½»t_ÿ¡
<
Buck‘Ty³
*>(
»cÜd
->
	`d©aNoThrowšg
());

2420 
	}
}

2422 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2423 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Buck‘Ty³
*

2424 
BŒ“Logic
<
BŒ“Layout
>::
	$g‘RoÙ
() const {

2425  
	`g‘Buck‘
(
_h—dMªag”
->
	`g‘H—d
());

2426 
	}
}

2428 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2429 
DiskLoc


2430 
	gBŒ“Logic
<
	gBŒ“Layout
>::
	$g‘RoÙLoc
() const {

2431  
_h—dMªag”
->
	`g‘H—d
();

2432 
	}
}

2434 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2435 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
Buck‘Ty³
*

2436 
BŒ“Logic
<
BŒ“Layout
>::
	$chdFÜPos
(
Buck‘Ty³
* 
buck‘
, 
pos
) const {

2437  
	`g‘Buck‘
(
	`chdLocFÜPos
(
buck‘
, 
pos
));

2438 
	}
}

2440 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

2441 
ty³Çme
 
	gBŒ“Logic
<
	gBŒ“Layout
>::
LocTy³
&

2442 
BŒ“Logic
<
BŒ“Layout
>::
	$chdLocFÜPos
(
Buck‘Ty³
* 
buck‘
, 
pos
) {

2443 ià(
buck‘
->
n
 =ğ
pos
) {

2444  
buck‘
->
ÃxtChd
;

2447  
	`g‘KeyH—d”
(
buck‘
, 
pos
).
´evChdBuck‘
;

2449 
	}
}

2456 
‹m¶©e
 
	gFixedWidthKey
<
	gDiskLoc
>;

2457 
‹m¶©e
 
şass
 
	gBŒ“Logic
<
	gBŒ“LayoutV0
>;

2460 
‹m¶©e
 
	gFixedWidthKey
<
	gDiskLoc56B™
>;

2461 
‹m¶©e
 
şass
 
	gBŒ“Logic
<
	gBŒ“LayoutV1
>;

	@btree/btree_logic.h

29 #´agm¨
Úû


31 
	~"mÚgo/db/ÿlog/šdex_ÿlog_’Œy.h
"

32 
	~"mÚgo/db/diskloc.h
"

33 
	~"mÚgo/db/jsobj.h
"

34 
	~"mÚgo/db/¡Üage/»cÜd.h
"

35 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

36 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_Údisk.h
"

37 
	~"mÚgo/db/¡ruùu»/bŒ“/key.h
"

38 
	~"mÚgo/db/¡ruùu»/bŒ“/buck‘_d–‘iÚ_nÙifiÿtiÚ.h
"

39 
	~"mÚgo/db/¡ruùu»/h—d_mªag”.h
"

42 
Çme¥aû
 
	gmÚgo
 {

44 
şass
 
	gBuck‘D–‘iÚNÙifiÿtiÚ
;

45 
şass
 
	gRecÜdStÜe
;

48 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
> cÏs 
	gBŒ“LogicTe¡Ba£
;

49 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
> cÏs 
	gA¹ificŸlT»eBud”
;

55 
	g‹m¶©e
 <
şass
 
	gBŒ“Layout
>

56 şas 
	cBŒ“Logic
 {

57 
	gpublic
:

59 
ty³Çme
 
	tBŒ“Layout
::
	tFixedWidthKeyTy³
 
	tKeyH—d”Ty³
;

62 
ty³Çme
 
	tBŒ“Layout
::
	tKeyTy³
 
	tKeyD©aTy³
;

65 
ty³Çme
 
	tBŒ“Layout
::
	tKeyOwÃdTy³
 
	tKeyD©aOwÃdTy³
;

68 
ty³Çme
 
	tBŒ“Layout
::
	tLocTy³
 LocType;

71 
ty³Çme
 
	tBŒ“Layout
::
	tBuck‘Ty³
 BucketType;

79 
BŒ“Logic
(
H—dMªag”
* 
h—d
,

80 
RecÜdStÜe
* 
¡Üe
,

81 cÚ¡ 
Ord”šg
& 
Üd”šg
,

82 cÚ¡ 
¡ršg
& 
šdexName
,

83 
Buck‘D–‘iÚNÙifiÿtiÚ
* 
buck‘D–‘iÚ
)

84 : 
_h—dMªag”
(
h—d
),

85 
_»cÜdStÜe
(
¡Üe
),

86 
_Üd”šg
(
Üd”šg
),

87 
_šdexName
(
šdexName
),

88 
_buck‘D–‘iÚ
(
buck‘D–‘iÚ
) {

96 şas 
	cBud”
 {

97 
	gpublic
:

98 
ty³Çme
 
	tBŒ“Layout
::
	tKeyOwÃdTy³
 
	tKeyD©aOwÃdTy³
;

99 
ty³Çme
 
	tBŒ“Layout
::
	tKeyTy³
 
	tKeyD©aTy³
;

101 
Stus
 
addKey
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
);

104 
comm™
(
boŞ
 
mayIÁ”ru±
);

106 
	g´iv©e
:

107 
ä›nd
 
şass
 
BŒ“Logic
;

109 
Bud”
(
BŒ“Logic
* 
logic
, 
O³¿tiÚCÚ‹xt
* 
txn
, 
boŞ
 
dupsAÎowed
);

112 
ÃwBuck‘
();

113 
budNextLev–
(
DiskLoc
 
loc
, 
boŞ
 
mayIÁ”ru±
);

114 
mayComm™Prog»ssDu¿bly
();

115 
Buck‘Ty³
* 
_g‘ModifŸbËBuck‘
(
DiskLoc
 
loc
);

116 
Buck‘Ty³
* 
_g‘Buck‘
(
DiskLoc
 
loc
);

120 
BŒ“Logic
* 
	g_logic
;

123 
DiskLoc
 
	g_cur
;

124 
DiskLoc
 
	g_fœ¡
;

125 
Buck‘Ty³
* 
	g_b
;

126 
boŞ
 
	g_comm™‹d
;

127 
boŞ
 
	g_dupsAÎowed
;

128 
	g_numAdded
;

129 
	gauto_±r
<
	gKeyD©aOwÃdTy³
> 
	g_keyLa¡
;

132 
O³¿tiÚCÚ‹xt
* 
	g_txn
;

139 
Bud”
* 
ÃwBud”
(
O³¿tiÚCÚ‹xt
* 
txn
, 
boŞ
 
dupsAÎowed
);

141 
Stus
 
dupKeyCheck
(cÚ¡ 
BSONObj
& 
key
, cÚ¡ 
DiskLoc
& 
loc
) const;

143 
Stus
 
š£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

144 cÚ¡ 
BSONObj
& 
¿wKey
,

145 cÚ¡ 
DiskLoc
& 
v®ue
,

146 
boŞ
 
dupsAÎowed
);

156 
boŞ
 
loÿ‹
(cÚ¡ 
BSONObj
& 
key
,

157 cÚ¡ 
DiskLoc
& 
»cÜdLoc
,

158 cÚ¡ 
dœeùiÚ
,

159 * 
posOut
,

160 
DiskLoc
* 
buck‘LocOut
) const;

162 
advªû
(
DiskLoc
* 
buck‘LocInOut
, * 
posInOut
, 
dœeùiÚ
) const;

164 
boŞ
 
exi¡s
(cÚ¡ 
KeyD©aTy³
& 
key
) const;

166 
boŞ
 
unšdex
(
O³¿tiÚCÚ‹xt
* 
txn
,

167 cÚ¡ 
BSONObj
& 
key
,

168 cÚ¡ 
DiskLoc
& 
»cÜdLoc
);

170 
boŞ
 
isEm±y
() const;

172 
fuÎV®id©e
(*
unu£dCouÁ
,

173 
boŞ
 
¡riù
,

174 
boŞ
 
dumpBuck‘s
,

175 
d•th
);

177 
DiskLoc
 
g‘DiskLoc
(cÚ¡ DiskLoc& 
buck‘Loc
, cÚ¡ 
keyOff£t
) const;

179 
BSONObj
 
g‘Key
(cÚ¡ 
DiskLoc
& 
buck‘Loc
, cÚ¡ 
keyOff£t
) const;

185 
cu¡omLoÿ‹
(
DiskLoc
* 
locInOut
,

186 * 
keyOfsInOut
,

187 cÚ¡ 
BSONObj
& 
keyBegš
,

188 
keyBegšL’
,

189 
boŞ
 
aá”Key
,

190 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

191 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

192 
dœeùiÚ
) const;

194 
advªûTo
(
DiskLoc
* 
thisLocInOut
,

195 * 
keyOfsInOut
,

196 cÚ¡ 
BSONObj
 &
keyBegš
,

197 
keyBegšL’
,

198 
boŞ
 
aá”Key
,

199 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

200 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

201 
dœeùiÚ
) const;

203 
»¡ÜePos™iÚ
(cÚ¡ 
BSONObj
& 
§vedKey
,

204 cÚ¡ 
DiskLoc
& 
§vedLoc
,

205 
dœeùiÚ
,

206 
DiskLoc
* 
buck‘InOut
,

207 * 
keyOff£tInOut
) const;

209 
DiskLoc
 
g‘H—d
(ècÚ¡ {  
	g_h—dMªag”
->getHead(); }

218 
Stus
 
š™AsEm±y
(
O³¿tiÚCÚ‹xt
* 
txn
);

224 
lowW©”M¬k
();

226 
	g´iv©e
:

227 
ä›nd
 
şass
 
BŒ“Logic
::
Bud”
;

230 
ä›nd
 
şass
 
	gBŒ“LogicTe¡Ba£
<
	gBŒ“Layout
>;

231 
ä›nd
 
şass
 
	gA¹ificŸlT»eBud”
<
	gBŒ“Layout
>;

241 
	sFuÎKey
 {

242 
FuÎKey
(cÚ¡ 
Buck‘Ty³
* 
buck‘
, 
i
)

243 : 
h—d”
(
g‘KeyH—d”
(
buck‘
, 
i
)),

244 
´evChdBuck‘
(
h—d”
.prevChildBucket),

245 
»cÜdLoc
(
h—d”
.recordLoc),

246 
d©a
(
buck‘
->d©¨+ 
h—d”
.
keyD©aOfs
()) { }

249 cÚ¡ 
	gKeyH—d”Ty³
& 
	gh—d”
;

252 cÚ¡ 
	gLocTy³
& 
	g´evChdBuck‘
;

253 cÚ¡ 
	gLocTy³
& 
	g»cÜdLoc
;

256 
KeyD©aTy³
 
	gd©a
;

263 
	gLocTy³
& 
chdLocFÜPos
(
Buck‘Ty³
* 
buck‘
, 
pos
);

265 
FuÎKey
 
g‘FuÎKey
(cÚ¡ 
Buck‘Ty³
* 
buck‘
, 
i
);

267 
	gKeyH—d”Ty³
& 
g‘KeyH—d”
(
Buck‘Ty³
* 
buck‘
, 
i
);

269 cÚ¡ 
	gKeyH—d”Ty³
& 
g‘KeyH—d”
(cÚ¡ 
Buck‘Ty³
* 
buck‘
, 
i
);

271 * 
d©aAt
(
Buck‘Ty³
* 
buck‘
, 
ofs
);

273 
m¬kUnu£d
(
Buck‘Ty³
* 
buck‘
, 
keypos
);

275 
tÙ®D©aSize
(
Buck‘Ty³
* 
buck‘
);

277 
š™
(
Buck‘Ty³
* 
buck‘
);

279 
_®loc
(
Buck‘Ty³
* 
buck‘
, 
by‹s
);

281 
_uÇÎoc
(
Buck‘Ty³
* 
buck‘
, 
by‹s
);

283 
_d–KeyAtPos
(
Buck‘Ty³
* 
buck‘
, 
keypos
, 
boŞ
 
mayEm±y
 = 
çl£
);

285 
pİBack
(
Buck‘Ty³
* 
buck‘
, 
DiskLoc
* 
»cÜdLocOut
, 
KeyD©aTy³
 *
keyD©aOut
);

287 
boŞ
 
mayDrİKey
(
Buck‘Ty³
* 
buck‘
, 
šdex
, 
»fPos
);

289 
_·ckedD©aSize
(
Buck‘Ty³
* 
buck‘
, 
»fPos
);

291 
£tPacked
(
Buck‘Ty³
* 
buck‘
);

293 
£tNÙPacked
(
Buck‘Ty³
* 
buck‘
);

295 
Buck‘Ty³
* 
bŒ“mod
(
O³¿tiÚCÚ‹xt
* 
txn
, Buck‘Ty³* 
buck‘
);

297 
¥l™Pos
(
Buck‘Ty³
* 
buck‘
, 
keypos
);

299 
»£rveKeysFrÚt
(
Buck‘Ty³
* 
buck‘
, 
nAdd
);

301 
£tKey
(
Buck‘Ty³
* 
buck‘
,

302 
i
,

303 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

304 cÚ¡ 
KeyD©aTy³
 &
key
,

305 cÚ¡ 
DiskLoc
 
´evChdBuck‘
);

307 
boŞ
 
isH—d
(
Buck‘Ty³
* 
buck‘
);

309 
dumpBuck‘
(cÚ¡ 
Buck‘Ty³
* 
buck‘
, 
šd’tL’gth
 = 0);

311 
as£¹V®id
(cÚ¡ 
¡d
::
¡ršg
& 
ns
,

312 
Buck‘Ty³
* 
buck‘
,

313 cÚ¡ 
Ord”šg
& 
Üd”šg
,

314 
boŞ
 
fÜû
 = 
çl£
);

321 
boŞ
 
basicIn£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

322 
Buck‘Ty³
* 
buck‘
,

323 cÚ¡ 
DiskLoc
 
buck‘Loc
,

324 & 
keypos
,

325 cÚ¡ 
KeyD©aTy³
& 
key
,

326 cÚ¡ 
DiskLoc
 
»cÜdLoc
);

328 
drİFrÚt
(
Buck‘Ty³
* 
buck‘
, 
nDrİ
, & 
»åos
);

330 
_·ck
(
O³¿tiÚCÚ‹xt
* 
txn
, 
Buck‘Ty³
* 
buck‘
, cÚ¡ 
DiskLoc
 
thisLoc
, &
»fPos
);

332 
cu¡omLoÿ‹
(
DiskLoc
* 
locInOut
,

333 * 
keyOfsInOut
,

334 cÚ¡ 
BSONObj
& 
keyBegš
,

335 
keyBegšL’
,

336 
boŞ
 
aá”Key
,

337 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

338 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

339 
dœeùiÚ
,

340 
·œ
<
DiskLoc
, >& 
be¡P¬’t
) const;

342 
Stus
 
_fšd
(
Buck‘Ty³
* 
buck‘
,

343 cÚ¡ 
KeyD©aTy³
& 
key
,

344 cÚ¡ 
DiskLoc
& 
»cÜdLoc
,

345 
boŞ
 
”rÜIfDup
,

346 * 
keyPos™iÚOut
,

347 
boŞ
* 
foundOut
) const;

349 
boŞ
 
cu¡omFšd
(
low
,

350 
high
,

351 cÚ¡ 
BSONObj
& 
keyBegš
,

352 
keyBegšL’
,

353 
boŞ
 
aá”Key
,

354 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

355 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

356 cÚ¡ 
Ord”šg
& 
Üd”
,

357 
dœeùiÚ
,

358 
DiskLoc
* 
thisLocInOut
,

359 * 
keyOfsInOut
,

360 
·œ
<
DiskLoc
, >& 
be¡P¬’t
) const;

362 
advªûToIm¶
(
DiskLoc
* 
thisLocInOut
,

363 * 
keyOfsInOut
,

364 cÚ¡ 
BSONObj
 &
keyBegš
,

365 
keyBegšL’
,

366 
boŞ
 
aá”Key
,

367 cÚ¡ 
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
keyEnd
,

368 cÚ¡ 
veùÜ
<
boŞ
>& 
keyEndInşusive
,

369 
dœeùiÚ
) const;

371 
boŞ
 
wouldC»©eDup
(cÚ¡ 
KeyD©aTy³
& 
key
, cÚ¡ 
DiskLoc
 
£lf
) const;

373 
boŞ
 
keyIsU£d
(cÚ¡ 
DiskLoc
& 
loc
, cÚ¡ & 
pos
) const;

375 
skUnu£dKeys
(
DiskLoc
* 
loc
, * 
pos
, 
dœeùiÚ
) const;

377 
DiskLoc
 
advªû
(cÚ¡ DiskLoc& 
buck‘Loc
, * 
posInOut
, 
dœeùiÚ
) const;

379 
DiskLoc
 
_loÿ‹
(cÚ¡ DiskLoc& 
buck‘Loc
,

380 cÚ¡ 
KeyD©aTy³
& 
key
,

381 * 
posOut
,

382 
boŞ
* 
foundOut
,

383 cÚ¡ 
DiskLoc
& 
»cÜdLoc
,

384 cÚ¡ 
dœeùiÚ
) const;

386 
_fuÎV®id©e
(cÚ¡ 
DiskLoc
 
buck‘Loc
,

387 *
unu£dCouÁ
,

388 
boŞ
 
¡riù
,

389 
boŞ
 
dumpBuck‘s
,

390 
d•th
);

392 
DiskLoc
 
_addBuck‘
(
O³¿tiÚCÚ‹xt
* 
txn
);

394 
boŞ
 
ÿnM”geChd»n
(
Buck‘Ty³
* 
buck‘
,

395 cÚ¡ 
DiskLoc
 
buck‘Loc
,

396 cÚ¡ 
ËáIndex
);

399 
_»b®ªûdS•¬©ÜPos
(
Buck‘Ty³
* 
buck‘
, 
ËáIndex
);

401 
_·ckR—dyFÜMod
(
Buck‘Ty³
* 
buck‘
, &
»fPos
);

403 
Œunÿ‹To
(
Buck‘Ty³
* 
buck‘
, 
N
, &
»fPos
);

405 
¥l™
(
O³¿tiÚCÚ‹xt
* 
txn
,

406 
Buck‘Ty³
* 
buck‘
,

407 cÚ¡ 
DiskLoc
 
buck‘Loc
,

408 
keypos
,

409 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

410 cÚ¡ 
KeyD©aTy³
& 
key
,

411 cÚ¡ 
DiskLoc
 
lchd
,

412 cÚ¡ 
DiskLoc
 
rchd
);

414 
Stus
 
_š£¹
(
O³¿tiÚCÚ‹xt
* 
txn
,

415 
Buck‘Ty³
* 
buck‘
,

416 cÚ¡ 
DiskLoc
 
buck‘Loc
,

417 cÚ¡ 
KeyD©aTy³
& 
key
,

418 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

419 
boŞ
 
dupsAÎowed
,

420 cÚ¡ 
DiskLoc
 
ËáChd
,

421 cÚ¡ 
DiskLoc
 
rightChd
);

424 
š£¹H”e
(
O³¿tiÚCÚ‹xt
* 
txn
,

425 cÚ¡ 
DiskLoc
 
buck‘Loc
,

426 
pos
,

427 cÚ¡ 
KeyD©aTy³
& 
key
,

428 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

429 cÚ¡ 
DiskLoc
 
ËáChd
,

430 cÚ¡ 
DiskLoc
 
rightChd
);

432 
	g¡d
::
¡ršg
 
dupKeyE¼Ü
(cÚ¡ 
KeyD©aTy³
& 
key
) const;

434 
£tIÁ”ÇlKey
(
O³¿tiÚCÚ‹xt
* 
txn
,

435 
Buck‘Ty³
* 
buck‘
,

436 cÚ¡ 
DiskLoc
 
buck‘Loc
,

437 
keypos
,

438 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

439 cÚ¡ 
KeyD©aTy³
& 
key
,

440 cÚ¡ 
DiskLoc
 
lchd
,

441 cÚ¡ 
DiskLoc
 
rchd
);

443 
fixP¬’tPŒs
(
O³¿tiÚCÚ‹xt
* 
Œªs
,

444 
Buck‘Ty³
* 
buck‘
,

445 cÚ¡ 
DiskLoc
 
buck‘Loc
,

446 
fœ¡Index
 = 0,

447 
Ï¡Index
 = -1);

449 
boŞ
 
mayB®ªûW™hNeighbÜs
(
O³¿tiÚCÚ‹xt
* 
txn
, 
Buck‘Ty³
* 
buck‘
, cÚ¡ 
DiskLoc
 
buck‘Loc
);

451 
doB®ªûChd»n
(
O³¿tiÚCÚ‹xt
* 
txn
,

452 
Buck‘Ty³
* 
buck‘
,

453 cÚ¡ 
DiskLoc
 
buck‘Loc
,

454 
ËáIndex
);

456 
doB®ªûLeáToRight
(
O³¿tiÚCÚ‹xt
* 
txn
,

457 
Buck‘Ty³
* 
buck‘
,

458 cÚ¡ 
DiskLoc
 
thisLoc
,

459 
ËáIndex
,

460 
¥l™
,

461 
Buck‘Ty³
* 
l
,

462 cÚ¡ 
DiskLoc
 
lchd
,

463 
Buck‘Ty³
* 
r
,

464 cÚ¡ 
DiskLoc
 
rchd
);

466 
doB®ªûRightToLeá
(
O³¿tiÚCÚ‹xt
* 
txn
,

467 
Buck‘Ty³
* 
buck‘
,

468 cÚ¡ 
DiskLoc
 
buck‘Loc
,

469 
ËáIndex
,

470 
¥l™
,

471 
Buck‘Ty³
* 
l
,

472 cÚ¡ 
DiskLoc
 
lchd
,

473 
Buck‘Ty³
* 
r
,

474 cÚ¡ 
DiskLoc
 
rchd
);

476 
boŞ
 
ŒyB®ªûChd»n
(
O³¿tiÚCÚ‹xt
* 
txn
,

477 
Buck‘Ty³
* 
buck‘
,

478 cÚ¡ 
DiskLoc
 
buck‘Loc
,

479 
ËáIndex
);

481 
šdexInP¬’t
(
Buck‘Ty³
* 
buck‘
, cÚ¡ 
DiskLoc
 
buck‘Loc
) const;

483 
doM”geChd»n
(
O³¿tiÚCÚ‹xt
* 
txn
,

484 
Buck‘Ty³
* 
buck‘
,

485 cÚ¡ 
DiskLoc
 
buck‘Loc
,

486 
ËáIndex
);

488 
»¶aûW™hNextChd
(
O³¿tiÚCÚ‹xt
* 
txn
,

489 
Buck‘Ty³
* 
buck‘
,

490 cÚ¡ 
DiskLoc
 
buck‘Loc
);

492 
d–‘eIÁ”ÇlKey
(
O³¿tiÚCÚ‹xt
* 
txn
,

493 
Buck‘Ty³
* 
buck‘
,

494 cÚ¡ 
DiskLoc
 
buck‘Loc
,

495 
keypos
);

497 
d–KeyAtPos
(
O³¿tiÚCÚ‹xt
* 
txn
,

498 
Buck‘Ty³
* 
buck‘
,

499 cÚ¡ 
DiskLoc
 
buck‘Loc
,

500 
p
);

502 
d–Buck‘
(
O³¿tiÚCÚ‹xt
* 
txn
,

503 
Buck‘Ty³
* 
buck‘
,

504 cÚ¡ 
DiskLoc
 
buck‘Loc
);

506 
d—ÎocBuck‘
(
O³¿tiÚCÚ‹xt
* 
txn
,

507 
Buck‘Ty³
* 
buck‘
,

508 cÚ¡ 
DiskLoc
 
buck‘Loc
);

510 
boŞ
 
_keyIsAt
(cÚ¡ 
BSONObj
& 
§vedKey
,

511 cÚ¡ 
DiskLoc
& 
§vedLoc
,

512 
Buck‘Ty³
* 
buck‘
,

513 
keyPos
) const;

516 
cu¡omBSONCmp
(cÚ¡ 
BSONObj
& 
l
,

517 cÚ¡ 
BSONObj
& 
rBegš
,

518 
rBegšL’
,

519 
boŞ
 
rSup
,

520 cÚ¡ 
¡d
::
veùÜ
<cÚ¡ 
BSONEËm’t
*>& 
rEnd
,

521 cÚ¡ 
¡d
::
veùÜ
<
boŞ
>& 
rEndInşusive
,

522 cÚ¡ 
Ord”šg
& 
o
,

523 
dœeùiÚ
) const;

526 
boŞ
 
_pushBack
(
Buck‘Ty³
* 
buck‘
,

527 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

528 cÚ¡ 
KeyD©aTy³
& 
key
,

529 cÚ¡ 
DiskLoc
 
´evChd
);

531 
pushBack
(
Buck‘Ty³
* 
buck‘
,

532 cÚ¡ 
DiskLoc
 
»cÜdLoc
,

533 cÚ¡ 
KeyD©aTy³
& 
key
,

534 cÚ¡ 
DiskLoc
 
´evChd
) {

535 
šv¬ŸÁ
(
_pushBack
(
buck‘
, 
»cÜdLoc
, 
key
, 
´evChd
));

538 
Buck‘Ty³
* 
chdFÜPos
(Buck‘Ty³* 
buck‘
, 
pos
) const;

540 
Buck‘Ty³
* 
g‘Buck‘
(cÚ¡ 
DiskLoc
 
dl
) const;

542 
Buck‘Ty³
* 
g‘RoÙ
() const;

544 
DiskLoc
 
g‘RoÙLoc
() const;

551 
H—dMªag”
* 
	g_h—dMªag”
;

554 
RecÜdStÜe
* 
	g_»cÜdStÜe
;

556 
Ord”šg
 
	g_Üd”šg
;

558 
¡ršg
 
	g_šdexName
;

561 
Buck‘D–‘iÚNÙifiÿtiÚ
* 
	g_buck‘D–‘iÚ
;

	@btree/btree_logic_test.cpp

35 
	~"mÚgo/db/š¡ªû.h
"

36 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt_noİ.h
"

37 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_‹¡_h–p.h
"

38 
	~"mÚgo/un™‹¡/un™‹¡.h
"

41 
Çme¥aû
 
	gmÚgo
 {

47 
	g‹m¶©e
<
şass
 
	gBŒ“LayoutTy³
>

48 şas 
	cBŒ“LogicTe¡Ba£
 {

49 
	gpublic
:

50 
ty³Çme
 
	tBŒ“LayoutTy³
::
	tBuck‘Ty³
 BucketType;

51 
ty³Çme
 
	tBŒ“LayoutTy³
::
	tFixedWidthKeyTy³
 FixedWidthKeyType;

53 
ty³Çme
 
	tBŒ“Logic
<
	tBŒ“LayoutTy³
>::
	tFuÎKey
 FullKey;

54 
ty³Çme
 
	tBŒ“Logic
<
	tBŒ“LayoutTy³
>::
	tKeyD©aOwÃdTy³
 KeyDataOwnedType;

56 
BŒ“LogicTe¡Ba£
(è: 
_h–³r
(
BSON
("TheKey" << 1)) {

60 
vœtu®
 ~
BŒ“LogicTe¡Ba£
() {

64 
´Ùeùed
:

65 
checkV®idNumKeys
(
nKeys
) {

66 
ASSERT_EQUALS
(
nKeys
, 
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

69 
š£¹
(cÚ¡ 
BSONObj
 &
key
, cÚ¡ 
DiskLoc
 
dl
) {

70 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

71 
	g_h–³r
.
	gbŒ“
.
š£¹
(&
txn
, 
key
, 
dl
, 
Œue
);

74 
boŞ
 
unšdex
(cÚ¡ 
BSONObj
 &
key
) {

75 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

76  
	g_h–³r
.
	gbŒ“
.
unšdex
(&
txn
, 
key
, 
_h–³r
.
dummyDiskLoc
);

79 
loÿ‹
(cÚ¡ 
BSONObj
 &
key
,

80 
ex³ùedPos
,

81 
boŞ
 
ex³ùedFound
,

82 cÚ¡ 
DiskLoc
 &
ex³ùedLoÿtiÚ
,

83 
dœeùiÚ
) {

84 
	gpos
;

85 
DiskLoc
 
	gloc
;

86 
ASSERT_EQUALS
(
ex³ùedFound
,

87 
_h–³r
.
bŒ“
.
loÿ‹
(
key
, _h–³r.
dummyDiskLoc
, 
dœeùiÚ
, &
pos
, &
loc
));

88 
ASSERT_EQUALS
(
ex³ùedLoÿtiÚ
, 
loc
);

89 
ASSERT_EQUALS
(
ex³ùedPos
, 
pos
);

92 cÚ¡ 
Buck‘Ty³
* 
chd
(cÚ¡ Buck‘Ty³* 
buck‘
, 
i
) const {

93 
v”ify
(
i
 <ğ
buck‘
->
n
);

95 
DiskLoc
 
	gdiskLoc
;

96 ià(
	gi
 =ğ
buck‘
->
n
) {

97 
diskLoc
 = 
buck‘
->
ÃxtChd
;

100 
FuÎKey
 
	gfuÎKey
 = 
BŒ“Logic
<
BŒ“LayoutTy³
>::
g‘FuÎKey
(
buck‘
, 
i
);

101 
	gdiskLoc
 = 
fuÎKey
.
´evChdBuck‘
;

104 
v”ify
(!
diskLoc
.
isNuÎ
());

106  
	g_h–³r
.
	gbŒ“
.
g‘Buck‘
(
diskLoc
);

109 
Buck‘Ty³
* 
h—d
() const {

110  
	g_h–³r
.
	gbŒ“
.
g‘Buck‘
(
_h–³r
.
h—dMªag”
.
g‘H—d
());

113 
fÜûPackBuck‘
(cÚ¡ 
DiskLoc
 
buck‘Loc
) {

114 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
.
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

116 
	gbuck‘
->
	gtİSize
 +ğ
buck‘
->
em±ySize
;

117 
	gbuck‘
->
	gem±ySize
 = 0;

118 
	gBŒ“Logic
<
	gBŒ“LayoutTy³
>::
£tNÙPacked
(
buck‘
);

121 
Œunÿ‹Buck‘
(
Buck‘Ty³
* 
buck‘
, 
N
, &
»fPos
) {

122 
	g_h–³r
.
	gbŒ“
.
Œunÿ‹To
(
buck‘
, 
N
, 
»fPos
);

125 
buck‘PackedD©aSize
(
Buck‘Ty³
* 
buck‘
, 
»fPos
) {

126  
	g_h–³r
.
	gbŒ“
.
_·ckedD©aSize
(
buck‘
, 
»fPos
);

129 
buck‘Reb®ªûdS•¬©ÜPos
(cÚ¡ 
DiskLoc
 
buck‘Loc
, 
ËáIndex
) {

130 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
.
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

132  
	g_h–³r
.
	gbŒ“
.
_»b®ªûdS•¬©ÜPos
(
buck‘
, 
ËáIndex
);

135 
FuÎKey
 
g‘Key
(cÚ¡ 
DiskLoc
 
buck‘Loc
, 
pos
) const {

136 cÚ¡ 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
.
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

137  
	gBŒ“Logic
<
	gBŒ“LayoutTy³
>::
g‘FuÎKey
(
buck‘
, 
pos
);

140 
m¬kKeyUnu£d
(cÚ¡ 
DiskLoc
 
buck‘Loc
, 
keyPos
) {

141 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
.
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

142 
šv¬ŸÁ
(
keyPos
 >ğ0 && keyPo < 
buck‘
->
n
);

144 
	g_h–³r
.
	gbŒ“
.
g‘KeyH—d”
(
buck‘
, 
keyPos
).
£tUnu£d
();

147 
DiskLoc
 
ÃwBuck‘
() {

148 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

149  
	g_h–³r
.
	gbŒ“
.
_addBuck‘
(&
txn
);

155 
£tBuck‘NextChd
(cÚ¡ 
DiskLoc
 
buck‘Loc
, cÚ¡ DiskLoø
ÃxtChd
) {

156 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

158 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
.
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

159 
	gbuck‘
->
	gÃxtChd
 = 
ÃxtChd
;

161 
	g_h–³r
.
	gbŒ“
.
fixP¬’tPŒs
(&
txn
, 
buck‘
, 
buck‘Loc
);

164 
	g´Ùeùed
:

165 
BŒ“LogicTe¡H–³r
<
BŒ“LayoutTy³
> 
_h–³r
;

172 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

173 
şass
 
	gSim¶eC»©e
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

174 
public
:

175 
run
() {

176 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

177 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

179 
	gthis
->
checkV®idNumKeys
(0);

183 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

184 
şass
 
	gSim¶eIn£¹D–‘e
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

185 
public
:

186 
run
() {

187 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

188 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

190 
BSONObj
 
	gkey
 = 
sim¶eKey
('z');

191 
	gthis
->
š£¹
(
key
, 
this
->
_h–³r
.
dummyDiskLoc
);

193 
	gthis
->
checkV®idNumKeys
(1);

194 
	gthis
->
loÿ‹
(
key
, 0, 
Œue
, 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 1);

196 
	gthis
->
unšdex
(
key
);

198 
	gthis
->
checkV®idNumKeys
(0);

199 
	gthis
->
loÿ‹
(
key
, 0, 
çl£
, 
DiskLoc
(), 1);

203 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

204 
şass
 
	gS¶™UÃv’Buck‘Ba£
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

205 
public
:

206 
run
() {

207 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

208 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

210 
	gi
 = 0; i < 10; ++i) {

211 
BSONObj
 
	gshÜtKey
 = 
sim¶eKey
(
shÜtTok’
(
i
), 1);

212 
	gthis
->
š£¹
(
shÜtKey
, 
this
->
_h–³r
.
dummyDiskLoc
);

214 
BSONObj
 
	glÚgKey
 = 
sim¶eKey
(
lÚgTok’
(
i
), 800);

215 
	gthis
->
š£¹
(
lÚgKey
, 
this
->
_h–³r
.
dummyDiskLoc
);

218 
	gthis
->
checkV®idNumKeys
(20);

219 
ASSERT_EQUALS
(1, 
this
->
h—d
()->
n
);

220 
checkS¶™
();

223 
	g´Ùeùed
:

224 
vœtu®
 
shÜtTok’
(
i
) const = 0;

225 
vœtu®
 
lÚgTok’
(
i
) const = 0;

226 
vœtu®
 
checkS¶™
() = 0;

228 
ËáTok’
(
i
) {

229  'a' + 
	gi
;

232 
rightTok’
(
i
) {

233  'z' - 
	gi
;

237 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

238 
şass
 
	gS¶™RightH—vyBuck‘
 : 
public
 
S¶™UÃv’Buck‘Ba£
<
OnDiskFÜm©
> {

239 
´iv©e
:

240 
vœtu®
 
shÜtTok’
(
i
) const {

241  
this
->
ËáTok’
(
i
);

243 
vœtu®
 
lÚgTok’
(
i
) const {

244  
	gthis
->
rightTok’
(
i
);

246 
vœtu®
 
checkS¶™
() {

247 
ASSERT_EQUALS
(15, 
this
->
chd
Ñhis->
h—d
(), 0)->
n
);

248 
ASSERT_EQUALS
(4, 
this
->
chd
Ñhis->
h—d
(), 1)->
n
);

252 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

253 
şass
 
	gS¶™LeáH—vyBuck‘
 : 
public
 
S¶™UÃv’Buck‘Ba£
<
OnDiskFÜm©
> {

254 
´iv©e
:

255 
vœtu®
 
shÜtTok’
(
i
) const {

256  
this
->
rightTok’
(
i
);

258 
vœtu®
 
lÚgTok’
(
i
) const {

259  
	gthis
->
ËáTok’
(
i
);

261 
vœtu®
 
checkS¶™
() {

262 
ASSERT_EQUALS
(4, 
this
->
chd
Ñhis->
h—d
(), 0)->
n
);

263 
ASSERT_EQUALS
(15, 
this
->
chd
Ñhis->
h—d
(), 1)->
n
);

267 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

268 
şass
 
	gMissšgLoÿ‹
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

269 
public
:

270 
run
() {

271 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

272 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

274 
	gi
 = 0; i < 3; ++i) {

275 
BSONObj
 
	gk
 = 
sim¶eKey
('b' + 2 * 
i
);

276 
	gthis
->
š£¹
(
k
, 
this
->
_h–³r
.
dummyDiskLoc
);

279 
loÿ‹Ex‹nded
(1, 'a', 'b', 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

280 
loÿ‹Ex‹nded
(1, 'c', 'd', 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

281 
loÿ‹Ex‹nded
(1, 'e', 'f', 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

282 
loÿ‹Ex‹nded
(1, 'g', 'g' + 1, 
DiskLoc
());

290 
loÿ‹Ex‹nded
(-1, 'a', 'a' - 1, 
DiskLoc
());

291 
loÿ‹Ex‹nded
(-1, 'c', 'b', 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

292 
loÿ‹Ex‹nded
(-1, 'e', 'd', 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

293 
loÿ‹Ex‹nded
(-1, 'g', 'f', 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

296 
	g´iv©e
:

297 
loÿ‹Ex‹nded
(

298 
dœeùiÚ
, 
tok’
, 
ex³ùedM©ch
, 
DiskLoc
 
ex³ùedLoÿtiÚ
) {

299 cÚ¡ 
BSONObj
 
	gk
 = 
sim¶eKey
(
tok’
);

300 
	gex³ùedPos
 = (
ex³ùedM©ch
 - 'b') / 2;

302 
	gthis
->
loÿ‹
(
k
, 
ex³ùedPos
, 
çl£
, 
ex³ùedLoÿtiÚ
, 
dœeùiÚ
);

306 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

307 
şass
 
	gMissšgLoÿ‹MuÉiBuck‘
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

308 
public
:

309 
run
() {

310 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

311 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

313 
	gthis
->
š£¹
(
sim¶eKey
('A', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

314 
	gthis
->
š£¹
(
sim¶eKey
('B', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

315 
	gthis
->
š£¹
(
sim¶eKey
('C', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

316 
	gthis
->
š£¹
(
sim¶eKey
('D', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

317 
	gthis
->
š£¹
(
sim¶eKey
('E', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

318 
	gthis
->
š£¹
(
sim¶eKey
('F', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

319 
	gthis
->
š£¹
(
sim¶eKey
('G', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

320 
	gthis
->
š£¹
(
sim¶eKey
('H', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

321 
	gthis
->
š£¹
(
sim¶eKey
('J', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

324 
	gthis
->
š£¹
(
sim¶eKey
('I', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

326 
	gpos
;

327 
DiskLoc
 
	gloc
;

330 cÚ¡ 
BSONObj
 
	g¥l™Pošt
 = 
sim¶eKey
('E', 800);

331 
	gthis
->
	g_h–³r
.
	gbŒ“
.
loÿ‹
(
¥l™Pošt
, 
this
->
_h–³r
.
dummyDiskLoc
, 1, &
pos
, &
loc
);

332 
ASSERT_EQUALS
(
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 
loc
);

333 
ASSERT_EQUALS
(0, 
pos
);

336 
	gÏrgePos
;

337 
DiskLoc
 
	gÏrgeLoc
;

338 
	gthis
->
	g_h–³r
.
	gbŒ“
.
loÿ‹
(
¥l™Pošt
, 
this
->
_h–³r
.
dummyDiskLoc
, 1, &
ÏrgePos
, &
ÏrgeLoc
);

339 
	gthis
->
	g_h–³r
.
	gbŒ“
.
advªû
(&
ÏrgeLoc
, &
ÏrgePos
, -1);

342 
	gsm®lPos
;

343 
DiskLoc
 
	gsm®lLoc
;

344 
	gthis
->
	g_h–³r
.
	gbŒ“
.
loÿ‹
(
¥l™Pošt
, 
this
->
_h–³r
.
dummyDiskLoc
, 1, &
sm®lPos
, &
sm®lLoc
);

345 
	gthis
->
	g_h–³r
.
	gbŒ“
.
advªû
(&
sm®lLoc
, &
sm®lPos
, 1);

347 
ASSERT_NOT_EQUALS
(
sm®lLoc
, 
ÏrgeLoc
);

348 
ASSERT_NOT_EQUALS
(
sm®lLoc
, 
loc
);

349 
ASSERT_NOT_EQUALS
(
ÏrgeLoc
, 
loc
);

356 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

357 
şass
 
	gSERVER983
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

358 
public
:

359 
run
() {

360 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

361 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

363 
	gthis
->
š£¹
(
sim¶eKey
('A', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

364 
	gthis
->
š£¹
(
sim¶eKey
('B', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

365 
	gthis
->
š£¹
(
sim¶eKey
('C', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

366 
	gthis
->
š£¹
(
sim¶eKey
('D', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

367 
	gthis
->
š£¹
(
sim¶eKey
('E', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

368 
	gthis
->
š£¹
(
sim¶eKey
('F', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

369 
	gthis
->
š£¹
(
sim¶eKey
('G', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

370 
	gthis
->
š£¹
(
sim¶eKey
('H', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

371 
	gthis
->
š£¹
(
sim¶eKey
('I', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

374 
	gthis
->
š£¹
(
sim¶eKey
('J', 800), 
this
->
_h–³r
.
dummyDiskLoc
);

376 
	gpos
;

377 
DiskLoc
 
	gloc
;

380 cÚ¡ 
BSONObj
 
	g¥l™Pošt
 = 
sim¶eKey
('H', 800);

381 
	gthis
->
	g_h–³r
.
	gbŒ“
.
loÿ‹
(
¥l™Pošt
, 
this
->
_h–³r
.
dummyDiskLoc
, 1, &
pos
, &
loc
);

382 
ASSERT_EQUALS
(
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 
loc
);

383 
ASSERT_EQUALS
(0, 
pos
);

386 
	gÏrgePos
;

387 
DiskLoc
 
	gÏrgeLoc
;

388 
	gthis
->
	g_h–³r
.
	gbŒ“
.
loÿ‹
(

389 
¥l™Pošt
, 
this
->
_h–³r
.
dummyDiskLoc
, 1, &
ÏrgePos
, &
ÏrgeLoc
);

390 
	gthis
->
	g_h–³r
.
	gbŒ“
.
advªû
(&
ÏrgeLoc
, &
ÏrgePos
, -1);

393 
	gsm®lPos
;

394 
DiskLoc
 
	gsm®lLoc
;

395 
	gthis
->
	g_h–³r
.
	gbŒ“
.
loÿ‹
(

396 
¥l™Pošt
, 
this
->
_h–³r
.
dummyDiskLoc
, 1, &
sm®lPos
, &
sm®lLoc
);

397 
	gthis
->
	g_h–³r
.
	gbŒ“
.
advªû
(&
sm®lLoc
, &
sm®lPos
, 1);

399 
ASSERT_NOT_EQUALS
(
sm®lLoc
, 
ÏrgeLoc
);

400 
ASSERT_NOT_EQUALS
(
sm®lLoc
, 
loc
);

401 
ASSERT_NOT_EQUALS
(
ÏrgeLoc
, 
loc
);

405 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

406 
şass
 
	gDÚtReu£Unu£d
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

407 
public
:

408 
run
() {

409 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

410 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

412 
	gi
 = 0; i < 10; ++i) {

413 cÚ¡ 
BSONObj
 
	gk
 = 
sim¶eKey
('b' + 2 * 
i
, 800);

414 
	gthis
->
š£¹
(
k
, 
this
->
_h–³r
.
dummyDiskLoc
);

417 cÚ¡ 
BSONObj
 
	groÙ
 = 
sim¶eKey
('p', 800);

418 
	gthis
->
unšdex
(
roÙ
);

420 
	gthis
->
š£¹
(
roÙ
, 
this
->
_h–³r
.
dummyDiskLoc
);

421 
	gthis
->
loÿ‹
(
roÙ
, 0, 
Œue
, 
this
->
h—d
()->
ÃxtChd
, 1);

425 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

426 
şass
 
	gM”geBuck‘sTe¡Ba£
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

427 
public
:

428 
run
() {

429 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

430 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

432 
	gi
 = 0; i < 10; ++i) {

433 cÚ¡ 
BSONObj
 
	gk
 = 
sim¶eKey
('b' + 2 * 
i
, 800);

434 
	gthis
->
š£¹
(
k
, 
this
->
_h–³r
.
dummyDiskLoc
);

438 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
() - 1);

440 
	gex³ùedCouÁ
 = 10 - 
unšdexKeys
();

441 
ASSERT_EQUALS
(1, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
() - 1);

443 
	gunu£dCouÁ
 = 0;

444 
ASSERT_EQUALS
(
ex³ùedCouÁ
, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£dCouÁ
, 
Œue
,rue, 0));

445 
ASSERT_EQUALS
(0, 
unu£dCouÁ
);

448 
	g´Ùeùed
:

449 
vœtu®
 
unšdexKeys
() = 0;

452 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

453 
şass
 
	gM”geBuck‘sLeá
 : 
public
 
M”geBuck‘sTe¡Ba£
<
OnDiskFÜm©
> {

454 
vœtu®
 
unšdexKeys
() {

455 
BSONObj
 
k
 = 
sim¶eKey
('b', 800);

456 
	gthis
->
unšdex
(
k
);

458 
	gk
 = 
sim¶eKey
('b' + 2, 800);

459 
	gthis
->
unšdex
(
k
);

461 
	gk
 = 
sim¶eKey
('b' + 4, 800);

462 
	gthis
->
unšdex
(
k
);

464 
	gk
 = 
sim¶eKey
('b' + 6, 800);

465 
	gthis
->
unšdex
(
k
);

471 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

472 
şass
 
	gM”geBuck‘sRight
 : 
public
 
M”geBuck‘sTe¡Ba£
<
OnDiskFÜm©
> {

473 
vœtu®
 
unšdexKeys
() {

474 cÚ¡ 
BSONObj
 
k
 = 
sim¶eKey
('b' + 2 * 9, 800);

475 
	gthis
->
unšdex
(
k
);

480 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

481 
şass
 
	gM”geBuck‘sDÚtR•ÏûH—d
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

482 
public
:

483 
run
() {

484 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

485 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

487 
	gi
 = 0; i < 18; ++i) {

488 cÚ¡ 
BSONObj
 
	gk
 = 
sim¶eKey
('a' + 
i
, 800);

489 
	gthis
->
š£¹
(
k
, 
this
->
_h–³r
.
dummyDiskLoc
);

493 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
() - 1);

495 cÚ¡ 
BSONObj
 
	gk
 = 
sim¶eKey
('a' + 17, 800);

496 
	gthis
->
unšdex
(
k
);

497 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
() - 1);

499 
	gunu£dCouÁ
 = 0;

500 
ASSERT_EQUALS
(17, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£dCouÁ
, 
Œue
,rue, 0));

501 
ASSERT_EQUALS
(0, 
unu£dCouÁ
);

505 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

506 
şass
 
	gM”geBuck‘sD–IÁ”Çl
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

507 
public
:

508 
run
() {

509 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

510 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

512 
	gbud”
.
makeT»e
("{d:{b:{a:null},bb:null,_:{c:null}},_:{f:{e:null},_:{g:null}}}");

513 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

516 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

518 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "bb");

519 
v”ify
(
this
->
unšdex
(
k
));

521 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

524 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

526 
	gbud”
.
checkSŒuùu»
("{b:{a:null},d:{c:null},f:{e:null},_:{g:null}}");

530 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

531 
şass
 
	gM”geBuck‘sRightNuÎ
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

532 
public
:

533 
run
() {

534 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

535 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

537 
	gbud”
.
makeT»e
("{d:{b:{a:null},bb:null,cc:{c:null}},_:{f:{e:null},h:{g:null}}}");

538 
ASSERT_EQUALS
(10, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

541 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

543 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "bb");

544 
v”ify
(
this
->
unšdex
(
k
));

546 
ASSERT_EQUALS
(9, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

549 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

551 
	gbud”
.
checkSŒuùu»
("{b:{a:null},cc:{c:null},d:null,f:{e:null},h:{g:null}}");

558 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

559 
şass
 
	gDÚtM”geSšgËBuck‘
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

560 
public
:

561 
run
() {

562 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

563 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

565 
	gbud”
.
makeT»e
("{d:{b:{a:null},c:null}}");

567 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

570 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

572 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "c");

573 
v”ify
(
this
->
unšdex
(
k
));

575 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

578 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

580 
	gbud”
.
checkSŒuùu»
("{d:{b:{a:null}}}");

584 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

585 
şass
 
	gP¬’tM”geNÚRightToLeá
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

586 
public
:

587 
run
() {

588 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

589 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

591 
	gbud”
.
makeT»e
("{d:{b:{a:null},bb:null,cc:{c:null}},i:{f:{e:null},h:{g:null}}}");

593 
ASSERT_EQUALS
(11, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

596 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

598 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "bb");

599 
v”ify
(
this
->
unšdex
(
k
));

601 
ASSERT_EQUALS
(10, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

605 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

607 
	gbud”
.
checkSŒuùu»
("{i:{b:{a:null},cc:{c:null},d:null,f:{e:null},h:{g:null}}}");

611 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

612 
şass
 
	gP¬’tM”geNÚRightToRight
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

613 
public
:

614 
run
() {

615 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

616 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

618 
	gbud”
.
makeT»e
("{d:{b:{a:null},cc:{c:null}},i:{f:{e:null},ff:null,h:{g:null}}}");

620 
ASSERT_EQUALS
(11, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

623 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

625 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "ff");

626 
v”ify
(
this
->
unšdex
(
k
));

628 
ASSERT_EQUALS
(10, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

632 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

634 
	gbud”
.
checkSŒuùu»
("{i:{b:{a:null},cc:{c:null},d:null,f:{e:null},h:{g:null}}}");

638 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

639 
şass
 
	gCªtM”geRightNoM”ge
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

640 
public
:

641 
run
() {

642 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

643 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

645 
	gbud”
.
makeT»e
("{d:{b:{a:null},bb:null,cc:{c:null}},"

649 
ASSERT_EQUALS
(11, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

652 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

654 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "bb");

655 
v”ify
(
this
->
unšdex
(
k
));

657 
ASSERT_EQUALS
(10, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

660 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

662 
	gbud”
.
checkSŒuùu»
("{d:{b:{a:null},cc:{c:null}},"

668 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

669 
şass
 
	gCªtM”geLeáNoM”ge
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

670 
public
:

671 
run
() {

672 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

673 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

675 
	gbud”
.
makeT»e
("{c:{b:{a:null}},d:null,_:{f:{e:null},g:null}}");

677 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

680 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

682 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "g");

683 
v”ify
(
this
->
unšdex
(
k
));

685 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

688 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

690 
	gbud”
.
checkSŒuùu»
("{c:{b:{a:null}},d:null,_:{f:{e:null}}}");

694 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

695 
şass
 
	gM”geO±iÚ
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

696 
public
:

697 
run
() {

698 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

699 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

701 
	gbud”
.
makeT»e
("{c:{b:{a:null}},f:{e:{d:null},ee:null},_:{h:{g:null}}}");

703 
ASSERT_EQUALS
(9, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

706 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

708 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "ee");

709 
v”ify
(
this
->
unšdex
(
k
));

711 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

714 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

716 
	gbud”
.
checkSŒuùu»
("{c:{b:{a:null}},_:{e:{d:null},f:null,h:{g:null}}}");

720 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

721 
şass
 
	gFÜûM”geLeá
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

722 
public
:

723 
run
() {

724 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

725 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

727 
	gbud”
.
makeT»e
("{c:{b:{a:null}},f:{e:{d:null},ee:null},ff:null,_:{h:{g:null}}}");

729 
ASSERT_EQUALS
(10, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

732 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

734 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "ee");

735 
v”ify
(
this
->
unšdex
(
k
));

737 
ASSERT_EQUALS
(9, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

740 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

742 
	gbud”
.
checkSŒuùu»
("{f:{b:{a:null},c:null,e:{d:null}},ff:null,_:{h:{g:null}}}");

746 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

747 
şass
 
	gFÜûM”geRight
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

748 
public
:

749 
run
() {

750 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

751 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

753 
	gbud”
.
makeT»e
("{c:{b:{a:null}},cc:null,f:{e:{d:null},ee:null},_:{h:{g:null}}}");

755 
ASSERT_EQUALS
(10, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

758 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

760 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "ee");

761 
v”ify
(
this
->
unšdex
(
k
));

763 
ASSERT_EQUALS
(9, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

766 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

768 
	gbud”
.
checkSŒuùu»
("{c:{b:{a:null}},cc:null,_:{e:{d:null},f:null,h:{g:null}}}");

772 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

773 
şass
 
	gRecursiveM”ge
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

774 
public
:

775 
run
() {

776 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

777 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

779 
	gbud”
.
makeT»e
("{h:{e:{b:{a:null},c:null,d:null},g:{f:null}},j:{i:null}}");

781 
ASSERT_EQUALS
(10, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

784 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

786 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "c");

787 
v”ify
(
this
->
unšdex
(
k
));

789 
ASSERT_EQUALS
(9, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

792 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

795 
	gbud”
.
checkSŒuùu»
("{j:{g:{b:{a:null},d:null,e:null,f:null},h:null,i:null}}");

799 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

800 
şass
 
	gRecursiveM”geRightBuck‘
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

801 
public
:

802 
run
() {

803 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

804 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

806 
	gbud”
.
makeT»e
("{h:{e:{b:{a:null},c:null,d:null},g:{f:null}},_:{i:null}}");

808 
ASSERT_EQUALS
(9, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

811 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

813 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "c");

814 
v”ify
(
this
->
unšdex
(
k
));

816 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

819 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

821 
	gbud”
.
checkSŒuùu»
("{g:{b:{a:null},d:null,e:null,f:null},h:null,i:null}");

825 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

826 
şass
 
	gRecursiveM”geDoubËRightBuck‘
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

827 
public
:

828 
run
() {

829 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

830 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

832 
	gbud”
.
makeT»e
("{h:{e:{b:{a:null},c:null,d:null},_:{f:null}},_:{i:null}}");

834 
ASSERT_EQUALS
(8, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

837 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

839 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "c");

840 
v”ify
(
this
->
unšdex
(
k
));

842 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

845 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

848 
	gbud”
.
checkSŒuùu»
("{h:{b:{a:null},d:null,e:null,f:null},_:{i:null}}");

852 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

853 
şass
 
	gM”geSizeTe¡Ba£
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

854 
public
:

855 
M”geSizeTe¡Ba£
(è: 
_couÁ
(0) {

859 
run
() {

860 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

861 
	gthis
->
	g_h–³r
.
	gbŒ“
.
š™AsEm±y
(&
txn
);

863 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

865 cÚ¡ 
	gBSONObj
& 
	gtİKey
 = 
bigge¡Key
('m');

867 
DiskLoc
 
	gËáChd
 = 
this
->
ÃwBuck‘
();

868 
	gbud”
.
push
(
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 
tİKey
, 
ËáChd
);

869 
	g_couÁ
++;

871 
DiskLoc
 
	grightChd
 = 
this
->
ÃwBuck‘
();

872 
	gthis
->
£tBuck‘NextChd
(
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 
rightChd
);

874 
	g_couÁ
 +ğ
bud”
.
flBuck‘ToExaùSize
(
ËáChd
, 
ËáSize
(), 'a');

875 
	g_couÁ
 +ğ
bud”
.
flBuck‘ToExaùSize
(
rightChd
, 
rightSize
(), 'n');

877 
ASSERT
(
ËáAdd™iÚ®
() <= 2);

878 ià(
ËáAdd™iÚ®
() >= 2) {

879 
bud”
.
push
(
ËáChd
, 
bigKey
('k'), 
DiskLoc
());

881 ià(
ËáAdd™iÚ®
() >= 1) {

882 
bud”
.
push
(
ËáChd
, 
bigKey
('l'), 
DiskLoc
());

885 
ASSERT
(
rightAdd™iÚ®
() <= 2);

886 ià(
rightAdd™iÚ®
() >= 2) {

887 
bud”
.
push
(
rightChd
, 
bigKey
('y'), 
DiskLoc
());

889 ià(
rightAdd™iÚ®
() >= 1) {

890 
bud”
.
push
(
rightChd
, 
bigKey
('z'), 
DiskLoc
());

893 
	g_couÁ
 +ğ
ËáAdd™iÚ®
(è+ 
rightAdd™iÚ®
();

895 
š™Check
();

897 cÚ¡ *
	gkeys
 = 
d–Keys
();

898 cÚ¡ *
	gi
 = 
keys
; *i; ++i) {

899 
	gunu£d
 = 0;

900 
ASSERT_EQUALS
(
_couÁ
, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

901 
ASSERT_EQUALS
(0, 
unu£d
);

904 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

906 cÚ¡ 
BSONObj
 
	gk
 = 
bigKey
(*
i
);

907 
	gthis
->
unšdex
(
k
);

909 --
	g_couÁ
;

912 
	gunu£d
 = 0;

913 
ASSERT_EQUALS
(
_couÁ
, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

914 
ASSERT_EQUALS
(0, 
unu£d
);

916 
v®id©e
();

918 ià(!
m”ge
()) {

920 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

924 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

928 
	g´Ùeùed
:

929 
vœtu®
 
ËáAdd™iÚ®
() const {  2; }

930 
vœtu®
 
rightAdd™iÚ®
() const {  2; }

931 
vœtu®
 
š™Check
() {}

932 
vœtu®
 
v®id©e
() {}

933 
vœtu®
 
ËáSize
() const = 0;

934 
vœtu®
 
rightSize
() const = 0;

935 
vœtu®
 cÚ¡ * 
d–Keys
() const {  "klyz"; }

936 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gŒue
; }

938 
BSONObj
 
bigKey
(
a
) {

939  
sim¶eKey
(
a
, 801);

942 
BSONObj
 
bigge¡Key
(
a
) {

943 
	gsize
 = 
OnDiskFÜm©
::
KeyMax
 - 
bigSize
() + 801;

944  
sim¶eKey
(
a
, 
size
);

947 
bigSize
() {

948  
ty³Çme
 
	gBŒ“LogicTe¡Ba£
<
	gOnDiskFÜm©
>::
KeyD©aOwÃdTy³
(
bigKey
('a')).
d©aSize
();

951 
bigge¡Size
() {

952  
ty³Çme
 
	gBŒ“LogicTe¡Ba£
<
	gOnDiskFÜm©
>::
KeyD©aOwÃdTy³
(
bigge¡Key
('a')).
d©aSize
();

955 
	g_couÁ
;

958 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

959 
şass
 
	gM”geSizeJu¡RightRight
 : 
public
 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
> {

960 
´Ùeùed
:

961 
vœtu®
 
rightSize
() const {

962  
BŒ“Logic
<
OnDiskFÜm©
>::
lowW©”M¬k
() - 1;

965 
vœtu®
 
ËáSize
() const {

966  
	gOnDiskFÜm©
::
Buck‘BodySize
 -

967 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
>::
bigge¡Size
() -

968 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
) -

969 (
BŒ“Logic
<
OnDiskFÜm©
>::
lowW©”M¬k
() - 1);

973 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

974 
şass
 
	gM”geSizeJu¡RightLeá
 : 
public
 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
> {

975 
´Ùeùed
:

976 
vœtu®
 
ËáSize
() const {

977  
BŒ“Logic
<
OnDiskFÜm©
>::
lowW©”M¬k
() - 1;

980 
vœtu®
 
rightSize
() const {

981  
	gOnDiskFÜm©
::
Buck‘BodySize
 -

982 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
>::
bigge¡Size
() -

983 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
) -

984 (
BŒ“Logic
<
OnDiskFÜm©
>::
lowW©”M¬k
() - 1);

987 
vœtu®
 cÚ¡ * 
d–Keys
() const {  "yzkl"; }

990 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

991 
şass
 
	gM”geSizeRight
 : 
public
 
M”geSizeJu¡RightRight
<
OnDiskFÜm©
> {

992 
vœtu®
 
rightSize
(ècÚ¡ {  
M”geSizeJu¡RightRight
<
OnDiskFÜm©
>::rightSize() - 1; }

993 
vœtu®
 
ËáSize
(ècÚ¡ {  
	gM”geSizeJu¡RightRight
<
	gOnDiskFÜm©
>::leftSize() + 1; }

996 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

997 
şass
 
	gM”geSizeLeá
 : 
public
 
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
> {

998 
vœtu®
 
rightSize
(ècÚ¡ {  
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
>::rightSize() + 1; }

999 
vœtu®
 
ËáSize
(ècÚ¡ {  
	gM”geSizeJu¡RightLeá
<
	gOnDiskFÜm©
>::leftSize() - 1; }

1002 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1003 
şass
 
	gNoM”geB–owM¬kRight
 : 
public
 
M”geSizeJu¡RightRight
<
OnDiskFÜm©
> {

1004 
vœtu®
 
rightSize
(ècÚ¡ {  
M”geSizeJu¡RightRight
<
OnDiskFÜm©
>::rightSize() + 1; }

1005 
vœtu®
 
ËáSize
(ècÚ¡ {  
	gM”geSizeJu¡RightRight
<
	gOnDiskFÜm©
>::leftSize() - 1; }

1006 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1009 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1010 
şass
 
	gNoM”geB–owM¬kLeá
 : 
public
 
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
> {

1011 
vœtu®
 
rightSize
(ècÚ¡ {  
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
>::rightSize() - 1; }

1012 
vœtu®
 
ËáSize
(ècÚ¡ {  
	gM”geSizeJu¡RightLeá
<
	gOnDiskFÜm©
>::leftSize() + 1; }

1013 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1016 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1017 
şass
 
	gM”geSizeRightTooBig
 : 
public
 
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
> {

1018 
vœtu®
 
rightSize
(ècÚ¡ {  
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
>::rightSize() + 1; }

1019 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1022 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1023 
şass
 
	gM”geSizeLeáTooBig
 : 
public
 
M”geSizeJu¡RightRight
<
OnDiskFÜm©
> {

1024 
vœtu®
 
ËáSize
(ècÚ¡ {  
M”geSizeJu¡RightRight
<
OnDiskFÜm©
>::leftSize() + 1; }

1025 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1028 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1029 
şass
 
	gM”geRightEm±y
 : 
public
 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
> {

1030 
´Ùeùed
:

1031 
vœtu®
 
rightAdd™iÚ®
() const {  1; }

1032 
vœtu®
 
ËáAdd™iÚ®
() const {  1; }

1033 
vœtu®
 cÚ¡ * 
d–Keys
() const {  "lz"; }

1034 
vœtu®
 
rightSize
() const {  0; }

1035 
vœtu®
 
ËáSize
() const {

1036  
	gOnDiskFÜm©
::
Buck‘BodySize
 -

1037 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
>::
bigge¡Size
() -

1038 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
);

1042 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1043 
şass
 
	gM”geMšRightEm±y
 : 
public
 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
> {

1044 
´Ùeùed
:

1045 
vœtu®
 
rightAdd™iÚ®
() const {  1; }

1046 
vœtu®
 
ËáAdd™iÚ®
() const {  0; }

1047 
vœtu®
 cÚ¡ * 
d–Keys
() const {  "z"; }

1048 
vœtu®
 
rightSize
() const {  0; }

1049 
vœtu®
 
ËáSize
() const {

1050  
	gM”geSizeTe¡Ba£
<
	gOnDiskFÜm©
>::
bigSize
() +

1051 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
);

1055 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1056 
şass
 
	gM”geLeáEm±y
 : 
public
 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
> {

1057 
´Ùeùed
:

1058 
vœtu®
 
rightAdd™iÚ®
() const {  1; }

1059 
vœtu®
 
ËáAdd™iÚ®
() const {  1; }

1060 
vœtu®
 cÚ¡ * 
d–Keys
() const {  "zl"; }

1061 
vœtu®
 
ËáSize
() const {  0; }

1062 
vœtu®
 
rightSize
() const {

1063  
	gOnDiskFÜm©
::
Buck‘BodySize
 -

1064 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
>::
bigge¡Size
() -

1065 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
);

1069 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1070 
şass
 
	gM”geMšLeáEm±y
 : 
public
 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
> {

1071 
´Ùeùed
:

1072 
vœtu®
 
ËáAdd™iÚ®
() const {  1; }

1073 
vœtu®
 
rightAdd™iÚ®
() const {  0; }

1074 
vœtu®
 cÚ¡ * 
d–Keys
() const {  "l"; }

1075 
vœtu®
 
ËáSize
() const {  0; }

1076 
vœtu®
 
rightSize
() const {

1077  
	gM”geSizeTe¡Ba£
<
	gOnDiskFÜm©
>::
bigSize
() +

1078 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
);

1082 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1083 
şass
 
	gB®ªûRightEm±y
 : 
public
 
M”geRightEm±y
<
OnDiskFÜm©
> {

1084 
´Ùeùed
:

1085 
vœtu®
 
ËáSize
() const {

1086  
OnDiskFÜm©
::
Buck‘BodySize
 -

1087 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
>::
bigge¡Size
() -

1088 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
) + 1;

1091 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1093 
vœtu®
 
š™Check
() {

1094 
	g_ŞdTİ
 = 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
	gd©a
.
toBsÚ
();

1097 
vœtu®
 
v®id©e
() {

1098 
ASSERT_NOT_EQUALS
(
_ŞdTİ
, 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
d©a
.
toBsÚ
());

1101 
	g´iv©e
:

1102 
BSONObj
 
_ŞdTİ
;

1105 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1106 
şass
 
	gB®ªûLeáEm±y
 : 
public
 
M”geLeáEm±y
<
OnDiskFÜm©
> {

1107 
´Ùeùed
:

1108 
vœtu®
 
rightSize
() const {

1109  
OnDiskFÜm©
::
Buck‘BodySize
 -

1110 
M”geSizeTe¡Ba£
<
OnDiskFÜm©
>::
bigge¡Size
() -

1111 (
ty³Çme
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
>::
FixedWidthKeyTy³
) + 1;

1114 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1116 
vœtu®
 
š™Check
() {

1117 
	g_ŞdTİ
 = 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
	gd©a
.
toBsÚ
();

1120 
vœtu®
 
v®id©e
() {

1121 
ASSERT_TRUE
(
_ŞdTİ
 !ğ
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
d©a
.
toBsÚ
());

1124 
	g´iv©e
:

1125 
BSONObj
 
_ŞdTİ
;

1128 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1129 
şass
 
	gB®ªûOÃLeáToRight
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1130 
public
:

1131 
run
() {

1132 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1133 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1135 
	gbud”
.
makeT»e
("{$10:{$1:null,$2:null,$3:null,$4:null,$5:null,$6:null},"

1139 
ASSERT_EQUALS
(14, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1142 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1144 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x40, 800));

1145 
ASSERT
(
this
->
unšdex
(
k
));

1147 
ASSERT_EQUALS
(13, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1150 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1152 
	gbud”
.
checkSŒuùu»
("{$6:{$1:null,$2:null,$3:null,$4:null,$5:null},"

1158 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1159 
şass
 
	gB®ªûOÃRightToLeá
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1160 
public
:

1161 
run
() {

1162 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1163 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1165 
	gbud”
.
makeT»e
("{$10:{$1:null,$2:null,$3:null,$4:null},"

1169 
ASSERT_EQUALS
(13, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1172 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1174 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x3, 800));

1175 
ASSERT
(
this
->
unšdex
(
k
));

1177 
ASSERT_EQUALS
(12, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1180 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1182 
	gbud”
.
checkSŒuùu»
("{$20:{$1:null,$2:null,$4:null,$10:null},"

1188 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1189 
şass
 
	gB®ªûTh»eLeáToRight
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1190 
public
:

1191 
run
() {

1192 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1193 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1195 
	gbud”
.
makeT»e
("{$20:{$1:{$0:null},$3:{$2:null},$5:{$4:null},$7:{$6:null},"

1200 
ASSERT_EQUALS
(23, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1203 
ASSERT_EQUALS
(15, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1205 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x30, 800));

1206 
ASSERT
(
this
->
unšdex
(
k
));

1208 
ASSERT_EQUALS
(22, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1211 
ASSERT_EQUALS
(15, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1213 
	gbud”
.
checkSŒuùu»
("{$9:{$1:{$0:null},$3:{$2:null},"

1221 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1222 
şass
 
	gB®ªûTh»eRightToLeá
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1223 
public
:

1224 
run
() {

1225 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1226 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1228 
	gbud”
.
makeT»e
("{$20:{$1:{$0:null},$3:{$2:null},$5:null,_:{$14:null}},"

1234 
ASSERT_EQUALS
(25, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1237 
ASSERT_EQUALS
(16, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1239 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x5, 800));

1240 
ASSERT
(
this
->
unšdex
(
k
));

1242 
ASSERT_EQUALS
(24, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1245 
ASSERT_EQUALS
(16, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1247 
	gbud”
.
checkSŒuùu»
("{$50:{$1:{$0:null},$3:{$2:null},$20:{$14:null},"

1255 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1256 
şass
 
	gB®ªûSšgËP¬’tKey
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1257 
public
:

1258 
run
() {

1259 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1260 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1262 
	gbud”
.
makeT»e
("{$10:{$1:null,$2:null,$3:null,$4:null,$5:null,$6:null},"

1265 
ASSERT_EQUALS
(12, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1268 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1270 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x40, 800));

1271 
ASSERT
(
this
->
unšdex
(
k
));

1273 
ASSERT_EQUALS
(11, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1276 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1278 
	gbud”
.
checkSŒuùu»
("{$6:{$1:null,$2:null,$3:null,$4:null,$5:null},"

1283 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1284 
şass
 
	gPackEm±yBuck‘
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1285 
public
:

1286 
run
() {

1287 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1288 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1290 
	gbud”
.
makeT»e
("{a:null}");

1292 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "a");

1293 
ASSERT
(
this
->
unšdex
(
k
));

1295 
	gthis
->
fÜûPackBuck‘
(
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

1297 
ty³Çme
 
	gBŒ“LogicTe¡Ba£
<
	gOnDiskFÜm©
>::
Buck‘Ty³
* 
h—dBuck‘
 = 
this
->
h—d
();

1299 
ASSERT_EQUALS
(0, 
h—dBuck‘
->
n
);

1300 
ASSERT_FALSE
(
h—dBuck‘
->
æags
 & 
Packed
);

1302 
	gunu£d
 = 0;

1303 
	gthis
->
Œunÿ‹Buck‘
(
h—dBuck‘
, 0, 
unu£d
);

1305 
ASSERT_EQUALS
(0, 
h—dBuck‘
->
n
);

1306 
ASSERT_EQUALS
(0, 
h—dBuck‘
->
tİSize
);

1307 
ASSERT_EQUALS
(()
OnDiskFÜm©
::
Buck‘BodySize
, 
h—dBuck‘
->
em±ySize
);

1308 
ASSERT_TRUE
(
h—dBuck‘
->
æags
 & 
Packed
);

1312 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1313 
şass
 
	gPackedD©aSizeEm±yBuck‘
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1314 
public
:

1315 
run
() {

1316 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1317 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1319 
	gbud”
.
makeT»e
("{a:null}");

1321 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "a");

1322 
ASSERT
(
this
->
unšdex
(
k
));

1324 
	gthis
->
fÜûPackBuck‘
(
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

1326 
ty³Çme
 
	gBŒ“LogicTe¡Ba£
<
	gOnDiskFÜm©
>::
Buck‘Ty³
* 
h—dBuck‘
 = 
this
->
h—d
();

1328 
ASSERT_EQUALS
(0, 
h—dBuck‘
->
n
);

1329 
ASSERT_FALSE
(
h—dBuck‘
->
æags
 & 
Packed
);

1330 
ASSERT_EQUALS
(0, 
this
->
buck‘PackedD©aSize
(
h—dBuck‘
, 0));

1331 
ASSERT_FALSE
(
h—dBuck‘
->
æags
 & 
Packed
);

1335 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1336 
şass
 
	gB®ªûSšgËP¬’tKeyPackP¬’t
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1337 
public
:

1338 
run
() {

1339 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1340 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1342 
	gbud”
.
makeT»e
("{$10:{$1:null,$2:null,$3:null,$4:null,$5:null,$6:null},"

1345 
ASSERT_EQUALS
(12, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1348 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1351 
	gthis
->
fÜûPackBuck‘
(
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
());

1353 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x40, 800));

1354 
ASSERT
(
this
->
unšdex
(
k
));

1356 
ASSERT_EQUALS
(11, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1359 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1361 
	gbud”
.
checkSŒuùu»
("{$6:{$1:null,$2:null,$3:null,$4:null,$5:null},"

1366 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1367 
şass
 
	gB®ªûS¶™P¬’t
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1368 
public
:

1369 
run
() {

1370 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1371 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1373 
	gbud”
.
makeT»e
(

1379 
ASSERT_EQUALS
(22, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1382 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1384 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x3, 800));

1385 
ASSERT
(
this
->
unšdex
(
k
));

1387 
ASSERT_EQUALS
(21, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1390 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1392 
	gbud”
.
checkSŒuùu»
("{$500:{ $30:{$1:null,$2:null,$4:null,$10$10:null,$20:null},"

1399 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1400 
şass
 
	gReb®ªûdS•¬©ÜBa£
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1401 
public
:

1402 
run
() {

1403 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1404 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1406 
	gbud”
.
makeT»e
(
Œ“S³c
());

1407 
modT»e
();

1409 
ASSERT_EQUALS
(
ex³ùedS•¬©Ü
(),

1410 
this
->
buck‘Reb®ªûdS•¬©ÜPos
(

1411 
this
->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0));

1414 
vœtu®
 
¡ršg
 
Œ“S³c
() const = 0;

1415 
vœtu®
 
ex³ùedS•¬©Ü
() const = 0;

1416 
vœtu®
 
modT»e
() {}

1419 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1420 
şass
 
	gEv’Reb®ªûLeá
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1421 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$7:{$1:null,$2$31f:null,$3:null,"

1424 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1427 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1428 
şass
 
	gEv’Reb®ªûLeáCu¥
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1429 
vœtu®
 
¡ršg
 
Œ“S³c
() const {

1433 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1436 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1437 
şass
 
	gEv’Reb®ªûRight
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1438 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$3:{$1:null,$2$31f:null},_:{$4$31f:null,$5:null,$6:null,$7:null,$8$31e:null,$9:null,$10:null}}"; }

1439 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1442 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1443 
şass
 
	gEv’Reb®ªûRightCu¥
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1444 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$4$31f:{$1:null,$2$31f:null,$3:null},_:{$5:null,$6:null,$7$31e:null,$8:null,$9:null,$10:null}}"; }

1445 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1448 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1449 
şass
 
	gEv’Reb®ªûC’‹r
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1450 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$5:{$1:null,$2$31f:null,$3:null,$4$31f:null},_:{$6:null,$7$31e:null,$8:null,$9:null,$10:null}}"; }

1451 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1454 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1455 
şass
 
	gOddReb®ªûLeá
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1456 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$6$31f:{$1:null,$2:null,$3:null,$4:null,$5:null},_:{$7:null,$8:null,$9:null,$10:null}}"; }

1457 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1460 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1461 
şass
 
	gOddReb®ªûRight
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1462 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$4:{$1:null,$2:null,$3:null},_:{$5:null,$6:null,$7:null,$8$31f:null,$9:null,$10:null}}"; }

1463 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1466 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1467 
şass
 
	gOddReb®ªûC’‹r
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1468 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$5:{$1:null,$2:null,$3:null,$4:null},_:{$6:null,$7:null,$8:null,$9:null,$10$31f:null}}"; }

1469 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1472 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1473 
şass
 
	gReb®ªûEm±yRight
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1474 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$a:{$1:null,$2:null,$3:null,$4:null,$5:null,$6:null,$7:null,$8:null,$9:null},_:{$b:null}}"; }

1475 
vœtu®
 
modT»e
() {

1476 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0xb, 800));

1477 
ASSERT
(
this
->
unšdex
(
k
));

1479 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1482 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1483 
şass
 
	gReb®ªûEm±yLeá
 : 
public
 
Reb®ªûdS•¬©ÜBa£
<
OnDiskFÜm©
> {

1484 
vœtu®
 
¡ršg
 
Œ“S³c
() const {  "{$a:{$1:null},_:{$11:null,$12:null,$13:null,$14:null,$15:null,$16:null,$17:null,$18:null,$19:null}}"; }

1485 
vœtu®
 
modT»e
() {

1486 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x1, 800));

1487 
ASSERT
(
this
->
unšdex
(
k
));

1489 
vœtu®
 
ex³ùedS•¬©Ü
() const {  4; }

1492 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1493 
şass
 
	gNoMoveAtLowW©”M¬kRight
 : 
public
 
M”geSizeJu¡RightRight
<
OnDiskFÜm©
> {

1494 
vœtu®
 
rightSize
(ècÚ¡ {  
M”geSizeJu¡RightRight
<
OnDiskFÜm©
>::rightSize() + 1; }

1496 
vœtu®
 
š™Check
() {

1497 
	g_ŞdTİ
 = 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
	gd©a
.
toBsÚ
();

1500 
vœtu®
 
v®id©e
() {

1501 
ASSERT_EQUALS
(
_ŞdTİ
, 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
d©a
.
toBsÚ
());

1504 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1506 
	g´Ùeùed
:

1507 
BSONObj
 
_ŞdTİ
;

1510 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1511 
şass
 
	gMoveB–owLowW©”M¬kRight
 : 
public
 
NoMoveAtLowW©”M¬kRight
<
OnDiskFÜm©
> {

1512 
vœtu®
 
rightSize
(ècÚ¡ {  
M”geSizeJu¡RightRight
<
OnDiskFÜm©
>::rightSize(); }

1513 
vœtu®
 
ËáSize
(ècÚ¡ {  
	gM”geSizeJu¡RightRight
<
	gOnDiskFÜm©
>::leftSize() + 1; }

1515 
vœtu®
 
v®id©e
() {

1517 
ASSERT_NOT_EQUALS
(
this
->
_ŞdTİ
,

1518 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
d©a
.
toBsÚ
());

1522 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1523 
şass
 
	gNoMoveAtLowW©”M¬kLeá
 : 
public
 
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
> {

1524 
vœtu®
 
ËáSize
(ècÚ¡ {  
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
>::leftSize() + 1; }

1525 
vœtu®
 
š™Check
() {

1526 
	gthis
->
	g_ŞdTİ
 = 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
	gd©a
.
toBsÚ
();

1529 
vœtu®
 
v®id©e
() {

1530 
ASSERT_EQUALS
(
this
->
_ŞdTİ
,

1531 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
d©a
.
toBsÚ
());

1533 
vœtu®
 
boŞ
 
m”ge
(ècÚ¡ {  
	gçl£
; }

1535 
	g´Ùeùed
:

1536 
BSONObj
 
_ŞdTİ
;

1539 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1540 
şass
 
	gMoveB–owLowW©”M¬kLeá
 : 
public
 
NoMoveAtLowW©”M¬kLeá
<
OnDiskFÜm©
> {

1541 
vœtu®
 
ËáSize
(ècÚ¡ {  
M”geSizeJu¡RightLeá
<
OnDiskFÜm©
>::leftSize(); }

1542 
vœtu®
 
rightSize
(ècÚ¡ {  
	gM”geSizeJu¡RightLeá
<
	gOnDiskFÜm©
>::rightSize() + 1; }

1544 
vœtu®
 
v®id©e
() {

1546 
ASSERT_NOT_EQUALS
(
this
->
_ŞdTİ
,

1547 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
d©a
.
toBsÚ
());

1551 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1552 
şass
 
	gP»ãrB®ªûLeá
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1553 
public
:

1554 
run
() {

1555 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1556 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1558 
	gbud”
.
makeT»e
("{$10:{$1:null,$2:null,$3:null,$4:null,$5:null,$6:null},"

1562 
ASSERT_EQUALS
(13, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1565 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1567 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x12, 800));

1568 
ASSERT
(
this
->
unšdex
(
k
));

1570 
ASSERT_EQUALS
(12, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1573 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1575 
	gbud”
.
checkSŒuùu»
("{$5:{$1:null,$2:null,$3:null,$4:null},"

1581 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1582 
şass
 
	gP»ãrB®ªûRight
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1583 
public
:

1584 
run
() {

1585 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1586 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1588 
	gbud”
.
makeT»e
("{$10:{$1:null},"

1592 
ASSERT_EQUALS
(13, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1595 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1597 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x12, 800));

1598 
ASSERT
(
this
->
unšdex
(
k
));

1600 
ASSERT_EQUALS
(12, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1603 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1605 
	gbud”
.
checkSŒuùu»
("{$10:{$1:null},"

1611 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1612 
şass
 
	gRecursiveM”geTh’B®ªû
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1613 
public
:

1614 
run
() {

1615 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1616 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1618 
	gbud”
.
makeT»e
("{$10:{$5:{$1:null,$2:null},$8:{$6:null,$7:null}},"

1622 
ASSERT_EQUALS
(15, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1625 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1627 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x7, 800));

1628 
ASSERT
(
this
->
unšdex
(
k
));

1630 
ASSERT_EQUALS
(14, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1633 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1635 
	gbud”
.
checkSŒuùu»
(

1641 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1642 
şass
 
	gD–Em±yNoNeighbÜs
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1643 
public
:

1644 
run
() {

1645 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1646 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1648 
	gbud”
.
makeT»e
("{b:{a:null}}");

1650 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1653 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1655 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "a");

1656 
ASSERT
(
this
->
unšdex
(
k
));

1658 
ASSERT_EQUALS
(1, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1661 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1663 
	gbud”
.
checkSŒuùu»
("{b:null}");

1667 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1668 
şass
 
	gD–Em±yEm±yNeighbÜs
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1669 
public
:

1670 
run
() {

1671 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1672 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1674 
	gbud”
.
makeT»e
("{a:null,c:{b:null},d:null}");

1676 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1679 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1681 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "b");

1682 
ASSERT
(
this
->
unšdex
(
k
));

1684 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(
NULL
, 
Œue
,rue, 0));

1687 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1689 
	gbud”
.
checkSŒuùu»
("{a:null,c:null,d:null}");

1693 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1694 
şass
 
	gD–IÁ”Çl
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1695 
public
:

1696 
run
() {

1697 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1698 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1700 
	gbud”
.
makeT»e
("{a:null,c:{b:null},d:null}");

1702 
	gunu£d
 = 0;

1703 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1706 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1707 
ASSERT_EQUALS
(0, 
unu£d
);

1709 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "c");

1710 
ASSERT
(
this
->
unšdex
(
k
));

1712 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1715 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1716 
ASSERT_EQUALS
(0, 
unu£d
);

1718 
	gbud”
.
checkSŒuùu»
("{a:null,b:null,d:null}");

1722 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1723 
şass
 
	gD–IÁ”ÇlR•ÏûW™hUnu£d
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1724 
public
:

1725 
run
() {

1726 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1727 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1729 
	gbud”
.
makeT»e
("{a:null,c:{b:null},d:null}");

1731 cÚ¡ 
DiskLoc
 
	g´evChdBuck‘
 =

1732 
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 1).
	g´evChdBuck‘
;

1733 
	gthis
->
m¬kKeyUnu£d
(
´evChdBuck‘
, 0);

1735 
	gunu£d
 = 0;

1736 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1739 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1740 
ASSERT_EQUALS
(1, 
unu£d
);

1742 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "c");

1743 
ASSERT
(
this
->
unšdex
(
k
));

1745 
	gunu£d
 = 0;

1746 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1749 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1750 
ASSERT_EQUALS
(1, 
unu£d
);

1753 
	gbud”
.
checkSŒuùu»
("{a:null,b:null,d:null}");

1757 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1758 
şass
 
	gD–IÁ”ÇlR•ÏûRight
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1759 
public
:

1760 
run
() {

1761 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1762 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1764 
	gbud”
.
makeT»e
("{a:null,_:{b:null}}");

1766 
	gunu£d
 = 0;

1767 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1770 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1771 
ASSERT_EQUALS
(0, 
unu£d
);

1773 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "a");

1774 
ASSERT
(
this
->
unšdex
(
k
));

1776 
	gunu£d
 = 0;

1777 
ASSERT_EQUALS
(1, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1780 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1781 
ASSERT_EQUALS
(0, 
unu£d
);

1783 
	gbud”
.
checkSŒuùu»
("{b:null}");

1787 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1788 
şass
 
	gD–IÁ”ÇlPromÙeKey
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1789 
public
:

1790 
run
() {

1791 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1792 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1794 
	gbud”
.
makeT»e
("{a:null,y:{d:{c:{b:null}},_:{e:null}},z:null}");

1796 
	gunu£d
 = 0;

1797 
ASSERT_EQUALS
(7, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1800 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1801 
ASSERT_EQUALS
(0, 
unu£d
);

1803 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "y");

1804 
ASSERT
(
this
->
unšdex
(
k
));

1806 
	gunu£d
 = 0;

1807 
ASSERT_EQUALS
(6, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1810 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1811 
ASSERT_EQUALS
(0, 
unu£d
);

1813 
	gbud”
.
checkSŒuùu»
("{a:null,e:{c:{b:null},d:null},z:null}");

1817 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1818 
şass
 
	gD–IÁ”ÇlPromÙeRightKey
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1819 
public
:

1820 
run
() {

1821 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1822 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1824 
	gbud”
.
makeT»e
("{a:null,_:{e:{c:null},_:{f:null}}}");

1826 
	gunu£d
 = 0;

1827 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1830 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1831 
ASSERT_EQUALS
(0, 
unu£d
);

1833 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "a");

1834 
ASSERT
(
this
->
unšdex
(
k
));

1836 
	gunu£d
 = 0;

1837 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1840 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1841 
ASSERT_EQUALS
(0, 
unu£d
);

1843 
	gbud”
.
checkSŒuùu»
("{c:null,_:{e:null,f:null}}");

1847 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1848 
şass
 
	gD–IÁ”ÇlR•Ïûm’tP»vNÚNuÎ
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1849 
public
:

1850 
run
() {

1851 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1852 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1854 
	gbud”
.
makeT»e
("{a:null,d:{c:{b:null}},e:null}");

1856 
	gunu£d
 = 0;

1857 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1860 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1861 
ASSERT_EQUALS
(0, 
unu£d
);

1863 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "d");

1864 
ASSERT
(
this
->
unšdex
(
k
));

1866 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1869 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1870 
ASSERT_EQUALS
(1, 
unu£d
);

1872 
	gbud”
.
checkSŒuùu»
("{a:null,d:{c:{b:null}},e:null}");

1875 
ASSERT
(
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 1).
»cÜdLoc
.
g‘Ofs
() & 1);

1879 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1880 
şass
 
	gD–IÁ”ÇlR•Ïûm’tNextNÚNuÎ
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1881 
public
:

1882 
run
() {

1883 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1884 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1886 
	gbud”
.
makeT»e
("{a:null,_:{c:null,_:{d:null}}}");

1888 
	gunu£d
 = 0;

1889 
ASSERT_EQUALS
(3, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1892 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1893 
ASSERT_EQUALS
(0, 
unu£d
);

1895 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << "a");

1896 
ASSERT
(
this
->
unšdex
(
k
));

1898 
ASSERT_EQUALS
(2, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1901 
ASSERT_EQUALS
(4, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1902 
ASSERT_EQUALS
(1, 
unu£d
);

1904 
	gbud”
.
checkSŒuùu»
("{a:null,_:{c:null,_:{d:null}}}");

1907 
ASSERT
(
this
->
g‘Key
Ñhis->
_h–³r
.
h—dMªag”
.
g‘H—d
(), 0).
»cÜdLoc
.
g‘Ofs
() & 1);

1911 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1912 
şass
 
	gD–IÁ”ÇlS¶™PromÙeLeá
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1913 
public
:

1914 
run
() {

1915 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1916 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1918 
	gbud”
.
makeT»e
("{$10:null,$20:null,$30$10:{$25:{$23:null},_:{$27:null}},"

1921 
	gunu£d
 = 0;

1922 
ASSERT_EQUALS
(13, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1925 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1926 
ASSERT_EQUALS
(0, 
unu£d
);

1928 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x30, 0x10));

1929 
ASSERT
(
this
->
unšdex
(
k
));

1931 
ASSERT_EQUALS
(12, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1934 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1935 
ASSERT_EQUALS
(0, 
unu£d
);

1937 
	gbud”
.
checkSŒuùu»
("{$60:{$10:null,$20:null,"

1943 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

1944 
şass
 
	gD–IÁ”ÇlS¶™PromÙeRight
 : 
public
 
BŒ“LogicTe¡Ba£
<
OnDiskFÜm©
> {

1945 
public
:

1946 
run
() {

1947 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

1948 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
> 
bud”
(&
txn
, &
this
->
_h–³r
);

1950 
	gbud”
.
makeT»e
("{$10:null,$20:null,$30:null,$40:null,$50:null,$60:null,$70:null,"

1953 
	gunu£d
 = 0;

1954 
ASSERT_EQUALS
(13, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1957 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1958 
ASSERT_EQUALS
(0, 
unu£d
);

1960 cÚ¡ 
BSONObj
 
	gk
 = 
BSON
("" << 
bigNumSŒšg
(0x100, 0x10));

1961 
ASSERT
(
this
->
unšdex
(
k
));

1963 
ASSERT_EQUALS
(12, 
this
->
_h–³r
.
bŒ“
.
fuÎV®id©e
(&
unu£d
, 
Œue
,rue, 0));

1966 
ASSERT_EQUALS
(5, 
this
->
_h–³r
.
»cÜdStÜe
.
numRecÜds
());

1967 
ASSERT_EQUALS
(0, 
unu£d
);

1969 
	gbud”
.
checkSŒuùu»
(

2110 
	g‹m¶©e
<
şass
 
	gOnDiskFÜm©
>

2111 şas 
	cBŒ“LogicTe¡Su™e
 : 
public
 
un™‹¡
::
Su™e
 {

2112 
public
:

2113 
BŒ“LogicTe¡Su™e
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
è: 
Su™e
(name) {

2117 
£tupTe¡s
() {

2118 
add
< 
Sim¶eC»©e
<
OnDiskFÜm©
> >();

2119 
	gadd
< 
	gSim¶eIn£¹D–‘e
<
	gOnDiskFÜm©
> >();

2120 
	gadd
< 
	gS¶™RightH—vyBuck‘
<
	gOnDiskFÜm©
> >();

2121 
	gadd
< 
	gS¶™LeáH—vyBuck‘
<
	gOnDiskFÜm©
> >();

2122 
	gadd
< 
	gMissšgLoÿ‹
<
	gOnDiskFÜm©
> >();

2123 
	gadd
< 
	gMissšgLoÿ‹MuÉiBuck‘
<
	gOnDiskFÜm©
> >();

2124 
	gadd
< 
	gSERVER983
<
	gOnDiskFÜm©
> >();

2125 
	gadd
< 
	gDÚtReu£Unu£d
<
	gOnDiskFÜm©
> >();

2126 
	gadd
< 
	gM”geBuck‘sLeá
<
	gOnDiskFÜm©
> >();

2127 
	gadd
< 
	gM”geBuck‘sRight
<
	gOnDiskFÜm©
> >();

2128 
	gadd
< 
	gM”geBuck‘sDÚtR•ÏûH—d
<
	gOnDiskFÜm©
> >();

2129 
	gadd
< 
	gM”geBuck‘sD–IÁ”Çl
<
	gOnDiskFÜm©
> >();

2130 
	gadd
< 
	gM”geBuck‘sRightNuÎ
<
	gOnDiskFÜm©
> >();

2131 
	gadd
< 
	gDÚtM”geSšgËBuck‘
<
	gOnDiskFÜm©
> >();

2132 
	gadd
< 
	gP¬’tM”geNÚRightToLeá
<
	gOnDiskFÜm©
> >();

2133 
	gadd
< 
	gP¬’tM”geNÚRightToRight
<
	gOnDiskFÜm©
> >();

2134 
	gadd
< 
	gCªtM”geRightNoM”ge
<
	gOnDiskFÜm©
> >();

2135 
	gadd
< 
	gCªtM”geLeáNoM”ge
<
	gOnDiskFÜm©
> >();

2136 
	gadd
< 
	gM”geO±iÚ
<
	gOnDiskFÜm©
> >();

2137 
	gadd
< 
	gFÜûM”geLeá
<
	gOnDiskFÜm©
> >();

2138 
	gadd
< 
	gFÜûM”geRight
<
	gOnDiskFÜm©
> >();

2139 
	gadd
< 
	gRecursiveM”ge
<
	gOnDiskFÜm©
> >();

2140 
	gadd
< 
	gRecursiveM”geRightBuck‘
<
	gOnDiskFÜm©
> >();

2141 
	gadd
< 
	gRecursiveM”geDoubËRightBuck‘
<
	gOnDiskFÜm©
> >();

2143 
	gadd
< 
	gM”geSizeJu¡RightRight
<
	gOnDiskFÜm©
> >();

2144 
	gadd
< 
	gM”geSizeJu¡RightLeá
<
	gOnDiskFÜm©
> >();

2145 
	gadd
< 
	gM”geSizeRight
<
	gOnDiskFÜm©
> >();

2146 
	gadd
< 
	gM”geSizeLeá
<
	gOnDiskFÜm©
> >();

2147 
	gadd
< 
	gNoM”geB–owM¬kRight
<
	gOnDiskFÜm©
> >();

2148 
	gadd
< 
	gNoM”geB–owM¬kLeá
<
	gOnDiskFÜm©
> >();

2149 
	gadd
< 
	gM”geSizeRightTooBig
<
	gOnDiskFÜm©
> >();

2150 
	gadd
< 
	gM”geSizeLeáTooBig
<
	gOnDiskFÜm©
> >();

2151 
	gadd
< 
	gM”geRightEm±y
<
	gOnDiskFÜm©
> >();

2152 
	gadd
< 
	gM”geMšRightEm±y
<
	gOnDiskFÜm©
> >();

2153 
	gadd
< 
	gM”geLeáEm±y
<
	gOnDiskFÜm©
> >();

2154 
	gadd
< 
	gM”geMšLeáEm±y
<
	gOnDiskFÜm©
> >();

2155 
	gadd
< 
	gB®ªûRightEm±y
<
	gOnDiskFÜm©
> >();

2156 
	gadd
< 
	gB®ªûLeáEm±y
<
	gOnDiskFÜm©
> >();

2158 
	gadd
< 
	gB®ªûOÃLeáToRight
<
	gOnDiskFÜm©
> >();

2159 
	gadd
< 
	gB®ªûOÃRightToLeá
<
	gOnDiskFÜm©
> >();

2160 
	gadd
< 
	gB®ªûTh»eLeáToRight
<
	gOnDiskFÜm©
> >();

2161 
	gadd
< 
	gB®ªûTh»eRightToLeá
<
	gOnDiskFÜm©
> >();

2162 
	gadd
< 
	gB®ªûSšgËP¬’tKey
<
	gOnDiskFÜm©
> >();

2164 
	gadd
< 
	gPackEm±yBuck‘
<
	gOnDiskFÜm©
> >();

2165 
	gadd
< 
	gPackedD©aSizeEm±yBuck‘
<
	gOnDiskFÜm©
> >();

2167 
	gadd
< 
	gB®ªûSšgËP¬’tKeyPackP¬’t
<
	gOnDiskFÜm©
> >();

2168 
	gadd
< 
	gB®ªûS¶™P¬’t
<
	gOnDiskFÜm©
> >();

2169 
	gadd
< 
	gEv’Reb®ªûLeá
<
	gOnDiskFÜm©
> >();

2170 
	gadd
< 
	gEv’Reb®ªûLeáCu¥
<
	gOnDiskFÜm©
> >();

2171 
	gadd
< 
	gEv’Reb®ªûRight
<
	gOnDiskFÜm©
> >();

2172 
	gadd
< 
	gEv’Reb®ªûRightCu¥
<
	gOnDiskFÜm©
> >();

2173 
	gadd
< 
	gEv’Reb®ªûC’‹r
<
	gOnDiskFÜm©
> >();

2174 
	gadd
< 
	gOddReb®ªûLeá
<
	gOnDiskFÜm©
> >();

2175 
	gadd
< 
	gOddReb®ªûRight
<
	gOnDiskFÜm©
> >();

2176 
	gadd
< 
	gOddReb®ªûC’‹r
<
	gOnDiskFÜm©
> >();

2177 
	gadd
< 
	gReb®ªûEm±yRight
<
	gOnDiskFÜm©
> >();

2178 
	gadd
< 
	gReb®ªûEm±yLeá
<
	gOnDiskFÜm©
> >();

2180 
	gadd
< 
	gNoMoveAtLowW©”M¬kRight
<
	gOnDiskFÜm©
> >();

2181 
	gadd
< 
	gMoveB–owLowW©”M¬kRight
<
	gOnDiskFÜm©
> >();

2182 
	gadd
< 
	gNoMoveAtLowW©”M¬kLeá
<
	gOnDiskFÜm©
> >();

2183 
	gadd
< 
	gMoveB–owLowW©”M¬kLeá
<
	gOnDiskFÜm©
> >();

2185 
	gadd
< 
	gP»ãrB®ªûLeá
<
	gOnDiskFÜm©
> >();

2186 
	gadd
< 
	gP»ãrB®ªûRight
<
	gOnDiskFÜm©
> >();

2187 
	gadd
< 
	gRecursiveM”geTh’B®ªû
<
	gOnDiskFÜm©
> >();

2188 
	gadd
< 
	gD–Em±yNoNeighbÜs
<
	gOnDiskFÜm©
> >();

2189 
	gadd
< 
	gD–Em±yEm±yNeighbÜs
<
	gOnDiskFÜm©
> >();

2190 
	gadd
< 
	gD–IÁ”Çl
<
	gOnDiskFÜm©
> >();

2191 
	gadd
< 
	gD–IÁ”ÇlR•ÏûW™hUnu£d
<
	gOnDiskFÜm©
> >();

2192 
	gadd
< 
	gD–IÁ”ÇlR•ÏûRight
<
	gOnDiskFÜm©
> >();

2193 
	gadd
< 
	gD–IÁ”ÇlPromÙeKey
<
	gOnDiskFÜm©
> >();

2194 
	gadd
< 
	gD–IÁ”ÇlPromÙeRightKey
<
	gOnDiskFÜm©
> >();

2195 
	gadd
< 
	gD–IÁ”ÇlR•Ïûm’tP»vNÚNuÎ
<
	gOnDiskFÜm©
> >();

2196 
	gadd
< 
	gD–IÁ”ÇlR•Ïûm’tNextNÚNuÎ
<
	gOnDiskFÜm©
> >();

2197 
	gadd
< 
	gD–IÁ”ÇlS¶™PromÙeLeá
<
	gOnDiskFÜm©
> >();

2198 
	gadd
< 
	gD–IÁ”ÇlS¶™PromÙeRight
<
	gOnDiskFÜm©
> >();

2203 
	gBŒ“LogicTe¡Su™e
<
	gBŒ“LayoutV0
> 
SUITE_V0
("BTreeLogicTests_V0");

2204 
	gBŒ“LogicTe¡Su™e
<
	gBŒ“LayoutV1
> 
SUITE_V1
("BTreeLogicTests_V1");

	@btree/btree_ondisk.h

29 #´agm¨
Úû


31 
	~"mÚgo/db/diskloc.h
"

32 
	~"mÚgo/db/¡Üage/mm­_v1/dur.h
"

33 
	~"mÚgo/db/jsobj.h
"

34 
	~"mÚgo/db/¡Üage/»cÜd.h
"

35 
	~"mÚgo/db/¡ruùu»/bŒ“/key.h
"

37 
Çme¥aû
 
	gmÚgo
 {

39 cÚ¡ 
	gOldBuck‘Size
 = 8192;

45 #´agm¨
·ck
(1)

54 
	g‹m¶©e
 <
şass
 
	gLocTy³
>

55 
	sFixedWidthKey
 {

64 
LocTy³
 
	g´evChdBuck‘
;

69 
LocTy³
 
	g»cÜdLoc
;

74 
	g_kdo
;

80 
keyD©aOfs
() const {

81  
	g¡©ic_ÿ¡
<>(
	g_kdo
);

84 
£tKeyD©aOfs
(
s
) {

85 
	g_kdo
 = 
s
;

86 
šv¬ŸÁ
(
s
>=0);

89 
£tKeyD©aOfsSavšgU£
(
s
) {

91 
£tKeyD©aOfs
(
s
);

108 
£tUnu£d
() {

109 
	g»cÜdLoc
.
GETOFS
() |= 1;

112 
£tU£d
(è{ 
	g»cÜdLoc
.
GETOFS
() &= ~1; }

114 
isUnu£d
() const {

115  
	g»cÜdLoc
.
g‘Ofs
() & 1;

118 
isU£d
() const {

119  !
isUnu£d
();

140 
	sBŒ“Buck‘V0
 {

144 
DiskLoc
 
	g·»Á
;

149 
DiskLoc
 
	gÃxtChd
;

154 
	g_wasSize
;

159 
	g_»£rved1
;

161 
	gæags
;

166 
	gem±ySize
;

169 
	gtİSize
;

172 
	gn
;

174 
	g»£rved
;

177 
	gd©a
[4];

180 ’um { 
	gH—d”Size
 = 40 };

184 
BOOST_STATIC_ASSERT
(

185 (
BŒ“Buck‘V0
è- (
»š‹½»t_ÿ¡
<BŒ“Buck‘V0*>(
NULL
)->
d©a
)

186 =ğ
BŒ“Buck‘V0
::
H—d”Size
);

191 
	sDiskLoc56B™
 {

196 
	gofs
;

198 
	g_a
[3];

204 & 
GETOFS
(è{  
	gofs
; }

206 
g‘Ofs
(ècÚ¡ {  
	gofs
; }

212 
boŞ
 
isNuÎ
(ècÚ¡ {  
	gofs
 < 0; }

214 
toLÚgLÚg
() const {

216 
	g»suÉ
 = 
ofs
;

217 * 
	gcursÜ
 = 
»š‹½»t_ÿ¡
<*>(&
»suÉ
);

218 *
	g»š‹½»t_ÿ¡
<
	gušt16_t
*>(
	gcursÜ
 + 4èğ*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt16_t
*>(&
_a
[0]);

219 *
	g»š‹½»t_ÿ¡
<
	gušt8_t
*>(
	gcursÜ
 + 6èğ*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(&
_a
[2]);

220 *
	g»š‹½»t_ÿ¡
<
	gušt8_t
*>(
	gcursÜ
 + 7èğ
ušt8_t
(0);

221  
	g»suÉ
;

224 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gDiskLoc56B™
& 
	grhs
) const {

228  
toLÚgLÚg
(è< 
	grhs
.toLongLong();

231 
com·»
(cÚ¡ 
DiskLoc56B™
& 
rhs
) const {

232 
	ga
 = 
toLÚgLÚg
();

233 
	gb
 = 
rhs
.
toLÚgLÚg
();

234 iàĞ
	ga
 < 
	gb
 ) {

238  
	ga
 =ğ
b
 ? 0 : 1;

242 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
DiskLoc56B™
& 
rhs
) const {

243  
toLÚgLÚg
(è=ğ
rhs
.toLongLong();

246 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
DiskLoc56B™
& 
rhs
) const {

247  
toLÚgLÚg
(è!ğ
rhs
.toLongLong();

250 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
DiskLoc
& 
rhs
) const {

251  
DiskLoc
(*
this
è=ğ
rhs
;

254 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
DiskLoc
& 
rhs
) const {

255  !(*
this
==
rhs
);

264 
	gOurNuÎOfs
 = -2

267 
NuÎ
() {

268 
	gofs
 = 
OurNuÎOfs
;

269 
	g_a
[0] = 
_a
[1] = _a[2] = 0;

272 
	gİ”©Ü
=(cÚ¡ 
DiskLoc
& 
loc
) {

273 
ofs
 = 
loc
.
g‘Ofs
();

274 
	gÏ
 = 
loc
.
a
();

275 
šv¬ŸÁ
Ğ
Ï
 <= 0xffffff );

276 ifĞ
	gÏ
 < 0 ) {

277 iàĞ
	gÏ
 != -1 ) {

278 
log
(è<< "bŒ“ diskloøi¢'ˆÃg©iv1: " << 
Ï
 << 
¡d
::
’dl
;

279 
šv¬ŸÁ
 ( 
Ï
 == -1 );

281 
	gÏ
 = 0;

282 
	gofs
 = 
OurNuÎOfs
;

284 
memıy
(
_a
, &
Ï
, 3);

291 
İ”©Ü
 cÚ¡ 
DiskLoc
() const {

293 ifĞ
isNuÎ
(èè 
DiskLoc
();

294 
	ga
 = *((*è(
_a
-1));

295  
DiskLoc
(
a
 >> 8, 
ofs
);

298 
	g¡d
::
¡ršg
 
toSŒšg
(ècÚ¡ {  
DiskLoc
(*
this
).toString(); }

301 
	sBŒ“Buck‘V1
 {

303 
DiskLoc56B™
 
	g·»Á
;

306 
DiskLoc56B™
 
	gÃxtChd
;

308 
	gæags
;

311 
	gem±ySize
;

314 
	gtİSize
;

317 
	gn
;

320 
	gd©a
[4];

323 ’um { 
	gH—d”Size
 = 22 };

327 
BOOST_STATIC_ASSERT
(

328 (
BŒ“Buck‘V1
è- (
»š‹½»t_ÿ¡
<BŒ“Buck‘V1*>(
NULL
)->
d©a
)

329 =ğ
BŒ“Buck‘V1
::
H—d”Size
);

331 
	eFÏgs
 {

332 
	gPacked
 = 1

335 
	sBŒ“LayoutV0
 {

336 
	gFixedWidthKey
<
	tDiskLoc
> 
	tFixedWidthKeyTy³
;

337 
DiskLoc
 
	tLocTy³
;

338 
KeyBsÚ
 
	tKeyTy³
;

339 
KeyBsÚ
 
	tKeyOwÃdTy³
;

340 
BŒ“Buck‘V0
 
	tBuck‘Ty³
;

342 ’um { 
	gBuck‘Size
 = 8192,

343 
	gBuck‘BodySize
 = 
Buck‘Size
 - 
Buck‘Ty³
::
H—d”Size


349 cÚ¡ 
	gKeyMax
 = 
OldBuck‘Size
 / 10;

352 cÚ¡ 
	gINVALID_N_SENTINEL
 = -1;

354 
š™Buck‘
(
Buck‘Ty³
* 
buck‘
) {

355 
	gbuck‘
->
	g_»£rved1
 = 0;

356 
	gbuck‘
->
	g_wasSize
 = 
Buck‘Size
;

357 
	gbuck‘
->
	g»£rved
 = 0;

361 
	sBŒ“LayoutV1
 {

362 
	gFixedWidthKey
<
	tDiskLoc56B™
> 
	tFixedWidthKeyTy³
;

363 
KeyV1
 
	tKeyTy³
;

364 
KeyV1OwÃd
 
	tKeyOwÃdTy³
;

365 
DiskLoc56B™
 
	tLocTy³
;

366 
BŒ“Buck‘V1
 
	tBuck‘Ty³
;

368 ’um { 
	gBuck‘Size
 = 8192 - 16,

369 
	gBuck‘BodySize
 = 
Buck‘Size
 - 
Buck‘Ty³
::
H—d”Size


372 cÚ¡ 
	gKeyMax
 = 1024;

375 cÚ¡ 
	gINVALID_N_SENTINEL
 = 0xffff;

377 
š™Buck‘
(
Buck‘Ty³
* 
buck‘
) { }

380 #´agm¨
·ck
()

	@btree/btree_test_help.cpp

32 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_‹¡_h–p.h
"

34 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt_noİ.h
"

35 
	~"mÚgo/un™‹¡/un™‹¡.h
"

38 
Çme¥aû
 
	gmÚgo
 {

40 
¡ršg
 
bigNumSŒšg
(
n
, 
Ën
) {

41 
	gsub
[17];

42 
¥rštf
(
sub
, "%.16Îx", 
n
);

43 
¡ršg
 
v®
(
Ën
, ' ');

44 
	gi
 = 0; i < 
	gËn
; ++i) {

45 
	gv®
[
i
] = 
sub
[i % 16];

47  
	gv®
;

50 
BSONObj
 
sim¶eKey
(
c
, 
n
) {

51 
BSONObjBud”
 
	gbud”
;

52 
¡ršg
 
v®
(
n
, 
c
);

53 
	gbud”
.
­³nd
("a", 
v®
);

54  
	gbud”
.
obj
();

61 
Buck‘D–‘iÚNÙifiÿtiÚ
 
	gdummyBuck‘D–‘iÚNÙifiÿtiÚ
;

63 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

64 
	gBŒ“LogicTe¡H–³r
<
	gOnDiskFÜm©
>::
BŒ“LogicTe¡H–³r
(cÚ¡ 
BSONObj
& 
Üd”
)

65 : 
»cÜdStÜe
("TestRecordStore"),

66 
bŒ“
(&
h—dMªag”
,

67 &
»cÜdStÜe
,

68 
Ord”šg
::
make
(
Üd”
),

70 &
dummyBuck‘D–‘iÚNÙifiÿtiÚ
) {

72 cÚ¡ 
¡ršg
 
¿ndomD©a
("RandomStuff");

76 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

77 
	gStusW™h
<
	gDiskLoc
> 
	gs
 =

78 
»cÜdStÜe
.
š£¹RecÜd
(&
txn
, 
¿ndomD©a
.
c_¡r
(),„ªdomD©a.
Ëngth
(), 0);

80 
ASSERT_TRUE
(
s
.
isOK
());

81 
ASSERT_EQUALS
(1, 
»cÜdStÜe
.
numRecÜds
());

83 
	gdummyDiskLoc
 = 
s
.
g‘V®ue
();

91 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

92 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
makeT»e
(cÚ¡ 
¡ršg
 &
¥ec
) {

93 
_h–³r
->
h—dMªag”
.
£tH—d
(
_txn
, 
makeT»e
(
äomjsÚ
(
¥ec
)));

96 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

97 
DiskLoc
 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
makeT»e
(cÚ¡ 
BSONObj
 &
¥ec
) {

98 
DiskLoc
 
buck‘Loc
 = 
_h–³r
->
bŒ“
.
_addBuck‘
(
_txn
);

99 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
->
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

101 
BSONObjI‹¿tÜ
 
i
(
¥ec
);

102 
	gi
.
mÜe
()) {

103 
BSONEËm’t
 
	ge
 = 
i
.
Ãxt
();

104 
DiskLoc
 
	gchd
;

105 ià(
	ge
.
ty³
(è=ğ
Objeù
) {

106 
chd
 = 
makeT»e
(
e
.
embeddedObjeù
());

109 ià(
	ge
.
f›ldName
(è=ğ
¡ršg
("_")) {

110 
buck‘
->
ÃxtChd
 = 
chd
;

113 
KeyD©aOwÃdTy³
 
key
(
BSON
("" << 
ex³ùedKey
(
e
.
f›ldName
())));

114 
	g_h–³r
->
	gbŒ“
.
_pushBack
(
buck‘
, 
_h–³r
->
dummyDiskLoc
, 
key
, 
chd
);

118 
	g_h–³r
->
	gbŒ“
.
fixP¬’tPŒs
(
_txn
, 
buck‘
, 
buck‘Loc
);

119  
	gbuck‘Loc
;

122 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

123 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
checkSŒuùu»
(cÚ¡ 
¡ršg
 &
¥ec
) const {

124 
checkSŒuùu»
(
äomjsÚ
(
¥ec
), 
_h–³r
->
h—dMªag”
.
g‘H—d
());

127 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

128 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
push
(

129 cÚ¡ 
DiskLoc
 
buck‘Loc
, cÚ¡ 
BSONObj
& 
key
, cÚ¡ DiskLoø
chd
) {

130 
KeyD©aOwÃdTy³
 
k
(
key
);

131 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
->
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

133 
	g_h–³r
->
	gbŒ“
.
_pushBack
(
buck‘
, 
_h–³r
->
dummyDiskLoc
, 
k
, 
chd
);

134 
	g_h–³r
->
	gbŒ“
.
fixP¬’tPŒs
(
_txn
, 
buck‘
, 
buck‘Loc
);

137 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

138 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
checkSŒuùu»
(

139 cÚ¡ 
BSONObj
 &
¥ec
, cÚ¡ 
DiskLoc
 
node
) const {

140 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
->
bŒ“
.
g‘Buck‘
(
node
);

142 
BSONObjI‹¿tÜ
 
j
(
¥ec
);

143 
	gi
 = 0; i < 
	gbuck‘
->
	gn
; ++i) {

144 
ASSERT
(
j
.
mÜe
());

145 
BSONEËm’t
 
	ge
 = 
j
.
Ãxt
();

146 
KeyH—d”Ty³
 
	gkn
 = 
BŒ“Logic
<
OnDiskFÜm©
>::
g‘KeyH—d”
(
buck‘
, 
i
);

147 
¡ršg
 
	gex³ùed
 = 
ex³ùedKey
(
e
.
f›ldName
());

148 
ASSERT
(
isP»£Á
(
BSON
("" << 
ex³ùed
), 1));

149 
ASSERT
(
isP»£Á
(
BSON
("" << 
ex³ùed
), -1));

152 ià(
	gkn
.
	g´evChdBuck‘
.
isNuÎ
()) {

153 
ASSERT
(
e
.
ty³
(è=ğ
j¡NULL
);

156 
ASSERT
(
e
.
ty³
(è=ğ
Objeù
);

157 
checkSŒuùu»
(
e
.
embeddedObjeù
(), 
kn
.
´evChdBuck‘
);

160 ià(
	gbuck‘
->
	gÃxtChd
.
isNuÎ
()) {

162 
ASSERT
(!
j
.
mÜe
());

165 
BSONEËm’t
 
	ge
 = 
j
.
Ãxt
();

166 
ASSERT_EQUALS
(
¡ršg
("_"), 
e
.
f›ldName
());

167 
ASSERT
(
e
.
ty³
(è=ğ
Objeù
);

168 
checkSŒuùu»
(
e
.
embeddedObjeù
(), 
buck‘
->
ÃxtChd
);

170 
ASSERT
(!
j
.
mÜe
());

173 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

174 
boŞ
 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
isP»£Á
(cÚ¡ 
BSONObj
 &
key
, 
dœeùiÚ
) const {

175 
	gpos
;

176 
DiskLoc
 
	gloc
;

177  
	g_h–³r
->
	gbŒ“
.
loÿ‹
(
key
, 
_h–³r
->
dummyDiskLoc
, 
dœeùiÚ
, &
pos
, &
loc
);

181 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

182 
¡ršg
 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
ex³ùedKey
(cÚ¡ *
¥ec
) {

183 ià(
¥ec
[0] != '$') {

184  
¥ec
;

186 *
	g’dPŒ
;

189 
	gnum
 = 
¡¹Ş
(
¥ec
 + 1, &
’dPŒ
, 16);

190 
	gËn
 = 800;

191 ià(*
	g’dPŒ
 == '$') {

192 
Ën
 = 
¡¹Ş
(
’dPŒ
 + 1, 0, 16);

195  
bigNumSŒšg
(
num
, 
Ën
);

198 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

199 
	gA¹ificŸlT»eBud”
<
	gOnDiskFÜm©
>::
flBuck‘ToExaùSize
(

200 cÚ¡ 
DiskLoc
 
buck‘Loc
, 
rg‘Size
, 
¡¬tKey
) {

201 
ASSERT_FALSE
(
buck‘Loc
.
isNuÎ
());

203 
Buck‘Ty³
* 
	gbuck‘
 = 
_h–³r
->
bŒ“
.
g‘Buck‘
(
buck‘Loc
);

204 
ASSERT_EQUALS
(0, 
buck‘
->
n
);

206 cÚ¡ 
	gbigSize
 = 
KeyD©aOwÃdTy³
(
sim¶eKey
('a', 801)).
d©aSize
();

208 
	gsize
 = 0;

209 
	gkeyCouÁ
 = 0;

210 
	gsize
 < 
	grg‘Size
) {

211 
	g¥aû
 = 
rg‘Size
 - 
size
;

212 
	gÃxtSize
 = 
¥aû
 - (
FixedWidthKeyTy³
);

213 
v”ify
(
ÃxtSize
 > 0);

215 
BSONObj
 
	gÃwKey
;

216 ià(
	gÃxtSize
 >ğ
bigSize
) {

217 
ÃwKey
 = 
sim¶eKey
(
¡¬tKey
++, 801);

220 
	gÃwKey
 = 
sim¶eKey
(
¡¬tKey
++, 
ÃxtSize
 - (
bigSize
 - 801));

223 
push
(
buck‘Loc
, 
ÃwKey
, 
DiskLoc
());

225 
	gsize
 +ğ
KeyD©aOwÃdTy³
(
ÃwKey
).
d©aSize
() +

226 (
FixedWidthKeyTy³
);

227 
	gkeyCouÁ
 += 1;

230 
ASSERT_EQUALS
(
_h–³r
->
bŒ“
.
_·ckedD©aSize
(
buck‘
, 0), 
rg‘Size
);

232  
	gkeyCouÁ
;

240 
‹m¶©e
 
	gBŒ“LogicTe¡H–³r
<
	gBŒ“LayoutV0
>;

241 
‹m¶©e
 
şass
 
	gA¹ificŸlT»eBud”
<
	gBŒ“LayoutV0
>;

244 
‹m¶©e
 
	gBŒ“LogicTe¡H–³r
<
	gBŒ“LayoutV1
>;

245 
‹m¶©e
 
şass
 
	gA¹ificŸlT»eBud”
<
	gBŒ“LayoutV1
>;

	@btree/btree_test_help.h

29 #´agm¨
Úû


31 
	~<¡ršg
>

33 
	~"mÚgo/db/jsÚ.h
"

34 
	~"mÚgo/db/¡ruùu»/bŒ“/bŒ“_logic.h
"

35 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_h—p.h
"

36 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_‹¡_h–p.h
"

39 
Çme¥aû
 
	gmÚgo
 {

45 
	g¡d
::
¡ršg
 
bigNumSŒšg
(
n
, 
Ën
);

50 
BSONObj
 
sim¶eKey
(
c
, 
n
 = 1);

55 şas 
	cTe¡H—dMªag”
 : 
public
 
H—dMªag”
 {

56 
public
:

57 
vœtu®
 cÚ¡ 
DiskLoc
 
g‘H—d
() const {

58  
_h—d
;

61 
vœtu®
 
£tH—d
(
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
 
ÃwH—d
) {

62 
	g_h—d
 = 
ÃwH—d
;

65 
	g´iv©e
:

66 
DiskLoc
 
_h—d
;

74 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

75 
	sBŒ“LogicTe¡H–³r
 {

76 
BŒ“LogicTe¡H–³r
(cÚ¡ 
BSONObj
& 
Üd”
);

79 
Te¡H—dMªag”
 
	gh—dMªag”
;

80 
H—pRecÜdStÜe
 
	g»cÜdStÜe
;

81 
	gBŒ“Logic
<
	gOnDiskFÜm©
> 
	gbŒ“
;

82 
DiskLoc
 
	gdummyDiskLoc
;

89 
	g‹m¶©e
 <
şass
 
	gOnDiskFÜm©
>

90 şas 
	cA¹ificŸlT»eBud”
 {

91 
	gpublic
:

93 
ty³Çme
 
	tBŒ“Logic
<
	tOnDiskFÜm©
>::
	tBuck‘Ty³
 BucketType;

94 
ty³Çme
 
	tBŒ“Logic
<
	tOnDiskFÜm©
>::
	tKeyD©aOwÃdTy³
 KeyDataOwnedType;

95 
ty³Çme
 
	tBŒ“Logic
<
	tOnDiskFÜm©
>::
	tKeyH—d”Ty³
 KeyHeaderType;

97 
ty³Çme
 
	tOnDiskFÜm©
::
	tFixedWidthKeyTy³
 FixedWidthKeyType;

104 
A¹ificŸlT»eBud”
(
O³¿tiÚCÚ‹xt
* 
txn
,

105 
BŒ“LogicTe¡H–³r
<
OnDiskFÜm©
>* 
h–³r
)

106 : 
_txn
(
txn
), 
_h–³r
(
h–³r
) {

124 
makeT»e
(cÚ¡ 
¡d
::
¡ršg
& 
¥ec
);

129 
checkSŒuùu»
(cÚ¡ 
¡d
::
¡ršg
& 
¥ec
) const;

134 
push
(cÚ¡ 
DiskLoc
 
buck‘Loc
, cÚ¡ 
BSONObj
& 
key
, cÚ¡ DiskLoø
chd
);

139 
flBuck‘ToExaùSize
(cÚ¡ 
DiskLoc
 
buck‘Loc
, 
rg‘Size
, 
¡¬tKey
);

141 
	g´iv©e
:

142 
DiskLoc
 
makeT»e
(cÚ¡ 
BSONObj
& 
¥ec
);

144 
checkSŒuùu»
(cÚ¡ 
BSONObj
& 
¥ec
, cÚ¡ 
DiskLoc
 
node
) const;

146 
boŞ
 
isP»£Á
(cÚ¡ 
BSONObj
& 
key
, 
dœeùiÚ
) const;

148 
¡ršg
 
ex³ùedKey
(cÚ¡ * 
¥ec
);

150 
O³¿tiÚCÚ‹xt
* 
	g_txn
;

151 
	gBŒ“LogicTe¡H–³r
<
	gOnDiskFÜm©
>* 
	g_h–³r
;

	@btree/bucket_deletion_notification.h

29 #´agm¨
Úû


31 
	~"mÚgo/db/diskloc.h
"

33 
Çme¥aû
 
	gmÚgo
 {

41 şas 
	cBuck‘D–‘iÚNÙifiÿtiÚ
 {

42 
	gpublic
:

49 
vœtu®
 
aboutToD–‘eBuck‘
(cÚ¡ 
DiskLoc
& 
buck‘
) { }

51 
vœtu®
 ~
Buck‘D–‘iÚNÙifiÿtiÚ
() { }

	@btree/key.cpp

31 
	~"mÚgo/pch.h
"

33 
	~"mÚgo/db/¡ruùu»/bŒ“/key.h
"

35 
	~"mÚgo/bsÚ/ut/bud”.h
"

36 
	~"mÚgo/¶©fÜm/æßt_uts.h
"

37 
	~"mÚgo/ut/¡¬tup_‹¡.h
"

40 
Çme¥aû
 
	gmÚgo
 {

42 cÚ¡ 
Ord”šg
 
nuÎOrd”šg
 = Ord”šg::
make
(
BSONObj
());

46 
ŞdCom·»
(cÚ¡ 
BSONObj
& 
l
,cÚ¡ BSONObj& 
r
, cÚ¡ 
Ord”šg
 &
o
);

50 
ŞdCom·»EËm’tV®ues
(cÚ¡ 
BSONEËm’t
& 
l
, cÚ¡ BSONEËm’t& 
r
) {

51 
das£¹
Ğ
l
.
ÿnÚiÿlTy³
(è=ğ
r
.canonicalType() );

52 
	gf
;

53 
	gx
;

55  
	gl
.
ty³
() ) {

56 
	gEOO
:

57 
Undefšed
:

58 
j¡NULL
:

59 
MaxKey
:

60 
MšKey
:

62 
	gBoŞ
:

63  *
l
.
v®ue
(è- *
r
.value();

64 
	gTime¡amp
:

65 
D©e
:

67 iàĞ
l
.
d©e
(è< 
r
.date() )

69  
	gl
.
d©e
(è=ğ
r
.date() ? 0 : 1;

70 
	gNumb”LÚg
:

71 ifĞ
r
.
ty³
(è=ğ
Numb”LÚg
 ) {

72 
L
 = 
l
.
_numb”LÚg
();

73 
	gR
 = 
r
.
_numb”LÚg
();

74 ifĞ
	gL
 < 
	gR
 )  -1;

75 ifĞ
	gL
 =ğ
R
 )  0;

79 
	gNumb”IÁ
:

80 
Numb”DoubË
: {

81 
Ëá
 = 
l
.
numb”
();

82 
	gright
 = 
r
.
numb”
();

83 
boŞ
 
	glNª
 = !Ğ
Ëá
 <ğ
num”ic_lim™s
< >::
max
() &&

84 
Ëá
 >ğ-
num”ic_lim™s
< >::
max
() );

85 
boŞ
 
	grNª
 = !Ğ
right
 <ğ
num”ic_lim™s
< >::
max
() &&

86 
right
 >ğ-
num”ic_lim™s
< >::
max
() );

87 iàĞ
	glNª
 ) {

88 iàĞ
	grNª
 ) {

95 iàĞ
	grNª
 ) {

98 
	gx
 = 
Ëá
 - 
right
;

99 iàĞ
	gx
 < 0 )  -1;

100  
	gx
 == 0 ? 0 : 1;

102 
	gj¡OID
:

103  
memcmp
(
l
.
v®ue
(), 
r
.value(), 12);

104 
	gCode
:

105 
SymbŞ
:

106 
SŒšg
:

108  
¡rcmp
(
l
.
v®ue¡r
(), 
r
.valuestr());

109 
	gObjeù
:

110 
A¼ay
:

111  
ŞdCom·»
(
l
.
embeddedObjeù
(), 
r
.embeddedObjeù(), 
nuÎOrd”šg
);

112 
	gDBRef
: {

113 
lsz
 = 
l
.
v®uesize
();

114 
	grsz
 = 
r
.
v®uesize
();

115 iàĞ
	glsz
 - 
	grsz
 !ğ0 )  
lsz
 - 
rsz
;

116  
memcmp
(
l
.
v®ue
(), 
r
.v®ue(), 
lsz
);

118 
	gBšD©a
: {

119 
lsz
 = 
l
.
objsize
();

120 
	grsz
 = 
r
.
objsize
();

121 iàĞ
	glsz
 - 
	grsz
 !ğ0 )  
lsz
 - 
rsz
;

122  
memcmp
(
l
.
v®ue
()+4, 
r
.v®ue()+4, 
lsz
+1);

124 
	gRegEx
: {

125 
c
 = 
¡rcmp
(
l
.
»gex
(), 
r
.regex());

126 iàĞ
	gc
 )

127  
	gc
;

128  
¡rcmp
(
l
.
»gexFÏgs
(), 
r
.regexFlags());

130 
	gCodeWScİe
 : {

131 
f
 = 
l
.
ÿnÚiÿlTy³
(è- 
r
.canonicalType();

132 iàĞ
	gf
 )

133  
	gf
;

134 
	gf
 = 
¡rcmp
Ğ
l
.
codeWScİeCode
(è, 
r
.codeWScopeCode() );

135 iàĞ
	gf
 )

136  
	gf
;

137 
	gf
 = 
¡rcmp
Ğ
l
.
codeWScİeScİeD©aUn§ã
(è, 
r
.codeWScopeScopeDataUnsafe() );

138 iàĞ
	gf
 )

139  
	gf
;

143 
log
(è<< "ŞdCom·»EËm’tV®ues: bady³ " << (è
l
.
ty³
(è<< 
’dl
;

144 
v”ify
(
çl£
);

149 
ŞdEËmCom·»
(cÚ¡ 
BSONEËm’t
&
l
 , cÚ¡ BSONEËm’t& 
r
) {

150 
	gÉ
 = (è
l
.
ÿnÚiÿlTy³
();

151 
	g¹
 = (è
r
.
ÿnÚiÿlTy³
();

152 
	gx
 = 
É
 - 
¹
;

153 ifĞ
	gx
 )

154  
	gx
;

155  
ŞdCom·»EËm’tV®ues
(
l
, 
r
);

159 
ŞdCom·»
(cÚ¡ 
BSONObj
& 
l
,cÚ¡ BSONObj& 
r
, cÚ¡ 
Ord”šg
 &
o
) {

160 
BSONObjI‹¿tÜ
 
i
(
l
);

161 
BSONObjI‹¿tÜ
 
j
(
r
);

162 
	gmask
 = 1;

166 
BSONEËm’t
 
	gl
 = 
i
.
Ãxt
();

167 
BSONEËm’t
 
	gr
 = 
j
.
Ãxt
();

168 iàĞ
	gl
.
eoo
() )

169  
	gr
.
eoo
() ? 0 : -1;

170 iàĞ
	gr
.
eoo
() )

173 
	gx
;

175 
	gx
 = 
ŞdEËmCom·»
(
l
, 
r
);

176 ifĞ
	go
.
desûndšg
(
mask
) )

177 
	gx
 = -
x
;

179 iàĞ
	gx
 != 0 )

180  
x
;

181 
	gmask
 <<= 1;

190 
	gKeyBsÚ
::
woCom·»
(cÚ¡ 
KeyBsÚ
& 
r
, cÚ¡ 
Ord”šg
 &
o
) const {

191  
ŞdCom·»
(
_o
, 
r
._o, 
o
);

195 
boŞ
 
	gKeyBsÚ
::
woEqu®
(cÚ¡ 
KeyBsÚ
& 
r
) const {

196  
ŞdCom·»
(
_o
, 
r
._o, 
nuÎOrd”šg
) == 0;

200 
	eCªÚiÿlsEtc
 {

201 
	gcmškey
=1,

202 
	gúuÎ
=2,

203 
	gcdoubË
=4,

204 
	gc¡ršg
=6,

205 
	gcbšd©a
=7,

206 
	gcoid
=8,

207 
	gcçl£
=10,

208 
	gùrue
=11,

209 
	gcd©e
=12,

210 
	gcmaxkey
=14,

211 
	gcCANONTYPEMASK
 = 0xf,

212 
	gcY
 = 0x10,

213 
	gcšt
 = 
cY
 | 
cdoubË
,

214 
	gcX
 = 0x20,

215 
	gşÚg
 = 
cX
 | 
cdoubË
,

216 
	gcHASMORE
 = 0x40,

217 
	gcNOTUSED
 = 0x80

221 cÚ¡ 
	gBšD©aL’Mask
 = 0xf0;

222 cÚ¡ 
	gBšD©aTy³Mask
 = 0x0f;

223 cÚ¡ 
	gBšD©aL’Max
 = 32;

224 cÚ¡ 
	gBšD©aL’gthToCode
[] = {

231 cÚ¡ 
	gBšD©aCodeToL’gth
[] = {

235 
bšD©aCodeToL’gth
(
codeBy‹
) {

236  
	gBšD©aCodeToL’gth
[
codeBy‹
 >> 4];

245 
	gKeyV1OwÃd
::
Œad™iÚ®
(cÚ¡ 
BSONObj
& 
obj
) {

246 
b
.
»£t
();

247 
	gb
.
­³ndUCh¬
(
IsBSON
);

248 
	gb
.
­³ndBuf
(
obj
.
objd©a
(), obj.
objsize
());

249 
	g_keyD©a
 = (cÚ¡ *è
b
.
buf
();

252 
	gKeyV1OwÃd
::
KeyV1OwÃd
(cÚ¡ 
KeyV1
& 
rhs
) {

253 
b
.
­³ndBuf
Ğ
rhs
.
d©a
(),„hs.
d©aSize
() );

254 
	g_keyD©a
 = (cÚ¡ *è
b
.
buf
();

255 
das£¹
Ğ
b
.
Ën
(è=ğ
d©aSize
() );

256 
das£¹
Ğ(*
_keyD©a
 & 
cNOTUSED
) == 0 );

260 
	gKeyV1OwÃd
::
KeyV1OwÃd
(cÚ¡ 
BSONObj
& 
obj
) {

261 
BSONObj
::
™”©Ü
 
i
(
obj
);

262 
	gb™s
 = 0;

264 
BSONEËm’t
 
	ge
 = 
i
.
Ãxt
();

265 ifĞ
	gi
.
mÜe
() )

266 
	gb™s
 |ğ
cHASMORE
;

267  
	ge
.
ty³
() ) {

268 
	gMšKey
:

269 
b
.
­³ndUCh¬
(
cmškey
|
b™s
);

271 
	gj¡NULL
:

272 
b
.
­³ndUCh¬
(
úuÎ
|
b™s
);

274 
	gMaxKey
:

275 
b
.
­³ndUCh¬
(
cmaxkey
|
b™s
);

277 
	gBoŞ
:

278 
b
.
­³ndUCh¬
Ğ(
e
.
boŞ—n
()?
ùrue
:
cçl£
è| 
b™s
 );

280 
	gj¡OID
:

281 
b
.
­³ndUCh¬
(
coid
|
b™s
);

282 
	gb
.
­³ndBuf
(&
e
.
__oid
(), (
OID
));

284 
	gBšD©a
:

286 
t
 = 
e
.
bšD©aTy³
();

288 ifĞ(
	gt
 & 0x78è=ğ0 && 
t
 !ğ
By‹A¼ayD•»ÿ‹d
 ) {

289 
Ën
;

290 cÚ¡ * 
	gd
 = 
e
.
bšD©a
(
Ën
);

291 ifĞ
	gËn
 <ğ
BšD©aL’Max
 ) {

292 
code
 = 
BšD©aL’gthToCode
[
Ën
];

293 ifĞ
	gcode
 >= 0 ) {

294 ifĞ
t
 >= 128 )

295 
t
 = (t-128) | 0x08;

296 
das£¹
Ğ(
code
&
t
) == 0 );

297 
	gb
.
­³ndUCh¬
Ğ
cbšd©a
|
b™s
 );

298 
	gb
.
­³ndUCh¬
Ğ
code
 | 
t
 );

299 
	gb
.
­³ndBuf
(
d
, 
Ën
);

304 
Œad™iÚ®
(
obj
);

307 
	gD©e
:

308 
b
.
­³ndUCh¬
(
cd©e
|
b™s
);

309 
	gb
.
­³ndSŒuù
(
e
.
d©e
());

311 
	gSŒšg
:

313 
b
.
­³ndUCh¬
(
c¡ršg
|
b™s
);

315 
	gx
 = (è
e
.
v®ue¡rsize
() - 1;

316 ifĞ
	gx
 > 255 ) {

317 
Œad™iÚ®
(
obj
);

320 
	gb
.
­³ndUCh¬
(
x
);

321 
	gb
.
­³ndBuf
(
e
.
v®ue¡r
(), 
x
);

324 
	gNumb”IÁ
:

325 
b
.
­³ndUCh¬
(
cšt
|
b™s
);

326 
	gb
.
­³ndNum
((è
e
.
_numb”IÁ
());

328 
	gNumb”LÚg
:

330 
n
 = 
e
.
_numb”LÚg
();

331 
	gm
 = 2LL << 52;

332 
	gDEV
 {

333 
	gd
 = 
m
-1;

334 
v”ify
Ğ((è((è-
d
)) == -d );

336 ifĞ
	gn
 >ğ
m
 || 
n
 <= -m ) {

338 
Œad™iÚ®
(
obj
);

341 
	gb
.
­³ndUCh¬
(
şÚg
|
b™s
);

342 
	gb
.
­³ndNum
((è
n
);

345 
	gNumb”DoubË
:

347 
d
 = 
e
.
_numb”DoubË
();

348 ifĞ
isNaN
(
d
) ) {

349 
Œad™iÚ®
(
obj
);

352 
	gb
.
­³ndUCh¬
(
cdoubË
|
b™s
);

353 
	gb
.
­³ndNum
(
d
);

358 
Œad™iÚ®
(
obj
);

361 ifĞ!
	gi
.
mÜe
() )

363 
	gb™s
 = 0;

365 
	g_keyD©a
 = (cÚ¡ *è
b
.
buf
();

366 
das£¹
Ğ
b
.
Ën
(è=ğ
d©aSize
() );

367 
das£¹
Ğ(*
_keyD©a
 & 
cNOTUSED
) == 0 );

370 
BSONObj
 
	gKeyV1
::
toBsÚ
() const {

371 
v”ify
Ğ
_keyD©a
 != 0 );

372 ifĞ!
isCom·ùFÜm©
() )

373  
bsÚ
();

375 
BSONObjBud”
 
b
(512);

376 cÚ¡ *
	gp
 = 
_keyD©a
;

378 
	gb™s
 = *
p
++;

380  
	gb™s
 & 0x3f ) {

381 
	gcmškey
: 
b
.
­³ndMšKey
(""); ;

382 
	gúuÎ
: 
b
.
­³ndNuÎ
(""); ;

383 
	gcçl£
: 
b
.
­³ndBoŞ
("", 
çl£
); ;

384 
	gùrue
: 
b
.
­³ndBoŞ
("", 
Œue
); ;

385 
	gcmaxkey
:

386 
b
.
­³ndMaxKey
("");

388 
	gc¡ršg
:

390 
sz
 = *
p
++;

392 
	gBufBud”
 &
	gbb
 = 
b
.
bb
();

393 
	gbb
.
­³ndNum
((è
SŒšg
);

394 
	gbb
.
­³ndUCh¬
(0);

395 
	gbb
.
­³ndNum
(
sz
+1);

396 
	gbb
.
­³ndBuf
(
p
, 
sz
);

397 
	gbb
.
­³ndUCh¬
(0);

398 
	gp
 +ğ
sz
;

401 
	gcoid
:

402 
b
.
­³ndOID
("", (
OID
 *è
p
);

403 
	gp
 +ğ(
OID
);

405 
	gcbšd©a
:

407 
Ën
 = 
bšD©aCodeToL’gth
(*
p
);

408 
	gsubty³
 = (*
p
è& 
BšD©aTy³Mask
;

409 ifĞ
	gsubty³
 & 0x8 ) {

410 
	gsubty³
 = (
subty³
 & 0x7) | 0x80;

412 
	gb
.
­³ndBšD©a
("", 
Ën
, (
BšD©aTy³
è
subty³
, ++
p
);

413 
	gp
 +ğ
Ën
;

416 
	gcd©e
:

417 
b
.
­³ndD©e
("", (
D©e_t
&è*
p
);

418 
	gp
 += 8;

420 
	gcdoubË
:

421 
b
.
­³nd
("", (&è*
p
);

422 
	gp
 += ();

424 
	gcšt
:

425 
b
.
­³nd
("", 
¡©ic_ÿ¡
< >((
»š‹½»t_ÿ¡
< cÚ¡ 
PackedDoubË
& >(*
p
)).
d
));

426 
	gp
 += ();

428 
	gşÚg
:

429 
b
.
­³nd
("", 
¡©ic_ÿ¡
< >((
»š‹½»t_ÿ¡
< cÚ¡ 
PackedDoubË
& >(*
p
)).
d
));

430 
	gp
 += ();

433 
v”ify
(
çl£
);

436 ifĞ(
	gb™s
 & 
	gcHASMORE
) == 0 )

439  
	gb
.
obj
();

442 
com·»
(cÚ¡ *&
l
, cÚ¡ *&
r
) {

443 
	gÉ
 = (*
l
 & 
cCANONTYPEMASK
);

444 
	g¹
 = (*
r
 & 
cCANONTYPEMASK
);

445 
	gx
 = 
É
 - 
¹
;

446 ifĞ
	gx
 )

447  
	gx
;

449 
	gl
++; 
	gr
++;

452  
	gÉ
 ) {

453 
	gcdoubË
:

455 
L
 = (
»š‹½»t_ÿ¡
< cÚ¡ 
PackedDoubË
* >(
l
))->
d
;

456 
	gR
 = (
»š‹½»t_ÿ¡
< cÚ¡ 
PackedDoubË
* >(
r
))->
d
;

457 ifĞ
	gL
 < 
	gR
 )

459 ifĞ
	gL
 !ğ
R
 )

461 
	gl
 +ğ8; 
	gr
 += 8;

464 
	gc¡ršg
:

466 
lsz
 = *
l
;

467 
	grsz
 = *
r
;

468 
	gcommÚ
 = 
mš
(
lsz
, 
rsz
);

469 
	gl
++; 
	gr
++;

471 
	g»s
 = 
memcmp
(
l
, 
r
, 
commÚ
);

472 ifĞ
	g»s
 )

473  
	g»s
;

475 
	gdiff
 = 
lsz
-
rsz
;

476 ifĞ
	gdiff
 )

477  
	gdiff
;

478 
	gl
 +ğ
lsz
; 
	gr
 +=†sz;

481 
	gcbšd©a
:

483 
L
 = *
l
;

484 
	gR
 = *
r
;

485 
	gÎ’
 = 
bšD©aCodeToL’gth
(
L
);

486 
	gdiff
 = 
L
-
R
;

487 ifĞ
	gdiff
 ) {

489 
	g¾’
 = 
bšD©aCodeToL’gth
(
R
);

490 ifĞ
	gÎ’
 !ğ
¾’
 )

491  
Î’
 - 
¾’
;

492  
	gdiff
;

495 
	gl
++; 
	gr
++;

496 
	g»s
 = 
memcmp
(
l
, 
r
, 
Î’
);

497 ifĞ
	g»s
 )

498  
	g»s
;

499 
	gl
 +ğ
Î’
; 
	gr
 +=†len;

502 
	gcd©e
:

504 
L
 = *((*è
l
);

505 
	gR
 = *((*è
r
);

506 ifĞ
	gL
 < 
	gR
 )

508 ifĞ
	gL
 > 
	gR
 )

510 
	gl
 +ğ8; 
	gr
 += 8;

513 
	gcoid
:

515 
»s
 = 
memcmp
(
l
, 
r
, (
OID
));

516 ifĞ
	g»s
 )

517  
	g»s
;

518 
	gl
 +ğ12; 
	gr
 += 12;

530 
NOINLINE_DECL
 
	gKeyV1
::
com·»Hybrid
(cÚ¡ 
KeyV1
& 
right
, cÚ¡ 
Ord”šg
& 
Üd”
) const {

531 
BSONObj
 
	gL
 = 
toBsÚ
();

532 
BSONObj
 
	gR
 = 
right
.
toBsÚ
();

533  
	gL
.
woCom·»
(
R
, 
Üd”
, 
çl£
);

536 
	gKeyV1
::
woCom·»
(cÚ¡ 
KeyV1
& 
right
, cÚ¡ 
Ord”šg
 &
Üd”
) const {

537 cÚ¡ *
	gl
 = 
_keyD©a
;

538 cÚ¡ *
	gr
 = 
right
.
_keyD©a
;

540 ifĞ(*
	gl
|*
	gr
è=ğ
IsBSON
 )

541  
com·»Hybrid
(
right
, 
Üd”
);

543 
	gmask
 = 1;

545 
	glv®
 = *
l
;

546 
	grv®
 = *
r
;

548 
	gx
 = 
com·»
(
l
, 
r
);

549 ifĞ
	gx
 ) {

550 ifĞ
	gÜd”
.
desûndšg
(
mask
) )

551 
	gx
 = -
x
;

552  
	gx
;

557 
	gx
 = (()(
lv®
 & 
cHASMORE
)è- (()(
rv®
 & cHASMORE));

558 ifĞ
	gx
 )

559  
	gx
;

560 ifĞ(
	glv®
 & 
	gcHASMORE
) == 0 )

564 
	gmask
 <<= 1;

570 
	gsizes
[] = {

589 
šlše
 
sizeOfEËm’t
(cÚ¡ *
p
) {

590 
	gty³
 = *
p
 & 
cCANONTYPEMASK
;

591 
	gsz
 = 
sizes
[
ty³
];

592 ifĞ
	gsz
 == 0 ) {

593 ifĞ
ty³
 =ğ
c¡ršg
 ) {

594 
sz
 = ((è
p
[1]) + 2;

597 
v”ify
Ğ
ty³
 =ğ
cbšd©a
 );

598 
	gsz
 = 
bšD©aCodeToL’gth
(
p
[1]) + 2;

601  
	gsz
;

604 
	gKeyV1
::
d©aSize
() const {

605 cÚ¡ *
p
 = 
_keyD©a
;

606 ifĞ!
isCom·ùFÜm©
() ) {

607  
bsÚ
().
objsize
() + 1;

610 
boŞ
 
	gmÜe
;

612 
	gz
 = 
sizeOfEËm’t
(
p
);

613 
	gmÜe
 = (*
p
 & 
cHASMORE
) != 0;

614 
	gp
 +ğ
z
;

615 }  
	gmÜe
 );

616  
	gp
 - 
	g_keyD©a
;

619 
boŞ
 
	gKeyV1
::
woEqu®
(cÚ¡ 
KeyV1
& 
right
) const {

620 cÚ¡ *
l
 = 
_keyD©a
;

621 cÚ¡ *
	gr
 = 
right
.
_keyD©a
;

623 ifĞ(*
	gl
|*
	gr
è=ğ
IsBSON
 ) {

624  
toBsÚ
().
equ®
(
right
.toBson());

628 
	glv®
 = *
l
;

629 
	grv®
 = *
r
;

630 ifĞ(
	glv®
&(
	gcCANONTYPEMASK
|
	gcHASMORE
)è!ğ(
rv®
&(
cCANONTYPEMASK
|
cHASMORE
)) )

631  
çl£
;

632 
	gl
++; 
	gr
++;

633  
	glv®
&
	gcCANONTYPEMASK
 ) {

634 
	gcoid
:

635 ifĞ*((*è
l
è!ğ*((*è
r
) )

636  
çl£
;

637 
	gl
 +ğ4; 
	gr
 += 4;

638 
	gcd©e
:

639 ifĞ*((*è
l
è!ğ*((*è
r
) )

640  
çl£
;

641 
	gl
 +ğ8; 
	gr
 += 8;

643 
	gcdoubË
:

644 ifĞ(
»š‹½»t_ÿ¡
< cÚ¡ 
PackedDoubË
* > (
l
))->
d
 !ğÔeš‹½»t_ÿ¡< cÚ¡ PackedDoubË* >(
r
))->d )

645  
çl£
;

646 
	gl
 +ğ8; 
	gr
 += 8;

648 
	gc¡ršg
:

650 ifĞ*
l
 !ğ*
r
 )

651  
çl£
;

652 
	gsz
 = ((è*
l
) + 1;

653 ifĞ
memcmp
(
l
, 
r
, 
sz
) )

654  
	gçl£
;

655 
	gl
 +ğ
sz
; 
	gr
 += sz;

658 
	gcbšd©a
:

660 ifĞ*
l
 !ğ*
r
 )

661  
çl£
;

662 
	gËn
 = 
bšD©aCodeToL’gth
(*
l
) + 1;

663 ifĞ
memcmp
(
l
, 
r
, 
Ën
) )

664  
	gçl£
;

665 
	gl
 +ğ
Ën
; 
	gr
 +=†en;

668 
	gcmškey
:

669 
úuÎ
:

670 
cçl£
:

671 
ùrue
:

672 
cmaxkey
:

675 
v”ify
(
çl£
);

677 ifĞ(
	glv®
&
	gcHASMORE
) == 0 )

680  
	gŒue
;

683 
	gCmpUn™Te¡
 : 
public
 
S¹upTe¡
 {

684 
run
() {

685 
a
[2];

686 
	gb
[2];

687 
	ga
[0] = -3;

688 
	ga
[1] = 0;

689 
	gb
[0] = 3;

690 
	gb
[1] = 0;

691 
v”ify
Ğ
¡rcmp
(
a
,
b
)>0 && 
memcmp
(a,b,2)>0 );

693 } 
	gcun™‹¡
;

	@btree/key.h

31 #´agm¨
Úû


33 
	~"mÚgo/db/jsobj.h
"

35 
Çme¥aû
 
	gmÚgo
 {

43 şas 
	cKeyBsÚ
 {

44 
	gpublic
:

45 
KeyBsÚ
() { }

46 
ex¶ic™
 
KeyBsÚ
(cÚ¡ *
keyD©a
è: 
_o
(keyData) { }

47 
ex¶ic™
 
KeyBsÚ
(cÚ¡ 
BSONObj
& 
obj
è: 
_o
(obj) { }

48 
woCom·»
(cÚ¡ 
KeyBsÚ
& 
r
, cÚ¡ 
Ord”šg
 &
o
) const;

49 
BSONObj
 
toBsÚ
(ècÚ¡ {  
	g_o
; }

50 
	g¡d
::
¡ršg
 
toSŒšg
(ècÚ¡ {  
_o
.toString(); }

51 
d©aSize
(ècÚ¡ {  
	g_o
.
objsize
(); }

52 cÚ¡ * 
d©a
(ècÚ¡ {  
	g_o
.
objd©a
(); }

53 
BSONEËm’t
 
_fœ¡EËm’t
(ècÚ¡ {  
	g_o
.
fœ¡EËm’t
(); }

54 
boŞ
 
isCom·ùFÜm©
(ècÚ¡ {  
	gçl£
; }

55 
boŞ
 
woEqu®
(cÚ¡ 
KeyBsÚ
& 
r
) const;

56 
assign
(cÚ¡ 
KeyBsÚ
& 
rhs
è{ *
	gthis
 =„hs; }

57 
boŞ
 
isV®id
(ècÚ¡ {  
	gŒue
; }

58 
	g´iv©e
:

59 
BSONObj
 
_o
;

62 
şass
 
	gKeyV1OwÃd
;

65 şas 
	cKeyV1
 {

66 
	gİ”©Ü
=(cÚ¡ 
KeyV1
&);

67 
KeyV1
(cÚ¡ 
KeyV1OwÃd
&);

68 
	gpublic
:

69 
KeyV1
(è{ 
_keyD©a
 = 0; }

70 ~
KeyV1
(è{ 
DEV
 
	g_keyD©a
 = (const *) 1; }

72 
KeyV1
(cÚ¡ KeyV1& 
rhs
è: 
_keyD©a
(rhs._keyData) {

73 
das£¹
Ğ
_keyD©a
 > (const *) 1 );

77 
assign
(cÚ¡ 
KeyV1
& 
rhs
) {

78 
	g_keyD©a
 = 
rhs
.
_keyD©a
;

84 
ex¶ic™
 
KeyV1
(cÚ¡ *
keyD©a
è: 
_keyD©a
((*) keyData) { }

86 
woCom·»
(cÚ¡ 
KeyV1
& 
r
, cÚ¡ 
Ord”šg
 &
o
) const;

87 
boŞ
 
woEqu®
(cÚ¡ 
KeyV1
& 
r
) const;

88 
BSONObj
 
toBsÚ
() const;

89 
	g¡d
::
¡ršg
 
toSŒšg
(ècÚ¡ {  
toBsÚ
().toString(); }

92 cÚ¡ * 
d©a
(ècÚ¡ {  (cÚ¡ *è
	g_keyD©a
; }

95 
d©aSize
() const;

98 
BSONEËm’t
 
_fœ¡EËm’t
(ècÚ¡ {  
bsÚ
().
fœ¡EËm’t
(); }

99 
boŞ
 
isCom·ùFÜm©
(ècÚ¡ {  *
	g_keyD©a
 !ğ
IsBSON
; }

101 
boŞ
 
isV®id
(ècÚ¡ {  
	g_keyD©a
 > (const *)1; }

102 
	g´Ùeùed
:

103 ’um { 
IsBSON
 = 0xff };

104 cÚ¡ *
	g_keyD©a
;

105 
BSONObj
 
bsÚ
() const {

106 
das£¹
Ğ!
isCom·ùFÜm©
() );

107  
BSONObj
((cÚ¡ *è
_keyD©a
+1);

109 
	g´iv©e
:

110 
com·»Hybrid
(cÚ¡ 
KeyV1
& 
right
, cÚ¡ 
Ord”šg
& 
Üd”
) const;

113 şas 
	cKeyV1OwÃd
 : 
public
 
KeyV1
 {

114 
İ”©Ü
=(cÚ¡ 
KeyV1OwÃd
&);

115 
	gpublic
:

120 
KeyV1OwÃd
(cÚ¡ 
BSONObj
& 
obj
);

123 
KeyV1OwÃd
(cÚ¡ 
KeyV1
& 
rhs
);

125 
	g´iv©e
:

126 
SckBufBud”
 
b
;

127 
Œad™iÚ®
(cÚ¡ 
BSONObj
& 
obj
);

	@capped_callback.h

31 #´agm¨
Úû


33 
	~"mÚgo/db/diskloc.h
"

35 
Çme¥aû
 
	gmÚgo
 {

37 
şass
 
	gO³¿tiÚCÚ‹xt
;

44 şas 
	cC­³dDocum’tD–‘eC®lback
 {

45 
	gpublic
:

46 
vœtu®
 ~
C­³dDocum’tD–‘eC®lback
(){}

51 
vœtu®
 
Stus
 
aboutToD–‘eC­³d
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) = 0;

	@catalog/hashtab.h

35 #´agm¨
Úû


37 
	~"mÚgo/pch.h
"

38 
	~<m­
>

39 
	~"mÚgo/db/¡Üage/mm­_v1/dur.h
"

40 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

42 
Çme¥aû
 
	gmÚgo
 {

44 #´agm¨
·ck
(1)

51 
	g‹m¶©e
 <
şass
 
	gKey
,şas 
	gTy³
>

52 şas 
	cHashTabË
 : 
boo¡
::
nÚcİyabË
 {

53 
public
:

54 cÚ¡ *
Çme
;

55 
	sNode
 {

56 
	ghash
;

57 
Key
 
	gk
;

58 
Ty³
 
	gv®ue
;

59 
boŞ
 
šU£
() {

60  
	ghash
 != 0;

62 
£tUnu£d
() {

63 
	ghash
 = 0;

66 * 
	g_buf
;

67 
	gn
;

68 
	gmaxChaš
;

70 
	gNode
& 
nodes
(
i
) {

71 
Node
 *
	gnodes
 = (Nod*è
_buf
;

72  
	gnodes
[
i
];

75 
_fšd
(cÚ¡ 
Key
& 
k
, 
boŞ
& 
found
) {

76 
	gfound
 = 
çl£
;

77 
	gh
 = 
k
.
hash
();

78 
	gi
 = 
h
 % 
n
;

79 
	g¡¬t
 = 
i
;

80 
	gchaš
 = 0;

81 
	gfœ¡NÚU£d
 = -1;

83 iàĞ!
nodes
(
i
).
šU£
() ) {

84 iàĞ
	gfœ¡NÚU£d
 < 0 )

85 
	gfœ¡NÚU£d
 = 
i
;

88 iàĞ
nodes
(
i
).
	ghash
 =ğ
h
 &&‚odes(i).
k
 == k ) {

89 iàĞ
chaš
 >= 200 )

90 
log
(è<< "w¬nšg: hashbË " << 
Çme
 << "†Úg chaš " << 
¡d
::
’dl
;

91 
	gfound
 = 
Œue
;

92  
	gi
;

94 
	gchaš
++;

95 
	gi
 = (
i
+1è% 
n
;

96 iàĞ
	gi
 =ğ
¡¬t
 ) {

98 
log
(è<< "”rÜ: hashbË " << 
Çme
 << " i fuÎ‚:" << 
n
 << 
¡d
::
’dl
;

101 ifĞ
	gchaš
 >ğ
maxChaš
 ) {

102 iàĞ
fœ¡NÚU£d
 >= 0 )

103  
fœ¡NÚU£d
;

104 
log
(è<< "”rÜ: hashbË " << 
	gÇme
 << " max chaš„—ched:" << 
	gmaxChaš
 << 
	g¡d
::
’dl
;

110 
	gpublic
:

112 
HashTabË
(* 
buf
, 
buæ’
, cÚ¡ *
_Çme
è: 
Çme
(_name) {

113 
m
 = (
Node
);

115 
	gn
 = 
buæ’
 / 
m
;

116 iàĞ(
	gn
 & 1) == 0 )

117 
n
--;

118 
	gmaxChaš
 = (è(
n
 * 0.05);

119 
	g_buf
 = 
buf
;

122 iàĞ(
	gNode
) != 628 ) {

123 
log
(è<< "HashTabË(è" << 
_Çme
 << " sizeofÒode):" << (
Node
è<< "‚:" << 
n
 << " sizeof(Key): " << (
Key
è<< " sizeof(Ty³):" << (
Ty³
è<< 
¡d
::
’dl
;

124 
v”ify
Ğ(
Node
) == 628 );

129 
Ty³
* 
g‘
(cÚ¡ 
Key
& 
k
) {

130 
boŞ
 
	gfound
;

131 
	gi
 = 
_fšd
(
k
, 
found
);

132 iàĞ
	gfound
 )

133  &
nodes
(
i
).
	gv®ue
;

137 
kl
(
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
Key
& 
k
) {

138 
boŞ
 
	gfound
;

139 
	gi
 = 
_fšd
(
k
, 
found
);

140 iàĞ
	gi
 >ğ0 && 
found
 ) {

141 
Node
* 
n
 = &
nodes
(
i
);

142 
	gn
 = 
txn
->
»cov”yUn™
()->
wr™šg
(
n
);

143 
	gn
->
	gk
.
kl
();

144 
	gn
->
£tUnu£d
();

149 
boŞ
 
put
(
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
Key
& 
k
, cÚ¡ 
Ty³
& 
v®ue
) {

150 
boŞ
 
	gfound
;

151 
	gi
 = 
_fšd
(
k
, 
found
);

152 iàĞ
	gi
 < 0 )

153  
	gçl£
;

154 
Node
* 
	gn
 = 
txn
->
»cov”yUn™
()->
wr™šg
Ğ&
nodes
(
i
) );

155 iàĞ!
	gfound
 ) {

156 
	gn
->
	gk
 = 
k
;

157 
	gn
->
	ghash
 = 
k
.
hash
();

160 
v”ify
Ğ
n
->
hash
 =ğ
k
.hash() );

162 
	gn
->
	gv®ue
 = 
v®ue
;

163  
	gŒue
;

166 (*
	gI‹¿tÜC®lback
)ĞcÚ¡ 
	tKey
& 
	tk
 , 
	tTy³
& 
	tv
 );

167 
™”AÎ
Ğ
I‹¿tÜC®lback
 
ÿÎback
 ) {

168  
	gi
=0; i<
	gn
; i++ ) {

169 iàĞ
nodes
(
i
).
šU£
() ) {

170 
ÿÎback
Ğ
nodes
(
i
).
k
 ,‚odes(i).
v®ue
 );

176 (*
	gI‹¿tÜC®lback2
)ĞcÚ¡ 
	tKey
& 
	tk
 , 
	tTy³
& 
	tv
 , * 
	texŒa
 );

177 
™”AÎ
Ğ
I‹¿tÜC®lback2
 
ÿÎback
 , * 
exŒa
 ) {

178  
	gi
=0; i<
	gn
; i++ ) {

179 iàĞ
nodes
(
i
).
šU£
() ) {

180 
ÿÎback
Ğ
nodes
(
i
).
k
 ,‚odes(i).
v®ue
 , 
exŒa
 );

187 #´agm¨
·ck
()

	@catalog/index_details.cpp

31 
	~"mÚgo/db/¡ruùu»/ÿlog/šdex_d‘as.h
"

33 
Çme¥aû
 
	gmÚgo
 {

35 
	gIndexD‘as
::
_»£t
() {

36 
h—d
.
£tInv®id
();

37 
	gšfo
.
£tInv®id
();

	@catalog/index_details.h

31 #´agm¨
Úû


33 
	~"mÚgo/db/diskloc.h
"

35 
Çme¥aû
 
	gmÚgo
 {

45 
	sIndexD‘as
 {

49 
DiskLoc
 
	gh—d
;

60 
DiskLoc
 
	gšfo
;

65 
_»£t
();

	@catalog/namespace-inl.h

31 #´agm¨
Úû


33 
Çme¥aû
 
	gmÚgo
 {

35 
šlše
 
	gName¥aû
& Name¥aû::
İ”©Ü
=(cÚ¡ 
SŒšgD©a
& 
ns
) {

44 
mem£t
Ğ
buf
, 0, (buf) );

45 
uas£¹
Ğ10080 , "n ÇmtoØlÚg, max sizi 127 by‹s", 
ns
.
size
(è<ğ
MaxNsL’
);

46 
uas£¹
Ğ17380 , "n Çmÿn'ˆcÚšƒmbedded '\0' by‹", 
ns
.
fšd
('\0'è=ğ
¡d
::
¡ršg
::
Åos
);

47 
	gns
.
cİyTo
Ğ
buf
, 
Œue
 );

48  *
	gthis
;

51 
šlše
 
	g¡d
::
¡ršg
 
Name¥aû
::
exŒaName
(
i
) const {

52 
ex
[] = "$extra";

53 
	gex
[5] +ğ
i
;

54 
	g¡d
::
¡ršg
 
s
 = 
¡d
::¡ršg(
buf
è+ 
ex
;

55 
mas£¹
Ğ10348 , "$exŒa:‚ ÇmtoØlÚg", 
s
.
size
(è<ğ
MaxNsL’
);

56  
	gs
;

59 
šlše
 
boŞ
 
	gName¥aû
::
isExŒa
() const {

60 cÚ¡ *
p
 = 
¡r¡r
(
buf
, "$extr");

61  
	gp
 &&…[5] &&…[6] == 0;

64 
šlše
 
	gName¥aû
::
hash
() const {

65 
x
 = 0;

66 cÚ¡ *
	gp
 = 
buf
;

67  *
	gp
 ) {

68 
	gx
 = 
x
 * 131 + *
p
;

69 
	gp
++;

71  (
	gx
 & 0x7fffffff) | 0x8000000;

	@catalog/namespace.cpp

31 
	~"mÚgo/pch.h
"

33 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû.h
"

35 
	~<boo¡/¡©ic_as£¹.hµ
>

37 
	~"mÚgo/db/Çme¥aû_¡ršg.h
"

39 
Çme¥aû
 
	gmÚgo
 {

40 
	gÇme¥aû
 {

41 
BOOST_STATIC_ASSERT
Ğ(
Name¥aû
) == 128 );

42 
BOOST_STATIC_ASSERT
Ğ
Name¥aû
::
MaxNsL’W™hNUL
 =ğ
MaxD©aba£NameL’
 );

	@catalog/namespace.h

31 #´agm¨
Úû


33 
	~<c¡ršg
>

34 
	~<¡ršg
>

36 
	~"mÚgo/ba£/¡ršg_d©a.h
"

38 
Çme¥aû
 
	gmÚgo
 {

40 #´agm¨
·ck
(1)

46 şas 
	cName¥aû
 {

47 
	gpublic
:

48 
Name¥aû
(cÚ¡ 
SŒšgD©a
& 
ns
è{ *
this
 =‚s; }

49 
	gName¥aû
& 
	gİ”©Ü
=(cÚ¡ 
SŒšgD©a
& 
ns
);

51 
kl
(è{ 
	gbuf
[0] = 0x7f; }

53 
boŞ
 
	gİ”©Ü
==(cÚ¡ *
r
ècÚ¡ {  
¡rcmp
(
buf
,„) == 0; }

54 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Name¥aû
& 
r
ècÚ¡ {  
¡rcmp
(
buf
,„.buf) == 0; }

55 
boŞ
 
	gİ”©Ü
!=(cÚ¡ *
r
ècÚ¡ {  
¡rcmp
(
buf
,„) != 0; }

56 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Name¥aû
& 
r
ècÚ¡ {  
¡rcmp
(
buf
,„.buf) != 0; }

58 
boŞ
 
hasDŞÏrSign
(ècÚ¡ {  
¡rchr
Ğ
buf
 , '$' ) !ğ
NULL
; }

60 
hash
() const;

62 
size_t
 
size
(ècÚ¡ {  
¡¾’
Ğ
buf
 ); }

64 
	g¡d
::
¡ršg
 
toSŒšg
(ècÚ¡ {  
buf
; }

65 
İ”©Ü
 
	g¡d
::
¡ršg
(ècÚ¡ {  
buf
; }

70 
	g¡d
::
¡ršg
 
exŒaName
(
i
) const;

71 
boŞ
 
isExŒa
() const;

73 
	eMaxNsL’V®ue
 {

76 
	gMaxNsL’W™hNUL
 = 128,

79 
	gMaxNsL’
 = 
MaxNsL’W™hNUL
 - 1,

83 
	gMaxNsCŞËtiÚL’
 = 
MaxNsL’
 - 7 ,

85 
	g´iv©e
:

86 
buf
[
MaxNsL’W™hNUL
];

88 #´agm¨
·ck
()

92 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû-šl.h
"

	@catalog/namespace_details.cpp

29 
	~"mÚgo/pch.h
"

31 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_d‘as.h
"

33 
	~<®gÜ™hm
>

34 
	~<li¡
>

36 
	~"mÚgo/ba£/couÁ”.h
"

37 
	~"mÚgo/db/ÿlog/cŞËùiÚ.h
"

38 
	~"mÚgo/db/ÿlog/cŞËùiÚ_İtiÚs.h
"

39 
	~"mÚgo/db/ş›ÁcursÜ.h
"

40 
	~"mÚgo/db/commªds/£rv”_¡©us.h
"

41 
	~"mÚgo/db/db.h
"

42 
	~"mÚgo/db/šdex_Ëgacy.h
"

43 
	~"mÚgo/db/jsÚ.h
"

44 
	~"mÚgo/db/İs/d–‘e.h
"

45 
	~"mÚgo/db/İs/upd©e.h
"

46 
	~"mÚgo/db/¡ruùu»/ÿlog/hashb.h
"

47 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

48 
	~"mÚgo/sütšg/’gše.h
"

49 
	~"mÚgo/ut/¡¬tup_‹¡.h
"

52 
Çme¥aû
 
	gmÚgo
 {

55 
BSONObj
 
	gidKeyP©‹º
 = 
äomjsÚ
("{\"_id\":1}");

57 
	gName¥aûD‘as
::
Name¥aûD‘as
ĞcÚ¡ 
DiskLoc
 &
loc
, 
boŞ
 
ÿµed
 ) {

58 
BOOST_STATIC_ASSERT
Ğ(
Name¥aûD‘as
::
ExŒa
) <= (NamespaceDetails) );

61 
	gfœ¡Ex‹Á
 = 
Ï¡Ex‹Á
 = 
ÿpEx‹Á
 = 
loc
;

62 
	g¡©s
.
	gd©asize
 = 
¡©s
.
ÄecÜds
 = 0;

63 
	gÏ¡Ex‹ÁSize
 = 0;

64 
	gnIndexes
 = 0;

65 
	gisC­³d
 = 
ÿµed
;

66 
	gmaxDocsInC­³d
 = 0x7fffffff;

67 
	g·ddšgFaùÜ
 = 1.0;

68 
	gsy¡emFÏgsOldDoNÙU£
 = 0;

69 
	gu£rFÏgs
 = 0;

70 
	gÿpFœ¡NewRecÜd
 = 
DiskLoc
();

72 
	gÿpFœ¡NewRecÜd
.
£tInv®id
();

74 iàĞ
	gÿµed
 ) {

76 
	gd–‘edLi¡
[1].
£tInv®id
();

78 
v”ify
Ğ(
_d©aFeV”siÚ
) == 2 );

79 
	g_d©aFeV”siÚ
 = 0;

80 
	g_šdexFeV”siÚ
 = 0;

81 
	gmuÉiKeyIndexB™s
 = 0;

82 
	g_»£rvedA
 = 0;

83 
	g_exŒaOff£t
 = 0;

84 
	gšdexBudsInProg»ss
 = 0;

85 
mem£t
(
_»£rved
, 0, (_reserved));

88 
	gName¥aûD‘as
::
ExŒa
* 
Name¥aûD‘as
::
®locExŒa
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

89 cÚ¡ 
SŒšgD©a
& 
ns
,

90 
Name¥aûIndex
& 
ni
,

91 
nšdexessoçr
) {

92 
	gtxn
->
lockS‹
()->
as£¹Wr™eLocked
(
ns
);

94 
	gi
 = (
nšdexessoçr
 - 
NIndexesBa£
è/ 
NIndexesExŒa
;

95 
v”ify
Ğ
i
 >= 0 && i <= 1 );

97 
Name¥aû
 
fuÎns
Ğ
ns
 );

98 
Name¥aû
 
exŒªs
Ğ
fuÎns
.
exŒaName
(
i
) );

100 
mas£¹
Ğ10350, "®locExŒa: ba£‚ missšg?", 
this
 );

101 
mas£¹
Ğ10351, "®locExŒa:ƒxŒ¨®»adyƒxi¡s", 
ni
.
d‘as
(
exŒªs
) == 0 );

103 
ExŒa
 
	g‹mp
;

104 
	g‹mp
.
š™
();

106 
	gni
.
add_ns
Ğ
txn
, 
exŒªs
, 
»š‹½»t_ÿ¡
<
Name¥aûD‘as
*>Ğ&
‹mp
 ) );

107 
ExŒa
* 
	ge
 = 
»š‹½»t_ÿ¡
<
Name¥aûD‘as
::ExŒa*>Ğ
ni
.
d‘as
Ğ
exŒªs
 ) );

109 
	gofs
 = 
e
->
ofsFrom
(
this
);

110 ifĞ
	gi
 == 0 ) {

111 
v”ify
Ğ
_exŒaOff£t
 == 0 );

112 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
_exŒaOff£t
èğ
ofs
;

113 
v”ify
Ğ
exŒa
(è=ğ
e
 );

116 
ExŒa
 *
	ghd
 = 
exŒa
();

117 
v”ify
Ğ
hd
->
Ãxt
(
this
) == 0 );

118 
	ghd
->
£tNext
(
txn
, 
ofs
);

120  
	ge
;

123 
	gIndexD‘as
& 
	gName¥aûD‘as
::
idx
(
idxNo
, 
boŞ
 
missšgEx³ùed
) {

124 ifĞ
	gidxNo
 < 
	gNIndexesBa£
 ) {

125 
	gIndexD‘as
& 
	gid
 = 
_šdexes
[
idxNo
];

126  
	gid
;

128 
ExŒa
 *
	ge
 = 
exŒa
();

129 iàĞ! 
	ge
 ) {

130 iàĞ
	gmissšgEx³ùed
 )

131 
throw
 
MsgAs£¹iÚExû±iÚ
( 13283 , "Missing Extra" );

132 
mas£¹
(14045, "missšg ExŒa", 
e
);

134 
	gi
 = 
idxNo
 - 
NIndexesBa£
;

135 ifĞ
	gi
 >ğ
NIndexesExŒa
 ) {

136 
e
 =ƒ->
Ãxt
(
this
);

137 iàĞ! 
	ge
 ) {

138 iàĞ
	gmissšgEx³ùed
 )

139 
throw
 
MsgAs£¹iÚExû±iÚ
( 14823 , "missingƒxtra" );

140 
mas£¹
(14824, "missšg ExŒa", 
e
);

142 
	gi
 -ğ
NIndexesExŒa
;

144  
	ge
->
	gd‘as
[
i
];

148 cÚ¡ 
	gIndexD‘as
& 
	gName¥aûD‘as
::
idx
(
idxNo
, 
boŞ
 
missšgEx³ùed
) const {

149 ifĞ
	gidxNo
 < 
	gNIndexesBa£
 ) {

150 cÚ¡ 
	gIndexD‘as
& 
	gid
 = 
_šdexes
[
idxNo
];

151  
	gid
;

153 cÚ¡ 
ExŒa
 *
	ge
 = 
exŒa
();

154 iàĞ! 
	ge
 ) {

155 iàĞ
	gmissšgEx³ùed
 )

156 
throw
 
MsgAs£¹iÚExû±iÚ
( 17421 , "Missing Extra" );

157 
mas£¹
(17422, "missšg ExŒa", 
e
);

159 
	gi
 = 
idxNo
 - 
NIndexesBa£
;

160 ifĞ
	gi
 >ğ
NIndexesExŒa
 ) {

161 
e
 =ƒ->
Ãxt
(
this
);

162 iàĞ! 
	ge
 ) {

163 iàĞ
	gmissšgEx³ùed
 )

164 
throw
 
MsgAs£¹iÚExû±iÚ
( 17423 , "missingƒxtra" );

165 
mas£¹
(17424, "missšg ExŒa", 
e
);

167 
	gi
 -ğ
NIndexesExŒa
;

169  
	ge
->
	gd‘as
[
i
];

172 
	gName¥aûD‘as
::
IndexI‹¿tÜ
::IndexI‹¿tÜ(cÚ¡ 
Name¥aûD‘as
 *
_d
,

173 
boŞ
 
šşudeBackgroundInProg»ss
) {

174 
	gd
 = 
_d
;

175 
	gi
 = 0;

176 
	gn
 = 
d
->
nIndexes
;

177 iàĞ
	gšşudeBackgroundInProg»ss
 )

178 
	gn
 +ğ
d
->
šdexBudsInProg»ss
;

182 
	gName¥aûD‘as
::
cİyšgFrom
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

183 cÚ¡ 
SŒšgD©a
& 
thi¢s
,

184 
Name¥aûIndex
& 
ni
,

185 
Name¥aûD‘as
* 
¤c
) {

186 
	g_exŒaOff£t
 = 0;

187 
ExŒa
 *
	g£
 = 
¤c
->
exŒa
();

188 
	gn
 = 
NIndexesBa£
;

189 ifĞ
	g£
 ) {

190 
ExŒa
 *
	ge
 = 
®locExŒa
(
txn
, 
thi¢s
, 
ni
, 
n
);

192 
	gn
 +ğ
NIndexesExŒa
;

193 
	ge
->
cİy
(
this
, *
£
);

194 
	g£
 = 
£
->
Ãxt
(
¤c
);

195 ifĞ
	g£
 == 0 ) ;

196 
ExŒa
 *
	gnxt
 = 
®locExŒa
(
txn
, 
thi¢s
, 
ni
, 
n
);

197 
	ge
->
£tNext
Ğ
txn
, 
nxt
->
ofsFrom
(
this
) );

198 
	ge
 = 
nxt
;

200 
v”ify
Ğ
_exŒaOff£t
 );

204 
Name¥aûD‘as
* 
	gName¥aûD‘as
::
wr™šgW™houtExŒa
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

205  
txn
->
»cov”yUn™
()->
wr™šg
Ğ
this
 );

210 
Name¥aûD‘as
 *
	gName¥aûD‘as
::
wr™šgW™hExŒa
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

211  
ExŒa
 *
e
 = 
exŒa
(); 
	ge
;ƒ =ƒ->
Ãxt
Ğ
this
 ) ) {

212 
txn
->
»cov”yUn™
()->
wr™šg
Ğ
e
 );

214  
wr™šgW™houtExŒa
Ğ
txn
 );

217 
	gName¥aûD‘as
::
£tMaxC­³dDocs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
max
 ) {

218 
mas£¹
( 16499,

220 
CŞËùiÚO±iÚs
::
v®idMaxC­³dDocs
Ğ&
max
 ) );

221 
	gmaxDocsInC­³d
 = 
max
;

227 
	gName¥aûD‘as
::
_ÿlogFšdIndexByName
(cÚ¡ 
CŞËùiÚ
* 
cŞl
,

228 cÚ¡ 
SŒšgD©a
& 
Çme
,

229 
boŞ
 
šşudeBackgroundInProg»ss
) const {

230 
IndexI‹¿tÜ
 
	gi
 = 
ii
(
šşudeBackgroundInProg»ss
);

231  
	gi
.
mÜe
() ) {

232 cÚ¡ 
BSONObj
 
	gobj
 = 
cŞl
->
docFÜ
(
i
.
Ãxt
().
šfo
);

233 iàĞ
	gÇme
 =ğ
obj
.
g‘SŒšgF›ld
("name") )

234  
i
.
pos
()-1;

239 
	gName¥aûD‘as
::
ExŒa
::
£tNext
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

240 
ofs
 ) {

241 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
_Ãxt
èğ
ofs
;

	@catalog/namespace_details.h

29 #´agm¨
Úû


31 
	~"mÚgo/db/diskloc.h
"

32 
	~"mÚgo/db/Çme¥aû_¡ršg.h
"

33 
	~"mÚgo/db/¡ruùu»/ÿlog/šdex_d‘as.h
"

34 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû.h
"

35 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_šdex.h
"

37 
Çme¥aû
 
	gmÚgo
 {

39 
şass
 
	gCŞËùiÚ
;

40 
şass
 
	gO³¿tiÚCÚ‹xt
;

45 cÚ¡ 
	gBuck‘s
 = 19;

46 cÚ¡ 
	gMaxBuck‘
 = 18;

48 
buck‘Sizes
[];

50 #´agm¨
·ck
(1)

54 şas 
	cName¥aûD‘as
 {

55 
	gpublic
:

56 ’um { 
NIndexesMax
 = 64, 
	gNIndexesExŒa
 = 30, 
	gNIndexesBa£
 = 10 };

62 
DiskLoc
 
	gfœ¡Ex‹Á
;

63 
DiskLoc
 
	gÏ¡Ex‹Á
;

72 
DiskLoc
 
	gd–‘edLi¡
[
Buck‘s
];

75 
	sSts
 {

77 
	gd©asize
;

78 
	gÄecÜds
;

79 } 
	g¡©s
;

82 
	gÏ¡Ex‹ÁSize
;

84 
	gnIndexes
;

87 
IndexD‘as
 
	g_šdexes
[
NIndexesBa£
];

89 
	gpublic
:

91 
isC­³d
;

93 
	gmaxDocsInC­³d
;

95 
	g·ddšgFaùÜ
;

97 
	gsy¡emFÏgsOldDoNÙU£
;

99 
DiskLoc
 
	gÿpEx‹Á
;

100 
DiskLoc
 
	gÿpFœ¡NewRecÜd
;

102 
	g_d©aFeV”siÚ
;

103 
	g_šdexFeV”siÚ
;

105 
	gmuÉiKeyIndexB™s
;

108 
	g_»£rvedA
;

109 
	g_exŒaOff£t
;

111 
	gpublic
:

112 
šdexBudsInProg»ss
;

114 
	gu£rFÏgs
;

116 
	g_»£rved
[72];

118 
	gpublic
:

119 
ex¶ic™
 
Name¥aûD‘as
ĞcÚ¡ 
DiskLoc
 &
loc
, 
boŞ
 
_ÿµed
 );

121 şas 
	cExŒa
 {

122 
	g_Ãxt
;

123 
	gpublic
:

124 
IndexD‘as
 
d‘as
[
NIndexesExŒa
];

125 
	g´iv©e
:

126 
»£rved2
;

127 
	g»£rved3
;

128 
ExŒa
(cÚ¡ ExŒa&è{ 
v”ify
(
çl£
); }

129 
	gExŒa
& 
	gİ”©Ü
=(cÚ¡ 
ExŒa
& 
r
è{ 
v”ify
(
çl£
);  *
	gthis
; }

130 
	gpublic
:

131 
ExŒa
() { }

132 
ofsFrom
(
Name¥aûD‘as
 *
d
) {

133  ((*è
this
è- ((*è
d
);

135 
š™
(è{ 
mem£t
(
this
, 0, (
ExŒa
)); }

136 
ExŒa
* 
Ãxt
(cÚ¡ 
Name¥aûD‘as
 *
d
) const {

137 ifĞ
	g_Ãxt
 == 0 )  0;

138  (
	gExŒa
*è(((*è
	gd
è+ 
	g_Ãxt
);

140 
£tNext
(
O³¿tiÚCÚ‹xt
* 
txn
, 
ofs
);

141 
cİy
(
Name¥aûD‘as
 *
d
, cÚ¡ 
ExŒa
& 
e
) {

142 
memıy
(
this
, &
e
, (
ExŒa
));

143 
	g_Ãxt
 = 0;

146 
ExŒa
* 
exŒa
() const {

147 ifĞ
	g_exŒaOff£t
 == 0 )  0;

148  (
	gExŒa
 *è(((*è
	gthis
è+ 
	g_exŒaOff£t
);

151 
ExŒa
* 
®locExŒa
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

152 cÚ¡ 
SŒšgD©a
& 
ns
,

153 
Name¥aûIndex
& 
ni
,

154 
nšdexessoçr
 );

156 
cİyšgFrom
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

157 cÚ¡ 
SŒšgD©a
& 
thi¢s
,

158 
Name¥aûIndex
& 
ni
,

159 
Name¥aûD‘as
 *
¤c
);

161 
	gpublic
:

162 
£tMaxC­³dDocs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
max
 );

164 
	eU£rFÏgs
 {

165 
	gFÏg_U£Pow”Of2Sizes
 = 1 << 0

168 
	gIndexD‘as
& 
idx
(
idxNo
, 
boŞ
 
missšgEx³ùed
 = 
çl£
 );

169 cÚ¡ 
	gIndexD‘as
& 
idx
(
idxNo
, 
boŞ
 
missšgEx³ùed
 = 
çl£
 ) const;

171 şas 
	cIndexI‹¿tÜ
 {

172 
	gpublic
:

173 
pos
(è{  
i
; }

174 
boŞ
 
mÜe
(è{  
	gi
 < 
	gn
; }

175 cÚ¡ 
	gIndexD‘as
& 
Ãxt
(è{  
	gd
->
idx
(
i
++); }

176 
	g´iv©e
:

177 
ä›nd
 
şass
 
Name¥aûD‘as
;

178 
	gi
, 
	gn
;

179 cÚ¡ 
Name¥aûD‘as
 *
	gd
;

180 
IndexI‹¿tÜ
(cÚ¡ 
Name¥aûD‘as
 *
_d
, 
boŞ
 
šşudeBackgroundInProg»ss
);

183 
IndexI‹¿tÜ
 
ii
Ğ
boŞ
 
šşudeBackgroundInProg»ss
 = 
çl£
 ) const {

184  
IndexI‹¿tÜ
(
this
, 
šşudeBackgroundInProg»ss
);

191 
	gIndexD‘as
& 
g‘NextIndexD‘as
(
O³¿tiÚCÚ‹xt
* 
txn
, 
CŞËùiÚ
* 
cŞËùiÚ
);

193 
Name¥aûD‘as
 *
wr™šgW™houtExŒa
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

196 
Name¥aûD‘as
 *
wr™šgW™hExŒa
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

204 
_ÿlogFšdIndexByName
(cÚ¡ 
CŞËùiÚ
* 
cŞl
,

205 cÚ¡ 
SŒšgD©a
& 
Çme
,

206 
boŞ
 
šşudeBackgroundInProg»ss
) const;

208 
	g´iv©e
:

215 
sw­Index
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
a
, 
b
 );

217 
ä›nd
 
şass
 
	gIndexC©®og
;

218 
ä›nd
 
şass
 
	gIndexC©®ogEÁry
;

221 
ÿµedTrunÿ‹La¡D–Upd©e
();

222 
BOOST_STATIC_ASSERT
Ğ
NIndexesMax
 <ğ
NIndexesBa£
 + 
NIndexesExŒa
*2 );

223 
BOOST_STATIC_ASSERT
Ğ
NIndexesMax
 <= 64 );

224 
BOOST_STATIC_ASSERT
Ğ(
Name¥aûD‘as
::
ExŒa
) == 496 );

226 
BOOST_STATIC_ASSERT
Ğ(
Name¥aûD‘as
) == 496 );

227 #´agm¨
·ck
()

	@catalog/namespace_details_collection_entry.cpp

31 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_d‘as_cŞËùiÚ_’Œy.h
"

33 
	~"mÚgo/db/šdex/šdex_desütÜ.h
"

34 
	~"mÚgo/db/¡Üage/mm­_v1/mm­_v1_d©aba£_ÿlog_’Œy.h
"

35 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_d‘as.h
"

36 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

37 
	~"mÚgo/ut/¡¬tup_‹¡.h
"

39 
Çme¥aû
 
	gmÚgo
 {

40 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
Name¥aûD‘asCŞËùiÚC©®ogEÁry
ĞcÚ¡ 
SŒšgD©a
& 
ns
,

41 
Name¥aûD‘as
* 
d‘as
,

42 
RecÜdStÜe
* 
šdexRecÜdStÜe
,

43 
MMAPV1D©aba£C©®ogEÁry
* 
db
 )

44 : 
CŞËùiÚC©®ogEÁry
Ğ
ns
 ),

45 
_d‘as
Ğ
d‘as
 ),

46 
_šdexRecÜdStÜe
Ğ
šdexRecÜdStÜe
 ),

47 
_db
Ğ
db
 ) {

50 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
g‘TÙ®IndexCouÁ
() const {

51  
_d‘as
->
nIndexes
 + _d‘as->
šdexBudsInProg»ss
;

54 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
g‘Com¶‘edIndexCouÁ
() const {

55  
_d‘as
->
nIndexes
;

58 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
g‘MaxAÎowedIndexes
() const {

59  
Name¥aûD‘as
::
NIndexesMax
;

62 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
g‘AÎIndexes
Ğ
¡d
::
veùÜ
<¡d::
¡ršg
>* 
Çmes
 ) const {

63 
Name¥aûD‘as
::
IndexI‹¿tÜ
 
i
 = 
_d‘as
->
ii
Ğ
Œue
 );

64  
	gi
.
mÜe
() ) {

65 cÚ¡ 
	gIndexD‘as
& 
	gid
 = 
i
.
Ãxt
();

66 cÚ¡ 
BSONObj
 
obj
Ğ
_šdexRecÜdStÜe
->
»cÜdFÜ
Ğ
id
.
šfo
 )->
d©a
() );

67 
	gÇmes
->
push_back
Ğ
obj
.
g‘SŒšgF›ld
("name") );

71 
boŞ
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
isIndexMuÉikey
(cÚ¡ 
SŒšgD©a
& 
idxName
) const {

72 
idxNo
 = 
_fšdIndexNumb”
Ğ
idxName
 );

73 
šv¬ŸÁ
Ğ
idxNo
 >= 0 );

74  
isIndexMuÉikey
Ğ
idxNo
 );

77 
boŞ
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
isIndexMuÉikey
(
idxNo
) const {

78  (
_d‘as
->
muÉiKeyIndexB™s
 & (((è1è<< 
idxNo
)) != 0;

81 
boŞ
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
£tIndexIsMuÉikey
(
O³¿tiÚCÚ‹xt
* 
txn
,

82 cÚ¡ 
SŒšgD©a
& 
šdexName
,

83 
boŞ
 
muÉikey
 ) {

85 
	gidxNo
 = 
_fšdIndexNumb”
Ğ
šdexName
 );

86 
šv¬ŸÁ
Ğ
idxNo
 >= 0 );

87  
£tIndexIsMuÉikey
Ğ
txn
, 
idxNo
, 
muÉikey
 );

90 
boŞ
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
£tIndexIsMuÉikey
(
O³¿tiÚCÚ‹xt
* 
txn
,

91 
idxNo
,

92 
boŞ
 
muÉikey
 ) {

93 
	gmask
 = 1ULL << 
idxNo
;

95 ià(
	gmuÉikey
) {

97 ià(
	g_d‘as
->
	gmuÉiKeyIndexB™s
 & 
	gmask
) {

98  
	gçl£
;

101 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
_d‘as
->
muÉiKeyIndexB™s
è|ğ
mask
;

105 ià(!(
	g_d‘as
->
	gmuÉiKeyIndexB™s
 & 
	gmask
)) {

106  
	gçl£
;

110 
	gmask
 = ~
mask
;

111 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
_d‘as
->
muÉiKeyIndexB™s
è&ğ
mask
;

114  
	gŒue
;

117 
DiskLoc
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
g‘IndexH—d
ĞcÚ¡ 
SŒšgD©a
& 
idxName
 ) const {

118 
idxNo
 = 
_fšdIndexNumb”
Ğ
idxName
 );

119 
šv¬ŸÁ
Ğ
idxNo
 >= 0 );

120  
	g_d‘as
->
idx
Ğ
idxNo
 ).
	gh—d
;

123 
BSONObj
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
g‘IndexS³c
ĞcÚ¡ 
SŒšgD©a
& 
idxName
 ) const {

124 
idxNo
 = 
_fšdIndexNumb”
Ğ
idxName
 );

125 
šv¬ŸÁ
Ğ
idxNo
 >= 0 );

126 cÚ¡ 
	gIndexD‘as
& 
	gid
 = 
_d‘as
->
idx
Ğ
idxNo
 );

127  
BSONObj
Ğ
_šdexRecÜdStÜe
->
»cÜdFÜ
Ğ
id
.
šfo
 )->
d©a
() );

130 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
£tIndexH—d
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

131 cÚ¡ 
SŒšgD©a
& 
idxName
,

132 cÚ¡ 
DiskLoc
& 
ÃwH—d
 ) {

133 
	gidxNo
 = 
_fšdIndexNumb”
Ğ
idxName
 );

134 
šv¬ŸÁ
Ğ
idxNo
 >= 0 );

135 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
idx
Ğ
idxNo
 ).
h—d
èğ
ÃwH—d
;

138 
boŞ
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
isIndexR—dy
ĞcÚ¡ 
SŒšgD©a
& 
idxName
 ) const {

139 
idxNo
 = 
_fšdIndexNumb”
Ğ
idxName
 );

140 
šv¬ŸÁ
Ğ
idxNo
 >= 0 );

141  
	gidxNo
 < 
g‘Com¶‘edIndexCouÁ
();

144 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
_fšdIndexNumb”
ĞcÚ¡ 
SŒšgD©a
& 
idxName
 ) const {

145 
Name¥aûD‘as
::
IndexI‹¿tÜ
 
i
 = 
_d‘as
->
ii
Ğ
Œue
 );

146  
	gi
.
mÜe
() ) {

147 cÚ¡ 
	gIndexD‘as
& 
	gid
 = 
i
.
Ãxt
();

148 
	gidxNo
 = 
i
.
pos
() - 1;

149 cÚ¡ 
BSONObj
 
obj
Ğ
_šdexRecÜdStÜe
->
»cÜdFÜ
Ğ
id
.
šfo
 )->
d©a
() );

150 iàĞ
	gidxName
 =ğ
obj
.
g‘SŒšgF›ld
("name") )

151  
idxNo
;

161 
»moveAndSlideB™
(
b
, 
x
) {

162 
	gtmp
 = 
b
;

164 (
	gtmp
 & ((((è1è<< 
	gx
)-1)) |

165 ((
	gtmp
 >> (
	gx
+1)) << x);

168 şas 
	cIndexUpd©eTe¡
 : 
public
 
S¹upTe¡
 {

169 
public
:

170 
run
() {

171 
v”ify
Ğ
»moveAndSlideB™
(1, 0) == 0 );

172 
v”ify
Ğ
»moveAndSlideB™
(2, 0) == 1 );

173 
v”ify
Ğ
»moveAndSlideB™
(2, 1) == 0 );

174 
v”ify
Ğ
»moveAndSlideB™
(255, 1) == 127 );

175 
v”ify
Ğ
»moveAndSlideB™
(21, 2) == 9 );

176 
v”ify
Ğ
»moveAndSlideB™
(0x4000000000000001ULL, 62) == 1 );

178 } 
	giu_un™‹¡
;

180 
Stus
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
	$»moveIndex
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

181 cÚ¡ 
SŒšgD©a
& 
šdexName
 ) {

182 
idxNo
 = 
	`_fšdIndexNumb”
Ğ
šdexName
 );

183 iàĞ
idxNo
 < 0 )

184  
	`Stus
Ğ
E¼ÜCodes
::
Name¥aûNÙFound
, "index‚ot foundo„emove" );

186 
DiskLoc
 
šfoLoÿtiÚ
 = 
_d‘as
->
	`idx
Ğ
idxNo
 ).
šfo
;

189 
RecÜd
* 
»cÜd
 = 
_šdexRecÜdStÜe
->
	`»cÜdFÜ
Ğ
šfoLoÿtiÚ
 );

190 
	`šv¬ŸÁ
Ğ
»cÜd
 );

191 
BSONObj
 
	`šfo
Ğ
»cÜd
->
	`d©a
() );

192 
	`šv¬ŸÁ
Ğ
šfo
["Çme"].
	`SŒšg
(è=ğ
šdexName
 );

196 
¡ršg
 
šdexName¥aû
 = 
IndexDesütÜ
::
	`makeIndexName¥aû
Ğ
	`ns
().ns(), 
šdexName
 );

197 
Stus
 
¡©us
 = 
_db
->
	`drİCŞËùiÚ
Ğ
txn
, 
šdexName¥aû
 );

198 iàĞ!
¡©us
.
	`isOK
() ) {

199  
¡©us
;

204 
Name¥aûD‘as
* 
d
 = 
_d‘as
->
	`wr™šgW™hExŒa
Ğ
txn
 );

207 
d
->
muÉiKeyIndexB™s
 = 
	`»moveAndSlideB™
(d->muÉiKeyIndexB™s, 
idxNo
);

209 iàĞ
idxNo
 >ğ
d
->
nIndexes
 )

210 
d
->
šdexBudsInProg»ss
--;

212 
d
->
nIndexes
--;

214  
i
 = 
idxNo
; i < 
	`g‘TÙ®IndexCouÁ
(); i++ )

215 
d
->
	`idx
(
i
) = d->idx(i+1);

217 
d
->
	`idx
Ğ
	`g‘TÙ®IndexCouÁ
(èèğ
	`IndexD‘as
();

221 
_šdexRecÜdStÜe
->
	`d–‘eRecÜd
Ğ
txn
, 
šfoLoÿtiÚ
 );

223  
Stus
::
	`OK
();

224 
	}
}

226 
Stus
 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
	$´•¬eFÜIndexBud
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

227 cÚ¡ 
IndexDesütÜ
* 
desc
 ) {

228 
BSONObj
 
¥ec
 = 
desc
->
	`šfoObj
();

230 
StusW™h
<
DiskLoc
> 
sy¡emIndexesEÁry
 = 
_šdexRecÜdStÜe
->
	`š£¹RecÜd
Ğ
txn
,

231 
¥ec
.
	`objd©a
(),

232 
¥ec
.
	`objsize
(),

234 iàĞ!
sy¡emIndexesEÁry
.
	`isOK
() )

235  
sy¡emIndexesEÁry
.
	`g‘Stus
();

238 
IndexD‘as
 *
id
;

239 
Œy
 {

240 
id
 = &
_d‘as
->
	`idx
(
	`g‘TÙ®IndexCouÁ
(), 
Œue
);

242 
	`ÿtch
Ğ
DBExû±iÚ
& ) {

243 
_d‘as
->
	`®locExŒa
(
txn
,

244 
	`ns
().ns(),

245 
_db
->
_Çme¥aûIndex
,

246 
	`g‘TÙ®IndexCouÁ
());

247 
id
 = &
_d‘as
->
	`idx
(
	`g‘TÙ®IndexCouÁ
(), 
çl£
);

250 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
Ğ&
id
->
šfo
 ) = 
sy¡emIndexesEÁry
.
	`g‘V®ue
();

251 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
Ğ&
id
->
h—d
 ) = 
	`DiskLoc
();

253 
txn
->
	`»cov”yUn™
()->
	`wr™šgIÁ
Ğ
_d‘as
->
šdexBudsInProg»ss
 ) += 1;

256 
Name¥aûIndex
& 
nsi
 = 
_db
->
_Çme¥aûIndex
;

257 
	`šv¬ŸÁ
Ğ
nsi
.
	`d‘as
Ğ
desc
->
	`šdexName¥aû
(èè=ğ
NULL
 );

258 
nsi
.
	`add_ns
Ğ
txn
, 
desc
->
	`šdexName¥aû
(), 
	`DiskLoc
(), 
çl£
 );

261 
_db
->
	`_addName¥aûToName¥aûCŞËùiÚ
Ğ
txn
, 
desc
->
	`šdexName¥aû
(), 
NULL
);

263  
Stus
::
	`OK
();

264 
	}
}

266 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
	$šdexBudSucûss
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

267 cÚ¡ 
SŒšgD©a
& 
šdexName
 ) {

268 
idxNo
 = 
	`_fšdIndexNumb”
Ğ
šdexName
 );

269 
	`çs£¹
Ğ17202, 
idxNo
 >= 0 );

272 iàĞ
idxNo
 !ğ
	`g‘Com¶‘edIndexCouÁ
() ) {

273 
toIdxNo
 = 
	`g‘Com¶‘edIndexCouÁ
();

278 
IndexD‘as
 
‹mp
 = 
_d‘as
->
	`idx
(
idxNo
);

279 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
(&
_d‘as
->
	`idx
(
idxNo
)èğ_d‘as->idx(
toIdxNo
);

280 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
(&
_d‘as
->
	`idx
(
toIdxNo
)èğ
‹mp
;

283 
boŞ
 
‹mpMuÉikey
 = 
	`isIndexMuÉikey
(
idxNo
);

284 
	`£tIndexIsMuÉikey
Ğ
txn
, 
idxNo
, 
	`isIndexMuÉikey
(
toIdxNo
) );

285 
	`£tIndexIsMuÉikey
Ğ
txn
, 
toIdxNo
, 
‹mpMuÉikey
 );

287 
idxNo
 = 
toIdxNo
;

288 
	`šv¬ŸÁ
Ğ
idxNo
 = 
	`_fšdIndexNumb”
Ğ
šdexName
 ) );

291 
txn
->
	`»cov”yUn™
()->
	`wr™šgIÁ
Ğ
_d‘as
->
šdexBudsInProg»ss
 ) -= 1;

292 
txn
->
	`»cov”yUn™
()->
	`wr™šgIÁ
Ğ
_d‘as
->
nIndexes
 ) += 1;

294 
	`šv¬ŸÁ
Ğ
	`isIndexR—dy
Ğ
šdexName
 ) );

295 
	}
}

297 
	gName¥aûD‘asCŞËùiÚC©®ogEÁry
::
	$upd©eTTLS‘tšg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

298 cÚ¡ 
SŒšgD©a
& 
idxName
,

299 
ÃwExpœeSecÚds
 ) {

300 
idx
 = 
	`_fšdIndexNumb”
Ğ
idxName
 );

301 
	`šv¬ŸÁ
Ğ
idx
 >= 0 );

303 
IndexD‘as
& 
šdexD‘as
 = 
_d‘as
->
	`idx
Ğ
idx
 );

305 
RecÜd
* 
»cÜd
 = 
_šdexRecÜdStÜe
->
	`»cÜdFÜ
Ğ
šdexD‘as
.
šfo
 );

306 
BSONObj
 
	`obj
Ğ
»cÜd
->
	`d©a
() );

307 cÚ¡ 
BSONEËm’t
 
ŞdExpœeSecs
 = 
obj
.
	`g‘F›ld
("expireAfterSeconds");

312 * 
nÚCÚ¡PŒ
 = 
cÚ¡_ÿ¡
<*>(
ŞdExpœeSecs
.
	`v®ue
());

313  
ŞdExpœeSecs
.
	`ty³
() ) {

314 
EOO
:

315 
	`mas£¹
Ğ16631, "šdex dÛ nÙ havª 'expœeAá”SecÚds' f›ld", 
çl£
 );

317 
Numb”IÁ
:

318 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
(
»š‹½»t_ÿ¡
<*>(
nÚCÚ¡PŒ
)èğ
ÃwExpœeSecÚds
;

320 
Numb”DoubË
:

321 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
(
»š‹½»t_ÿ¡
<*>(
nÚCÚ¡PŒ
)èğ
ÃwExpœeSecÚds
;

323 
Numb”LÚg
:

324 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
(
»š‹½»t_ÿ¡
<*>(
nÚCÚ¡PŒ
)èğ
ÃwExpœeSecÚds
;

327 
	`mas£¹
Ğ16632, "cu¼’ˆ'expœeAá”SecÚds' i nÙ‡‚umb”", 
çl£
 );

329 
	}
}

	@catalog/namespace_details_collection_entry.h

3 #´agm¨
Úû


33 
	~"mÚgo/ba£/¡ršg_d©a.h
"

34 
	~"mÚgo/bsÚ/bsÚobj.h
"

35 
	~"mÚgo/db/ÿlog/cŞËùiÚ_ÿlog_’Œy.h
"

36 
	~"mÚgo/db/diskloc.h
"

38 
Çme¥aû
 
	gmÚgo
 {

40 
şass
 
	gName¥aûD‘as
;

42 
şass
 
	gMMAPV1D©aba£C©®ogEÁry
;;

43 
şass
 
	gRecÜdStÜe
;

44 
şass
 
	gO³¿tiÚCÚ‹xt
;

46 şas 
	cName¥aûD‘asCŞËùiÚC©®ogEÁry
 : 
public
 
CŞËùiÚC©®ogEÁry
 {

47 
public
:

48 
Name¥aûD‘asCŞËùiÚC©®ogEÁry
ĞcÚ¡ 
SŒšgD©a
& 
ns
,

49 
Name¥aûD‘as
* 
d‘as
,

50 
RecÜdStÜe
* 
šdexRecÜdStÜe
,

51 
MMAPV1D©aba£C©®ogEÁry
* 
db
 );

53 
	gvœtu®
 ~
Name¥aûD‘asCŞËùiÚC©®ogEÁry
(){}

55 
vœtu®
 
g‘TÙ®IndexCouÁ
() const;

57 
vœtu®
 
g‘Com¶‘edIndexCouÁ
() const;

59 
vœtu®
 
g‘MaxAÎowedIndexes
() const;

61 
vœtu®
 
g‘AÎIndexes
Ğ
¡d
::
veùÜ
<¡d::
¡ršg
>* 
Çmes
 ) const;

63 
vœtu®
 
BSONObj
 
g‘IndexS³c
ĞcÚ¡ 
SŒšgD©a
& 
idxName
 ) const;

65 
vœtu®
 
boŞ
 
isIndexMuÉikey
(cÚ¡ 
SŒšgD©a
& 
šdexName
) const;

66 
vœtu®
 
boŞ
 
isIndexMuÉikey
(
idxNo
) const;

68 
vœtu®
 
boŞ
 
£tIndexIsMuÉikey
(
O³¿tiÚCÚ‹xt
* 
txn
,

69 
idxNo
,

70 
boŞ
 
muÉikey
 = 
Œue
);

71 
vœtu®
 
boŞ
 
£tIndexIsMuÉikey
(
O³¿tiÚCÚ‹xt
* 
txn
,

72 cÚ¡ 
SŒšgD©a
& 
šdexName
,

73 
boŞ
 
muÉikey
 = 
Œue
);

75 
vœtu®
 
DiskLoc
 
g‘IndexH—d
ĞcÚ¡ 
SŒšgD©a
& 
šdexName
 ) const;

77 
vœtu®
 
£tIndexH—d
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

78 cÚ¡ 
SŒšgD©a
& 
šdexName
,

79 cÚ¡ 
DiskLoc
& 
ÃwH—d
 );

81 
vœtu®
 
boŞ
 
isIndexR—dy
ĞcÚ¡ 
SŒšgD©a
& 
šdexName
 ) const;

83 
vœtu®
 
Stus
 
»moveIndex
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

84 cÚ¡ 
SŒšgD©a
& 
šdexName
 );

86 
vœtu®
 
Stus
 
´•¬eFÜIndexBud
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

87 cÚ¡ 
IndexDesütÜ
* 
¥ec
 );

89 
vœtu®
 
šdexBudSucûss
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

90 cÚ¡ 
SŒšgD©a
& 
šdexName
 );

92 
vœtu®
 
upd©eTTLS‘tšg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

93 cÚ¡ 
SŒšgD©a
& 
idxName
,

94 
ÃwExpœeSecÚds
 );

98 
_fšdIndexNumb”
ĞcÚ¡ 
SŒšgD©a
& 
šdexName
) const;

100 
	g´iv©e
:

101 
Name¥aûD‘as
* 
_d‘as
;

102 
RecÜdStÜe
* 
	g_šdexRecÜdStÜe
;

103 
MMAPV1D©aba£C©®ogEÁry
* 
	g_db
;

105 
ä›nd
 
şass
 
	gMMAPV1D©aba£C©®ogEÁry
;

	@catalog/namespace_details_rsv1_metadata.cpp

31 
	~"mÚgo/db/İs/upd©e.h
"

32 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_d‘as_rsv1_m‘ad©a.h
"

34 
Çme¥aû
 
	gmÚgo
 {

35 
	gName¥aûD‘asRSV1M‘aD©a
::
Name¥aûD‘asRSV1M‘aD©a
ĞcÚ¡ 
SŒšgD©a
& 
ns
,

36 
Name¥aûD‘as
* 
d‘as
,

37 
RecÜdStÜe
* 
Çme¥aûRecÜdStÜe
 )

38 : 
_ns
Ğ
ns
.
toSŒšg
() ),

39 
_d‘as
Ğ
d‘as
 ),

40 
_Çme¥aûRecÜdStÜe
Ğ
Çme¥aûRecÜdStÜe
 ) {

43 cÚ¡ 
	gDiskLoc
& 
	gName¥aûD‘asRSV1M‘aD©a
::
ÿpEx‹Á
() const {

44  
_d‘as
->
ÿpEx‹Á
;

47 
	gName¥aûD‘asRSV1M‘aD©a
::
£tC­Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) {

48 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
ÿpEx‹Á
 ) = 
loc
;

51 cÚ¡ 
	gDiskLoc
& 
	gName¥aûD‘asRSV1M‘aD©a
::
ÿpFœ¡NewRecÜd
() const {

52  
_d‘as
->
ÿpFœ¡NewRecÜd
;

55 
	gName¥aûD‘asRSV1M‘aD©a
::
£tC­Fœ¡NewRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

56 cÚ¡ 
DiskLoc
& 
loc
 ) {

57 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
ÿpFœ¡NewRecÜd
 ) = 
loc
;

60 
boŞ
 
	gName¥aûD‘asRSV1M‘aD©a
::
ÿpLoİed
() const {

61  
_d‘as
->
ÿpFœ¡NewRecÜd
.
isV®id
();

64 
	gName¥aûD‘asRSV1M‘aD©a
::
d©aSize
() const {

65  
_d‘as
->
¡©s
.
d©asize
;

67 
	gName¥aûD‘asRSV1M‘aD©a
::
numRecÜds
() const {

68  
_d‘as
->
¡©s
.
ÄecÜds
;

71 
	gName¥aûD‘asRSV1M‘aD©a
::
šüem’tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

72 
d©aSizeInüem’t
,

73 
numRecÜdsInüem’t
 ) {

75 
	gName¥aûD‘as
::
Sts
* 
s
 = 
txn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
¡©s
 );

76 
	gs
->
	gd©asize
 +ğ
d©aSizeInüem’t
;

77 
	gs
->
	gÄecÜds
 +ğ
numRecÜdsInüem’t
;

80 
	gName¥aûD‘asRSV1M‘aD©a
::
£tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

81 
d©aSize
,

82 
numRecÜds
 ) {

83 
	gName¥aûD‘as
::
Sts
* 
s
 = 
txn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
¡©s
 );

84 
	gs
->
	gd©asize
 = 
d©aSize
;

85 
	gs
->
	gÄecÜds
 = 
numRecÜds
;

88 cÚ¡ 
	gDiskLoc
& 
	gName¥aûD‘asRSV1M‘aD©a
::
d–‘edLi¡EÁry
Ğ
buck‘
 ) const {

89  
_d‘as
->
d–‘edLi¡
[ 
buck‘
 ];

92 
	gName¥aûD‘asRSV1M‘aD©a
::
£tD–‘edLi¡EÁry
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

93 
buck‘
,

94 cÚ¡ 
DiskLoc
& 
loc
 ) {

95 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
d–‘edLi¡
[
buck‘
] ) = 
loc
;

98 
	gName¥aûD‘asRSV1M‘aD©a
::
ÜphªD–‘edLi¡
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

99  
i
 = 0; 
	gi
 < 
	gBuck‘s
; i++ ) {

100 
£tD–‘edLi¡EÁry
Ğ
txn
, 
i
, 
DiskLoc
() );

104 cÚ¡ 
	gDiskLoc
& 
	gName¥aûD‘asRSV1M‘aD©a
::
fœ¡Ex‹Á
() const {

105  
_d‘as
->
fœ¡Ex‹Á
;

108 
	gName¥aûD‘asRSV1M‘aD©a
::
£tFœ¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) {

109 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
fœ¡Ex‹Á
 ) = 
loc
;

112 cÚ¡ 
	gDiskLoc
& 
	gName¥aûD‘asRSV1M‘aD©a
::
Ï¡Ex‹Á
() const {

113  
_d‘as
->
Ï¡Ex‹Á
;

116 
	gName¥aûD‘asRSV1M‘aD©a
::
£tLa¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) {

117 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
_d‘as
->
Ï¡Ex‹Á
 ) = 
loc
;

120 
boŞ
 
	gName¥aûD‘asRSV1M‘aD©a
::
isC­³d
() const {

121  
_d‘as
->
isC­³d
;

124 
boŞ
 
	gName¥aûD‘asRSV1M‘aD©a
::
isU£rFÏgS‘
Ğ
æag
 ) const {

125  
_d‘as
->
u£rFÏgs
 & 
æag
;

128 
	gName¥aûD‘asRSV1M‘aD©a
::
u£rFÏgs
() const {

129  
_d‘as
->
u£rFÏgs
;

132 
boŞ
 
	gName¥aûD‘asRSV1M‘aD©a
::
£tU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 ) {

133 iàĞĞ
	g_d‘as
->
	gu£rFÏgs
 & 
	gæag
 ) =ğ
æag
 )

134  
çl£
;

136 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
Ğ
_d‘as
->
u£rFÏgs
è|ğ
æag
;

137 
_syncU£rFÏgs
Ğ
txn
 );

138  
	gŒue
;

141 
boŞ
 
	gName¥aûD‘asRSV1M‘aD©a
::
ş—rU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 ) {

142 iàĞĞ
	g_d‘as
->
	gu£rFÏgs
 & 
	gæag
 ) == 0 )

143  
çl£
;

145 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
(
_d‘as
->
u£rFÏgs
è&ğ~
æag
;

146 
_syncU£rFÏgs
Ğ
txn
 );

147  
	gŒue
;

150 
boŞ
 
	gName¥aûD‘asRSV1M‘aD©a
::
»¶aûU£rFÏgs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æags
 ) {

151 iàĞ
	g_d‘as
->
	gu£rFÏgs
 =ğ
æags
 )

152  
çl£
;

154 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
(
_d‘as
->
u£rFÏgs
èğ
æags
;

155 
_syncU£rFÏgs
Ğ
txn
 );

156  
	gŒue
;

159 
	gName¥aûD‘asRSV1M‘aD©a
::
Ï¡Ex‹ÁSize
() const {

160  
_d‘as
->
Ï¡Ex‹ÁSize
;

163 
	gName¥aûD‘asRSV1M‘aD©a
::
£tLa¡Ex‹ÁSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
ÃwMax
 ) {

164 iàĞ
	g_d‘as
->
	gÏ¡Ex‹ÁSize
 =ğ
ÃwMax
 )

166 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
(
_d‘as
->
Ï¡Ex‹ÁSize
èğ
ÃwMax
;

169 
	gName¥aûD‘asRSV1M‘aD©a
::
maxC­³dDocs
() const {

170 
šv¬ŸÁ
Ğ
_d‘as
->
isC­³d
 );

171 iàĞ
	g_d‘as
->
	gmaxDocsInC­³d
 == 0x7fffffff )

172  
num”ic_lim™s
<>::
max
();

173  
	g_d‘as
->
	gmaxDocsInC­³d
;

176 
	gName¥aûD‘asRSV1M‘aD©a
::
·ddšgFaùÜ
() const {

177  
_d‘as
->
·ddšgFaùÜ
;

180 
	gName¥aûD‘asRSV1M‘aD©a
::
£tPaddšgFaùÜ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
·ddšgFaùÜ
 ) {

181 iàĞ
	g·ddšgFaùÜ
 =ğ
_d‘as
->
·ddšgFaùÜ
 )

184 iàĞ
	g_d‘as
->
	gisC­³d
 )

187 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
_d‘as
->
·ddšgFaùÜ
) =…addingFactor;

190 
	gName¥aûD‘asRSV1M‘aD©a
::
_syncU£rFÏgs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

191 iàĞ!
_Çme¥aûRecÜdStÜe
 )

194 
	gscİed_±r
<
	gRecÜdI‹¿tÜ
> 
™”©Ü
Ğ
_Çme¥aûRecÜdStÜe
->
g‘I‹¿tÜ
Ğ
DiskLoc
(),

195 
çl£
,

196 
CŞËùiÚSÿnP¬ams
::
FORWARD
 ) );

197  !
	g™”©Ü
->
isEOF
() ) {

198 
DiskLoc
 
	gloc
 = 
™”©Ü
->
g‘Next
();

199 cÚ¡ 
RecÜd
* 
	g»c
 = 
™”©Ü
->
»cÜdFÜ
Ğ
loc
 );

201 
BSONObj
 
ŞdEÁry
Ğ
»c
->
d©a
() );

202 
BSONEËm’t
 
	ge
 = 
ŞdEÁry
["name"];

203 iàĞ
	ge
.
ty³
(è!ğ
SŒšg
 )

206 iàĞ
	ge
.
SŒšg
(è!ğ
_ns
 )

209 
BSONObj
 
	gÃwEÁry
 = 
­¶yUpd©eO³¿tÜs
Ğ
ŞdEÁry
,

210 
BSON
Ğ"$£t" << BSONĞ"İtiÚs.æags" << 
u£rFÏgs
() ) ) );

212 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
_Çme¥aûRecÜdStÜe
->
upd©eRecÜd
Ğ
txn
,

213 
loc
,

214 
ÃwEÁry
.
objd©a
(),

215 
ÃwEÁry
.
objsize
(),

217 
NULL
 );

218 
çs£¹
Ğ17486, 
»suÉ
.
isOK
() );

222 
çs£¹Faed
( 17488 );

	@catalog/namespace_details_rsv1_metadata.h

31 #´agm¨
Úû


33 
	~<¡ršg
>

35 
	~"mÚgo/ba£/¡ršg_d©a.h
"

36 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_d‘as.h
"

37 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ba£.h
"

39 
Çme¥aû
 
	gmÚgo
 {

41 
şass
 
	gRecÜdStÜe
;

47 şas 
	cName¥aûD‘asRSV1M‘aD©a
 : 
public
 
RecÜdStÜeV1M‘aD©a
 {

48 
public
:

49 
ex¶ic™
 
Name¥aûD‘asRSV1M‘aD©a
ĞcÚ¡ 
SŒšgD©a
& 
ns
,

50 
Name¥aûD‘as
* 
d‘as
,

51 
RecÜdStÜe
* 
Çme¥aûRecÜdStÜe
 );

53 
	gvœtu®
 ~
Name¥aûD‘asRSV1M‘aD©a
(){}

55 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
ÿpEx‹Á
() const;

56 
vœtu®
 
£tC­Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

58 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
ÿpFœ¡NewRecÜd
() const;

59 
vœtu®
 
£tC­Fœ¡NewRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

61 
vœtu®
 
boŞ
 
ÿpLoİed
() const;

63 
vœtu®
 
d©aSize
() const;

64 
vœtu®
 
numRecÜds
() const;

66 
vœtu®
 
šüem’tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

67 
d©aSizeInüem’t
,

68 
numRecÜdsInüem’t
 );

70 
vœtu®
 
£tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

71 
d©aSize
,

72 
numRecÜds
 );

74 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
d–‘edLi¡EÁry
Ğ
buck‘
 ) const;

75 
vœtu®
 
£tD–‘edLi¡EÁry
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

76 
buck‘
,

77 cÚ¡ 
DiskLoc
& 
loc
 );

78 
vœtu®
 
ÜphªD–‘edLi¡
(
O³¿tiÚCÚ‹xt
* 
txn
);

80 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
fœ¡Ex‹Á
() const;

81 
vœtu®
 
£tFœ¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

83 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
Ï¡Ex‹Á
() const;

84 
vœtu®
 
£tLa¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

86 
vœtu®
 
boŞ
 
isC­³d
() const;

88 
vœtu®
 
boŞ
 
isU£rFÏgS‘
Ğ
æag
 ) const;

89 
vœtu®
 
u£rFÏgs
() const;

90 
vœtu®
 
boŞ
 
£tU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 );

91 
vœtu®
 
boŞ
 
ş—rU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 );

92 
vœtu®
 
boŞ
 
»¶aûU£rFÏgs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æags
 );

94 
vœtu®
 
Ï¡Ex‹ÁSize
() const;

95 
vœtu®
 
£tLa¡Ex‹ÁSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
ÃwMax
 );

97 
vœtu®
 
maxC­³dDocs
() const;

99 
vœtu®
 
·ddšgFaùÜ
() const;

100 
vœtu®
 
£tPaddšgFaùÜ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
·ddšgFaùÜ
 );

102 
	g´iv©e
:

104 
_syncU£rFÏgs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

106 
	g¡d
::
¡ršg
 
_ns
;

107 
Name¥aûD‘as
* 
	g_d‘as
;

108 
RecÜdStÜe
* 
	g_Çme¥aûRecÜdStÜe
;

	@catalog/namespace_index.cpp

31 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_šdex.h
"

33 
	~<boo¡/fesy¡em/İ”©iÚs.hµ
>

35 
	~"mÚgo/db/d_cÚcu¼’cy.h
"

36 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

37 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû_d‘as.h
"

38 
	~"mÚgo/ut/ex™.h
"

40 
Çme¥aû
 
	gmÚgo
 {

42 
Name¥aûD‘as
* 
	gName¥aûIndex
::
d‘as
(cÚ¡ 
SŒšgD©a
& 
ns
) {

43 
Name¥aû
 
n
(
ns
);

44  
d‘as
(
n
);

47 
Name¥aûD‘as
* 
	gName¥aûIndex
::
d‘as
(cÚ¡ 
Name¥aû
& 
ns
) {

48 iàĞ!
_ht
.
g‘
() )

50  
	g_ht
->
g‘
(
ns
);

53 
	gName¥aûIndex
::
add_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

54 cÚ¡ 
SŒšgD©a
& 
ns
, cÚ¡ 
DiskLoc
& 
loc
, 
boŞ
 
ÿµed
) {

55 
Name¥aûD‘as
 
d‘as
Ğ
loc
, 
ÿµed
 );

56 
add_ns
Ğ
txn
, 
ns
, &
d‘as
 );

59 
	gName¥aûIndex
::
add_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

60 cÚ¡ 
SŒšgD©a
& 
ns
, cÚ¡ 
Name¥aûD‘as
* 
d‘as
 ) {

61 
Name¥aû
 
n
(
ns
);

62 
add_ns
Ğ
txn
, 
n
, 
d‘as
 );

65 
	gName¥aûIndex
::
add_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

66 cÚ¡ 
Name¥aû
& 
ns
, cÚ¡ 
Name¥aûD‘as
* 
d‘as
 ) {

67 
¡ršg
 
	gnsSŒšg
 = 
ns
.
toSŒšg
();

68 
	gtxn
->
lockS‹
()->
as£¹Wr™eLocked
Ğ
nsSŒšg
 );

69 
mas£¹
Ğ17315, "nØ. iÀns", 
nsSŒšg
.
fšd
Ğ'.' ) !ğ
¡ršg
::
Åos
 );

70 
š™
Ğ
txn
 );

71 
uas£¹
Ğ10081, "toØmªy‚ame¥aûs/cŞËùiÚs", 
_ht
->
put
(
txn
, 
ns
, *
d‘as
));

74 
	gName¥aûIndex
::
kl_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
SŒšgD©a
& 
ns
) {

75 
	gtxn
->
lockS‹
()->
as£¹Wr™eLocked
(
ns
);

76 iàĞ!
	g_ht
.
g‘
() )

78 
Name¥aû
 
n
(
ns
);

79 
	g_ht
->
kl
(
txn
, 
n
);

81 ià(
	gns
.
size
(è<ğ
Name¥aû
::
MaxNsCŞËtiÚL’
) {

85  
i
 = 0; 
	gi
<=1; i++ ) {

86 
	gŒy
 {

87 
Name¥aû
 
exŒa
(
n
.
exŒaName
(
i
));

88 
	g_ht
->
kl
(
txn
, 
exŒa
);

90 
ÿtch
(
DBExû±iÚ
&) {

91 
LOG
(3è<< "ÿughˆexû±iÚ iÀkl_ns" << 
	g’dl
;

97 
boŞ
 
	gName¥aûIndex
::
·thExi¡s
() const {

98  
boo¡
::
fesy¡em
::
exi¡s
(
·th
());

101 
	gboo¡
::
fesy¡em
::
·th
 
Name¥aûIndex
::path() const {

102 
boo¡
::
fesy¡em
::
·th
 
»t
Ğ
_dœ
 );

103 ià(
	g¡ÜageGlob®P¬ams
.
	gdœeùÜy³rdb
)

104 
	g»t
 /ğ
_d©aba£
;

105 
	g»t
 /ğĞ
_d©aba£
 + ".ns" );

106  
	g»t
;

109 
Çme¥aûG‘Name¥aûsC®lback
ĞcÚ¡ 
Name¥aû
& 
k
 , 
Name¥aûD‘as
& 
v
 , * 
exŒa
 ) {

110 
	gli¡
<
	g¡ršg
> * 
	gl
 = (
li¡
<
¡ršg
>*)
exŒa
;

111 iàĞ! 
	gk
.
hasDŞÏrSign
() || k == "local.oplog.$main" ) {

114 
l
->
push_back
Ğ(
¡ršg
)
k
 );

118 
	gName¥aûIndex
::
g‘CŞËùiÚName¥aûs
Ğ
li¡
<
¡ršg
>* 
tofl
 ) const {

119 iàĞ
_ht
.
g‘
() )

120 
_ht
->
™”AÎ
Ğ
Çme¥aûG‘Name¥aûsC®lback
 , (*)
tofl
 );

123 
	gName¥aûIndex
::
maybeMkdœ
() const {

124 ià(!
¡ÜageGlob®P¬ams
.
dœeùÜy³rdb
)

126 
	gboo¡
::
fesy¡em
::
·th
 
dœ
Ğ
_dœ
 );

127 
	gdœ
 /ğ
_d©aba£
;

128 iàĞ!
	gboo¡
::
fesy¡em
::
exi¡s
Ğ
dœ
 ) )

129 
MONGO_ASSERT_ON_EXCEPTION_WITH_MSG
Ğ
boo¡
::
fesy¡em
::
ü—‹_dœeùÜy
Ğ
dœ
 ), "create dir for db " );

132 
NOINLINE_DECL
 
	gName¥aûIndex
::
_š™
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

133 
v”ify
Ğ!
_ht
.
g‘
() );

135 
	gtxn
->
lockS‹
()->
as£¹Wr™eLocked
(
_d©aba£
);

148 
	gËn
 = 0;

149 
	gboo¡
::
fesy¡em
::
·th
 
nsP©h
 =…ath();

150 
¡ršg
 
	g·thSŒšg
 = 
nsP©h
.string();

151 *
	gp
 = 0;

152 iàĞ
	gboo¡
::
fesy¡em
::
exi¡s
(
nsP©h
) ) {

153 ifĞ
_f
.
İ’
(
·thSŒšg
, 
Œue
) ) {

154 
	gËn
 = 
_f
.
Ëngth
();

155 iàĞ
	gËn
 % (1024*1024) != 0 ) {

156 
log
(è<< "bad .n fe: " << 
·thSŒšg
 << 
’dl
;

157 
uas£¹
Ğ10079 , "bad .n fËngth, cªnÙ o³Àd©aba£", 
Ën
 % (1024*1024) == 0 );

159 
	gp
 = 
_f
.
g‘V›w
();

164 
mas£¹
(10343, "bad storageGlobalParams.lenForNewNsFiles",

165 
¡ÜageGlob®P¬ams
.
ËnFÜNewNsFes
 >= 1024*1024);

166 
maybeMkdœ
();

167 
	gl
 = 
¡ÜageGlob®P¬ams
.
ËnFÜNewNsFes
;

168 iàĞ
	g_f
.
ü—‹
(
·thSŒšg
, 
l
, 
Œue
) ) {

174 
g‘Dur
().
ü—‹dFe
(
·thSŒšg
, 
l
);

175 
	gËn
 = 
l
;

176 
v”ify
(
Ën
 =ğ
¡ÜageGlob®P¬ams
.
ËnFÜNewNsFes
);

177 
	gp
 = 
_f
.
g‘V›w
();

179 iàĞ
	gp
 ) {

183 
g‘Dur
().
wr™šgPŒ
Ğ
p
, 5 );

188 iàĞ
	gp
 == 0 ) {

190 
log
(è<< "”rÜ couldn'ˆİ’ f" << 
·thSŒšg
 << "”mš©šg" << 
’dl
;

191 
dbex™
Ğ
EXIT_FS
 );

195 
v”ify
Ğ
Ën
 <= 0x7fffffff );

196 
	g_ht
.
»£t
(
Ãw
 
HashTabË
<
Name¥aû
,
Name¥aûD‘as
>(
p
, (è
Ën
, "namespace index"));

	@catalog/namespace_index.h

31 #´agm¨
Úû


33 
	~<li¡
>

34 
	~<¡ršg
>

36 
	~"mÚgo/ba£/di§Îow_cİyšg.h
"

37 
	~"mÚgo/db/diskloc.h
"

38 
	~"mÚgo/db/¡ruùu»/ÿlog/hashb.h
"

39 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû.h
"

41 
Çme¥aû
 
	gmÚgo
 {

43 
şass
 
	gName¥aûD‘as
;

44 
şass
 
	gO³¿tiÚCÚ‹xt
;

49 şas 
	cName¥aûIndex
 {

50 
MONGO_DISALLOW_COPYING
(
Name¥aûIndex
);

51 
	gpublic
:

52 
Name¥aûIndex
(cÚ¡ 
¡d
::
¡ršg
 &
dœ
, cÚ¡ std::¡ršg &
d©aba£
) :

53 
_ht
Ğ0 ), 
_dœ
Ğ
dœ
 ), 
_d©aba£
Ğ
d©aba£
 ) {}

56 
boŞ
 
·thExi¡s
() const;

58 
š™
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

59 iàĞ!
	g_ht
.
g‘
() )

60 
_š™
Ğ
txn
 );

63 
add_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

64 cÚ¡ 
SŒšgD©a
& 
ns
, cÚ¡ 
DiskLoc
& 
loc
, 
boŞ
 
ÿµed
);

65 
add_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

66 cÚ¡ 
SŒšgD©a
& 
ns
, cÚ¡ 
Name¥aûD‘as
* 
d‘as
 );

67 
add_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

68 cÚ¡ 
Name¥aû
& 
ns
, cÚ¡ 
Name¥aûD‘as
* 
d‘as
 );

70 
Name¥aûD‘as
* 
d‘as
(cÚ¡ 
SŒšgD©a
& 
ns
);

71 
Name¥aûD‘as
* 
d‘as
(cÚ¡ 
Name¥aû
& 
ns
);

73 
kl_ns
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

74 cÚ¡ 
SŒšgD©a
& 
ns
);

76 
boŞ
 
®loÿ‹d
(ècÚ¡ {  
	g_ht
.
g‘
() != 0; }

78 
g‘CŞËùiÚName¥aûs
Ğ
¡d
::
li¡
<¡d::
¡ršg
>* 
tofl
 ) const;

80 
	gboo¡
::
fesy¡em
::
·th
…ath() const;

82 
feL’gth
(ècÚ¡ {  
	g_f
.
Ëngth
(); }

84 
	g´iv©e
:

85 
_š™
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

86 
maybeMkdœ
() const;

88 
Du¿bËM­³dFe
 
	g_f
;

89 
	gscİed_±r
<
	gHashTabË
<
	gName¥aû
,
	gName¥aûD‘as
> > 
	g_ht
;

90 
	g¡d
::
¡ršg
 
_dœ
;

91 
	g¡d
::
¡ršg
 
_d©aba£
;

	@catalog/namespace_test.cpp

31 
	~"mÚgo/un™‹¡/un™‹¡.h
"

33 
	~"mÚgo/db/¡ruùu»/ÿlog/Çme¥aû.h
"

35 
Çme¥aû
 
	gmÚgo
 {

37 
TEST
Ğ
Name¥aûTe¡
, 
Basics
 ) {

38 
Name¥aû
 
foo
( "foo.bar" );

39 
Name¥aû
 
b¬
( "bar.foo" );

41 
ASSERT_EQUALS
Ğ
foo
.
toSŒšg
(), foo.toString() );

42 
ASSERT_EQUALS
Ğ
foo
.
hash
(), foo.hash() );

44 
ASSERT_NOT_EQUALS
Ğ
foo
.
hash
(), 
b¬
.hash() );

46 
ASSERT
Ğ
foo
 == foo );

47 
ASSERT
Ğ!Ğ
foo
 != foo ) );

48 
ASSERT
Ğ
foo
 !ğ
b¬
 );

49 
ASSERT
Ğ!Ğ
foo
 =ğ
b¬
 ) );

52 
TEST
Ğ
Name¥aûTe¡
, 
ExŒaName
 ) {

53 
Name¥aû
 
foo
( "foo.bar" );

54 
ASSERT_FALSE
Ğ
foo
.
isExŒa
() );

56 
¡ršg
 
	g¡r0
 = 
foo
.
exŒaName
( 0 );

57 
ASSERT_EQUALS
Ğ"foo.b¬$exŒa", 
¡r0
 );

58 
Name¥aû
 
ex0
Ğ
¡r0
 );

59 
ASSERT_TRUE
Ğ
ex0
.
isExŒa
() );

61 
¡ršg
 
	g¡r1
 = 
foo
.
exŒaName
( 1 );

62 
ASSERT_EQUALS
Ğ"foo.b¬$exŒb", 
¡r1
 );

63 
Name¥aû
 
ex1
Ğ
¡r1
 );

64 
ASSERT_TRUE
Ğ
ex1
.
isExŒa
() );

	@collection_compact.cpp

31 
	~"mÚgo/db/ÿlog/cŞËùiÚ.h
"

33 
	~"mÚgo/ba£/couÁ”.h
"

34 
	~"mÚgo/ba£/owÃd_poš‹r_m­.h
"

35 
	~"mÚgo/db/ÿlog/šdex_ü—‹.h
"

36 
	~"mÚgo/db/ş›ÁcursÜ.h
"

37 
	~"mÚgo/db/commªds/£rv”_¡©us.h
"

38 
	~"mÚgo/db/curİ.h
"

39 
	~"mÚgo/db/ÿlog/d©aba£.h
"

40 
	~"mÚgo/db/ÿlog/šdex_key_v®id©e.h
"

41 
	~"mÚgo/db/šdex/šdex_acûss_m‘hod.h
"

42 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

43 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

44 
	~"mÚgo/db/¡Üage/»cÜd.h
"

45 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

46 
	~"mÚgo/ut/touch_·ges.h
"

48 
Çme¥aû
 
	gmÚgo
 {

50 
	gÇme¥aû
 {

51 
BSONObj
 
_com·ùAdju¡IndexS³c
ĞcÚ¡ BSONObj& 
ŞdS³c
 ) {

52 
BSONObjBud”
 
	gb
;

53 
	gBSONObj
::
™”©Ü
 
i
Ğ
ŞdS³c
 );

54  
	gi
.
mÜe
() ) {

55 
BSONEËm’t
 
	ge
 = 
i
.
Ãxt
();

56 iàĞ
	g¡r
::
equ®s
Ğ
e
.
f›ldName
(), "v" ) ) {

61 iàĞ
	g¡r
::
equ®s
Ğ
e
.
f›ldName
(), "background" ) ) {

66 
	gb
.
­³nd
(
e
);

68  
	gb
.
obj
();

71 şas 
	cMyCom·ùAd­tÜ
 : 
public
 
RecÜdStÜeCom·ùAd­tÜ
 {

72 
public
:

73 
MyCom·ùAd­tÜ
(
CŞËùiÚ
* 
cŞËùiÚ
,

74 
MuÉiIndexBlock
* 
šdexBlock
)

76 : 
_cŞËùiÚ
Ğ
cŞËùiÚ
 ),

77 
_muÉiIndexBlock
(
šdexBlock
) {

80 
vœtu®
 
boŞ
 
isD©aV®id
Ğ
RecÜd
* 
»c
 ) {

81  
BSONObj
Ğ
»c
->
d©a
(è).
v®id
();

84 
vœtu®
 
size_t
 
d©aSize
Ğ
RecÜd
* 
»c
 ) {

85  
BSONObj
Ğ
»c
->
d©a
(è).
objsize
();

88 
vœtu®
 
š£¹ed
Ğ
RecÜd
* 
»c
, cÚ¡ 
DiskLoc
& 
ÃwLoÿtiÚ
 ) {

89 
In£¹D–‘eO±iÚs
 
	gİtiÚs
;

90 
	gİtiÚs
.
	glogIfE¼Ü
 = 
çl£
;

91 
	gİtiÚs
.
	gdupsAÎowed
 = 
Œue
;

93 
	g_muÉiIndexBlock
->
š£¹
Ğ
BSONObj
Ğ
»c
->
d©a
(è), 
ÃwLoÿtiÚ
, 
İtiÚs
 );

96 
	g´iv©e
:

97 
CŞËùiÚ
* 
_cŞËùiÚ
;

99 
MuÉiIndexBlock
* 
	g_muÉiIndexBlock
;

105 
	gStusW™h
<
	gCom·ùSts
> 
	gCŞËùiÚ
::
	$com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

106 cÚ¡ 
Com·ùO±iÚs
* 
com·ùO±iÚs
 ) {

107 iàĞ!
_»cÜdStÜe
->
	`com·ùSuµÜ‹d
() )

108  
StusW™h
<
Com·ùSts
>Ğ
E¼ÜCodes
::
BadV®ue
,

109 
¡r
::
	`¡»am
() <<

111 
_»cÜdStÜe
->
	`Çme
() );

113 iàĞ
_šdexC©®og
.
	`numIndexesInProg»ss
() )

114  
StusW™h
<
Com·ùSts
>Ğ
E¼ÜCodes
::
BadV®ue
,

119 
_šfoCache
.
	`»£t
();

121 
veùÜ
<
BSONObj
> 
šdexS³cs
;

123 
IndexC©®og
::
IndexI‹¿tÜ
 
	`ii
Ğ
_šdexC©®og
.
	`g‘IndexI‹¿tÜ
Ğ
çl£
 ) );

124  
ii
.
	`mÜe
() ) {

125 
IndexDesütÜ
* 
desütÜ
 = 
ii
.
	`Ãxt
();

127 cÚ¡ 
BSONObj
 
¥ec
 = 
	`_com·ùAdju¡IndexS³c
(
desütÜ
->
	`šfoObj
());

128 cÚ¡ 
BSONObj
 
key
 = 
¥ec
.
	`g‘ObjeùF›ld
("key");

129 cÚ¡ 
Stus
 
keyStus
 = 
	`v®id©eKeyP©‹º
(
key
);

130 ià(!
keyStus
.
	`isOK
()) {

131  
StusW™h
<
Com·ùSts
>(

132 
E¼ÜCodes
::
CªnÙC»©eIndex
,

133 
¡r
::
	`¡»am
() << "Cannot compact collection dueo invalid index "

134 << 
¥ec
 << ": " << 
keyStus
.
	`»asÚ
() << " For more info see"

137 
šdexS³cs
.
	`push_back
(
¥ec
);

143 
	`log
(è<< "com·ù drİpšg indexes" << 
’dl
;

144 
Stus
 
¡©us
 = 
_šdexC©®og
.
	`drİAÎIndexes
(
txn
, 
Œue
);

145 iàĞ!
¡©us
.
	`isOK
() ) {

146  
StusW™h
<
Com·ùSts
>Ğ
¡©us
 );

149 
txn
->
	`checkFÜIÁ”ru±
();

151 
Com·ùSts
 
¡©s
;

153 
MuÉiIndexBlock
 
	`muÉiIndexBlock
(
txn
, 
this
);

154 
¡©us
 = 
muÉiIndexBlock
.
	`š™
Ğ
šdexS³cs
 );

155 iàĞ!
¡©us
.
	`isOK
() )

156  
StusW™h
<
Com·ùSts
>Ğ
¡©us
 );

158 
MyCom·ùAd­tÜ
 
	`ad­tÜ
(
this
, &
muÉiIndexBlock
);

160 
_»cÜdStÜe
->
	`com·ù
Ğ
txn
, &
ad­tÜ
, 
com·ùO±iÚs
, &
¡©s
 );

162 
	`log
() << "starting index commits";

163 
¡©us
 = 
muÉiIndexBlock
.
	`comm™
();

164 iàĞ!
¡©us
.
	`isOK
() )

165  
StusW™h
<
Com·ùSts
>Ğ
¡©us
 );

167  
StusW™h
<
Com·ùSts
>Ğ
¡©s
 );

168 
	}
}

	@head_manager.h

29 #´agm¨
Úû


31 
	~"mÚgo/db/diskloc.h
"

33 
Çme¥aû
 
	gmÚgo
 {

35 
şass
 
	gO³¿tiÚCÚ‹xt
;

41 şas 
	cH—dMªag”
 {

42 
	gpublic
:

43 
vœtu®
 ~
H—dMªag”
() { }

45 
vœtu®
 cÚ¡ 
DiskLoc
 
g‘H—d
() const = 0;

47 
vœtu®
 
£tH—d
(
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
 
ÃwH—d
) = 0;

	@record_store.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

33 
Çme¥aû
 
	gmÚgo
 {

35 
	gRecÜdStÜe
::
RecÜdStÜe
ĞcÚ¡ 
SŒšgD©a
& 
ns
 )

36 : 
_ns
Ğ
ns
.
toSŒšg
() ) {

39 
RecÜdStÜe
::~RecordStore() {

	@record_store.h

31 #´agm¨
Úû


33 
	~"mÚgo/ba£/owÃd_poš‹r_veùÜ.h
"

34 
	~"mÚgo/bsÚ/mubË/damage_veùÜ.h
"

35 
	~"mÚgo/db/diskloc.h
"

36 
	~"mÚgo/db/exec/cŞËùiÚ_sÿn_commÚ.h
"

38 
Çme¥aû
 
	gmÚgo
 {

40 
şass
 
	gC­³dDocum’tD–‘eC®lback
;

41 
şass
 
	gCŞËùiÚ
;

42 
	gCom·ùO±iÚs
;

43 
	gCom·ùSts
;

44 
şass
 
	gD–‘edRecÜd
;

45 
şass
 
	gDocWr™”
;

46 
şass
 
	gEx‹ÁMªag”
;

47 
şass
 
	gMAdvi£
;

48 
şass
 
	gName¥aûD‘as
;

49 
şass
 
	gRecÜd
;

50 
şass
 
	gO³¿tiÚCÚ‹xt
;

52 
şass
 
	gRecÜdStÜeCom·ùAd­tÜ
;

53 
şass
 
	gRecÜdStÜe
;

55 
	gV®id©eResuÉs
;

56 
şass
 
	gV®id©eAd­tÜ
;

61 şas 
	cDocWr™”
 {

62 
	gpublic
:

63 
vœtu®
 ~
DocWr™”
() {}

64 
vœtu®
 
wr™eDocum’t
Ğ* 
buf
 ) const = 0;

65 
vœtu®
 
size_t
 
docum’tSize
() const = 0;

66 
vœtu®
 
boŞ
 
addPaddšg
(ècÚ¡ {  
	gŒue
; }

72 şas 
	cUpd©eMoveNÙif›r
 {

73 
	gpublic
:

74 
vœtu®
 ~
Upd©eMoveNÙif›r
(){}

75 
vœtu®
 
Stus
 
»cÜdStÜeGošgToMove
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

76 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

77 cÚ¡ * 
ŞdBufãr
,

78 
size_t
 
ŞdSize
 ) = 0;

85 şas 
	cRecÜdI‹¿tÜ
 {

86 
	gpublic
:

87 
vœtu®
 ~
RecÜdI‹¿tÜ
() { }

90 
vœtu®
 
boŞ
 
isEOF
() = 0;

93 
vœtu®
 
DiskLoc
 
cu¼
() = 0;

97 
vœtu®
 
DiskLoc
 
g‘Next
() = 0;

100 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
) = 0;

104 
vœtu®
 
´•¬eToY›ld
() = 0;

107 
vœtu®
 
boŞ
 
»cov”FromY›ld
() = 0;

111 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const = 0;

115 şas 
	cRecÜdStÜe
 {

116 
MONGO_DISALLOW_COPYING
(
RecÜdStÜe
);

117 
	gpublic
:

118 
RecÜdStÜe
ĞcÚ¡ 
SŒšgD©a
& 
ns
 );

119 
	gvœtu®
 ~
RecÜdStÜe
();

124 
vœtu®
 cÚ¡ * 
Çme
() const = 0;

126 
vœtu®
 
d©aSize
() const = 0;

128 
vœtu®
 
numRecÜds
() const = 0;

130 
vœtu®
 
boŞ
 
isC­³d
() const = 0;

132 
vœtu®
 
£tC­³dD–‘eC®lback
(
C­³dDocum’tD–‘eC®lback
*è{
šv¬ŸÁ
Ğ
çl£
 );}

138 
vœtu®
 
št64_t
 
¡ÜageSize
Ğ
BSONObjBud”
* 
exŒaInfo
 = 
NULL
, 
šfoLev–
 = 0 ) const = 0;

142 
vœtu®
 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const = 0;

144 
vœtu®
 
d–‘eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dl
 ) = 0;

146 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

147 cÚ¡ * 
d©a
,

148 
Ën
,

149 
quÙaMax
 ) = 0;

151 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

152 cÚ¡ 
DocWr™”
* 
doc
,

153 
quÙaMax
 ) = 0;

161 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
upd©eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

162 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

163 cÚ¡ * 
d©a
,

164 
Ën
,

165 
quÙaMax
,

166 
Upd©eMoveNÙif›r
* 
nÙif›r
 ) = 0;

168 
vœtu®
 
Stus
 
upd©eW™hDamages
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

169 cÚ¡ 
DiskLoc
& 
loc
,

170 cÚ¡ * 
damªgeSourû
,

171 cÚ¡ 
mubËbsÚ
::
DamageVeùÜ
& 
damages
 ) = 0;

177 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜ
ĞcÚ¡ 
DiskLoc
& 
¡¬t
 = DiskLoc(),

178 
boŞ
 
abË
 = 
çl£
,

179 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
 =

180 
CŞËùiÚSÿnP¬ams
::
FORWARD


188 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜFÜR•aœ
() const = 0;

194 
vœtu®
 
	g¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
g‘MªyI‹¿tÜs
() const = 0;

202 
vœtu®
 
Stus
 
Œunÿ‹
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) = 0;

205 
vœtu®
 
boŞ
 
com·ùSuµÜ‹d
() const = 0;

206 
vœtu®
 
Stus
 
com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

207 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

208 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

209 
Com·ùSts
* 
¡©s
 ) = 0;

218 
vœtu®
 
Stus
 
v®id©e
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

219 
boŞ
 
fuÎ
, boŞ 
sÿnD©a
,

220 
V®id©eAd­tÜ
* 
ad­tÜ
,

221 
V®id©eResuÉs
* 
»suÉs
, 
BSONObjBud”
* 
ouut
 ) const = 0;

227 
vœtu®
 
­³ndCu¡omSts
Ğ
BSONObjBud”
* 
»suÉ
, 
sÿË
 ) const = 0;

234 
vœtu®
 
Stus
 
touch
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
BSONObjBud”
* 
ouut
 ) const = 0;

241 
vœtu®
 
Stus
 
£tCu¡omO±iÚ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

242 cÚ¡ 
BSONEËm’t
& 
İtiÚ
,

243 
BSONObjBud”
* 
šfo
 = 
NULL
 ) = 0;

244 
	g´Ùeùed
:

245 
¡d
::
¡ršg
 
_ns
;

248 şas 
	cRecÜdStÜeCom·ùAd­tÜ
 {

249 
	gpublic
:

250 
vœtu®
 ~
RecÜdStÜeCom·ùAd­tÜ
(){}

251 
vœtu®
 
boŞ
 
isD©aV®id
Ğ
RecÜd
* 
»c
 ) = 0;

252 
vœtu®
 
size_t
 
d©aSize
Ğ
RecÜd
* 
»c
 ) = 0;

253 
vœtu®
 
š£¹ed
Ğ
RecÜd
* 
»c
, cÚ¡ 
DiskLoc
& 
ÃwLoÿtiÚ
 ) = 0;

256 
	sV®id©eResuÉs
 {

257 
V®id©eResuÉs
() {

258 
	gv®id
 = 
Œue
;

260 
boŞ
 
	gv®id
;

261 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
”rÜs
;

269 şas 
	cV®id©eAd­tÜ
 {

270 
	gpublic
:

271 
vœtu®
 ~
V®id©eAd­tÜ
(){}

273 
vœtu®
 
Stus
 
v®id©e
Ğ
RecÜd
* 
»cÜd
, 
size_t
* 
d©aSize
 ) = 0;

	@record_store_berkeley.cpp

32 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_b”k–ey.h
"

34 
	~<db_cxx.h
>

36 
	~"mÚgo/db/¡Üage/»cÜd.h
"

37 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

38 
	~"mÚgo/db/¡Üage/b”k–ey/b”k–ey_»cov”y_un™.h
"

42 
	#BUFFER_SIZE
 16 * 1024000

	)

44 
Çme¥aû
 
	gmÚgo
 {

50 
	gB”k–eyRecÜdStÜe
::
B”k–eyRecÜdStÜe
(
DbEnv
& 
’v
,

51 cÚ¡ 
SŒšgD©a
& 
ns
,

52 
boŞ
 
isC­³d
,

53 
št64_t
 
ÿµedMaxSize
,

54 
št64_t
 
ÿµedMaxDocs
,

55 
C­³dDocum’tD–‘eC®lback
* 
ÿµedD–‘eC®lback
)

56 : 
RecÜdStÜe
(
ns
),

57 
_isC­³d
(
isC­³d
),

58 
_ÿµedMaxSize
(
ÿµedMaxSize
),

59 
_ÿµedMaxDocs
(
ÿµedMaxDocs
),

60 
_ÿµedD–‘eC®lback
(
ÿµedD–‘eC®lback
),

61 
db
(&
’v
, 0),

62 
_’v
(
’v
) {

64 ià(
	g_isC­³d
) {

65 
šv¬ŸÁ
(
_ÿµedMaxSize
 > 0);

66 
šv¬ŸÁ
(
_ÿµedMaxDocs
 == -1 || _cappedMaxDocs > 0);

69 
šv¬ŸÁ
(
_ÿµedMaxSize
 == -1);

70 
šv¬ŸÁ
(
_ÿµedMaxDocs
 == -1);

74 
	gŒy
 {

78 
ušt32_t
 
	gcFÏgs_
 = (
DB_CREATE
 | 
DB_AUTO_COMMIT
 | 
DB_READ_UNCOMMITTED
);

80 
	g¡d
::
¡ršg
 
db_Çme
 = 
ns
.
toSŒšg
() + ".db";

81 
	gdb
.
İ’
(
NULL
, 
db_Çme
.
d©a
(), NULL, 
DB_BTREE
, 
cFÏgs_
, 0);

85 
ÿtch
(
DbExû±iÚ
 &
e
) {

86 
”rÜ
(è<< "E¼Ü o³nšg d©aba£: " << 
	gns
.
toSŒšg
() << "\n";

87 
”rÜ
(è<< 
	ge
.
wh©
(è<< 
	g¡d
::
’dl
;

89 
ÿtch
(
¡d
::
exû±iÚ
 &
e
) {

90 
”rÜ
(è<< "E¼Ü o³nšg d©aba£: " << 
ns
.
toSŒšg
() << "\n";

91 
”rÜ
(è<< 
	ge
.
wh©
(è<< 
	g¡d
::
’dl
;

94 
	g»adBufãr
 = 
boo¡
::
sh¬ed_¬¿y
<>(
Ãw
 [
BUFFER_SIZE
]);

97 
	gB”k–eyRecÜdStÜe
::~
B”k–eyRecÜdStÜe
() {

98 
db
.
şo£
(0);

101 cÚ¡ * 
	gB”k–eyRecÜdStÜe
::
Çme
() const {  "berkeley"; }

103 
RecÜd
* 
	gB”k–eyRecÜdStÜe
::
»cÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

104 
Dbt
 
v®ue
;

106 
št64_t
 
	gkey_id
 = 
g‘LocID
(
loc
);

107 
Dbt
 
key
(
»š‹½»t_ÿ¡
<*>(&
key_id
), (
št64_t
));

109 
	gv®ue
.
£t_d©a
(
»adBufãr
.
g‘
());

110 
	gv®ue
.
£t_æags
(
DB_DBT_USERMEM
);

111 
	gv®ue
.
£t_uËn
(
BUFFER_SIZE
);

113 
šv¬ŸÁ
(
cÚ¡_ÿ¡
<
Db
&>(
db
).
g‘
(
NULL
, &
key
, &
v®ue
, 
DB_READ_UNCOMMITTED
) == 0);

115 
	gsize
 = 
»š‹½»t_ÿ¡
<
RecÜd
*>(
»adBufãr
.
g‘
())->
ËngthW™hH—d”s
();

118 
	gboo¡
::
sh¬ed_¬¿y
<> *
»c
 = 
Ãw
 
boo¡
::sh¬ed_¬¿y<>Òew [
size
]);

119 
memıy
(
»c
->
g‘
(), 
»adBufãr
.g‘(), 
size
);

121  
	g»š‹½»t_ÿ¡
<
	gRecÜd
*>(
	g»c
->
g‘
());

125 
	gB”k–eyRecÜdStÜe
::
d–‘eRecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
) {

126 
št64_t
 
	gkey_id
 = 
g‘LocID
(
loc
);

127 
Dbt
 
key
(
»š‹½»t_ÿ¡
<*>(&
key_id
), (
št64_t
));

129 
šv¬ŸÁ
(
db
.
d–
(
»š‹½»t_ÿ¡
<
B”k–eyRecov”yUn™
*>(
txn
->
»cov”yUn™
())->

130 
g‘Cu¼’tT¿n§ùiÚ
(), &
key
, 0) == 0);

133 
boŞ
 
	gB”k–eyRecÜdStÜe
::
ÿµedAndN“dD–‘e
() const {

134 
šv¬ŸÁ
(!"nyi");

137 
	gB”k–eyRecÜdStÜe
::
ÿµedD–‘eAsN“ded
(
O³¿tiÚCÚ‹xt
* 
txn
) {

138 
šv¬ŸÁ
(!"nyi");

141 
	gStusW™h
<
	gDiskLoc
> 
	gB”k–eyRecÜdStÜe
::
š£¹RecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
,

142 cÚ¡ * 
d©a
,

143 
Ën
,

144 
quÙaMax
) {

145 
Dbt
 
	gv®ue
;

147 ià(
	g_isC­³d
 && 
	gËn
 > 
	g_ÿµedMaxSize
) {

150  
	gStusW™h
<
	gDiskLoc
>(
	gE¼ÜCodes
::
BadV®ue
,

154 cÚ¡ 
	gËngthW™hH—d”s
 = 
Ën
 + 
RecÜd
::
H—d”Size
;

155 
	gboo¡
::
sh¬ed_¬¿y
<> 
buf
(
Ãw
 [
ËngthW™hH—d”s
]);

156 
RecÜd
* 
	g»c
 = 
»š‹½»t_ÿ¡
<RecÜd*>(
buf
.
g‘
());

157 
	g»c
->
ËngthW™hH—d”s
() =†engthWithHeaders;

158 
memıy
(
»c
->
d©a
(), d©a, 
Ën
);

160 cÚ¡ 
DiskLoc
 
	gloc
 = 
®loÿ‹Loc
(
txn
);

162 
	gv®ue
.
£t_size
(
ËngthW™hH—d”s
);

163 
	gv®ue
.
£t_d©a
(
»c
);

165 
št64_t
 
	gkey_id
 = 
g‘LocID
(
loc
);

166 
Dbt
 
key
(
»š‹½»t_ÿ¡
<*>(&
key_id
), (
št64_t
));

169 
DbTxn
* 
	gru
 = 
»š‹½»t_ÿ¡
<
B”k–eyRecov”yUn™
*>(
txn
->
»cov”yUn™
())->

170 
g‘Cu¼’tT¿n§ùiÚ
();

171 
šv¬ŸÁ
(
ru
 !ğ
NULL
);

173 
šv¬ŸÁ
(
db
.
put
(
ru
, &
key
, &
v®ue
, 
DB_NOOVERWRITE
) == 0);

175  
	gStusW™h
<
	gDiskLoc
>(
	gloc
);

178 
	gStusW™h
<
	gDiskLoc
> 
	gB”k–eyRecÜdStÜe
::
š£¹RecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
,

179 cÚ¡ 
DocWr™”
* 
doc
,

180 
quÙaMax
) {

181 
šv¬ŸÁ
(!"nyi");

184 
	gStusW™h
<
	gDiskLoc
> 
	gB”k–eyRecÜdStÜe
::
upd©eRecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
,

185 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

186 cÚ¡ * 
d©a
,

187 
Ën
,

188 
quÙaMax
,

189 
Upd©eMoveNÙif›r
* 
nÙif›r
 ) {

190 
Dbt
 
	gv®ue
;

192 ià(
	g_isC­³d
 && 
	gËn
 > 
	g_ÿµedMaxSize
) {

195  
	gStusW™h
<
	gDiskLoc
>(
	gE¼ÜCodes
::
BadV®ue
,

199 cÚ¡ 
	gËngthW™hH—d”s
 = 
Ën
 + 
RecÜd
::
H—d”Size
;

200 
	gboo¡
::
sh¬ed_¬¿y
<> 
buf
(
Ãw
 [
ËngthW™hH—d”s
]);

201 
RecÜd
* 
	g»c
 = 
»š‹½»t_ÿ¡
<RecÜd*>(
buf
.
g‘
());

202 
	g»c
->
ËngthW™hH—d”s
() =†engthWithHeaders;

203 
memıy
(
»c
->
d©a
(), d©a, 
Ën
);

206 
	gv®ue
.
£t_size
(
ËngthW™hH—d”s
);

207 
	gv®ue
.
£t_d©a
(
»c
);

209 
št64_t
 
	gkey_id
 = 
g‘LocID
(
ŞdLoÿtiÚ
);

210 
Dbt
 
key
(
»š‹½»t_ÿ¡
<*>(&
key_id
), (
št64_t
));

212 
šv¬ŸÁ
(
db
.
put
(
»š‹½»t_ÿ¡
<
B”k–eyRecov”yUn™
*>(
txn
->
»cov”yUn™
())->

213 
g‘Cu¼’tT¿n§ùiÚ
(), &
key
, &
v®ue
, 0) == 0);

216  
	gStusW™h
<
	gDiskLoc
>(
	gŞdLoÿtiÚ
);

219 
Stus
 
	gB”k–eyRecÜdStÜe
::
upd©eW™hDamages
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

220 cÚ¡ 
DiskLoc
& 
loc
,

221 cÚ¡ * 
damªgeSourû
,

222 cÚ¡ 
mubËbsÚ
::
DamageVeùÜ
& 
damages
 ) {

223 
šv¬ŸÁ
(!"updateRecord‚ot yet implemented");

226 
RecÜdI‹¿tÜ
* 
	gB”k–eyRecÜdStÜe
::
g‘I‹¿tÜ
(cÚ¡ 
DiskLoc
& 
¡¬t
,

227 
boŞ
 
abË
,

228 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const {

229 
šv¬ŸÁ
(!"nyi");

232 
RecÜdI‹¿tÜ
* 
	gB”k–eyRecÜdStÜe
::
g‘I‹¿tÜFÜR•aœ
() const {

233 
šv¬ŸÁ
(!"nyi");

236 
	g¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
B”k–eyRecÜdStÜe
::
g‘MªyI‹¿tÜs
() const {

237 
šv¬ŸÁ
(!"nyi");

240 
Stus
 
	gB”k–eyRecÜdStÜe
::
Œunÿ‹
(
O³¿tiÚCÚ‹xt
* 
txn
) {

241 
db
.
Œunÿ‹
(
»š‹½»t_ÿ¡
<
B”k–eyRecov”yUn™
*>(
txn
->
»cov”yUn™
())->

242 
g‘Cu¼’tT¿n§ùiÚ
(), 
NULL
, 0);

244  
	gStus
::
OK
();

247 
boŞ
 
	gB”k–eyRecÜdStÜe
::
com·ùSuµÜ‹d
() const {

248  
Œue
;

250 
Stus
 
	gB”k–eyRecÜdStÜe
::
com·ù
(
O³¿tiÚCÚ‹xt
* 
txn
,

251 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

252 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

253 
Com·ùSts
* 
¡©s
) {

254 
šv¬ŸÁ
(
db
.
com·ù
(
»š‹½»t_ÿ¡
<
B”k–eyRecov”yUn™
*>(
txn
->
»cov”yUn™
())->

255 
g‘Cu¼’tT¿n§ùiÚ
(), 
NULL
, NULL, NULL, 0, NULL) == 0);

257  
	gStus
::
OK
();

260 
Stus
 
	gB”k–eyRecÜdStÜe
::
v®id©e
(
O³¿tiÚCÚ‹xt
* 
txn
,

261 
boŞ
 
fuÎ
,

262 
boŞ
 
sÿnD©a
,

263 
V®id©eAd­tÜ
* 
ad­tÜ
,

264 
V®id©eResuÉs
* 
»suÉs
,

265 
BSONObjBud”
* 
ouut
) const {

266 
šv¬ŸÁ
(!"nyi");

269 
	gB”k–eyRecÜdStÜe
::
­³ndCu¡omSts
Ğ
BSONObjBud”
* 
»suÉ
, 
sÿË
 ) const {

270 
šv¬ŸÁ
(!"appendCustomStats‚ot yet implemented");

273 
Stus
 
	gB”k–eyRecÜdStÜe
::
touch
(
O³¿tiÚCÚ‹xt
* 
txn
, 
BSONObjBud”
* 
ouut
) const {

274 
šv¬ŸÁ
(!"nyi");

277 
Stus
 
	gB”k–eyRecÜdStÜe
::
£tCu¡omO±iÚ
(

278 
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
BSONEËm’t
& 
İtiÚ
, 
BSONObjBud”
* 
šfo
) {

279 
šv¬ŸÁ
(!"setCustomOption‚ot yet implemented");

282 
	gB”k–eyRecÜdStÜe
::
šü—£StÜageSize
(
O³¿tiÚCÚ‹xt
* 
txn
, 
size
, 
quÙaMax
) {

286 
št64_t
 
	gB”k–eyRecÜdStÜe
::
¡ÜageSize
(
BSONObjBud”
* 
exŒaInfo
, 
šfoLev–
) const {

288 
šv¬ŸÁ
(!"nyi");

292 
boŞ
 
	gB”k–eyRecÜdStÜe
::
hasRecÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

293 
št64_t
 
key_id
 = 
g‘LocID
(
loc
);

294 
Dbt
 
key
(
»š‹½»t_ÿ¡
<*>(&
key_id
), (
št64_t
));

296  (
	gcÚ¡_ÿ¡
<
	gDb
&>(
	gdb
).
exi¡s
(
NULL
, &
key
, 
DB_READ_UNCOMMITTED
è!ğ
DB_NOTFOUND
);

299 
DiskLoc
 
	gB”k–eyRecÜdStÜe
::
®loÿ‹Loc
(
O³¿tiÚCÚ‹xt
* 
txn
) {

300 
id_key
 = 0;

301 
št64_t
 
	gid
 = 0, 
	gÃw_id
 = 0;

303 
Dbt
 
key
(
»š‹½»t_ÿ¡
<*>(&
id_key
), ());

304 
Dbt
 
v®ue
(
»š‹½»t_ÿ¡
<*>(&
id
), (
št64_t
));

305 
	gv®ue
.
£t_æags
(
DB_DBT_USERMEM
);

306 
	gv®ue
.
£t_uËn
((
št64_t
));

308 
DbTxn
* 
	gŒª§ùiÚ
 = 
NULL
;

309 
	g_’v
.
txn_begš
(
»š‹½»t_ÿ¡
<
B”k–eyRecov”yUn™
*>(
txn
->
»cov”yUn™
())->

310 
g‘Cu¼’tT¿n§ùiÚ
(), &
Œª§ùiÚ
, 0);

311 ià(
	gcÚ¡_ÿ¡
<
	gDb
&>(
	gdb
).
g‘
(
Œª§ùiÚ
, &
key
, &
v®ue
, 
DB_READ_UNCOMMITTED
è=ğ
DB_NOTFOUND
) {

312 
id
 = 0;

315 
	gÃw_id
 = 
id
 + 1;

316 
Dbt
 
Ãw_v®ue
(
»š‹½»t_ÿ¡
<*>(&
Ãw_id
), (
št64_t
));

318 
šv¬ŸÁ
(
db
.
put
(
Œª§ùiÚ
, &
key
, &
Ãw_v®ue
, 0) == 0);

319 
	gŒª§ùiÚ
->
comm™
(0);

323 
šv¬ŸÁ
(
id
 < (1LL << 53));

324  
DiskLoc
((
id
 >> 30), ((id << 1) & ~(1<<31)));

327 
št64_t
 
	gB”k–eyRecÜdStÜe
::
g‘LocID
(cÚ¡ 
DiskLoc
& 
loc
) const {

328  (((
št64_t
è
loc
.
g‘Ofs
(è<< 32è+ (št64_tèloc.
a
());

331 
	gB”k–eyRecÜdStÜe
::
d©aSize
() const {

332 
DB_BTREE_STAT
* 
¡©
 = 
NULL
;

333 
	g¡©
 = (
DB_BTREE_STAT
*è
m®loc
((DB_BTREE_STAT));

335 
šv¬ŸÁ
(
cÚ¡_ÿ¡
<
Db
&>(
db
).
¡©
(
NULL
, &¡©, 
DB_READ_UNCOMMITTED
) == 0);

336 
	gnum_»cÜds
 = (è
¡©
->
bt_nkeys
;

339 ià(
	gnum_»cÜds
 != 0)

340 
num_»cÜds
--;

341  
	gnum_»cÜds
 * ()
	g¡©
->
	gbt_·gesize
;

344 
	gB”k–eyRecÜdStÜe
::
numRecÜds
() const {

345 
DB_BTREE_STAT
* 
¡©
 = 
NULL
;

346 
	g¡©
 = (
DB_BTREE_STAT
*è
m®loc
((DB_BTREE_STAT));

348 
šv¬ŸÁ
(
cÚ¡_ÿ¡
<
Db
&>(
db
).
¡©
(
NULL
, &¡©, 
DB_READ_UNCOMMITTED
) == 0);

349 
	gnum_»cÜds
 = (è
¡©
->
bt_nkeys
;

352 ià(
	gnum_»cÜds
 != 0)

353 
num_»cÜds
--;

354  
	gnum_»cÜds
;

362 
	gB”k–eyRecÜdI‹¿tÜ
::
B”k–eyRecÜdI‹¿tÜ
(cÚ¡ 
B”k–eyRecÜdStÜe
::
RecÜds
& 
»cÜds
,

363 cÚ¡ 
B”k–eyRecÜdStÜe
& 
rs
,

364 
DiskLoc
 
¡¬t
,

365 
boŞ
 
abË
)

366 : 
_abË
(
abË
),

367 
_kËdByInv®id©e
(
çl£
),

368 
_»cÜds
(
»cÜds
),

369 
_rs
(
rs
) {

370 ià(
	g¡¬t
.
isNuÎ
()) {

371 
	g_™
 = 
_»cÜds
.
begš
();

374 
	g_™
 = 
_»cÜds
.
fšd
(
¡¬t
);

375 
šv¬ŸÁ
(
_™
 !ğ
_»cÜds
.
’d
());

379 
boŞ
 
	gB”k–eyRecÜdI‹¿tÜ
::
isEOF
() {

380 
šv¬ŸÁ
(!"nyi");

383 
DiskLoc
 
	gB”k–eyRecÜdI‹¿tÜ
::
cu¼
() {

384 
šv¬ŸÁ
(!"nyi");

387 
DiskLoc
 
	gB”k–eyRecÜdI‹¿tÜ
::
g‘Next
() {

388 
šv¬ŸÁ
(!"nyi");

391 
	gB”k–eyRecÜdI‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
loc
) {

392 
šv¬ŸÁ
(!"nyi");

395 
	gB”k–eyRecÜdI‹¿tÜ
::
´•¬eToY›ld
() {

396 
šv¬ŸÁ
(!"nyi");

399 
boŞ
 
	gB”k–eyRecÜdI‹¿tÜ
::
»cov”FromY›ld
() {

400 
šv¬ŸÁ
(!"nyi");

403 cÚ¡ 
RecÜd
* 
	gB”k–eyRecÜdI‹¿tÜ
::
»cÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

404 
šv¬ŸÁ
(!"nyi");

411 
	gB”k–eyRecÜdRev”£I‹¿tÜ
::
B”k–eyRecÜdRev”£I‹¿tÜ
(cÚ¡ 
B”k–eyRecÜdStÜe
::
RecÜds
& 
»cÜds
,

412 cÚ¡ 
B”k–eyRecÜdStÜe
& 
rs
,

413 
DiskLoc
 
¡¬t
)

414 : 
_kËdByInv®id©e
(
çl£
),

415 
_»cÜds
(
»cÜds
),

416 
_rs
(
rs
) {

417 
šv¬ŸÁ
(!"nyi");

420 
boŞ
 
	gB”k–eyRecÜdRev”£I‹¿tÜ
::
isEOF
() {

421 
šv¬ŸÁ
(!"nyi");

424 
DiskLoc
 
	gB”k–eyRecÜdRev”£I‹¿tÜ
::
cu¼
() {

425 
šv¬ŸÁ
(!"nyi");

428 
DiskLoc
 
	gB”k–eyRecÜdRev”£I‹¿tÜ
::
g‘Next
() {

429 
šv¬ŸÁ
(!"nyi");

432 
	gB”k–eyRecÜdRev”£I‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
loc
) {

433 
šv¬ŸÁ
(!"nyi");

436 
	gB”k–eyRecÜdRev”£I‹¿tÜ
::
´•¬eToY›ld
() {

439 
boŞ
 
B”k–eyRecÜdRev”£I‹¿tÜ
::
»cov”FromY›ld
() {

440 
šv¬ŸÁ
(!"nyi");

443 cÚ¡ 
RecÜd
* 
	gB”k–eyRecÜdRev”£I‹¿tÜ
::
»cÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

444 
šv¬ŸÁ
(!"nyi");

	@record_store_berkeley.h

31 #´agm¨
Úû


33 
	~<boo¡/sh¬ed_¬¿y.hµ
>

34 
	~<m­
>

35 
	~<¡ršg
>

36 
	~<db_cxx.h
>

38 
	~"mÚgo/db/¡ruùu»/ÿµed_ÿÎback.h
"

39 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

41 
Çme¥aû
 
	gmÚgo
 {

42 
şass
 
	gB”k–eyRecÜdI‹¿tÜ
;

49 şas 
	cB”k–eyRecÜdStÜe
 : 
public
 
RecÜdStÜe
 {

50 
public
:

51 
ex¶ic™
 
B”k–eyRecÜdStÜe
(
DbEnv
& 
’v
,

52 cÚ¡ 
SŒšgD©a
& 
ns
,

53 
boŞ
 
isC­³d
 = 
çl£
,

54 
št64_t
 
ÿµedMaxSize
 = -1,

55 
št64_t
 
ÿµedMaxDocs
 = -1,

56 
C­³dDocum’tD–‘eC®lback
* 
ÿµedD–‘eC®lback
 = 
NULL
);

58 
	gvœtu®
 ~
B”k–eyRecÜdStÜe
();

60 
vœtu®
 cÚ¡ * 
Çme
() const;

65 
vœtu®
 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

67 
vœtu®
 
d–‘eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dl
 );

69 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

70 cÚ¡ * 
d©a
,

71 
Ën
,

72 
quÙaMax
 );

74 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

75 cÚ¡ 
DocWr™”
* 
doc
,

76 
quÙaMax
 );

78 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
upd©eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

79 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

80 cÚ¡ * 
d©a
,

81 
Ën
,

82 
quÙaMax
,

83 
Upd©eMoveNÙif›r
* 
nÙif›r
 );

85 
vœtu®
 
Stus
 
upd©eW™hDamages
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

86 cÚ¡ 
DiskLoc
& 
loc
,

87 cÚ¡ * 
damªgeSourû
,

88 cÚ¡ 
mubËbsÚ
::
DamageVeùÜ
& 
damages
 );

90 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜ
ĞcÚ¡ 
DiskLoc
& 
¡¬t
, 
boŞ
 
abË
,

91 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const;

93 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜFÜR•aœ
() const;

95 
vœtu®
 
	g¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
g‘MªyI‹¿tÜs
() const;

97 
vœtu®
 
Stus
 
Œunÿ‹
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

99 
vœtu®
 
boŞ
 
com·ùSuµÜ‹d
() const;

100 
vœtu®
 
Stus
 
com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

101 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

102 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

103 
Com·ùSts
* 
¡©s
 );

105 
vœtu®
 
Stus
 
v®id©e
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

106 
boŞ
 
fuÎ
,

107 
boŞ
 
sÿnD©a
,

108 
V®id©eAd­tÜ
* 
ad­tÜ
,

109 
V®id©eResuÉs
* 
»suÉs
, 
BSONObjBud”
* 
ouut
 ) const;

111 
vœtu®
 
­³ndCu¡omSts
Ğ
BSONObjBud”
* 
»suÉ
, 
sÿË
 ) const;

113 
vœtu®
 
Stus
 
touch
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
BSONObjBud”
* 
ouut
 ) const;

115 
vœtu®
 
Stus
 
£tCu¡omO±iÚ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

116 cÚ¡ 
BSONEËm’t
& 
İtiÚ
,

117 
BSONObjBud”
* 
šfo
 = 
NULL
 );

119 
vœtu®
 
šü—£StÜageSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
size
, 
quÙaMax
 );

121 
vœtu®
 
št64_t
 
¡ÜageSize
(
BSONObjBud”
* 
exŒaInfo
 = 
NULL
, 
šfoLev–
 = 0) const;

124 
vœtu®
 
d©aSize
() const;

126 
vœtu®
 
numRecÜds
() const;

132 
	g¡d
::
	tm­
<
	tDiskLoc
, 
	tboo¡
::
	tsh¬ed_¬¿y
<> > 
	tRecÜds
;

134 
boŞ
 
isC­³d
(ècÚ¡ {  
	g_isC­³d
; }

135 
boŞ
 
ÿµedMaxDocs
(ècÚ¡ { 
šv¬ŸÁ
(
_isC­³d
);  
	g_ÿµedMaxDocs
; }

136 
boŞ
 
ÿµedMaxSize
(ècÚ¡ { 
šv¬ŸÁ
(
_isC­³d
);  
	g_ÿµedMaxSize
; }

141 
boŞ
 
hasRecÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const;

145 
	g´iv©e
:

146 
DiskLoc
 
®loÿ‹Loc
(
O³¿tiÚCÚ‹xt
* 
txn
);

147 
boŞ
 
ÿµedAndN“dD–‘e
() const;

148 
ÿµedD–‘eAsN“ded
(
O³¿tiÚCÚ‹xt
* 
txn
);

149 
št64_t
 
g‘LocID
(cÚ¡ 
DiskLoc
& 
loc
) const;

152 cÚ¡ 
boŞ
 
	g_isC­³d
;

153 cÚ¡ 
št64_t
 
	g_ÿµedMaxSize
;

154 cÚ¡ 
št64_t
 
	g_ÿµedMaxDocs
;

156 
C­³dDocum’tD–‘eC®lback
* cÚ¡ 
	g_ÿµedD–‘eC®lback
;

157 
Db
 
	gdb
;

158 
	gDbEnv
& 
	g_’v
;

159 
	gboo¡
::
sh¬ed_¬¿y
<> 
»adBufãr
;

162 şas 
	cB”k–eyRecÜdI‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

163 
public
:

164 
B”k–eyRecÜdI‹¿tÜ
(cÚ¡ 
B”k–eyRecÜdStÜe
::
RecÜds
& 
»cÜds
,

165 cÚ¡ 
B”k–eyRecÜdStÜe
& 
rs
,

166 
DiskLoc
 
¡¬t
 = DiskLoc(),

167 
boŞ
 
abË
 = 
çl£
);

169 
vœtu®
 
boŞ
 
isEOF
();

171 
vœtu®
 
DiskLoc
 
cu¼
();

173 
vœtu®
 
DiskLoc
 
g‘Next
();

175 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

177 
vœtu®
 
´•¬eToY›ld
();

179 
vœtu®
 
boŞ
 
»cov”FromY›ld
();

181 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

183 
	g´iv©e
:

184 
B”k–eyRecÜdStÜe
::
RecÜds
::
cÚ¡_™”©Ü
 
_™
;

185 
boŞ
 
	g_abË
;

186 
DiskLoc
 
	g_Ï¡Loc
;

187 
boŞ
 
	g_kËdByInv®id©e
;

189 cÚ¡ 
	gB”k–eyRecÜdStÜe
::
RecÜds
& 
_»cÜds
;

190 cÚ¡ 
	gB”k–eyRecÜdStÜe
& 
	g_rs
;

193 şas 
	cB”k–eyRecÜdRev”£I‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

194 
public
:

195 
B”k–eyRecÜdRev”£I‹¿tÜ
(cÚ¡ 
B”k–eyRecÜdStÜe
::
RecÜds
& 
»cÜds
,

196 cÚ¡ 
B”k–eyRecÜdStÜe
& 
rs
,

197 
DiskLoc
 
¡¬t
 = DiskLoc());

199 
vœtu®
 
boŞ
 
isEOF
();

201 
vœtu®
 
DiskLoc
 
cu¼
();

203 
vœtu®
 
DiskLoc
 
g‘Next
();

205 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

207 
vœtu®
 
´•¬eToY›ld
();

209 
vœtu®
 
boŞ
 
»cov”FromY›ld
();

211 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

213 
	g´iv©e
:

214 
B”k–eyRecÜdStÜe
::
RecÜds
::
cÚ¡_»v”£_™”©Ü
 
_™
;

215 
boŞ
 
	g_kËdByInv®id©e
;

217 cÚ¡ 
	gB”k–eyRecÜdStÜe
::
RecÜds
& 
_»cÜds
;

218 cÚ¡ 
	gB”k–eyRecÜdStÜe
& 
	g_rs
;

	@record_store_berkeley_test.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_b”k–ey.h
"

33 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt_b”k–ey.h
"

34 
	~"mÚgo/db/¡Üage/»cÜd.h
"

35 
	~"mÚgo/db/¡Üage/b”k–ey/b”k–ey_»cov”y_un™.h
"

36 
	~"mÚgo/un™‹¡/un™‹¡.h
"

38 
usšg
 
Çme¥aû
 
	gmÚgo
;

40 
	gÇme¥aû
 {

43 
DiskLoc
 
	gdummyDiskLoc
;

44 
	gStusW™h
<
	gDiskLoc
> 
dummyStusW™h
(
dummyDiskLoc
);

45 
	g¡d
::
¡ršg
 
db_Çme
 = "berkeleytest";

47 
TEST
(
B”k–eyRecÜdStÜe
, 
FuÎSim¶eIn£¹1
) {

49 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

50 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

53 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

54 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

55 
ASSERT_TRUE
(
»suÉ
.
isOK
());

56 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

57 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

62 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

63 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

64 
»move
("berkeleyEnv/log.0000000001");

69 
TEST
(
B”k–eyRecÜdStÜe
, 
FuÎSim¶eD–‘e1
) {

71 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

72 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

73 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 0);

75 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

77 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

78 
ASSERT_TRUE
(
»suÉ
.
isOK
());

79 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

80 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

81 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

83 
	grs
.
d–‘eRecÜd
(&
txn
, 
»suÉ
.
g‘V®ue
());

84 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(
»suÉ
.
g‘V®ue
()));

85 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 0);

86 
ASSERT_EQUALS
(
rs
.
d©aSize
(), 0);

91 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

92 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

93 
»move
("berkeleyEnv/log.0000000001");

96 
TEST
(
B”k–eyRecÜdStÜe
, 
Upd©eSm®Ër1
) {

98 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

99 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

102 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

103 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

104 
ASSERT_TRUE
(
»suÉ
.
isOK
());

105 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

106 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

108 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ2
 = 
rs
.
upd©eRecÜd
(&
txn
, 
»suÉ
.
g‘V®ue
(), "a", 2, 1000, 
NULL
);

109 
ASSERT_TRUE
(
»suÉ2
.
isOK
());

110 
RecÜd
* 
	g»cÜd2
 = 
rs
.
»cÜdFÜ
(
»suÉ2
.
g‘V®ue
());

111 
ASSERT_EQUALS
(
¡ršg
("a"), sŒšg(
»cÜd2
->
d©a
()));

116 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

117 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

118 
»move
("berkeleyEnv/log.0000000001");

121 
TEST
(
B”k–eyRecÜdStÜe
, 
Upd©eL¬g”1
) {

123 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

124 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

127 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

129 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

130 
ASSERT_TRUE
(
»suÉ
.
isOK
());

131 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

132 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

134 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ2
 = 
rs
.
upd©eRecÜd
(&
txn
, 
»suÉ
.
g‘V®ue
(),

135 "abcdef", 7, 1000, 
NULL
);

136 
ASSERT_TRUE
(
»suÉ2
.
isOK
());

137 
RecÜd
* 
	g»cÜd2
 = 
rs
.
»cÜdFÜ
(
»suÉ2
.
g‘V®ue
());

138 
ASSERT_EQUALS
(
¡ršg
("abcdef"), sŒšg(
»cÜd2
->
d©a
()));

143 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

144 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

145 
»move
("berkeleyEnv/log.0000000001");

148 
TEST
(
B”k–eyRecÜdStÜe
, 
MuÉËUpd©eL¬ge
) {

150 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

151 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

154 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

156 cÚ¡ 
	gÏrge_d©a_Ëngth
 = 1000 * 1000;

157 
	gÏrge_d©a
[
Ïrge_d©a_Ëngth
];

158 
	gi
 = 0; i < 
	gÏrge_d©a_Ëngth
; i++)

159 
	gÏrge_d©a
[
i
] = i % 255;

162 cÚ¡ 
	gÜigš®_d©a_Ëngth
 = 1000;

163 
	gÜigš®_d©a
[
Üigš®_d©a_Ëngth
];

164 
	gi
 = 0; i < 
	gÜigš®_d©a_Ëngth
; i++)

165 
	gÜigš®_d©a
[
i
] = i % 255;

168 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, 
Üigš®_d©a
,

169 
Üigš®_d©a_Ëngth
 + 1, 1000);

170 
ASSERT_TRUE
(
»suÉ
.
isOK
());

171 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

172 
ASSERT_EQUALS
(
Üigš®_d©a
, 
¡ršg
(
»cÜd
->
d©a
()));

174 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ2
 = 
rs
.
upd©eRecÜd
(&
txn
, 
»suÉ
.
g‘V®ue
(), "a", 2,

175 1000, 
NULL
);

176 
ASSERT_TRUE
(
»suÉ2
.
isOK
());

177 
RecÜd
* 
	g»cÜd2
 = 
rs
.
»cÜdFÜ
(
»suÉ2
.
g‘V®ue
());

178 
ASSERT_EQUALS
(
¡ršg
("a"), sŒšg(
»cÜd2
->
d©a
()));

180 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ3
 = 
rs
.
upd©eRecÜd
(&
txn
, 
»suÉ
.
g‘V®ue
(), 
Ïrge_d©a
,

181 
Ïrge_d©a_Ëngth
 + 1, 1000, 
NULL
);

182 
ASSERT_TRUE
(
»suÉ3
.
isOK
());

183 
RecÜd
* 
	g»cÜd3
 = 
rs
.
»cÜdFÜ
(
»suÉ3
.
g‘V®ue
());

184 
ASSERT_EQUALS
(
Ïrge_d©a
, 
¡ršg
(
»cÜd3
->
d©a
()));

189 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

190 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

191 
»move
("berkeleyEnv/log.0000000001");

194 
TEST
(
B”k–eyRecÜdStÜe
, 
RŞlbackSšgËIn£¹iÚ
) {

196 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

197 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

199 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
dummyStusW™h
;

200 
RecÜd
* 
	g»cÜd
;

203 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

205 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

206 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

207 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

208 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

211 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(
»suÉ
.
g‘V®ue
()));

212 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 0);

213 
ASSERT_EQUALS
(
rs
.
d©aSize
(), 0);

217 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

218 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

219 
»move
("berkeleyEnv/log.0000000001");

222 
TEST
(
B”k–eyRecÜdStÜe
, 
Comm™SšgËIn£¹iÚ
) {

224 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

225 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

227 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
dummyStusW™h
;

228 
RecÜd
* 
	g»cÜd
;

231 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

233 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

234 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

235 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

236 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

238 
	gwu
.
comm™
();

241 
RecÜd
* 
	gÃwRecÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

242 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
ÃwRecÜd
->
d©a
()));

243 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

247 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

248 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

249 
»move
("berkeleyEnv/log.0000000001");

252 
TEST
(
B”k–eyRecÜdStÜe
, 
RŞlbackSšgËD–‘iÚ
) {

254 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

255 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

257 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
dummyStusW™h
;

260 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

262 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

263 
ASSERT_TRUE
(
»suÉ
.
isOK
());

265 
	gwu
.
comm™
();

267 
	grs
.
d–‘eRecÜd
(&
txn
, 
»suÉ
.
g‘V®ue
());

268 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(
»suÉ
.
g‘V®ue
()));

269 
ASSERT_EQUALS
(
rs
.
d©aSize
(), 0);

270 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 0);

274 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

275 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

276 
ASSERT_TRUE
(
rs
.
hasRecÜdFÜ
(
»suÉ
.
g‘V®ue
()));

277 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

281 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

282 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

283 
»move
("berkeleyEnv/log.0000000001");

286 
TEST
(
B”k–eyRecÜdStÜe
, 
Comm™SšgËD–‘iÚ
) {

288 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

289 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

291 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
dummyStusW™h
;

294 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

295 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

296 
ASSERT_TRUE
(
»suÉ
.
isOK
());

298 
	gwu
.
comm™
();

300 
	grs
.
d–‘eRecÜd
(&
txn
, 
»suÉ
.
g‘V®ue
());

301 
	gwu
.
comm™
();

304 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(
»suÉ
.
g‘V®ue
()));

305 
ASSERT_EQUALS
(
rs
.
d©aSize
(), 0);

306 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 0);

310 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

311 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

312 
»move
("berkeleyEnv/log.0000000001");

315 
TEST
(
B”k–eyRecÜdStÜe
, 
RŞlbackSšgËUpd©e
) {

317 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

318 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

320 
	gStusW™h
<
	gDiskLoc
> 
	gš£¹ResuÉ
 = 
dummyStusW™h
;

321 
	gStusW™h
<
	gDiskLoc
> 
	gupd©eResuÉ
 = 
dummyStusW™h
;

324 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

325 
	gš£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

326 
ASSERT_TRUE
(
š£¹ResuÉ
.
isOK
());

328 
	gwu
.
comm™
();

330 
	gupd©eResuÉ
 = 
rs
.
upd©eRecÜd
(&
txn
, 
š£¹ResuÉ
.
g‘V®ue
(), "def", 4, 1000, 
NULL
);

332 
ASSERT_TRUE
(
upd©eResuÉ
.
isOK
());

333 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
upd©eResuÉ
.
g‘V®ue
());

334 
ASSERT_EQUALS
(
¡ršg
("def"), sŒšg(
»cÜd
->
d©a
()));

338 
RecÜd
* 
	gÃwRecÜd
 = 
rs
.
»cÜdFÜ
(
š£¹ResuÉ
.
g‘V®ue
());

339 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
ÃwRecÜd
->
d©a
()));

340 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

341 
ASSERT_TRUE
(
š£¹ResuÉ
.
g‘V®ue
(è=ğ
upd©eResuÉ
.getValue()

342 || !
rs
.
hasRecÜdFÜ
(
upd©eResuÉ
.
g‘V®ue
()));

346 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

347 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

348 
»move
("berkeleyEnv/log.0000000001");

351 
TEST
(
B”k–eyRecÜdStÜe
, 
Comm™SšgËUpd©e
) {

353 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

354 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

356 
	gStusW™h
<
	gDiskLoc
> 
	gš£¹ResuÉ
 = 
dummyStusW™h
;

357 
	gStusW™h
<
	gDiskLoc
> 
	gupd©eResuÉ
 = 
dummyStusW™h
;

360 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

361 
	gš£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

362 
ASSERT_TRUE
(
š£¹ResuÉ
.
isOK
());

364 
	gwu
.
comm™
();

366 
	gupd©eResuÉ
 = 
rs
.
upd©eRecÜd
(&
txn
, 
š£¹ResuÉ
.
g‘V®ue
(), "def", 4, 1000, 
NULL
);

368 
ASSERT_TRUE
(
upd©eResuÉ
.
isOK
());

369 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
upd©eResuÉ
.
g‘V®ue
());

370 
ASSERT_EQUALS
(
¡ršg
("def"), sŒšg(
»cÜd
->
d©a
()));

372 
	gwu
.
comm™
();

376 
RecÜd
* 
	gupd©edRecÜd
 = 
rs
.
»cÜdFÜ
(
upd©eResuÉ
.
g‘V®ue
());

377 
ASSERT_EQUALS
(
¡ršg
("def"), sŒšg(
upd©edRecÜd
->
d©a
()));

378 
ASSERT_TRUE
(
š£¹ResuÉ
.
g‘V®ue
(è=ğ
upd©eResuÉ
.getValue()

379 || !
rs
.
hasRecÜdFÜ
(
š£¹ResuÉ
.
g‘V®ue
()));

383 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

384 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

385 
»move
("berkeleyEnv/log.0000000001");

388 
TEST
(
B”k–eyRecÜdStÜe
, 
MuÉiComm™sMixed
) {

390 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

391 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

393 
	gStusW™h
<
	gDiskLoc
> 
	gfœ¡In£¹ResuÉ
 = 
dummyStusW™h
;

394 
	gStusW™h
<
	gDiskLoc
> 
	g£cÚdIn£¹ResuÉ
 = 
dummyStusW™h
;

395 
	gStusW™h
<
	gDiskLoc
> 
	gthœdIn£¹ResuÉ
 = 
dummyStusW™h
;

396 
RecÜd
* 
	g»cÜd
;

397 
	gStusW™h
<
	gDiskLoc
> 
	gfou¹hIn£¹ResuÉ
 = 
dummyStusW™h
;

398 
	gStusW™h
<
	gDiskLoc
> 
	gfœ¡Upd©eResuÉ
 = 
dummyStusW™h
;

399 
	gStusW™h
<
	gDiskLoc
> 
	g£cÚdUpd©eResuÉ
 = 
dummyStusW™h
;

402 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

405 
	gfœ¡In£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

406 
ASSERT_TRUE
(
fœ¡In£¹ResuÉ
.
isOK
());

408 
	g£cÚdIn£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "123", 4, 1000);

409 
ASSERT_TRUE
(
£cÚdIn£¹ResuÉ
.
isOK
());

411 
	gthœdIn£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "xyz", 4, 1000);

412 
ASSERT_TRUE
(
thœdIn£¹ResuÉ
.
isOK
());

414 
	gwu
.
comm™
();

417 
	grs
.
d–‘eRecÜd
(&
txn
, 
thœdIn£¹ResuÉ
.
g‘V®ue
());

418 
	grs
.
d–‘eRecÜd
(&
txn
, 
fœ¡In£¹ResuÉ
.
g‘V®ue
());

420 
	gwu
.
comm™
();

424 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(
fœ¡In£¹ResuÉ
.
g‘V®ue
()));

425 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(
thœdIn£¹ResuÉ
.
g‘V®ue
()));

426 
ASSERT_TRUE
(
rs
.
hasRecÜdFÜ
(
£cÚdIn£¹ResuÉ
.
g‘V®ue
()));

427 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
£cÚdIn£¹ResuÉ
.
g‘V®ue
());

428 
ASSERT_EQUALS
(
¡ršg
("123"), sŒšg(
»cÜd
->
d©a
()));

431 
	gfou¹hIn£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "789", 4, 1000);

432 
ASSERT_TRUE
(
fou¹hIn£¹ResuÉ
.
isOK
());

435 
	gfœ¡Upd©eResuÉ
 = 
rs
.
upd©eRecÜd
(&
txn
,

436 
£cÚdIn£¹ResuÉ
.
g‘V®ue
(),

440 
NULL
);

443 
	g£cÚdUpd©eResuÉ
 = 
rs
.
upd©eRecÜd
(&
txn
,

444 
fou¹hIn£¹ResuÉ
.
g‘V®ue
(),

448 
NULL
);

450 
	gwu
.
comm™
();

455 
ASSERT_TRUE
(
fœ¡Upd©eResuÉ
.
isOK
());

456 
ASSERT_TRUE
(
£cÚdUpd©eResuÉ
.
isOK
());

458 
RecÜd
* 
	gfœ¡Upd©edRecÜd
 = 
rs
.
»cÜdFÜ
(
fœ¡Upd©eResuÉ
.
g‘V®ue
());

459 
RecÜd
* 
	g£cÚdUpd©edRecÜd
 = 
rs
.
»cÜdFÜ
(
£cÚdUpd©eResuÉ
.
g‘V®ue
());

461 
ASSERT_EQUALS
(
¡ršg
("321"), sŒšg(
fœ¡Upd©edRecÜd
->
d©a
()));

462 
ASSERT_EQUALS
(
¡ršg
("987"), sŒšg(
£cÚdUpd©edRecÜd
->
d©a
()));

464 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 2);

468 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

469 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

470 
»move
("berkeleyEnv/log.0000000001");

473 
TEST
(
B”k–eyRecÜdStÜe
, 
MuÉiRŞlbacksMixed
) {

475 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

476 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

478 
	gStusW™h
<
	gDiskLoc
> 
	gfœ¡In£¹ResuÉ
 = 
dummyStusW™h
;

479 
	gStusW™h
<
	gDiskLoc
> 
	g£cÚdIn£¹ResuÉ
 = 
dummyStusW™h
;

480 
	gStusW™h
<
	gDiskLoc
> 
	gthœdIn£¹ResuÉ
 = 
dummyStusW™h
;

483 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

486 
	gfœ¡In£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

487 
ASSERT_TRUE
(
fœ¡In£¹ResuÉ
.
isOK
());

489 
	g£cÚdIn£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "123", 4, 1000);

490 
ASSERT_TRUE
(
£cÚdIn£¹ResuÉ
.
isOK
());

492 
	gthœdIn£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "xyz", 4, 1000);

493 
ASSERT_TRUE
(
thœdIn£¹ResuÉ
.
isOK
());

495 
	gwu
.
comm™
();

498 
	grs
.
d–‘eRecÜd
(&
txn
, 
thœdIn£¹ResuÉ
.
g‘V®ue
());

499 
	grs
.
d–‘eRecÜd
(&
txn
, 
fœ¡In£¹ResuÉ
.
g‘V®ue
());

504 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 3);

505 
ASSERT_TRUE
(
rs
.
hasRecÜdFÜ
(
fœ¡In£¹ResuÉ
.
g‘V®ue
()));

506 
ASSERT_TRUE
(
rs
.
hasRecÜdFÜ
(
thœdIn£¹ResuÉ
.
g‘V®ue
()));

507 
ASSERT_TRUE
(
rs
.
hasRecÜdFÜ
(
thœdIn£¹ResuÉ
.
g‘V®ue
()));

509 
RecÜd
* 
	gfœ¡RecÜd
 = 
rs
.
»cÜdFÜ
(
fœ¡In£¹ResuÉ
.
g‘V®ue
());

510 
RecÜd
* 
	g£cÚdRecÜd
 = 
rs
.
»cÜdFÜ
(
£cÚdIn£¹ResuÉ
.
g‘V®ue
());

511 
RecÜd
* 
	gthœdRecÜd
 = 
rs
.
»cÜdFÜ
(
thœdIn£¹ResuÉ
.
g‘V®ue
());

512 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
fœ¡RecÜd
->
d©a
()));

513 
ASSERT_EQUALS
(
¡ršg
("123"), sŒšg(
£cÚdRecÜd
->
d©a
()));

514 
ASSERT_EQUALS
(
¡ršg
("xyz"), sŒšg(
thœdRecÜd
->
d©a
()));

518 
	gStusW™h
<
	gDiskLoc
> 
	gfou¹hIn£¹ResuÉ
 = 
dummyStusW™h
;

519 
	gStusW™h
<
	gDiskLoc
> 
	gfœ¡Upd©eResuÉ
 = 
dummyStusW™h
;

520 
	gStusW™h
<
	gDiskLoc
> 
	g£cÚdUpd©eResuÉ
 = 
dummyStusW™h
;

523 
Wr™eUn™OfWÜk
 
£cÚdWu
(
txn
.
»cov”yUn™
());

525 
	gfou¹hIn£¹ResuÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "789", 4, 1000);

526 
ASSERT_TRUE
(
fou¹hIn£¹ResuÉ
.
isOK
());

528 
	grs
.
d–‘eRecÜd
(&
txn
, 
thœdIn£¹ResuÉ
.
g‘V®ue
());

529 
	grs
.
d–‘eRecÜd
(&
txn
, 
fœ¡In£¹ResuÉ
.
g‘V®ue
());

531 
	gfœ¡Upd©eResuÉ
 = 
rs
.
upd©eRecÜd
(&
txn
,

532 
£cÚdIn£¹ResuÉ
.
g‘V®ue
(),

536 
NULL
);

538 
	g£cÚdUpd©eResuÉ
 = 
rs
.
upd©eRecÜd
(&
txn
,

539 
fou¹hIn£¹ResuÉ
.
g‘V®ue
(),

543 
NULL
);

546 
ASSERT_TRUE
(
fœ¡Upd©eResuÉ
.
isOK
());

547 
ASSERT_TRUE
(
£cÚdUpd©eResuÉ
.
isOK
());

549 
RecÜd
* 
	gfœ¡Upd©edRecÜd
 = 
rs
.
»cÜdFÜ
(
fœ¡Upd©eResuÉ
.
g‘V®ue
());

550 
RecÜd
* 
	g£cÚdUpd©edRecÜd
 = 
rs
.
»cÜdFÜ
(
£cÚdUpd©eResuÉ
.
g‘V®ue
());

552 
ASSERT_EQUALS
(
¡ršg
("321"), sŒšg(
fœ¡Upd©edRecÜd
->
d©a
()));

553 
ASSERT_EQUALS
(
¡ršg
("987"), sŒšg(
£cÚdUpd©edRecÜd
->
d©a
()));

555 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 2);

560 
RecÜd
* 
	gfœ¡NewRecÜd
 = 
rs
.
»cÜdFÜ
(
fœ¡In£¹ResuÉ
.
g‘V®ue
());

561 
RecÜd
* 
	g£cÚdNewRecÜd
 = 
rs
.
»cÜdFÜ
(
£cÚdIn£¹ResuÉ
.
g‘V®ue
());

562 
RecÜd
* 
	gthœdNewRecÜd
 = 
rs
.
»cÜdFÜ
(
thœdIn£¹ResuÉ
.
g‘V®ue
());

563 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(
fou¹hIn£¹ResuÉ
.
g‘V®ue
()));

565 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
fœ¡NewRecÜd
->
d©a
()));

566 
ASSERT_EQUALS
(
¡ršg
("123"), sŒšg(
£cÚdNewRecÜd
->
d©a
()));

567 
ASSERT_EQUALS
(
¡ršg
("xyz"), sŒšg(
thœdNewRecÜd
->
d©a
()));

568 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 3);

572 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

573 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

574 
»move
("berkeleyEnv/log.0000000001");

577 
TEST
(
B”k–eyRecÜdStÜe
, 
MuÉËRecÜdStÜes
) {

579 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

580 
B”k–eyRecÜdStÜe
 
fœ¡Rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

581 
B”k–eyRecÜdStÜe
 
£cÚdRs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

582 
B”k–eyRecÜdStÜe
 
thœdRs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

584 
	gStusW™h
<
	gDiskLoc
> 
	gfœ¡In£¹ResuÉ
 = 
dummyStusW™h
;

585 
	gStusW™h
<
	gDiskLoc
> 
	g£cÚdIn£¹ResuÉ
 = 
dummyStusW™h
;

586 
	gStusW™h
<
	gDiskLoc
> 
	gthœdIn£¹ResuÉ
 = 
dummyStusW™h
;

589 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

591 
	gfœ¡In£¹ResuÉ
 = 
fœ¡Rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

592 
	g£cÚdIn£¹ResuÉ
 = 
£cÚdRs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

593 
	gthœdIn£¹ResuÉ
 = 
thœdRs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

595 
ASSERT_TRUE
(
fœ¡In£¹ResuÉ
.
isOK
());

596 
ASSERT_TRUE
(
£cÚdIn£¹ResuÉ
.
isOK
());

597 
ASSERT_TRUE
(
thœdIn£¹ResuÉ
.
isOK
());

600 
ASSERT_FALSE
(
fœ¡Rs
.
hasRecÜdFÜ
(
fœ¡In£¹ResuÉ
.
g‘V®ue
()));

601 
ASSERT_FALSE
(
£cÚdRs
.
hasRecÜdFÜ
(
£cÚdIn£¹ResuÉ
.
g‘V®ue
()));

602 
ASSERT_FALSE
(
thœdRs
.
hasRecÜdFÜ
(
thœdIn£¹ResuÉ
.
g‘V®ue
()));

604 
ASSERT_EQUALS
(
fœ¡Rs
.
numRecÜds
(), 0);

605 
ASSERT_EQUALS
(
£cÚdRs
.
numRecÜds
(), 0);

606 
ASSERT_EQUALS
(
thœdRs
.
numRecÜds
(), 0);

610 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

611 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

612 
»move
("berkeleyEnv/log.0000000001");

615 
TEST
(
B”k–eyRecÜdStÜe
, 
P”si¡’û1
) {

616 
DiskLoc
* 
	gloc
;

619 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

620 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

623 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

624 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

625 
	gloc
 = 
Ãw
 
DiskLoc
(
»suÉ
.
g‘V®ue
());

627 
ASSERT_TRUE
(
»suÉ
.
isOK
());

628 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

629 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

631 
	gwu
.
comm™
();

636 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

637 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

638 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

640 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

642 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(*
loc
);

643 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

644 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 1);

646 
	grs
.
d–‘eRecÜd
(&
txn
, *
loc
);

647 
ASSERT_FALSE
(
rs
.
hasRecÜdFÜ
(*
loc
));

648 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 0);

649 
ASSERT_EQUALS
(
rs
.
d©aSize
(), 0);

651 
	gwu
.
comm™
();

656 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

657 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

658 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 0);

661 
d–‘e
 
	gloc
;

664 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

665 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

666 
»move
("berkeleyEnv/log.0000000001");

669 
TEST
(
B”k–eyRecÜdStÜe
, 
P”si¡’û2
) {

670 cÚ¡ 
	gnum_š£¹s
 = 1000;

672 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

673 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

676 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

678 
	gi
 = 0; i < 
	gnum_š£¹s
; i++) {

679 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

681 
ASSERT_TRUE
(
»suÉ
.
isOK
());

682 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

683 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

686 
	gwu
.
comm™
();

691 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

692 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

693 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 
num_š£¹s
);

695 
Wr™eUn™OfWÜk
 
wu
(
txn
.
»cov”yUn™
());

697 
	gi
 = 0; i < 
	gnum_š£¹s
; i++) {

698 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, "abc", 4, 1000);

700 
ASSERT_TRUE
(
»suÉ
.
isOK
());

701 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
(
»suÉ
.
g‘V®ue
());

702 
ASSERT_EQUALS
(
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()));

705 
	gwu
.
comm™
();

710 
O³¿tiÚCÚ‹xtB”k–ey
 
	gtxn
;

711 
B”k–eyRecÜdStÜe
 
rs
(
txn
.
g‘Env
(), 
db_Çme
.
d©a
(), 
çl£
, -1, -1, 
NULL
);

712 
ASSERT_EQUALS
(
rs
.
numRecÜds
(), 2 * 
num_š£¹s
);

717 
Db
(
NULL
, 0).
»move
(("b”k–eyEnv/" + 
db_Çme
 + ".db").
d©a
(), NULL, 0);

718 
DbEnv
(0).
»move
("b”k–eyEnv/", 
DB_FORCE
);

719 
»move
("berkeleyEnv/log.0000000001");

	@record_store_heap.cpp

32 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_h—p.h
"

34 
	~"mÚgo/db/¡Üage/»cÜd.h
"

36 
Çme¥aû
 
	gmÚgo
 {

42 
	gH—pRecÜdStÜe
::
H—pRecÜdStÜe
(cÚ¡ 
SŒšgD©a
& 
ns
,

43 
boŞ
 
isC­³d
,

44 
št64_t
 
ÿµedMaxSize
,

45 
št64_t
 
ÿµedMaxDocs
,

46 
C­³dDocum’tD–‘eC®lback
* 
ÿµedD–‘eC®lback
)

47 : 
RecÜdStÜe
(
ns
),

48 
_isC­³d
(
isC­³d
),

49 
_ÿµedMaxSize
(
ÿµedMaxSize
),

50 
_ÿµedMaxDocs
(
ÿµedMaxDocs
),

51 
_ÿµedD–‘eC®lback
(
ÿµedD–‘eC®lback
),

52 
_d©aSize
(0),

53 
_ÃxtId
(1) {

55 ià(
	g_isC­³d
) {

56 
šv¬ŸÁ
(
_ÿµedMaxSize
 > 0);

57 
šv¬ŸÁ
(
_ÿµedMaxDocs
 == -1 || _cappedMaxDocs > 0);

60 
šv¬ŸÁ
(
_ÿµedMaxSize
 == -1);

61 
šv¬ŸÁ
(
_ÿµedMaxDocs
 == -1);

65 cÚ¡ * 
	gH—pRecÜdStÜe
::
Çme
() const {  "heap"; }

67 
RecÜd
* 
	gH—pRecÜdStÜe
::
»cÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

68 
RecÜds
::
cÚ¡_™”©Ü
 
™
 = 
_»cÜds
.
fšd
(
loc
);

69 
šv¬ŸÁ
(
™
 !ğ
_»cÜds
.
’d
());

70  
	g»š‹½»t_ÿ¡
<
	gRecÜd
*>(
	g™
->
	g£cÚd
.
g‘
());

73 
	gH—pRecÜdStÜe
::
d–‘eRecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
) {

74 
RecÜd
* 
	g»c
 = 
»cÜdFÜ
(
loc
);

75 
	g_d©aSize
 -ğ
»c
->
ÃtL’gth
();

76 
šv¬ŸÁ
(
_»cÜds
.
”a£
(
loc
) == 1);

79 
boŞ
 
	gH—pRecÜdStÜe
::
ÿµedAndN“dD–‘e
() const {

80 ià(!
_isC­³d
)

81  
çl£
;

83 ià(
	g_d©aSize
 > 
	g_ÿµedMaxSize
)

84  
	gŒue
;

86 ià((
	g_ÿµedMaxDocs
 !ğ-1è&& (
numRecÜds
(è> 
_ÿµedMaxDocs
))

87  
Œue
;

89  
	gçl£
;

92 
	gH—pRecÜdStÜe
::
ÿµedD–‘eAsN“ded
(
O³¿tiÚCÚ‹xt
* 
txn
) {

93 
ÿµedAndN“dD–‘e
()) {

94 
šv¬ŸÁ
(!
_»cÜds
.
em±y
());

96 
DiskLoc
 
	gŞde¡
 = 
_»cÜds
.
begš
()->
fœ¡
;

98 ià(
	g_ÿµedD–‘eC®lback
)

99 
uas£¹StusOK
(
_ÿµedD–‘eC®lback
->
aboutToD–‘eC­³d
(
txn
, 
Şde¡
));

101 
d–‘eRecÜd
(
txn
, 
Şde¡
);

105 
	gStusW™h
<
	gDiskLoc
> 
	gH—pRecÜdStÜe
::
š£¹RecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
,

106 cÚ¡ * 
d©a
,

107 
Ën
,

108 
quÙaMax
) {

109 ià(
	g_isC­³d
 && 
	gËn
 > 
	g_ÿµedMaxSize
) {

112  
	gStusW™h
<
	gDiskLoc
>(
	gE¼ÜCodes
::
BadV®ue
,

117 cÚ¡ 
	gËngthW™hH—d”s
 = 
Ën
 + 
RecÜd
::
H—d”Size
;

118 
	gboo¡
::
sh¬ed_¬¿y
<> 
buf
(
Ãw
 [
ËngthW™hH—d”s
]);

119 
RecÜd
* 
	g»c
 = 
»š‹½»t_ÿ¡
<RecÜd*>(
buf
.
g‘
());

120 
	g»c
->
ËngthW™hH—d”s
() =†engthWithHeaders;

121 
memıy
(
»c
->
d©a
(), d©a, 
Ën
);

123 cÚ¡ 
DiskLoc
 
	gloc
 = 
®loÿ‹Loc
();

124 
	g_»cÜds
[
loc
] = 
buf
;

125 
	g_d©aSize
 +ğ
Ën
;

127 
ÿµedD–‘eAsN“ded
(
txn
);

129  
	gStusW™h
<
	gDiskLoc
>(
	gloc
);

132 
	gStusW™h
<
	gDiskLoc
> 
	gH—pRecÜdStÜe
::
š£¹RecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
,

133 cÚ¡ 
DocWr™”
* 
doc
,

134 
quÙaMax
) {

135 cÚ¡ 
	gËn
 = 
doc
->
docum’tSize
();

136 ià(
	g_isC­³d
 && 
	gËn
 > 
	g_ÿµedMaxSize
) {

139  
	gStusW™h
<
	gDiskLoc
>(
	gE¼ÜCodes
::
BadV®ue
,

144 cÚ¡ 
	gËngthW™hH—d”s
 = 
Ën
 + 
RecÜd
::
H—d”Size
;

145 
	gboo¡
::
sh¬ed_¬¿y
<> 
buf
(
Ãw
 [
ËngthW™hH—d”s
]);

146 
RecÜd
* 
	g»c
 = 
»š‹½»t_ÿ¡
<RecÜd*>(
buf
.
g‘
());

147 
	g»c
->
ËngthW™hH—d”s
() =†engthWithHeaders;

148 
	gdoc
->
wr™eDocum’t
(
»c
->
d©a
());

150 cÚ¡ 
DiskLoc
 
	gloc
 = 
®loÿ‹Loc
();

151 
	g_»cÜds
[
loc
] = 
buf
;

152 
	g_d©aSize
 +ğ
Ën
;

154 
ÿµedD–‘eAsN“ded
(
txn
);

156  
	gStusW™h
<
	gDiskLoc
>(
	gloc
);

159 
	gStusW™h
<
	gDiskLoc
> 
	gH—pRecÜdStÜe
::
upd©eRecÜd
(
O³¿tiÚCÚ‹xt
* 
txn
,

160 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

161 cÚ¡ * 
d©a
,

162 
Ën
,

163 
quÙaMax
,

164 
Upd©eMoveNÙif›r
* 
nÙif›r
 ) {

165 
šv¬ŸÁ
(!"updateRecord‚ot yet implemented");

168 
Stus
 
	gH—pRecÜdStÜe
::
upd©eW™hDamages
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

169 cÚ¡ 
DiskLoc
& 
loc
,

170 cÚ¡ * 
damªgeSourû
,

171 cÚ¡ 
mubËbsÚ
::
DamageVeùÜ
& 
damages
 ) {

172 
šv¬ŸÁ
(!"updateRecord‚ot yet implemented");

175 
RecÜdI‹¿tÜ
* 
	gH—pRecÜdStÜe
::
g‘I‹¿tÜ
(cÚ¡ 
DiskLoc
& 
¡¬t
,

176 
boŞ
 
abË
,

177 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const {

178 ià(
abË
)

179 
šv¬ŸÁ
(
_isC­³d
 && 
dœ
 =ğ
CŞËùiÚSÿnP¬ams
::
FORWARD
);

181 ià(
	gdœ
 =ğ
CŞËùiÚSÿnP¬ams
::
FORWARD
) {

182  
Ãw
 
H—pRecÜdI‹¿tÜ
(
_»cÜds
, *
this
, 
¡¬t
, 
abË
);

185  
Ãw
 
H—pRecÜdI‹¿tÜ
(
_»cÜds
, *
this
, 
¡¬t
);

189 
RecÜdI‹¿tÜ
* 
	gH—pRecÜdStÜe
::
g‘I‹¿tÜFÜR•aœ
() const {

191  
Ãw
 
H—pRecÜdI‹¿tÜ
(
_»cÜds
, *
this
);

194 
	g¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
H—pRecÜdStÜe
::
g‘MªyI‹¿tÜs
() const {

195 
¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
out
;

197 
	gout
.
push_back
(
Ãw
 
H—pRecÜdI‹¿tÜ
(
_»cÜds
, *
this
));

198  
	gout
;

201 
Stus
 
	gH—pRecÜdStÜe
::
Œunÿ‹
(
O³¿tiÚCÚ‹xt
* 
txn
) {

202 
_»cÜds
.
ş—r
();

203 
	g_d©aSize
 = 0;

204  
	gStus
::
OK
();

207 
boŞ
 
	gH—pRecÜdStÜe
::
com·ùSuµÜ‹d
() const {

208  
çl£
;

210 
Stus
 
	gH—pRecÜdStÜe
::
com·ù
(
O³¿tiÚCÚ‹xt
* 
txn
,

211 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

212 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

213 
Com·ùSts
* 
¡©s
) {

215 
šv¬ŸÁ
(!"compact‚ot yet implemented");

218 
Stus
 
	gH—pRecÜdStÜe
::
v®id©e
(
O³¿tiÚCÚ‹xt
* 
txn
,

219 
boŞ
 
fuÎ
,

220 
boŞ
 
sÿnD©a
,

221 
V®id©eAd­tÜ
* 
ad­tÜ
,

222 
V®id©eResuÉs
* 
»suÉs
,

223 
BSONObjBud”
* 
ouut
) const {

226 
	g»suÉs
->
	gv®id
 = 
Œue
;

227 ià(
	gsÿnD©a
 && 
	gfuÎ
) {

228 
	gRecÜds
::
cÚ¡_™”©Ü
 
™
 = 
_»cÜds
.
begš
(); 
	g™
 !ğ_»cÜds.
’d
(); ++it) {

229 
RecÜd
* 
	g»c
 = 
»š‹½»t_ÿ¡
<RecÜd*>(
™
->
£cÚd
.
g‘
());

230 
size_t
 
	gd©aSize
;

231 cÚ¡ 
Stus
 
	g¡©us
 = 
ad­tÜ
->
v®id©e
(
»c
, &
d©aSize
);

232 ià(!
	g¡©us
.
isOK
()) {

233 
	g»suÉs
->
	gv®id
 = 
çl£
;

234 
	g»suÉs
->
	g”rÜs
.
push_back
("invalid object detected (see†ogs)");

235 
log
(è<< "Inv®id objeù d‘eùed iÀ" << 
	g_ns
 << ": " << 
	g¡©us
.
»asÚ
();

240  
	gStus
::
OK
();

244 
	gH—pRecÜdStÜe
::
­³ndCu¡omSts
Ğ
BSONObjBud”
* 
»suÉ
, 
sÿË
 ) const {

245 
šv¬ŸÁ
(!"appendCustomStats‚ot yet implemented");

248 
Stus
 
	gH—pRecÜdStÜe
::
touch
(
O³¿tiÚCÚ‹xt
* 
txn
, 
BSONObjBud”
* 
ouut
) const {

249 ià(
	gouut
) {

250 
	gouut
->
­³nd
("numRanges", 1);

251 
	gouut
->
­³nd
("millis", 0);

253  
	gStus
::
OK
();

256 
Stus
 
	gH—pRecÜdStÜe
::
£tCu¡omO±iÚ
(

257 
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
BSONEËm’t
& 
İtiÚ
, 
BSONObjBud”
* 
šfo
) {

258 
šv¬ŸÁ
(!"setCustomOption‚ot yet implemented");

261 
	gH—pRecÜdStÜe
::
šü—£StÜageSize
(
O³¿tiÚCÚ‹xt
* 
txn
, 
size
, 
quÙaMax
) {

263 
šv¬ŸÁ
(!"increaseStorageSize‚ot yet implemented");

266 
št64_t
 
	gH—pRecÜdStÜe
::
¡ÜageSize
(
BSONObjBud”
* 
exŒaInfo
, 
šfoLev–
) const {

268 cÚ¡ 
št64_t
 
	g»cÜdOv”h—d
 = 
numRecÜds
(è* 
RecÜd
::
H—d”Size
;

269  
	g_d©aSize
 + 
	g»cÜdOv”h—d
;

272 
DiskLoc
 
	gH—pRecÜdStÜe
::
®loÿ‹Loc
() {

273 cÚ¡ 
št64_t
 
id
 = 
_ÃxtId
++;

276 
šv¬ŸÁ
(
id
 < (1LL << 53));

277  
DiskLoc
((
id
 >> 30), ((id << 1) & ~(1<<31)));

284 
	gH—pRecÜdI‹¿tÜ
::
H—pRecÜdI‹¿tÜ
(cÚ¡ 
H—pRecÜdStÜe
::
RecÜds
& 
»cÜds
,

285 cÚ¡ 
H—pRecÜdStÜe
& 
rs
,

286 
DiskLoc
 
¡¬t
,

287 
boŞ
 
abË
)

288 : 
_abË
(
abË
),

289 
_kËdByInv®id©e
(
çl£
),

290 
_»cÜds
(
»cÜds
),

291 
_rs
(
rs
) {

292 ià(
	g¡¬t
.
isNuÎ
()) {

293 
	g_™
 = 
_»cÜds
.
begš
();

296 
	g_™
 = 
_»cÜds
.
fšd
(
¡¬t
);

297 
šv¬ŸÁ
(
_™
 !ğ
_»cÜds
.
’d
());

301 
boŞ
 
	gH—pRecÜdI‹¿tÜ
::
isEOF
() {

302  
_™
 =ğ
_»cÜds
.
’d
();

305 
DiskLoc
 
	gH—pRecÜdI‹¿tÜ
::
cu¼
() {

306 ià(
isEOF
())

307  
DiskLoc
();

308  
	g_™
->
	gfœ¡
;

311 
DiskLoc
 
	gH—pRecÜdI‹¿tÜ
::
g‘Next
() {

312 ià(
isEOF
()) {

313 ià(!
_abË
)

314  
DiskLoc
();

316 
šv¬ŸÁ
(!
_kËdByInv®id©e
);

319 
šv¬ŸÁ
(!
_Ï¡Loc
.
isNuÎ
());

320 
	g_™
 = 
_»cÜds
.
fšd
(
_Ï¡Loc
);

321 
šv¬ŸÁ
(
_™
 !ğ
_»cÜds
.
’d
());

323 ià(++
	g_™
 =ğ
_»cÜds
.
’d
())

324  
DiskLoc
();

327 cÚ¡ 
DiskLoc
 
	gout
 = 
_™
->
fœ¡
;

328 ++
	g_™
;

329 ià(
	g_abË
 && 
	g_™
 =ğ
_»cÜds
.
’d
())

330 
_Ï¡Loc
 = 
out
;

331  
	gout
;

334 
	gH—pRecÜdI‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
loc
) {

335 ià(
_rs
.
isC­³d
()) {

337 ià(
isEOF
()) {

338 ià(
_Ï¡Loc
 =ğ
loc
) {

339 
_kËdByInv®id©e
 = 
Œue
;

342 ià(
	g_™
->
	gfœ¡
 =ğ
loc
) {

343 
_kËdByInv®id©e
 = 
Œue
;

349 ià(
	g_™
->
	gfœ¡
 =ğ
loc
)

350 ++
_™
;

353 
	gH—pRecÜdI‹¿tÜ
::
´•¬eToY›ld
() {

356 
boŞ
 
H—pRecÜdI‹¿tÜ
::
»cov”FromY›ld
() {

357  !
_kËdByInv®id©e
;

360 cÚ¡ 
RecÜd
* 
	gH—pRecÜdI‹¿tÜ
::
»cÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

361  
_rs
.
»cÜdFÜ
(
loc
);

368 
	gH—pRecÜdRev”£I‹¿tÜ
::
H—pRecÜdRev”£I‹¿tÜ
(cÚ¡ 
H—pRecÜdStÜe
::
RecÜds
& 
»cÜds
,

369 cÚ¡ 
H—pRecÜdStÜe
& 
rs
,

370 
DiskLoc
 
¡¬t
)

371 : 
_kËdByInv®id©e
(
çl£
),

372 
_»cÜds
(
»cÜds
),

373 
_rs
(
rs
) {

374 ià(
	g¡¬t
.
isNuÎ
()) {

375 
	g_™
 = 
_»cÜds
.
rbegš
();

378 
	g_™
 = 
H—pRecÜdStÜe
::
RecÜds
::
cÚ¡_»v”£_™”©Ü
(
_»cÜds
.
fšd
(
¡¬t
));

379 
šv¬ŸÁ
(
_™
 !ğ
_»cÜds
.
»nd
());

383 
boŞ
 
	gH—pRecÜdRev”£I‹¿tÜ
::
isEOF
() {

384  
_™
 =ğ
_»cÜds
.
»nd
();

387 
DiskLoc
 
	gH—pRecÜdRev”£I‹¿tÜ
::
cu¼
() {

388 ià(
isEOF
())

389  
DiskLoc
();

390  
	g_™
->
	gfœ¡
;

393 
DiskLoc
 
	gH—pRecÜdRev”£I‹¿tÜ
::
g‘Next
() {

394 ià(
isEOF
())

395  
DiskLoc
();

397 cÚ¡ 
DiskLoc
 
	gout
 = 
_™
->
fœ¡
;

398 ++
	g_™
;

399  
	gout
;

402 
	gH—pRecÜdRev”£I‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
loc
) {

403 ià(
isEOF
())

406 ià(
	g_™
->
	gfœ¡
 =ğ
loc
) {

407 ià(
_rs
.
isC­³d
()) {

409 
_kËdByInv®id©e
 = 
Œue
;

412 ++
	g_™
;

416 
	gH—pRecÜdRev”£I‹¿tÜ
::
´•¬eToY›ld
() {

419 
boŞ
 
H—pRecÜdRev”£I‹¿tÜ
::
»cov”FromY›ld
() {

420  !
_kËdByInv®id©e
;

423 cÚ¡ 
RecÜd
* 
	gH—pRecÜdRev”£I‹¿tÜ
::
»cÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

424  
_rs
.
»cÜdFÜ
(
loc
);

	@record_store_heap.h

31 #´agm¨
Úû


33 
	~<boo¡/sh¬ed_¬¿y.hµ
>

34 
	~<m­
>

36 
	~"mÚgo/db/¡ruùu»/ÿµed_ÿÎback.h
"

37 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

39 
Çme¥aû
 
	gmÚgo
 {

40 
şass
 
	gH—pRecÜdI‹¿tÜ
;

47 şas 
	cH—pRecÜdStÜe
 : 
public
 
RecÜdStÜe
 {

48 
public
:

49 
ex¶ic™
 
H—pRecÜdStÜe
(cÚ¡ 
SŒšgD©a
& 
ns
,

50 
boŞ
 
isC­³d
 = 
çl£
,

51 
št64_t
 
ÿµedMaxSize
 = -1,

52 
št64_t
 
ÿµedMaxDocs
 = -1,

53 
C­³dDocum’tD–‘eC®lback
* 
ÿµedD–‘eC®lback
 = 
NULL
);

55 
vœtu®
 cÚ¡ * 
Çme
() const;

57 
vœtu®
 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

59 
vœtu®
 
d–‘eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dl
 );

61 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

62 cÚ¡ * 
d©a
,

63 
Ën
,

64 
quÙaMax
 );

66 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

67 cÚ¡ 
DocWr™”
* 
doc
,

68 
quÙaMax
 );

70 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
upd©eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

71 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

72 cÚ¡ * 
d©a
,

73 
Ën
,

74 
quÙaMax
,

75 
Upd©eMoveNÙif›r
* 
nÙif›r
 );

77 
vœtu®
 
Stus
 
upd©eW™hDamages
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

78 cÚ¡ 
DiskLoc
& 
loc
,

79 cÚ¡ * 
damªgeSourû
,

80 cÚ¡ 
mubËbsÚ
::
DamageVeùÜ
& 
damages
 );

82 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜ
ĞcÚ¡ 
DiskLoc
& 
¡¬t
, 
boŞ
 
abË
,

83 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const;

85 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜFÜR•aœ
() const;

87 
vœtu®
 
	g¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
g‘MªyI‹¿tÜs
() const;

89 
vœtu®
 
Stus
 
Œunÿ‹
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

91 
vœtu®
 
boŞ
 
com·ùSuµÜ‹d
() const;

92 
vœtu®
 
Stus
 
com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

93 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

94 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

95 
Com·ùSts
* 
¡©s
 );

97 
vœtu®
 
Stus
 
v®id©e
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

98 
boŞ
 
fuÎ
,

99 
boŞ
 
sÿnD©a
,

100 
V®id©eAd­tÜ
* 
ad­tÜ
,

101 
V®id©eResuÉs
* 
»suÉs
, 
BSONObjBud”
* 
ouut
 ) const;

103 
vœtu®
 
­³ndCu¡omSts
Ğ
BSONObjBud”
* 
»suÉ
, 
sÿË
 ) const;

105 
vœtu®
 
Stus
 
touch
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
BSONObjBud”
* 
ouut
 ) const;

107 
vœtu®
 
Stus
 
£tCu¡omO±iÚ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

108 cÚ¡ 
BSONEËm’t
& 
İtiÚ
,

109 
BSONObjBud”
* 
šfo
 = 
NULL
 );

111 
vœtu®
 
šü—£StÜageSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
size
, 
quÙaMax
 );

113 
vœtu®
 
št64_t
 
¡ÜageSize
(
BSONObjBud”
* 
exŒaInfo
 = 
NULL
, 
šfoLev–
 = 0) const;

115 
vœtu®
 
d©aSize
(ècÚ¡ {  
	g_d©aSize
; }

117 
vœtu®
 
numRecÜds
(ècÚ¡ {  
	g_»cÜds
.
size
(); }

123 
	g¡d
::
	tm­
<
	tDiskLoc
, 
	tboo¡
::
	tsh¬ed_¬¿y
<> > 
	tRecÜds
;

125 
boŞ
 
isC­³d
(ècÚ¡ {  
	g_isC­³d
; }

126 
£tC­³dD–‘eC®lback
(
C­³dDocum’tD–‘eC®lback
* 
cb
è{ 
	g_ÿµedD–‘eC®lback
 = cb; }

127 
boŞ
 
ÿµedMaxDocs
(ècÚ¡ { 
šv¬ŸÁ
(
_isC­³d
);  
	g_ÿµedMaxDocs
; }

128 
boŞ
 
ÿµedMaxSize
(ècÚ¡ { 
šv¬ŸÁ
(
_isC­³d
);  
	g_ÿµedMaxSize
; }

130 
	g´iv©e
:

131 
DiskLoc
 
®loÿ‹Loc
();

132 
boŞ
 
ÿµedAndN“dD–‘e
() const;

133 
ÿµedD–‘eAsN“ded
(
O³¿tiÚCÚ‹xt
* 
txn
);

136 cÚ¡ 
boŞ
 
	g_isC­³d
;

137 cÚ¡ 
št64_t
 
	g_ÿµedMaxSize
;

138 cÚ¡ 
št64_t
 
	g_ÿµedMaxDocs
;

139 
C­³dDocum’tD–‘eC®lback
* 
	g_ÿµedD–‘eC®lback
;

140 
št64_t
 
	g_d©aSize
;

142 
RecÜds
 
	g_»cÜds
;

143 
št64_t
 
	g_ÃxtId
;

146 şas 
	cH—pRecÜdI‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

147 
public
:

148 
H—pRecÜdI‹¿tÜ
(cÚ¡ 
H—pRecÜdStÜe
::
RecÜds
& 
»cÜds
,

149 cÚ¡ 
H—pRecÜdStÜe
& 
rs
,

150 
DiskLoc
 
¡¬t
 = DiskLoc(),

151 
boŞ
 
abË
 = 
çl£
);

153 
vœtu®
 
boŞ
 
isEOF
();

155 
vœtu®
 
DiskLoc
 
cu¼
();

157 
vœtu®
 
DiskLoc
 
g‘Next
();

159 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

161 
vœtu®
 
´•¬eToY›ld
();

163 
vœtu®
 
boŞ
 
»cov”FromY›ld
();

165 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

167 
	g´iv©e
:

168 
H—pRecÜdStÜe
::
RecÜds
::
cÚ¡_™”©Ü
 
_™
;

169 
boŞ
 
	g_abË
;

170 
DiskLoc
 
	g_Ï¡Loc
;

171 
boŞ
 
	g_kËdByInv®id©e
;

173 cÚ¡ 
	gH—pRecÜdStÜe
::
RecÜds
& 
_»cÜds
;

174 cÚ¡ 
	gH—pRecÜdStÜe
& 
	g_rs
;

177 şas 
	cH—pRecÜdRev”£I‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

178 
public
:

179 
H—pRecÜdRev”£I‹¿tÜ
(cÚ¡ 
H—pRecÜdStÜe
::
RecÜds
& 
»cÜds
,

180 cÚ¡ 
H—pRecÜdStÜe
& 
rs
,

181 
DiskLoc
 
¡¬t
 = DiskLoc());

183 
vœtu®
 
boŞ
 
isEOF
();

185 
vœtu®
 
DiskLoc
 
cu¼
();

187 
vœtu®
 
DiskLoc
 
g‘Next
();

189 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

191 
vœtu®
 
´•¬eToY›ld
();

193 
vœtu®
 
boŞ
 
»cov”FromY›ld
();

195 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

197 
	g´iv©e
:

198 
H—pRecÜdStÜe
::
RecÜds
::
cÚ¡_»v”£_™”©Ü
 
_™
;

199 
boŞ
 
	g_kËdByInv®id©e
;

201 cÚ¡ 
	gH—pRecÜdStÜe
::
RecÜds
& 
_»cÜds
;

202 cÚ¡ 
	gH—pRecÜdStÜe
& 
	g_rs
;

	@record_store_v1_base.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ba£.h
"

33 
	~"mÚgo/db/ÿlog/cŞËùiÚ.h
"

34 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

35 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

36 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

37 
	~"mÚgo/db/¡Üage/»cÜd.h
"

38 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_»·œ_™”©Ü.h
"

39 
	~"mÚgo/ut/´og»ss_m‘”.h
"

40 
	~"mÚgo/ut/tim”.h
"

41 
	~"mÚgo/ut/touch_·ges.h
"

43 
Çme¥aû
 
	gmÚgo
 {

45 cÚ¡ 
	gRecÜdStÜeV1Ba£
::
Buck‘s
 = 19;

46 cÚ¡ 
	gRecÜdStÜeV1Ba£
::
MaxBuck‘
 = 18;

51 cÚ¡ 
	gRecÜdStÜeV1Ba£
::
buck‘Sizes
[] = {

60 
	gRecÜdStÜeV1Ba£
::
RecÜdStÜeV1Ba£
ĞcÚ¡ 
SŒšgD©a
& 
ns
,

61 
RecÜdStÜeV1M‘aD©a
* 
d‘as
,

62 
Ex‹ÁMªag”
* 
em
,

63 
boŞ
 
isSy¡emIndexes
 )

64 : 
RecÜdStÜe
Ğ
ns
 ),

65 
_d‘as
Ğ
d‘as
 ),

66 
_ex‹ÁMªag”
Ğ
em
 ),

67 
_isSy¡emIndexes
Ğ
isSy¡emIndexes
 ) {

70 
	gRecÜdStÜeV1Ba£
::~
RecÜdStÜeV1Ba£
() {

74 
št64_t
 
RecÜdStÜeV1Ba£
::
¡ÜageSize
Ğ
BSONObjBud”
* 
exŒaInfo
, 
Ëv–
 ) const {

75 
BSONA¼ayBud”
 
	gex‹ÁInfo
;

77 
št64_t
 
	gtÙ®
 = 0;

78 
	gn
 = 0;

80 
DiskLoc
 
	gcur
 = 
_d‘as
->
fœ¡Ex‹Á
();

81  !
	gcur
.
isNuÎ
() ) {

82 
Ex‹Á
* 
	ge
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
cur
 );

84 
	gtÙ®
 +ğ
e
->
Ëngth
;

85 
	gn
++;

87 iàĞ
	gexŒaInfo
 && 
	gËv–
 > 0 ) {

88 
	gex‹ÁInfo
.
­³nd
Ğ
BSON
Ğ"Ën" << 
e
->
Ëngth
 << "loc: " <<ƒ->
myLoc
.
toBSONObj
() ) );

91 
	gcur
 = 
e
->
xÃxt
;

94 iàĞ
	gexŒaInfo
 ) {

95 
	gexŒaInfo
->
­³nd
Ğ"numEx‹Ás", 
n
 );

96 iàĞ
	gËv–
 > 0 )

97 
	gexŒaInfo
->
­³nd
Ğ"ex‹Ás", 
ex‹ÁInfo
.
¬r
() );

100  
	gtÙ®
;

103 
RecÜd
* 
	gRecÜdStÜeV1Ba£
::
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

104  
_ex‹ÁMªag”
->
»cÜdFÜV1
Ğ
loc
 );

107 cÚ¡ 
D–‘edRecÜd
* 
	gRecÜdStÜeV1Ba£
::
d–‘edRecÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

108 
šv¬ŸÁ
Ğ
loc
.
a
() != -1 );

109  
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gD–‘edRecÜd
*>Ğ
»cÜdFÜ
Ğ
loc
 ) );

112 
D–‘edRecÜd
* 
	gRecÜdStÜeV1Ba£
::
d»c
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

113 
šv¬ŸÁ
Ğ
loc
.
a
() != -1 );

114  
	g»š‹½»t_ÿ¡
<
	gD–‘edRecÜd
*>Ğ
»cÜdFÜ
Ğ
loc
 ) );

117 
Ex‹Á
* 
	gRecÜdStÜeV1Ba£
::
_g‘Ex‹Á
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

118  
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
loc
 );

121 
DiskLoc
 
	gRecÜdStÜeV1Ba£
::
_g‘Ex‹ÁLocFÜRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const {

122  
_ex‹ÁMªag”
->
ex‹ÁLocFÜV1
Ğ
loc
 );

126 
DiskLoc
 
	gRecÜdStÜeV1Ba£
::
g‘NextRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const {

127 
DiskLoc
 
Ãxt
 = 
g‘NextRecÜdInEx‹Á
Ğ
loc
 );

128 iàĞ!
	gÃxt
.
isNuÎ
() )

129  
	gÃxt
;

133 
Ex‹Á
* 
	ge
 = 
_g‘Ex‹Á
Ğ
_g‘Ex‹ÁLocFÜRecÜd
(
loc
) );

135 iàĞ
	ge
->
	gxÃxt
.
isNuÎ
() )

136  
DiskLoc
();

137 
	ge
 = 
_g‘Ex‹Á
Ğ
e
->
xÃxt
 );

138 iàĞ!
	ge
->
	gfœ¡RecÜd
.
isNuÎ
() )

142  
	ge
->
	gfœ¡RecÜd
;

145 
DiskLoc
 
	gRecÜdStÜeV1Ba£
::
g‘P»vRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const {

146 
DiskLoc
 
´ev
 = 
g‘P»vRecÜdInEx‹Á
Ğ
loc
 );

147 iàĞ!
	g´ev
.
isNuÎ
() )

148  
	g´ev
;

152 
Ex‹Á
 *
	ge
 = 
_g‘Ex‹Á
(
_g‘Ex‹ÁLocFÜRecÜd
(
loc
));

154 iàĞ
	ge
->
	gx´ev
.
isNuÎ
() )

155  
DiskLoc
();

156 
	ge
 = 
_g‘Ex‹Á
Ğ
e
->
x´ev
 );

157 iàĞ!
	ge
->
	gfœ¡RecÜd
.
isNuÎ
() )

161  
	ge
->
	gÏ¡RecÜd
;

165 
DiskLoc
 
	gRecÜdStÜeV1Ba£
::
_fšdFœ¡SpÙ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

166 cÚ¡ 
DiskLoc
& 
extDiskLoc
, 
Ex‹Á
* 
e
 ) {

167 
DiskLoc
 
	gem±yLoc
 = 
extDiskLoc
;

168 
	gem±yLoc
.
šc
Ğ
Ex‹Á
::
H—d”Size
() );

169 
	gd–RecL’gth
 = 
e
->
Ëngth
 - 
Ex‹Á
::
H—d”Size
();

170 iàĞ
	gd–RecL’gth
 >ğ32*1024 && 
_ns
.
fšd
('$'è!ğ
¡ršg
::
Åos
 && !
isC­³d
() ) {

172 & 
ofs
 = 
em±yLoc
.
GETOFS
();

173 
	gÃwOfs
 = (
ofs
 + 0xfff) & ~0xfff;

174 
	gd–RecL’gth
 -ğ(
ÃwOfs
-
ofs
);

175 
das£¹
Ğ
d–RecL’gth
 > 0 );

176 
	gofs
 = 
ÃwOfs
;

179 
D–‘edRecÜd
* 
	gem±y
 = 
txn
->
»cov”yUn™
()->
wr™šg
(
d»c
(
em±yLoc
));

180 
	gem±y
->
ËngthW™hH—d”s
(èğ
d–RecL’gth
;

181 
	gem±y
->
ex‹ÁOfs
(èğ
e
->
myLoc
.
g‘Ofs
();

182 
	gem±y
->
ÃxtD–‘ed
().
NuÎ
();

183  
	gem±yLoc
;

187 
DiskLoc
 
	gRecÜdStÜeV1Ba£
::
g‘NextRecÜdInEx‹Á
ĞcÚ¡ DiskLoc& 
loc
 ) const {

188 
ÃxtOff£t
 = 
»cÜdFÜ
Ğ
loc
 )->
ÃxtOfs
();

190 iàĞ
	gÃxtOff£t
 =ğ
DiskLoc
::
NuÎOfs
 )

191  
DiskLoc
();

193 
çs£¹
Ğ17441, 
abs
(
ÃxtOff£t
) >= 8 );

194  
DiskLoc
Ğ
loc
.
a
(), 
ÃxtOff£t
 );

197 
DiskLoc
 
	gRecÜdStÜeV1Ba£
::
g‘P»vRecÜdInEx‹Á
ĞcÚ¡ DiskLoc& 
loc
 ) const {

198 
´evOff£t
 = 
»cÜdFÜ
Ğ
loc
 )->
´evOfs
();

200 iàĞ
	g´evOff£t
 =ğ
DiskLoc
::
NuÎOfs
 )

201  
DiskLoc
();

203 
çs£¹
Ğ17442, 
abs
(
´evOff£t
) >= 8 );

204  
DiskLoc
Ğ
loc
.
a
(), 
´evOff£t
 );

209 
	gStusW™h
<
	gDiskLoc
> 
	gRecÜdStÜeV1Ba£
::
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

210 cÚ¡ 
DocWr™”
* 
doc
,

211 
quÙaMax
 ) {

212 
	gdocSize
 = 
doc
->
docum’tSize
();

213 iàĞ
	gdocSize
 < 4 ) {

214  
	gStusW™h
<
	gDiskLoc
>Ğ
	gE¼ÜCodes
::
Inv®idL’gth
,

217 
	gËnWHdr
 = 
docSize
 + 
RecÜd
::
H—d”Size
;

218 iàĞ
	gdoc
->
addPaddšg
() )

219 
	gËnWHdr
 = 
g‘RecÜdAÎoÿtiÚSize
Ğ
ËnWHdr
 );

221 
	gStusW™h
<
	gDiskLoc
> 
	gloc
 = 
®locRecÜd
Ğ
txn
, 
ËnWHdr
, 
quÙaMax
 );

222 iàĞ!
	gloc
.
isOK
() )

223  
	gloc
;

225 
RecÜd
 *
	gr
 = 
»cÜdFÜ
Ğ
loc
.
g‘V®ue
() );

226 
çs£¹
Ğ17319, 
r
->
ËngthW™hH—d”s
(è>ğ
ËnWHdr
 );

228 
	gr
 = 
»š‹½»t_ÿ¡
<
RecÜd
*>Ğ
txn
->
»cov”yUn™
()->
wr™šgPŒ
(
r
, 
ËnWHdr
) );

229 
	gdoc
->
wr™eDocum’t
Ğ
r
->
d©a
() );

231 
_addRecÜdToRecLi¡InEx‹Á
(
txn
, 
r
, 
loc
.
g‘V®ue
());

233 
	g_d‘as
->
šüem’tSts
Ğ
txn
, 
r
->
ÃtL’gth
(), 1 );

235 
_·ddšgF™s
Ğ
txn
 );

237  
	gloc
;

241 
	gStusW™h
<
	gDiskLoc
> 
	gRecÜdStÜeV1Ba£
::
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

242 cÚ¡ * 
d©a
,

243 
Ën
,

244 
quÙaMax
 ) {

245 iàĞ
	gËn
 < 4 ) {

246  
	gStusW™h
<
	gDiskLoc
>Ğ
	gE¼ÜCodes
::
Inv®idL’gth
,

250 
	gStusW™h
<
	gDiskLoc
> 
	g¡©us
 = 
_š£¹RecÜd
Ğ
txn
, 
d©a
, 
Ën
, 
quÙaMax
 );

251 iàĞ
	g¡©us
.
isOK
() )

252 
_·ddšgF™s
Ğ
txn
 );

254  
	g¡©us
;

257 
	gStusW™h
<
	gDiskLoc
> 
	gRecÜdStÜeV1Ba£
::
_š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

258 cÚ¡ * 
d©a
,

259 
Ën
,

260 
quÙaMax
 ) {

262 
	gËnWHdr
 = 
g‘RecÜdAÎoÿtiÚSize
Ğ
Ën
 + 
RecÜd
::
H—d”Size
 );

263 
çs£¹
Ğ17208, 
ËnWHdr
 >ğĞ
Ën
 + 
RecÜd
::
H—d”Size
 ) );

265 
	gStusW™h
<
	gDiskLoc
> 
	gloc
 = 
®locRecÜd
Ğ
txn
, 
ËnWHdr
, 
quÙaMax
 );

266 iàĞ!
	gloc
.
isOK
() )

267  
	gloc
;

269 
RecÜd
 *
	gr
 = 
»cÜdFÜ
Ğ
loc
.
g‘V®ue
() );

270 
çs£¹
Ğ17210, 
r
->
ËngthW™hH—d”s
(è>ğ
ËnWHdr
 );

273 
	gr
 = 
»š‹½»t_ÿ¡
<
RecÜd
*>Ğ
txn
->
»cov”yUn™
()->
wr™šgPŒ
(
r
, 
ËnWHdr
) );

274 
memıy
Ğ
r
->
d©a
(), d©a, 
Ën
 );

276 
_addRecÜdToRecLi¡InEx‹Á
(
txn
, 
r
, 
loc
.
g‘V®ue
());

278 
	g_d‘as
->
šüem’tSts
Ğ
txn
, 
r
->
ÃtL’gth
(), 1 );

280  
	gloc
;

283 
	gStusW™h
<
	gDiskLoc
> 
	gRecÜdStÜeV1Ba£
::
upd©eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

284 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

285 cÚ¡ * 
d©a
,

286 
d©aSize
,

287 
quÙaMax
,

288 
Upd©eMoveNÙif›r
* 
nÙif›r
 ) {

289 
RecÜd
* 
	gŞdRecÜd
 = 
»cÜdFÜ
Ğ
ŞdLoÿtiÚ
 );

290 iàĞ
	gŞdRecÜd
->
ÃtL’gth
(è>ğ
d©aSize
 ) {

292 
_·ddšgF™s
Ğ
txn
 );

293 
memıy
Ğ
txn
->
»cov”yUn™
()->
wr™šgPŒ
Ğ
ŞdRecÜd
->
d©a
(), 
d©aSize
 ), data, dataSize );

294  
	gStusW™h
<
	gDiskLoc
>Ğ
	gŞdLoÿtiÚ
 );

297 iàĞ
isC­³d
() )

298  
	gStusW™h
<
	gDiskLoc
>Ğ
	gE¼ÜCodes
::
IÁ”ÇlE¼Ü
,

304 
_·ddšgTooSm®l
Ğ
txn
 );

306 
	gStusW™h
<
	gDiskLoc
> 
	gÃwLoÿtiÚ
 = 
_š£¹RecÜd
Ğ
txn
, 
d©a
, 
d©aSize
, 
quÙaMax
 );

307 iàĞ!
	gÃwLoÿtiÚ
.
isOK
() )

308  
	gÃwLoÿtiÚ
;

311 iàĞ
	gnÙif›r
 ) {

312 
Stus
 
	gmoveStus
 = 
nÙif›r
->
»cÜdStÜeGošgToMove
Ğ
txn
,

313 
ŞdLoÿtiÚ
,

314 
ŞdRecÜd
->
d©a
(),

315 
ŞdRecÜd
->
ÃtL’gth
() );

316 iàĞ!
	gmoveStus
.
isOK
() )

317  
	gStusW™h
<
	gDiskLoc
>Ğ
	gmoveStus
 );

320 
d–‘eRecÜd
Ğ
txn
, 
ŞdLoÿtiÚ
 );

322  
	gÃwLoÿtiÚ
;

326 
Stus
 
	gRecÜdStÜeV1Ba£
::
upd©eW™hDamages
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

327 cÚ¡ 
DiskLoc
& 
loc
,

328 cÚ¡ * 
damªgeSourû
,

329 cÚ¡ 
mubËbsÚ
::
DamageVeùÜ
& 
damages
 ) {

330 
_·ddšgF™s
Ğ
txn
 );

332 
RecÜd
* 
	g»c
 = 
»cÜdFÜ
Ğ
loc
 );

333 * 
	groÙ
 = 
»c
->
d©a
();

336 
	gmubËbsÚ
::
DamageVeùÜ
::
cÚ¡_™”©Ü
 
wh”e
 = 
damages
.
begš
();

337 cÚ¡ 
	gmubËbsÚ
::
DamageVeùÜ
::
cÚ¡_™”©Ü
 
’d
 = 
damages
.end();

338  ; 
	gwh”e
 !ğ
’d
; ++where ) {

339 cÚ¡ * 
	gsourûPŒ
 = 
damªgeSourû
 + 
wh”e
->
sourûOff£t
;

340 * 
	grg‘PŒ
 = 
txn
->
»cov”yUn™
()->
wr™šgPŒ
(
roÙ
 + 
wh”e
->
rg‘Off£t
, wh”e->
size
);

341 
	g¡d
::
memıy
(
rg‘PŒ
, 
sourûPŒ
, 
wh”e
->
size
);

344  
	gStus
::
OK
();

347 
	gRecÜdStÜeV1Ba£
::
d–‘eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dl
 ) {

349 
RecÜd
* 
	gtod–‘e
 = 
»cÜdFÜ
Ğ
dl
 );

350 
šv¬ŸÁ
Ğ
tod–‘e
->
ÃtL’gth
() >= 4 );

354 iàĞ
	gtod–‘e
->
´evOfs
(è!ğ
DiskLoc
::
NuÎOfs
 ) {

355 
DiskLoc
 
´ev
 = 
g‘P»vRecÜdInEx‹Á
Ğ
dl
 );

356 
RecÜd
* 
	g´evRecÜd
 = 
»cÜdFÜ
Ğ
´ev
 );

357 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
Ğ
´evRecÜd
->
ÃxtOfs
(èèğ
tod–‘e
->nextOfs();

360 iàĞ
	gtod–‘e
->
ÃxtOfs
(è!ğ
DiskLoc
::
NuÎOfs
 ) {

361 
DiskLoc
 
Ãxt
 = 
g‘NextRecÜd
Ğ
dl
 );

362 
RecÜd
* 
	gÃxtRecÜd
 = 
»cÜdFÜ
Ğ
Ãxt
 );

363 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
Ğ
ÃxtRecÜd
->
´evOfs
(èèğ
tod–‘e
->prevOfs();

369 
Ex‹Á
 *
	ge
 = 
_g‘Ex‹Á
Ğ
tod–‘e
->
myEx‹ÁLoc
(
dl
) );

370 iàĞ
	ge
->
	gfœ¡RecÜd
 =ğ
dl
 ) {

371 
txn
->
»cov”yUn™
()->
wr™šg
(&
e
->
fœ¡RecÜd
);

372 iàĞ
	gtod–‘e
->
ÃxtOfs
(è=ğ
DiskLoc
::
NuÎOfs
 )

373 
e
->
fœ¡RecÜd
.
NuÎ
();

375 
	ge
->
	gfœ¡RecÜd
.
£t
(
dl
.
a
(), 
tod–‘e
->
ÃxtOfs
() );

377 iàĞ
	ge
->
	gÏ¡RecÜd
 =ğ
dl
 ) {

378 
txn
->
»cov”yUn™
()->
wr™šg
(&
e
->
Ï¡RecÜd
);

379 iàĞ
	gtod–‘e
->
´evOfs
(è=ğ
DiskLoc
::
NuÎOfs
 )

380 
e
->
Ï¡RecÜd
.
NuÎ
();

382 
	ge
->
	gÏ¡RecÜd
.
£t
(
dl
.
a
(), 
tod–‘e
->
´evOfs
() );

388 
	g_d‘as
->
šüem’tSts
Ğ
txn
, -1 * 
tod–‘e
->
ÃtL’gth
(), -1 );

390 iàĞ
	g_isSy¡emIndexes
 ) {

396 
mem£t
Ğ
txn
->
»cov”yUn™
()->
wr™šgPŒ
(
tod–‘e
,od–‘e->
ËngthW™hH—d”s
() ),

397 0, 
tod–‘e
->
ËngthW™hH—d”s
() );

402 
mem£t
(
txn
->
»cov”yUn™
()->
wr™šgPŒ
(
tod–‘e
->
d©a
(), 4), 0xee, 4);

403 
addD–‘edRec
(
txn
, 
dl
);

409 
RecÜdI‹¿tÜ
* 
	gRecÜdStÜeV1Ba£
::
g‘I‹¿tÜFÜR•aœ
() const {

410  
Ãw
 
RecÜdStÜeV1R•aœI‹¿tÜ
(
this
);

413 
	gRecÜdStÜeV1Ba£
::
_addRecÜdToRecLi¡InEx‹Á
(
O³¿tiÚCÚ‹xt
* 
txn
,

414 
RecÜd
 *
r
,

415 
DiskLoc
 
loc
) {

416 
das£¹
Ğ
»cÜdFÜ
(
loc
è=ğ
r
 );

417 
Ex‹Á
 *
	ge
 = 
_g‘Ex‹Á
Ğ
_g‘Ex‹ÁLocFÜRecÜd
Ğ
loc
 ) );

418 iàĞ
	ge
->
	gÏ¡RecÜd
.
isNuÎ
() ) {

419 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
e
->
fœ¡RecÜd
èğ
loc
;

420 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
e
->
Ï¡RecÜd
èğ
loc
;

421 
	gr
->
´evOfs
(èğ
r
->
ÃxtOfs
(èğ
DiskLoc
::
NuÎOfs
;

424 
RecÜd
 *
	gŞdÏ¡
 = 
»cÜdFÜ
(
e
->
Ï¡RecÜd
);

425 
	gr
->
´evOfs
(èğ
e
->
Ï¡RecÜd
.
g‘Ofs
();

426 
	gr
->
ÃxtOfs
(èğ
DiskLoc
::
NuÎOfs
;

427 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
(
ŞdÏ¡
->
ÃxtOfs
()èğ
loc
.
g‘Ofs
();

428 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
e
->
Ï¡RecÜd
èğ
loc
;

432 
	gRecÜdStÜeV1Ba£
::
šü—£StÜageSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

433 
size
,

434 
quÙaMax
 ) {

435 
DiskLoc
 
	g–oc
 = 
_ex‹ÁMªag”
->
®loÿ‹Ex‹Á
Ğ
txn
,

436 
isC­³d
(),

437 
size
,

438 
quÙaMax
 );

440 
Ex‹Á
 *
	ge
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
–oc
 );

441 
šv¬ŸÁ
Ğ
e
 );

443 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
e
->
nsDŸgno¡ic
 ) = 
_ns
;

445 
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
e
->
xÃxt
 )->
NuÎ
();

446 
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
e
->
x´ev
 )->
NuÎ
();

447 
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
e
->
fœ¡RecÜd
 )->
NuÎ
();

448 
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
e
->
Ï¡RecÜd
 )->
NuÎ
();

450 
DiskLoc
 
	gem±yLoc
 = 
_fšdFœ¡SpÙ
Ğ
txn
, 
–oc
, 
e
 );

452 iàĞ
	g_d‘as
->
Ï¡Ex‹Á
().
isNuÎ
() ) {

453 
šv¬ŸÁ
Ğ
_d‘as
->
fœ¡Ex‹Á
().
isNuÎ
() );

454 
	g_d‘as
->
£tFœ¡Ex‹Á
Ğ
txn
, 
–oc
 );

455 
	g_d‘as
->
£tLa¡Ex‹Á
Ğ
txn
, 
–oc
 );

456 
	g_d‘as
->
£tC­Ex‹Á
Ğ
txn
, 
–oc
 );

457 
šv¬ŸÁ
Ğ
e
->
x´ev
.
isNuÎ
() );

458 
šv¬ŸÁ
Ğ
e
->
xÃxt
.
isNuÎ
() );

461 
šv¬ŸÁ
Ğ!
_d‘as
->
fœ¡Ex‹Á
().
isNuÎ
() );

462 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
e
->
x´ev
èğ
_d‘as
->
Ï¡Ex‹Á
();

463 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
_ex‹ÁMªag”
->
g‘Ex‹Á
(
_d‘as
->
Ï¡Ex‹Á
())->
xÃxt
èğ
–oc
;

464 
	g_d‘as
->
£tLa¡Ex‹Á
Ğ
txn
, 
–oc
 );

467 
	g_d‘as
->
£tLa¡Ex‹ÁSize
Ğ
txn
, 
e
->
Ëngth
 );

469 
addD–‘edRec
(
txn
, 
em±yLoc
);

472 
Stus
 
	gRecÜdStÜeV1Ba£
::
v®id©e
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

473 
boŞ
 
fuÎ
, boŞ 
sÿnD©a
,

474 
V®id©eAd­tÜ
* 
ad­tÜ
,

475 
V®id©eResuÉs
* 
»suÉs
, 
BSONObjBud”
* 
ouut
 ) const {

486 iàĞ
isC­³d
() ){

487 
	gouut
->
­³ndBoŞ
("ÿµed", 
Œue
);

488 
	gouut
->
­³ndNumb”
("max", 
_d‘as
->
maxC­³dDocs
());

491 
	gouut
->
­³ndNumb”
("d©asize", 
_d‘as
->
d©aSize
());

492 
	gouut
->
­³ndNumb”
("ÄecÜds", 
_d‘as
->
numRecÜds
());

493 
	gouut
->
­³ndNumb”
("Ï¡Ex‹ÁSize", 
_d‘as
->
Ï¡Ex‹ÁSize
());

494 
	gouut
->
­³ndNumb”
("·ddšg", 
_d‘as
->
·ddšgFaùÜ
());

496 iàĞ
	g_d‘as
->
fœ¡Ex‹Á
().
isNuÎ
() )

497 
	gouut
->
­³nd
( "firstExtent", "null" );

499 
	gouut
->
­³nd
( "firstExtent",

500 
¡r
::
¡»am
(è<< 
_d‘as
->
fœ¡Ex‹Á
().
toSŒšg
()

502 << 
_g‘Ex‹Á
Ğ
_d‘as
->
fœ¡Ex‹Á
(è)->
nsDŸgno¡ic
.
toSŒšg
());

503 iàĞ
	g_d‘as
->
Ï¡Ex‹Á
().
isNuÎ
() )

504 
	gouut
->
­³nd
( "lastExtent", "null" );

506 
	gouut
->
­³nd
Ğ"Ï¡Ex‹Á", 
¡r
::
¡»am
(è<< 
_d‘as
->
Ï¡Ex‹Á
().
toSŒšg
()

508 << 
_g‘Ex‹Á
Ğ
_d‘as
->
Ï¡Ex‹Á
(è)->
nsDŸgno¡ic
.
toSŒšg
());

512 
BSONA¼ayBud”
 
	gex‹ÁD©a
;

513 
	gex‹ÁCouÁ
 = 0;

514 
	gŒy
 {

515 iàĞ!
	g_d‘as
->
fœ¡Ex‹Á
().
isNuÎ
() ) {

516 
_g‘Ex‹Á
Ğ
_d‘as
->
fœ¡Ex‹Á
(è)->
as£¹Ok
();

517 
_g‘Ex‹Á
Ğ
_d‘as
->
Ï¡Ex‹Á
(è)->
as£¹Ok
();

520 
DiskLoc
 
	gex‹ÁDiskLoc
 = 
_d‘as
->
fœ¡Ex‹Á
();

521 !
	gex‹ÁDiskLoc
.
isNuÎ
()) {

522 
Ex‹Á
* 
	gthisEx‹Á
 = 
_g‘Ex‹Á
Ğ
ex‹ÁDiskLoc
 );

523 ià(
	gfuÎ
) {

524 
	gex‹ÁD©a
 << 
	gthisEx‹Á
->
dump
();

526 ià(!
	gthisEx‹Á
->
v®id©es
(
ex‹ÁDiskLoc
, &
»suÉs
->
”rÜs
)) {

527 
	g»suÉs
->
	gv®id
 = 
çl£
;

529 
DiskLoc
 
	gÃxtDiskLoc
 = 
thisEx‹Á
->
xÃxt
;

530 ià(
	gex‹ÁCouÁ
 > 0 && !
	gÃxtDiskLoc
.
isNuÎ
()

531 && 
_g‘Ex‹Á
Ğ
ÃxtDiskLoc
 )->
	gx´ev
 !ğ
ex‹ÁDiskLoc
) {

532 
SŒšgBud”
 
sb
;

533 
	gsb
 << "'x´ev'…oš‹¸" << 
_g‘Ex‹Á
Ğ
ÃxtDiskLoc
 )->
	gx´ev
.
toSŒšg
()

534 << " iÀex‹Á " << 
	gÃxtDiskLoc
.
toSŒšg
()

535 << " dÛ nÙ…ošˆtØex‹Á " << 
	gex‹ÁDiskLoc
.
toSŒšg
();

536 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
sb
.
¡r
() );

537 
	g»suÉs
->
	gv®id
 = 
çl£
;

539 ià(
	gÃxtDiskLoc
.
isNuÎ
(è&& 
	gex‹ÁDiskLoc
 !ğ
_d‘as
->
Ï¡Ex‹Á
()) {

540 
SŒšgBud”
 
sb
;

541 
	gsb
 << "'Ï¡Ex‹Á'…oš‹¸" << 
	g_d‘as
->
Ï¡Ex‹Á
().
toSŒšg
()

542 << " dÛ nÙ…ošˆtØÏ¡ƒx‹Á iÀli¡ " << 
	gex‹ÁDiskLoc
.
toSŒšg
();

543 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
sb
.
¡r
() );

544 
	g»suÉs
->
	gv®id
 = 
çl£
;

546 
	gex‹ÁDiskLoc
 = 
ÃxtDiskLoc
;

547 
	gex‹ÁCouÁ
++;

548 
	gtxn
->
checkFÜIÁ”ru±
();

551 
ÿtch
 (cÚ¡ 
DBExû±iÚ
& 
e
) {

552 
SŒšgBud”
 
	gsb
;

553 
	gsb
 << "exû±iÚ v®id©šgƒx‹Á " << 
	gex‹ÁCouÁ


554 << ": " << 
	ge
.
wh©
();

555 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
sb
.
¡r
() );

556 
	g»suÉs
->
	gv®id
 = 
çl£
;

557  
	gStus
::
OK
();

559 
	gouut
->
­³nd
("ex‹ÁCouÁ", 
ex‹ÁCouÁ
);

561 iàĞ
	gfuÎ
 )

562 
	gouut
->
­³ndA¼ay
Ğ"ex‹Ás" , 
ex‹ÁD©a
.
¬r
() );

566 
	gŒy
 {

568 
boŞ
 
	g‹¡šgLa¡Ex‹Á
 = 
çl£
;

569 
	gŒy
 {

570 ià(
	g_d‘as
->
fœ¡Ex‹Á
().
isNuÎ
()) {

574 
	gouut
->
­³nd
("fœ¡Ex‹ÁD‘as", 
_g‘Ex‹Á
(
_d‘as
->
fœ¡Ex‹Á
())->
dump
());

575 ià(!
_g‘Ex‹Á
(
_d‘as
->
fœ¡Ex‹Á
())->
	gx´ev
.
isNuÎ
()) {

576 
SŒšgBud”
 
	gsb
;

577 
	gsb
 << "'x´ev'…oš‹¸š 'fœ¡Ex‹Á' " << 
	g_d‘as
->
fœ¡Ex‹Á
().
toSŒšg
()

578 << " i " << 
_g‘Ex‹Á
(
_d‘as
->
fœ¡Ex‹Á
())->
	gx´ev
.
toSŒšg
()

580 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
sb
.
¡r
() );

581 
	g»suÉs
->
	gv®id
 = 
çl£
;

584 
	g‹¡šgLa¡Ex‹Á
 = 
Œue
;

585 ià(
	g_d‘as
->
Ï¡Ex‹Á
().
isNuÎ
()) {

589 ià(
	g_d‘as
->
fœ¡Ex‹Á
(è!ğ
_d‘as
->
Ï¡Ex‹Á
()) {

590 
ouut
->
­³nd
("Ï¡Ex‹ÁD‘as", 
_g‘Ex‹Á
(
_d‘as
->
Ï¡Ex‹Á
())->
dump
());

591 ià(!
_g‘Ex‹Á
(
_d‘as
->
Ï¡Ex‹Á
())->
	gxÃxt
.
isNuÎ
()) {

592 
SŒšgBud”
 
	gsb
;

593 
	gsb
 << "'xÃxt'…oš‹¸š 'Ï¡Ex‹Á' " << 
	g_d‘as
->
Ï¡Ex‹Á
().
toSŒšg
()

594 << " i " << 
_g‘Ex‹Á
(
_d‘as
->
Ï¡Ex‹Á
())->
	gxÃxt
.
toSŒšg
()

596 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
sb
.
¡r
() );

597 
	g»suÉs
->
	gv®id
 = 
çl£
;

602 
ÿtch
 (cÚ¡ 
DBExû±iÚ
& 
e
) {

603 
SŒšgBud”
 
	gsb
;

604 
	gsb
 << "exception…rocessing '"

605 << (
	g‹¡šgLa¡Ex‹Á
 ? "lastExtent" : "firstExtent")

606 << "': " << 
e
.
wh©
();

607 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
sb
.
¡r
() );

608 
	g»suÉs
->
	gv®id
 = 
çl£
;

613 
	g£t
<
	gDiskLoc
> 
	g»cs
;

614 ifĞ
	gsÿnD©a
 ) {

615 
	gn
 = 0;

616 
	gnInv®id
 = 0;

617 
	gnQuªtizedSize
 = 0;

618 
	gnPow”Of2QuªtizedSize
 = 0;

619 
	gËn
 = 0;

620 
	gÆ’
 = 0;

621 
	gbsÚL’
 = 0;

622 
	goutOfOrd”
 = 0;

623 
DiskLoc
 
	gş_Ï¡
;

625 
	gscİed_±r
<
	gRecÜdI‹¿tÜ
> 
™”©Ü
Ğ
g‘I‹¿tÜ
Ğ
DiskLoc
(),

626 
çl£
,

627 
CŞËùiÚSÿnP¬ams
::
FORWARD
 ) );

628 
DiskLoc
 
	gş
;

629  !Ğ
	gş
 = 
™”©Ü
->
g‘Next
(è).
isNuÎ
() ) {

630 
n
++;

632 iàĞ
	gn
 < 1000000 )

633 
	g»cs
.
š£¹
(
ş
);

634 iàĞ
isC­³d
() ) {

635 iàĞ
	gş
 < 
	gş_Ï¡
 )

636 
	goutOfOrd”
++;

637 
	gş_Ï¡
 = 
ş
;

640 
RecÜd
 *
	gr
 = 
»cÜdFÜ
(
ş
);

641 
	gËn
 +ğ
r
->
ËngthW™hH—d”s
();

642 
	gÆ’
 +ğ
r
->
ÃtL’gth
();

644 iàĞ
	gr
->
ËngthW™hH—d”s
() ==

645 
quªtizeAÎoÿtiÚS·û
Ğ
r
->
ËngthW™hH—d”s
() ) ) {

648 ++
nQuªtizedSize
;

651 iàĞ
	gr
->
ËngthW™hH—d”s
() ==

652 
quªtizePow”Of2AÎoÿtiÚS·û
Ğ
r
->
ËngthW™hH—d”s
() ) ) {

655 ++
nPow”Of2QuªtizedSize
;

658 ià(
	gfuÎ
){

659 
size_t
 
	gd©aSize
 = 0;

660 cÚ¡ 
Stus
 
	g¡©us
 = 
ad­tÜ
->
v®id©e
Ğ
r
, &
d©aSize
 );

661 ià(!
	g¡©us
.
isOK
()) {

662 
	g»suÉs
->
	gv®id
 = 
çl£
;

663 ià(
	gnInv®id
 == 0)

664 
»suÉs
->
”rÜs
.
push_back
( "invalid object detected (see†ogs)" );

666 
	gnInv®id
++;

667 
log
(è<< "Inv®id objeù d‘eùed iÀ" << 
	g_ns


668 << ": " << 
	g¡©us
.
»asÚ
();

671 
	gbsÚL’
 +ğ
d©aSize
;

676 iàĞ
isC­³d
(è&& !
	g_d‘as
->
ÿpLoİed
() ) {

677 
	gouut
->
­³nd
("ÿµedOutOfOrd”", 
outOfOrd”
);

678 iàĞ
	goutOfOrd”
 > 1 ) {

679 
	g»suÉs
->
	gv®id
 = 
çl£
;

680 
	g»suÉs
->
	g”rÜs
.
push_back
( "too many out of order„ecords" );

683 
	gouut
->
­³nd
("objeùsFound", 
n
);

685 ià(
	gfuÎ
) {

686 
	gouut
->
­³nd
("šv®idObjeùs", 
nInv®id
);

689 
	gouut
->
­³ndNumb”
("nQuªtizedSize", 
nQuªtizedSize
);

690 
	gouut
->
­³ndNumb”
("nPow”Of2QuªtizedSize", 
nPow”Of2QuªtizedSize
);

691 
	gouut
->
­³ndNumb”
("by‹sW™hH—d”s", 
Ën
);

692 
	gouut
->
­³ndNumb”
("by‹sW™houtH—d”s", 
Æ’
);

694 ià(
	gfuÎ
) {

695 
	gouut
->
­³ndNumb”
("by‹sBsÚ", 
bsÚL’
);

700 
BSONA¼ayBud”
 
	gd–‘edLi¡A¼ay
;

701  
	gi
 = 0; i < 
	gBuck‘s
; i++ ) {

702 
	gd–‘edLi¡A¼ay
 << 
	g_d‘as
->
d–‘edLi¡EÁry
(
i
).
isNuÎ
();

705 
	gnd–
 = 0;

706 
	gd–Size
 = 0;

707 
BSONA¼ayBud”
 
	gd–Buck‘Sizes
;

708 
	gšcÜ»ù
 = 0;

709  
	gi
 = 0; i < 
	gBuck‘s
; i++ ) {

710 
DiskLoc
 
	gloc
 = 
_d‘as
->
d–‘edLi¡EÁry
(
i
);

711 
	gŒy
 {

712 
	gk
 = 0;

713  !
	gloc
.
isNuÎ
() ) {

714 iàĞ
	g»cs
.
couÁ
(
loc
) )

715 
	gšcÜ»ù
++;

716 
	gnd–
++;

718 iàĞ
	gloc
.
que¡iÚabË
() ) {

719 ifĞ
isC­³d
(è&& !
	gloc
.
isV®id
(è&& 
	gi
 == 1 ) {

726 
¡ršg
 
”r
Ğ
¡r
::
¡»am
() << "bad…ointer in deleted„ecord†ist: "

727 << 
loc
.
toSŒšg
()

728 << " buck‘: " << 
i


729 << " k: " << 
k
 );

730 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
”r
 );

731 
	g»suÉs
->
	gv®id
 = 
çl£
;

735 cÚ¡ 
D–‘edRecÜd
* 
	gd
 = 
d–‘edRecÜdFÜ
(
loc
);

736 
	gd–Size
 +ğ
d
->
ËngthW™hH—d”s
();

737 
	gloc
 = 
d
->
ÃxtD–‘ed
();

738 
	gk
++;

739 
	gtxn
->
checkFÜIÁ”ru±
();

741 
	gd–Buck‘Sizes
 << 
	gk
;

743 
ÿtch
 (...) {

744 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ(
¡ršg
)"exception in deleted chain for bucket " +

745 
BSONObjBud”
::
numSŒ
(
i
) );

746 
	g»suÉs
->
	gv®id
 = 
çl£
;

749 
	gouut
->
­³ndNumb”
("d–‘edCouÁ", 
nd–
);

750 
	gouut
->
­³ndNumb”
("d–‘edSize", 
d–Size
);

751 iàĞ
	gfuÎ
 ) {

752 
	gouut
->
­³nd
Ğ"d–Buck‘Sizes", 
d–Buck‘Sizes
.
¬r
() );

755 iàĞ
	gšcÜ»ù
 ) {

756 
	g»suÉs
->
	g”rÜs
.
push_back
Ğ
BSONObjBud”
::
numSŒ
(
šcÜ»ù
) +

758 
	g»suÉs
->
	gv®id
 = 
çl£
;

762 
ÿtch
 (
As£¹iÚExû±iÚ
) {

763 
	g»suÉs
->
	g”rÜs
.
push_back
( "exception during validate" );

764 
	g»suÉs
->
	gv®id
 = 
çl£
;

767  
	gStus
::
OK
();

770 
	gRecÜdStÜeV1Ba£
::
­³ndCu¡omSts
Ğ
BSONObjBud”
* 
»suÉ
, 
sÿË
 ) const {

771 
	g»suÉ
->
­³nd
Ğ"Ï¡Ex‹ÁSize", 
_d‘as
->
Ï¡Ex‹ÁSize
(è/ 
sÿË
 );

772 
	g»suÉ
->
­³nd
Ğ"·ddšgFaùÜ", 
_d‘as
->
·ddšgFaùÜ
() );

773 
	g»suÉ
->
­³nd
Ğ"u£rFÏgs", 
_d‘as
->
u£rFÏgs
() );

775 iàĞ
isC­³d
() ) {

776 
	g»suÉ
->
­³ndBoŞ
Ğ"ÿµed", 
Œue
 );

777 
	g»suÉ
->
­³ndNumb”
Ğ"max", 
_d‘as
->
maxC­³dDocs
() );

782 
	gÇme¥aû
 {

783 
	stouch_loÿtiÚ
 {

784 cÚ¡ * 
	groÙ
;

785 
size_t
 
	gËngth
;

789 
Stus
 
	gRecÜdStÜeV1Ba£
::
touch
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
BSONObjBud”
* 
ouut
 ) const {

790 
Tim”
 
	gt
;

795 
	g¡d
::
veùÜ
<
touch_loÿtiÚ
> 
¿nges
;

797 
Ex‹Á
* 
	gext
 = 
_g‘Ex‹Á
Ğ
_d‘as
->
fœ¡Ex‹Á
() );

798  
	gext
 ) {

799 
touch_loÿtiÚ
 
	g
;

800 
	g
.
	groÙ
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
ext
);

801 
	g
.
	gËngth
 = 
ext
->
Ëngth
;

802 
	g¿nges
.
push_back
(

);

803 iàĞ
	gext
->
	gxÃxt
.
isNuÎ
() )

804 
	gext
 = 
NULL
;

806 
	gext
 = 
_g‘Ex‹Á
Ğ
ext
->
xÃxt
 );

810 
	g¡d
::
¡ršg
 
´og»ss_msg
 = "touch " + 
¡d
::¡ršg(
txn
->
g‘NS
()) + "ƒxtents";

811 
Prog»ssM‘”HŞd”
 
pm
(*
txn
->
£tMes§ge
(
´og»ss_msg
.
c_¡r
(),

813 
¿nges
.
size
()));

815  
	g¡d
::
veùÜ
<
touch_loÿtiÚ
>::
™”©Ü
 
™
 = 
¿nges
.
begš
(); 
	g™
 !ğ¿nges.
’d
(); ++it ) {

816 
touch_·ges
Ğ
™
->
roÙ
, it->
Ëngth
 );

817 
	gpm
.
h™
();

818 
	gtxn
->
checkFÜIÁ”ru±
();

820 
	gpm
.
fšished
();

822 iàĞ
	gouut
 ) {

823 
	gouut
->
­³nd
Ğ"numRªges", 
¡©ic_ÿ¡
<>Ğ
¿nges
.
size
() ) );

824 
	gouut
->
­³nd
Ğ"mlis", 
t
.
mlis
() );

827  
	gStus
::
OK
();

830 
	gRecÜdStÜeV1Ba£
::
g‘RecÜdAÎoÿtiÚSize
Ğ
mšRecÜdSize
 ) const {

832 iàĞ
isC­³d
() )

833  
mšRecÜdSize
;

835 
šv¬ŸÁ
Ğ
_d‘as
->
·ddšgFaùÜ
() >= 1 );

837 iàĞ
	g_d‘as
->
isU£rFÏgS‘
Ğ
FÏg_U£Pow”Of2Sizes
 ) ) {

839  
quªtizePow”Of2AÎoÿtiÚS·û
(
mšRecÜdSize
);

843  
	g¡©ic_ÿ¡
<>(
mšRecÜdSize
 * 
	g_d‘as
->
·ddšgFaùÜ
());

846 
DiskLoc
 
	gRecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
::
g‘Next
() {

847 ià(
_cu¼
.
isNuÎ
())

848  
DiskLoc
();

850 cÚ¡ 
DiskLoc
 
	gout
 = 
_cu¼
;

851 cÚ¡ 
RecÜd
* 
	g»c
 = 
»cÜdFÜ
(
_cu¼
);

852 cÚ¡ 
	gÃxtOfs
 = 
_fÜw¬d
 ? 
»c
->
ÃxtOfs
(è:„ec->
´evOfs
();

853 
	g_cu¼
 = (
ÃxtOfs
 =ğ
DiskLoc
::
NuÎOfs
 ? DiskLoc(è: DiskLoc(
_cu¼
.
a
(),‚extOfs));

854  
	gout
;

857 
	gRecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
) {

858 ià(
dl
 =ğ
_cu¼
)

859 
g‘Next
();

865 
	gRecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(
®locSize
) {

866 cÚ¡ 
buck‘Idx
 = 
buck‘
(
®locSize
);

867 
	gbuck‘Size
 = 
buck‘Sizes
[
buck‘Idx
];

868 
	gquªtizeUn™
 = 
buck‘Size
 / 16;

869 ià(
	g®locSize
 >= (1 << 22))

873 
quªtizeUn™
 = (1 << 18);

874 ià(
	g®locSize
 % 
	gquªtizeUn™
 == 0)

876  
®locSize
;

877 cÚ¡ 
	gquªtizedS·û
 = (
®locSize
 | (
quªtizeUn™
 - 1)) + 1;

878 
çs£¹
(16484, 
quªtizedS·û
 >ğ
®locSize
);

879  
	gquªtizedS·û
;

882 
	gRecÜdStÜeV1Ba£
::
quªtizePow”Of2AÎoÿtiÚS·û
(
®locSize
) {

883  
i
 = 0; 
	gi
 < 
	gMaxBuck‘
; i++ ) {

884 iàĞ
	gbuck‘Sizes
[
i
] >ğ
®locSize
 ) {

886  
buck‘Sizes
[
i
];

892 cÚ¡ 
	gMB
 = 1024*1024;

893 
šv¬ŸÁ
(
®locSize
 > 4*
MB
);

894  (
	g®locSize
 + (
	gMB
 - 1)) & ~(MB - 1);

897 
	gRecÜdStÜeV1Ba£
::
buck‘
(
size
) {

898  
i
 = 0; 
	gi
 < 
	gBuck‘s
; i++ ) {

899 iàĞ
	gbuck‘Sizes
[
i
] > 
	gsize
 ) {

901  
	gi
;

904  
	gMaxBuck‘
;

907 
	gRecÜdStÜeV1Ba£
::
_·ddšgF™s
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

908 
MONGO_SOMETIMES
(
som‘imes
, 4) {

909 
	gx
 = 
max
(1.0, 
_d‘as
->
·ddšgFaùÜ
() - 0.001 );

910 
	g_d‘as
->
£tPaddšgFaùÜ
Ğ
txn
, 
x
 );

914 
	gRecÜdStÜeV1Ba£
::
_·ddšgTooSm®l
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 ) {

915 
MONGO_SOMETIMES
(
som‘imes
, 4) {

923 
	gN
 = 4;

924 
	gx
 = 
mš
(2.0,
_d‘as
->
·ddšgFaùÜ
(è+ (0.001 * 
N
));

925 
	g_d‘as
->
£tPaddšgFaùÜ
Ğ
txn
, 
x
 );

929 
Stus
 
	gRecÜdStÜeV1Ba£
::
£tCu¡omO±iÚ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

930 cÚ¡ 
BSONEËm’t
& 
İtiÚ
,

931 
BSONObjBud”
* 
šfo
 ) {

932 iàĞ
	g¡r
::
equ®s
Ğ"u£Pow”Of2Sizes", 
İtiÚ
.
f›ldName
() ) ) {

933 
boŞ
 
	gŞdPow”Of2
 = 
_d‘as
->
isU£rFÏgS‘
Ğ
FÏg_U£Pow”Of2Sizes
 );

934 
boŞ
 
	gÃwPow”Of2
 = 
İtiÚ
.
ŒueV®ue
();

936 iàĞ
	gŞdPow”Of2
 !ğ
ÃwPow”Of2
 ) {

938 
šfo
->
­³ndBoŞ
Ğ"u£Pow”Of2Sizes_Şd", 
ŞdPow”Of2
 );

940 iàĞ
	gÃwPow”Of2
 )

941 
	g_d‘as
->
£tU£rFÏg
Ğ
txn
, 
FÏg_U£Pow”Of2Sizes
 );

943 
	g_d‘as
->
ş—rU£rFÏg
Ğ
txn
, 
FÏg_U£Pow”Of2Sizes
 );

945 
	gšfo
->
­³ndBoŞ
Ğ"u£Pow”Of2Sizes_Ãw", 
ÃwPow”Of2
 );

948  
	gStus
::
OK
();

951  
Stus
Ğ
E¼ÜCodes
::
Inv®idO±iÚs
,

952 
¡r
::
¡»am
(è<< "nØsuch o±iÚ: " << 
İtiÚ
.
f›ldName
() );

	@record_store_v1_base.h

31 #´agm¨
Úû


33 
	~"mÚgo/db/diskloc.h
"

34 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

36 
Çme¥aû
 
	gmÚgo
 {

38 
şass
 
	gDocWr™”
;

39 
şass
 
	gEx‹ÁMªag”
;

40 
şass
 
	gRecÜd
;

41 
şass
 
	gO³¿tiÚCÚ‹xt
;

43 
	gEx‹Á
;

45 şas 
	cRecÜdStÜeV1M‘aD©a
 {

46 
	gpublic
:

47 
vœtu®
 ~
RecÜdStÜeV1M‘aD©a
(){}

49 
vœtu®
 cÚ¡ 
DiskLoc
& 
ÿpEx‹Á
() const = 0;

50 
vœtu®
 
£tC­Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) = 0;

52 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
ÿpFœ¡NewRecÜd
() const = 0;

53 
vœtu®
 
£tC­Fœ¡NewRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) = 0;

55 
boŞ
 
ÿpLoİed
(ècÚ¡ {  
ÿpFœ¡NewRecÜd
().
isV®id
(); }

57 
vœtu®
 
d©aSize
() const = 0;

58 
vœtu®
 
numRecÜds
() const = 0;

60 
vœtu®
 
šüem’tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

61 
d©aSizeInüem’t
,

62 
numRecÜdsInüem’t
 ) = 0;

64 
vœtu®
 
£tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

65 
d©aSizeInüem’t
,

66 
numRecÜdsInüem’t
 ) = 0;

68 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
d–‘edLi¡EÁry
Ğ
buck‘
 ) const = 0;

69 
vœtu®
 
£tD–‘edLi¡EÁry
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

70 
buck‘
,

71 cÚ¡ 
DiskLoc
& 
loc
 ) = 0;

72 
vœtu®
 
ÜphªD–‘edLi¡
(
O³¿tiÚCÚ‹xt
* 
txn
) = 0;

74 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
fœ¡Ex‹Á
() const = 0;

75 
vœtu®
 
£tFœ¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) = 0;

77 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
Ï¡Ex‹Á
() const = 0;

78 
vœtu®
 
£tLa¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) = 0;

80 
vœtu®
 
boŞ
 
isC­³d
() const = 0;

82 
vœtu®
 
boŞ
 
isU£rFÏgS‘
Ğ
æag
 ) const = 0;

83 
vœtu®
 
u£rFÏgs
() const = 0;

84 
vœtu®
 
boŞ
 
£tU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 ) = 0;

85 
vœtu®
 
boŞ
 
ş—rU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 ) = 0;

86 
vœtu®
 
boŞ
 
»¶aûU£rFÏgs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æags
 ) = 0;

88 
vœtu®
 
Ï¡Ex‹ÁSize
() const = 0;

89 
vœtu®
 
£tLa¡Ex‹ÁSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
ÃwMax
 ) = 0;

91 
vœtu®
 
maxC­³dDocs
() const = 0;

93 
vœtu®
 
·ddšgFaùÜ
() const = 0;

95 
vœtu®
 
£tPaddšgFaùÜ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
·ddšgFaùÜ
 ) = 0;

99 şas 
	cRecÜdStÜeV1Ba£
 : 
public
 
RecÜdStÜe
 {

100 
public
:

102 cÚ¡ 
Buck‘s
;

103 cÚ¡ 
	gMaxBuck‘
;

105 cÚ¡ 
	gbuck‘Sizes
[];

107 
	eU£rFÏgs
 {

108 
	gFÏg_U£Pow”Of2Sizes
 = 1 << 0

113 
şass
 
	gIÁ¿Ex‹ÁI‹¿tÜ
;

119 
RecÜdStÜeV1Ba£
ĞcÚ¡ 
SŒšgD©a
& 
ns
,

120 
RecÜdStÜeV1M‘aD©a
* 
d‘as
,

121 
Ex‹ÁMªag”
* 
em
,

122 
boŞ
 
isSy¡emIndexes
 );

124 
	gvœtu®
 ~
RecÜdStÜeV1Ba£
();

126 
vœtu®
 
d©aSize
(ècÚ¡ {  
	g_d‘as
->dataSize(); }

127 
vœtu®
 
numRecÜds
(ècÚ¡ {  
	g_d‘as
->numRecords(); }

129 
vœtu®
 
št64_t
 
¡ÜageSize
Ğ
BSONObjBud”
* 
exŒaInfo
 = 
NULL
, 
Ëv–
 = 0 ) const;

131 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

133 
d–‘eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

134 cÚ¡ 
DiskLoc
& 
dl
 );

136 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

137 cÚ¡ * 
d©a
,

138 
Ën
,

139 
quÙaMax
 );

141 
	gStusW™h
<
	gDiskLoc
> 
š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

142 cÚ¡ 
DocWr™”
* 
doc
,

143 
quÙaMax
 );

145 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
upd©eRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

146 cÚ¡ 
DiskLoc
& 
ŞdLoÿtiÚ
,

147 cÚ¡ * 
d©a
,

148 
Ën
,

149 
quÙaMax
,

150 
Upd©eMoveNÙif›r
* 
nÙif›r
 );

152 
vœtu®
 
Stus
 
upd©eW™hDamages
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

153 cÚ¡ 
DiskLoc
& 
loc
,

154 cÚ¡ * 
damªgeSourû
,

155 cÚ¡ 
mubËbsÚ
::
DamageVeùÜ
& 
damages
 );

157 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜFÜR•aœ
() const;

159 
šü—£StÜageSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
size
, 
quÙaMax
 );

161 
vœtu®
 
Stus
 
v®id©e
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

162 
boŞ
 
fuÎ
, boŞ 
sÿnD©a
,

163 
V®id©eAd­tÜ
* 
ad­tÜ
,

164 
V®id©eResuÉs
* 
»suÉs
, 
BSONObjBud”
* 
ouut
 ) const;

166 
vœtu®
 
­³ndCu¡omSts
Ğ
BSONObjBud”
* 
»suÉ
, 
sÿË
 ) const;

168 
vœtu®
 
Stus
 
touch
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
BSONObjBud”
* 
ouut
 ) const;

170 cÚ¡ 
D–‘edRecÜd
* 
d–‘edRecÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

172 cÚ¡ 
RecÜdStÜeV1M‘aD©a
* 
d‘as
(ècÚ¡ {  
	g_d‘as
.
g‘
(); }

179 
g‘RecÜdAÎoÿtiÚSize
Ğ
mšRecÜdSize
 ) const;

181 
DiskLoc
 
g‘Ex‹ÁLocFÜRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const;

183 
DiskLoc
 
g‘NextRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const;

184 
DiskLoc
 
g‘P»vRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const;

186 
DiskLoc
 
g‘NextRecÜdInEx‹Á
ĞcÚ¡ DiskLoc& 
loc
 ) const;

187 
DiskLoc
 
g‘P»vRecÜdInEx‹Á
ĞcÚ¡ DiskLoc& 
loc
 ) const;

193 
quªtizeAÎoÿtiÚS·û
(
®locSize
);

198 
quªtizePow”Of2AÎoÿtiÚS·û
(
®locSize
);

201 
buck‘
(
size
);

203 
vœtu®
 
Stus
 
£tCu¡omO±iÚ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

204 cÚ¡ 
BSONEËm’t
& 
İtiÚ
,

205 
BSONObjBud”
* 
šfo
 = 
NULL
 );

206 
	g´Ùeùed
:

208 
vœtu®
 
boŞ
 
isC­³d
() const = 0;

210 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
®locRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

211 
ËngthW™hH—d”s
,

212 
quÙaMax
 ) = 0;

215 
vœtu®
 
addD–‘edRec
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dloc
) = 0;

218 
vœtu®
 
D–‘edRecÜd
* 
d»c
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

221 
Ex‹Á
* 
_g‘Ex‹Á
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

223 
DiskLoc
 
_g‘Ex‹ÁLocFÜRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const;

225 
DiskLoc
 
_g‘NextRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const;

226 
DiskLoc
 
_g‘P»vRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) const;

228 
DiskLoc
 
_g‘NextRecÜdInEx‹Á
ĞcÚ¡ DiskLoc& 
loc
 ) const;

229 
DiskLoc
 
_g‘P»vRecÜdInEx‹Á
ĞcÚ¡ DiskLoc& 
loc
 ) const;

235 
DiskLoc
 
_fšdFœ¡SpÙ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ DiskLoc& 
extDiskLoc
, 
Ex‹Á
* 
e
 );

240 
_addRecÜdToRecLi¡InEx‹Á
(
O³¿tiÚCÚ‹xt
* 
txn
, 
RecÜd
* 
r
, 
DiskLoc
 
loc
);

242 
_·ddšgTooSm®l
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

243 
_·ddšgF™s
Ğ
O³¿tiÚCÚ‹xt
* 
txn
 );

249 
	gStusW™h
<
	gDiskLoc
> 
_š£¹RecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

250 cÚ¡ * 
d©a
,

251 
Ën
,

252 
quÙaMax
 );

254 
	gscİed_±r
<
	gRecÜdStÜeV1M‘aD©a
> 
	g_d‘as
;

255 
Ex‹ÁMªag”
* 
	g_ex‹ÁMªag”
;

256 
boŞ
 
	g_isSy¡emIndexes
;

258 
ä›nd
 
şass
 
	gRecÜdStÜeV1R•aœI‹¿tÜ
;

266 şas 
	cRecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

267 
public
:

268 
IÁ¿Ex‹ÁI‹¿tÜ
(
DiskLoc
 
¡¬t
, cÚ¡ 
RecÜdStÜe
* 
rs
, 
boŞ
 
fÜw¬d
 = 
Œue
)

269 : 
_cu¼
(
¡¬t
), 
_rs
(
rs
), 
_fÜw¬d
(
fÜw¬d
) {}

271 
vœtu®
 
boŞ
 
isEOF
(è{  
	g_cu¼
.
isNuÎ
(); }

273 
vœtu®
 
DiskLoc
 
cu¼
(è{  
	g_cu¼
; }

275 
vœtu®
 
DiskLoc
 
g‘Next
();

277 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

279 
vœtu®
 
´•¬eToY›ld
() {}

281 
vœtu®
 
boŞ
 
»cov”FromY›ld
(è{  
	gŒue
; }

283 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) cÚ¡ {  
	g_rs
->recordFor(loc); }

285 
	g´iv©e
:

286 
DiskLoc
 
_cu¼
;

287 cÚ¡ 
RecÜdStÜe
* 
	g_rs
;

288 
boŞ
 
	g_fÜw¬d
;

	@record_store_v1_capped.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ÿµed.h
"

33 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

34 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

35 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt_im¶.h
"

36 
	~"mÚgo/db/¡Üage/»cÜd.h
"

37 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ÿµed_™”©Ü.h
"

38 
	~"mÚgo/ut/mm­.h
"

39 
	~"mÚgo/ut/mÚgouts/¡r.h
"

57 
	#DDD
(
x
)

	)

59 
Çme¥aû
 
	gmÚgo
 {

61 
	gC­³dRecÜdStÜeV1
::
C­³dRecÜdStÜeV1
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

62 
C­³dDocum’tD–‘eC®lback
* 
cŞËùiÚ
,

63 cÚ¡ 
SŒšgD©a
& 
ns
,

64 
RecÜdStÜeV1M‘aD©a
* 
d‘as
,

65 
Ex‹ÁMªag”
* 
em
,

66 
boŞ
 
isSy¡emIndexes
 )

67 : 
RecÜdStÜeV1Ba£
Ğ
ns
, 
d‘as
, 
em
, 
isSy¡emIndexes
 ),

68 
_d–‘eC®lback
Ğ
cŞËùiÚ
 ) {

70 
DiskLoc
 
	gex‹ÁLoc
 = 
d‘as
->
fœ¡Ex‹Á
();

71  !
	gex‹ÁLoc
.
isNuÎ
() ) {

72 
	g_ex‹ÁAdviû
.
push_back
Ğ
_ex‹ÁMªag”
->
ÿcheHšt
Ğ
ex‹ÁLoc
,

73 
Ex‹ÁMªag”
::
Sequ’tŸl
 ) );

74 
Ex‹Á
* 
	gex‹Á
 = 
em
->
g‘Ex‹Á
Ğ
ex‹ÁLoc
 );

75 
	gex‹ÁLoc
 = 
ex‹Á
->
xÃxt
;

79 
ÿµedCheckMig¿‹
(
txn
);

82 
	gC­³dRecÜdStÜeV1
::~
C­³dRecÜdStÜeV1
() {

85 
StusW™h
<
DiskLoc
> 
C­³dRecÜdStÜeV1
::
®locRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

86 
ËnToAÎoc
,

87 
quÙaMax
 ) {

90 
	gËnToAÎoc
 = (
ËnToAÎoc
 + 3) & 0xfffffffc;

93 iàĞ
	gËnToAÎoc
 > 
theC­Ex‹Á
()->
	gËngth
 ) {

97 iàĞ
	gËnToAÎoc
 > 
¡ÜageSize
() ) {

98  
	gStusW™h
<
	gDiskLoc
>Ğ
	gE¼ÜCodes
::
BadV®ue
,

99 
	gmÚgouts
::
¡r
::
¡»am
()

101 << 
ËnToAÎoc
 << " > " << 
¡ÜageSize
(),

106 
DiskLoc
 
	gloc
;

110 iàĞ!
ÿµedLa¡D–RecLa¡Ex‹Á
().
isV®id
() )

111 
£tLa¡D–RecLa¡Ex‹Á
Ğ
txn
, 
DiskLoc
() );

113 
šv¬ŸÁ
Ğ
ËnToAÎoc
 < 400000000 );

114 
	g·s£s
 = 0;

115 
	gmaxPas£s
 = ( 
ËnToAÎoc
 / 30 ) + 2;

116 iàĞ
	gmaxPas£s
 < 5000 ) {

118 
	gmaxPas£s
 = 5000;

126 
theC­Ex‹Á
()->
as£¹Ok
();

127 
DiskLoc
 
	gfœ¡Em±yEx‹Á
;

129 iàĞ
	g_d‘as
->
numRecÜds
(è< _d‘as->
maxC­³dDocs
() ) {

130 
	gloc
 = 
__ÿpAÎoc
Ğ
txn
, 
ËnToAÎoc
 );

131 iàĞ!
	gloc
.
isNuÎ
() )

136 iàĞ!
	g_d‘as
->
ÿpFœ¡NewRecÜd
().
isV®id
() ) {

137 
advªûC­Ex‹Á
Ğ
txn
, 
_ns
 );

139 iàĞ
	g_d‘as
->
ÿpEx‹Á
(è!ğ
_d‘as
->
fœ¡Ex‹Á
() )

140 
_d‘as
->
£tC­Fœ¡NewRecÜd
Ğ
txn
, 
DiskLoc
().
£tInv®id
() );

145 iàĞ!
	g_d‘as
->
ÿpFœ¡NewRecÜd
().
isNuÎ
() &&

146 
theC­Ex‹Á
()->
	gfœ¡RecÜd
 =ğ
_d‘as
->
ÿpFœ¡NewRecÜd
() ) {

149 
advªûC­Ex‹Á
Ğ
txn
, 
_ns
 );

153 iàĞ
theC­Ex‹Á
()->
	gfœ¡RecÜd
.
isNuÎ
() ) {

154 iàĞ
	gfœ¡Em±yEx‹Á
.
isNuÎ
() )

155 
	gfœ¡Em±yEx‹Á
 = 
_d‘as
->
ÿpEx‹Á
();

156 
advªûC­Ex‹Á
Ğ
txn
, 
_ns
 );

157 iàĞ
	gfœ¡Em±yEx‹Á
 =ğ
_d‘as
->
ÿpEx‹Á
() ) {

158 
_maybeCom¶aš
Ğ
ËnToAÎoc
 );

159  
	gStusW™h
<
	gDiskLoc
>Ğ
	gE¼ÜCodes
::
IÁ”ÇlE¼Ü
,

165 
DiskLoc
 
	gä
 = 
theC­Ex‹Á
()->
fœ¡RecÜd
;

166 
Stus
 
	g¡©us
 = 
_d–‘eC®lback
->
aboutToD–‘eC­³d
Ğ
txn
, 
ä
 );

167 iàĞ!
	g¡©us
.
isOK
() )

168  
	gStusW™h
<
	gDiskLoc
>Ğ
	g¡©us
 );

169 
d–‘eRecÜd
Ğ
txn
, 
ä
 );

171 
com·ù
(
txn
);

172 ifĞ++
	g·s£s
 > 
	gmaxPas£s
 ) {

173 
SŒšgBud”
 
	gsb
;

174 
	gsb
 << "·s£ >ğmaxPas£ š C­³dRecÜdStÜeV1::ÿµedAÎoc:‚s: " << 
	g_ns


175 << ",†’ToAÎoc: " << 
	gËnToAÎoc


176 << ", maxPas£s: " << 
	gmaxPas£s


177 << ", _maxDocsInC­³d: " << 
	g_d‘as
->
maxC­³dDocs
()

178 << ",‚»cÜds: " << 
	g_d‘as
->
numRecÜds
()

179 << ", d©asize: " << 
	g_d‘as
->
d©aSize
();

181  
	gStusW™h
<
	gDiskLoc
>Ğ
	gE¼ÜCodes
::
IÁ”ÇlE¼Ü
, 
	gsb
.
¡r
() );

186 iàĞ
	g_d‘as
->
ÿpFœ¡NewRecÜd
().
isV®id
(è&& _d‘as->ÿpFœ¡NewRecÜd().
isNuÎ
() )

187 
	g_d‘as
->
£tC­Fœ¡NewRecÜd
Ğ
txn
, 
loc
 );

190 
šv¬ŸÁ
Ğ!
loc
.
isNuÎ
() );

194 
D–‘edRecÜd
 *
	gr
 = 
d»c
Ğ
loc
 );

198 
	g»giÚËn
 = 
r
->
ËngthW™hH—d”s
();

199 
šv¬ŸÁ
Ğ
r
->
ex‹ÁOfs
(è< 
loc
.
g‘Ofs
() );

201 
	gËá
 = 
»giÚËn
 - 
ËnToAÎoc
;

204 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
(
r
->
ËngthW™hH—d”s
()èğ
ËnToAÎoc
;

205 
DiskLoc
 
	gÃwD–Loc
 = 
loc
;

206 
	gÃwD–Loc
.
šc
(
ËnToAÎoc
);

207 
D–‘edRecÜd
* 
	gÃwD–
 = 
d»c
Ğ
ÃwD–Loc
 );

208 
D–‘edRecÜd
* 
	gÃwD–W
 = 
txn
->
»cov”yUn™
()->
wr™šg
(
ÃwD–
);

209 
	gÃwD–W
->
ex‹ÁOfs
(èğ
r
->extentOfs();

210 
	gÃwD–W
->
ËngthW™hH—d”s
(èğ
Ëá
;

211 
	gÃwD–W
->
ÃxtD–‘ed
().
NuÎ
();

213 
addD–‘edRec
(
txn
, 
ÃwD–Loc
);

215  
	gStusW™h
<
	gDiskLoc
>Ğ
	gloc
 );

218 
Stus
 
	gC­³dRecÜdStÜeV1
::
Œunÿ‹
(
O³¿tiÚCÚ‹xt
* 
txn
) {

219 
£tLa¡D–RecLa¡Ex‹Á
Ğ
txn
, 
DiskLoc
() );

220 
£tLi¡OfAÎD–‘edRecÜds
Ğ
txn
, 
DiskLoc
() );

223 
	g_d‘as
->
£tC­Ex‹Á
Ğ
txn
, 
_d‘as
->
fœ¡Ex‹Á
() );

224 
	g_d‘as
->
£tSts
Ğ
txn
, 0, 0 );

229 
	g_d‘as
->
£tPaddšgFaùÜ
Ğ
txn
, 1.0 );

230 
	g_d‘as
->
£tC­Fœ¡NewRecÜd
Ğ
txn
, 
DiskLoc
().
£tInv®id
() );

231 
£tLa¡D–RecLa¡Ex‹Á
Ğ
txn
, 
DiskLoc
().
£tInv®id
() );

236 
Ex‹Á
* 
	gext
;

237  
DiskLoc
 
	gextLoc
 = 
_d‘as
->
fœ¡Ex‹Á
();

238 !
	gextLoc
.
isNuÎ
();

239 
	gextLoc
 = 
ext
->
xÃxt
 ) {

240 
ext
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
(
extLoc
);

242 
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
ext
->
fœ¡RecÜd
 )->
NuÎ
();

243 
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
ext
->
Ï¡RecÜd
 )->
NuÎ
();

245 
addD–‘edRec
Ğ
txn
, 
_fšdFœ¡SpÙ
Ğtxn, 
extLoc
, 
ext
 ) );

248  
	gStus
::
OK
();

251 
	gC­³dRecÜdStÜeV1
::
‹mp_ÿµedTrunÿ‹Aá”
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

252 
DiskLoc
 
’d
,

253 
boŞ
 
šşusive
 ) {

254 
ÿµedTrunÿ‹Aá”
Ğ
txn
, 
_ns
.
c_¡r
(), 
’d
, 
šşusive
 );

262 
	gC­³dRecÜdStÜeV1
::
com·ù
(
O³¿tiÚCÚ‹xt
* 
txn
) {

263 
DDD
( "CappedRecordStoreV1::compactƒnter" );

265 
	gveùÜ
<
	gDiskLoc
> 
	gd»cs
;

268 
DiskLoc
 
	gi
 = 
ÿµedFœ¡D–‘edInCurEx‹Á
();

269 ; !
	gi
.
isNuÎ
(è&& 
šC­Ex‹Á
Ğ
i
 ); i = 
d–‘edRecÜdFÜ
Ğ˜)->
ÃxtD–‘ed
() ) {

270 
DDD
Ğ"\t" << 
i
 );

271 
	gd»cs
.
push_back
Ğ
i
 );

274 
£tFœ¡D–‘edInCurEx‹Á
Ğ
txn
, 
i
 );

276 
	g¡d
::
sÜt
Ğ
d»cs
.
begš
(), d»cs.
’d
() );

277 
DDD
Ğ"\ˆd»cs.size(): " << 
d»cs
.
size
() );

279 
	gveùÜ
<
	gDiskLoc
>::
cÚ¡_™”©Ü
 
j
 = 
d»cs
.
begš
();

280 
šv¬ŸÁ
Ğ
j
 !ğ
d»cs
.
’d
() );

281 
DiskLoc
 
	ga
 = *
j
;

283 
	gj
++;

284 iàĞ
	gj
 =ğ
d»cs
.
’d
() ) {

285 
DDD
( "\t compact‡dddelrec" );

286 
addD–‘edRec
(
txn
, 
a
);

289 
DiskLoc
 
	gb
 = *
j
;

290  
	ga
.
a
(è=ğ
b
.a() &&

291 
a
.
g‘Ofs
(è+ 
d»c
Ğ¨)->
ËngthW™hH—d”s
(è=ğ
b
.getOfs() ) {

294 
txn
->
»cov”yUn™
()->
wr™šgIÁ
Ğ
d»c
(
a
)->
ËngthW™hH—d”s
(èè+ğd»c(
b
)->lengthWithHeaders();

295 
	gj
++;

296 iàĞ
	gj
 =ğ
d»cs
.
’d
() ) {

297 
DDD
( "\t compact‡dddelrec2" );

298 
addD–‘edRec
(
txn
, 
a
);

301 
	gb
 = *
j
;

303 
DDD
( "\t compact‡dddelrec3" );

304 
addD–‘edRec
(
txn
, 
a
);

305 
	ga
 = 
b
;

310 cÚ¡ 
	gDiskLoc
 &
	gC­³dRecÜdStÜeV1
::
ÿµedFœ¡D–‘edInCurEx‹Á
() const {

311 iàĞ
ÿµedLa¡D–RecLa¡Ex‹Á
().
isNuÎ
() )

312  
ÿµedLi¡OfAÎD–‘edRecÜds
();

314  
d»c
(
ÿµedLa¡D–RecLa¡Ex‹Á
())->
ÃxtD–‘ed
();

317 
	gC­³dRecÜdStÜeV1
::
£tFœ¡D–‘edInCurEx‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

318 cÚ¡ 
DiskLoc
& 
loc
 ) {

319 iàĞ
ÿµedLa¡D–RecLa¡Ex‹Á
().
isNuÎ
() )

320 
£tLi¡OfAÎD–‘edRecÜds
Ğ
txn
, 
loc
 );

322 *
	gtxn
->
»cov”yUn™
()->
wr™šg
Ğ&
d»c
(
ÿµedLa¡D–RecLa¡Ex‹Á
())->
ÃxtD–‘ed
(èèğ
loc
;

325 
	gC­³dRecÜdStÜeV1
::
ÿµedCheckMig¿‹
(
O³¿tiÚCÚ‹xt
* 
txn
) {

327 iàĞ
_d‘as
->
ÿpEx‹Á
().
a
(è=ğ0 && _d‘as->ÿpEx‹Á().
g‘Ofs
() == 0 ) {

328 
_d‘as
->
£tC­Fœ¡NewRecÜd
Ğ
txn
, 
DiskLoc
().
£tInv®id
() );

330  
	gi
 = 1; i < 
	gBuck‘s
; ++i ) {

331 
DiskLoc
 
	gfœ¡
 = 
_d‘as
->
d–‘edLi¡EÁry
Ğ
i
 );

332 iàĞ
	gfœ¡
.
isNuÎ
() )

334 
DiskLoc
 
	gÏ¡
 = 
fœ¡
;

335 ; !
d»c
(
Ï¡
)->
ÃxtD–‘ed
().
isNuÎ
(); 
	gÏ¡
 = drec(last)->nextDeleted() );

336 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
d»c
(
Ï¡
)->
ÃxtD–‘ed
()èğ
ÿµedLi¡OfAÎD–‘edRecÜds
();

337 
£tLi¡OfAÎD–‘edRecÜds
Ğ
txn
, 
fœ¡
 );

338 
	g_d‘as
->
£tD–‘edLi¡EÁry
(
txn
, 
i
, 
DiskLoc
());

343 
	g_d‘as
->
£tC­Ex‹Á
Ğ
txn
, 
_d‘as
->
fœ¡Ex‹Á
() );

347 
boŞ
 
	gC­³dRecÜdStÜeV1
::
šC­Ex‹Á
ĞcÚ¡ 
DiskLoc
 &
dl
 ) const {

348 
šv¬ŸÁ
Ğ!
dl
.
isNuÎ
() );

350 iàĞ
	gdl
.
a
(è!ğ
_d‘as
->
ÿpEx‹Á
().a() )

351  
çl£
;

353 iàĞ
	gdl
.
g‘Ofs
(è< 
	g_d‘as
->
ÿpEx‹Á
().getOfs() )

354  
	gçl£
;

356 cÚ¡ 
Ex‹Á
* 
	ge
 = 
theC­Ex‹Á
();

357 
	g’d
 = 
_d‘as
->
ÿpEx‹Á
().
g‘Ofs
(è+ 
e
->
Ëngth
;

358  
	gdl
.
g‘Ofs
(è<ğ
’d
;

361 
boŞ
 
	gC­³dRecÜdStÜeV1
::
ÃxtIsInC­Ex‹Á
ĞcÚ¡ 
DiskLoc
 &
dl
 ) const {

362 
šv¬ŸÁ
Ğ!
dl
.
isNuÎ
() );

363 
DiskLoc
 
	gÃxt
 = 
d»c
(
dl
)->
ÃxtD–‘ed
();

364 iàĞ
	gÃxt
.
isNuÎ
() )

365  
	gçl£
;

366  
šC­Ex‹Á
Ğ
Ãxt
 );

369 
	gC­³dRecÜdStÜeV1
::
advªûC­Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
SŒšgD©a
& 
ns
 ) {

372 iàĞ
	g_d‘as
->
ÿpEx‹Á
(è=ğ
_d‘as
->
Ï¡Ex‹Á
() )

373 
£tLa¡D–RecLa¡Ex‹Á
Ğ
txn
, 
DiskLoc
() );

375 
DiskLoc
 
	gi
 = 
ÿµedFœ¡D–‘edInCurEx‹Á
();

376 ; !
	gi
.
isNuÎ
(è&& 
ÃxtIsInC­Ex‹Á
Ğ
i
 ); i = 
d»c
(i)->
ÃxtD–‘ed
() );

377 
£tLa¡D–RecLa¡Ex‹Á
Ğ
txn
, 
i
 );

380 
	g_d‘as
->
£tC­Ex‹Á
Ğ
txn
,

381 
theC­Ex‹Á
()->
xÃxt
.
isNuÎ
(è? 
_d‘as
->
fœ¡Ex‹Á
()

382 : 
theC­Ex‹Á
()->
xÃxt
 );

387 
theC­Ex‹Á
()->
as£¹Ok
();

388 
	g_d‘as
->
£tC­Fœ¡NewRecÜd
Ğ
txn
, 
DiskLoc
() );

391 
DiskLoc
 
	gC­³dRecÜdStÜeV1
::
__ÿpAÎoc
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
Ën
 ) {

392 
DiskLoc
 
	g´ev
 = 
ÿµedLa¡D–RecLa¡Ex‹Á
();

393 
DiskLoc
 
	gi
 = 
ÿµedFœ¡D–‘edInCurEx‹Á
();

394 
DiskLoc
 
	g»t
;

395 ; !
	gi
.
isNuÎ
(è&& 
šC­Ex‹Á
Ğ
i
 ); 
	g´ev
 = i, i = 
d»c
(i)->
ÃxtD–‘ed
() ) {

398 iàĞ
d»c
(
i
)->
ËngthW™hH—d”s
(è>ğ
Ën
 + 24 ) {

399 
»t
 = 
i
;

405 iàĞ!
	g»t
.
isNuÎ
() ) {

406 iàĞ
	g´ev
.
isNuÎ
() )

407 
£tLi¡OfAÎD–‘edRecÜds
Ğ
txn
, 
d»c
(
»t
)->
ÃxtD–‘ed
() );

409 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
d»c
(
´ev
)->
ÃxtD–‘ed
()èğd»c(
»t
)->nextDeleted();

410 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
d»c
(
»t
)->
ÃxtD–‘ed
()èğ
DiskLoc
().
£tInv®id
();

411 
šv¬ŸÁ
Ğ
d»c
(
»t
)->
ex‹ÁOfs
(è<„‘.
g‘Ofs
() );

414  
	g»t
;

417 
	gC­³dRecÜdStÜeV1
::
ÿµedTrunÿ‹La¡D–Upd©e
(
O³¿tiÚCÚ‹xt
* 
txn
) {

418 iàĞ
_d‘as
->
ÿpEx‹Á
(è=ğ_d‘as->
fœ¡Ex‹Á
() ) {

422 
£tLa¡D–RecLa¡Ex‹Á
Ğ
txn
, 
DiskLoc
() );

429 
DiskLoc
 
	gi
 = 
ÿµedLi¡OfAÎD–‘edRecÜds
();

431 !
d»c
(
i
)->
ÃxtD–‘ed
().
isNuÎ
() &&

432 !
šC­Ex‹Á
Ğ
d»c
(
i
)->
ÃxtD–‘ed
() );

433 
	gi
 = 
d»c
(
i
)->
ÃxtD–‘ed
() );

438 
šv¬ŸÁ
Ğ!
d»c
(
i
)->
ÃxtD–‘ed
().
isNuÎ
() );

439 
£tLa¡D–RecLa¡Ex‹Á
Ğ
txn
, 
i
 );

443 
	gC­³dRecÜdStÜeV1
::
ÿµedTrunÿ‹Aá”
(
O³¿tiÚCÚ‹xt
* 
txn
,

444 cÚ¡ * 
ns
,

445 
DiskLoc
 
’d
,

446 
boŞ
 
šşusive
) {

447 
šv¬ŸÁ
Ğ
ÿµedLa¡D–RecLa¡Ex‹Á
().
isV®id
() );

451 
boŞ
 
	gfoundLa¡
 = 
çl£
;

453 iàĞ
	gfoundLa¡
 ) {

457 
	gtxn
->
»cov”yUn™
()->
comm™IfN“ded
();

459 
DiskLoc
 
	gcu¼
 = 
theC­Ex‹Á
()->
Ï¡RecÜd
;

460 
šv¬ŸÁ
Ğ!
cu¼
.
isNuÎ
() );

461 iàĞ
	gcu¼
 =ğ
’d
 ) {

462 iàĞ
šşusive
 ) {

464 
foundLa¡
 = 
Œue
;

475 
uas£¹
Ğ13415, "em±yšghcŞËùiÚ i nÙ‡Îowed", 
_d‘as
->
numRecÜds
() > 1 );

479 
Stus
 
	g¡©us
 = 
_d–‘eC®lback
->
aboutToD–‘eC­³d
Ğ
txn
, 
cu¼
 );

480 
uas£¹StusOK
Ğ
¡©us
 );

481 
d–‘eRecÜd
Ğ
txn
, 
cu¼
 );

482 
com·ù
(
txn
);

488 iàĞ!
	g_d‘as
->
ÿpLoİed
() ) {

493 iàĞ
theC­Ex‹Á
()->
	gÏ¡RecÜd
.
isNuÎ
() ) {

494 
šv¬ŸÁ
Ğ!
theC­Ex‹Á
()->
x´ev
.
isNuÎ
() );

498 
	g_d‘as
->
£tC­Ex‹Á
Ğ
txn
, 
theC­Ex‹Á
()->
x´ev
 );

499 
theC­Ex‹Á
()->
as£¹Ok
();

502 
ÿµedTrunÿ‹La¡D–Upd©e
(
txn
);

513 iàĞ
	gcu¼
 =ğ
_d‘as
->
ÿpFœ¡NewRecÜd
() ) {

522 
DiskLoc
 
ÃwC­Ex‹Á
 = 
_d‘as
->
ÿpEx‹Á
();

525 
	gÃwC­Ex‹Á
 = ( 
ÃwC­Ex‹Á
 =ğ
_d‘as
->
fœ¡Ex‹Á
() ) ?

526 
_d‘as
->
Ï¡Ex‹Á
() :

527 
_ex‹ÁMªag”
->
g‘Ex‹Á
(
ÃwC­Ex‹Á
)->
x´ev
;

528 
	g_ex‹ÁMªag”
->
g‘Ex‹Á
(
ÃwC­Ex‹Á
)->
as£¹Ok
();

530  
	g_ex‹ÁMªag”
->
g‘Ex‹Á
(
ÃwC­Ex‹Á
)->
	gfœ¡RecÜd
.
isNuÎ
() );

531 
	g_d‘as
->
£tC­Ex‹Á
Ğ
txn
, 
ÃwC­Ex‹Á
 );

536 
	g_d‘as
->
£tC­Fœ¡NewRecÜd
Ğ
txn
, 
theC­Ex‹Á
()->
fœ¡RecÜd
 );

539 
ÿµedTrunÿ‹La¡D–Upd©e
(
txn
);

544 cÚ¡ 
	gDiskLoc
& 
	gC­³dRecÜdStÜeV1
::
ÿµedLi¡OfAÎD–‘edRecÜds
() const {

545  
_d‘as
->
d–‘edLi¡EÁry
(0);

548 
	gC­³dRecÜdStÜeV1
::
£tLi¡OfAÎD–‘edRecÜds
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

549 cÚ¡ 
DiskLoc
& 
loc
 ) {

550  
	g_d‘as
->
£tD–‘edLi¡EÁry
(
txn
, 0, 
loc
);

553 cÚ¡ 
	gDiskLoc
& 
	gC­³dRecÜdStÜeV1
::
ÿµedLa¡D–RecLa¡Ex‹Á
() const {

554  
_d‘as
->
d–‘edLi¡EÁry
(1);

557 
	gC­³dRecÜdStÜeV1
::
£tLa¡D–RecLa¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

558 cÚ¡ 
DiskLoc
& 
loc
 ) {

559  
	g_d‘as
->
£tD–‘edLi¡EÁry
(
txn
, 1, 
loc
);

562 
Ex‹Á
* 
	gC­³dRecÜdStÜeV1
::
theC­Ex‹Á
() const {

563  
_ex‹ÁMªag”
->
g‘Ex‹Á
(
_d‘as
->
ÿpEx‹Á
());

566 
	gC­³dRecÜdStÜeV1
::
addD–‘edRec
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dloc
 ) {

567 
D–‘edRecÜd
* 
	gd
 = 
txn
->
»cov”yUn™
()->
wr™šg
Ğ
d»c
Ğ
dloc
 ) );

569 
DEBUGGING
 
log
(è<< "TEMP:‡dd d–‘ed„eø" << 
	gdloc
.
toSŒšg
(è<< ' ' << 
	ghex
 << 
	gd
->
ex‹ÁOfs
(è<< 
	g’dl
;

570 iàĞ!
ÿµedLa¡D–RecLa¡Ex‹Á
().
isV®id
() ) {

572 
	gd
->
ÃxtD–‘ed
(èğ
DiskLoc
();

573 iàĞ
ÿµedLi¡OfAÎD–‘edRecÜds
().
isNuÎ
() )

574 
£tLi¡OfAÎD–‘edRecÜds
Ğ
txn
, 
dloc
 );

576 
DiskLoc
 
	gi
 = 
ÿµedLi¡OfAÎD–‘edRecÜds
();

577 ; !
d»c
(
i
)->
ÃxtD–‘ed
().
isNuÎ
(); 
	gi
 = drec(i)->nextDeleted() )

579 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
d»c
(
i
)->
ÃxtD–‘ed
()èğ
dloc
;

583 
	gd
->
ÃxtD–‘ed
(èğ
ÿµedFœ¡D–‘edInCurEx‹Á
();

584 
£tFœ¡D–‘edInCurEx‹Á
Ğ
txn
, 
dloc
 );

589 
RecÜdI‹¿tÜ
* 
	gC­³dRecÜdStÜeV1
::
g‘I‹¿tÜ
ĞcÚ¡ 
DiskLoc
& 
¡¬t
, 
boŞ
 
abË
,

590 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const {

591  
Ãw
 
C­³dRecÜdStÜeV1I‹¿tÜ
Ğ
this
, 
¡¬t
, 
abË
, 
dœ
 );

594 
	gveùÜ
<
	gRecÜdI‹¿tÜ
*> 
	gC­³dRecÜdStÜeV1
::
g‘MªyI‹¿tÜs
() const {

595 
OwÃdPoš‹rVeùÜ
<
RecÜdI‹¿tÜ
> 
™”©Üs
;

597 ià(!
	g_d‘as
->
ÿpLoİed
()) {

599 cÚ¡ 
Ex‹Á
* 
	gext
;

600 
DiskLoc
 
	gextLoc
 = 
d‘as
()->
fœ¡Ex‹Á
(); !extLoc.
isNuÎ
();ƒxtLoøğ
ext
->
xÃxt
) {

601 
ext
 = 
_g‘Ex‹Á
(
extLoc
);

602 ià(
	gext
->
	gfœ¡RecÜd
.
isNuÎ
())

605 
	g™”©Üs
.
push_back
(
Ãw
 
RecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
(
ext
->
fœ¡RecÜd
,

606 
this
));

612 cÚ¡ 
DiskLoc
 
	gÿpEx‹Á
 = 
d‘as
()->
ÿpEx‹Á
();

613 
šv¬ŸÁ
(!
ÿpEx‹Á
.
isNuÎ
());

614 
šv¬ŸÁ
(
ÿpEx‹Á
.
isV®id
());

617 
DiskLoc
 
	gextLoc
 = 
ÿpEx‹Á
;

619 cÚ¡ 
Ex‹Á
* 
	gext
 = 
_g‘Ex‹Á
(
extLoc
);

620 ià(
	gext
->
	gfœ¡RecÜd
 !ğ
d‘as
()->
ÿpFœ¡NewRecÜd
()) {

622 
™”©Üs
.
push_back
(
Ãw
 
RecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
(
ext
->
fœ¡RecÜd
,

623 
this
));

626 
	gextLoc
 = 
ext
->
xÃxt
.
isNuÎ
(è? 
d‘as
()->
fœ¡Ex‹Á
() :ƒxt->xnext;

630 
	gextLoc
 !ğ
ÿpEx‹Á
) {

631 cÚ¡ 
Ex‹Á
* 
ext
 = 
_g‘Ex‹Á
(
extLoc
);

632 
	g™”©Üs
.
push_back
(
Ãw
 
RecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
(
ext
->
fœ¡RecÜd
,

633 
this
));

635 
	gextLoc
 = 
ext
->
xÃxt
.
isNuÎ
(è? 
d‘as
()->
fœ¡Ex‹Á
() :ƒxt->xnext;

639 
	g™”©Üs
.
push_back
(

640 
Ãw
 
RecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
(
d‘as
()->
ÿpFœ¡NewRecÜd
(), 
this
));

643  
	g™”©Üs
.
»Ëa£
();

646 
Stus
 
	gC­³dRecÜdStÜeV1
::
com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

647 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

648 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

649 
Com·ùSts
* 
¡©s
 ) {

650 
šv¬ŸÁ
(
çl£
);

653 
	gC­³dRecÜdStÜeV1
::
_maybeCom¶aš
Ğ
Ën
 ) const {

654 
RARELY
 {

655 
¡d
::
¡ršg¡»am
 
buf
;

656 
	gbuf
 << "couldn'ˆmakroom fÜ„ecÜd†’: " << 
	gËn
 << " iÀÿµed‚ " << 
	g_ns
 << '\n';

657 
	gbuf
 << "numRecÜds: " << 
numRecÜds
() << '\n';

658 
	gi
 = 0;

659  
DiskLoc
 
	ge
 = 
_d‘as
->
fœ¡Ex‹Á
();

660 !
	ge
.
isNuÎ
();

661 
	ge
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
e
 )->
xÃxt
, ++
	gi
 ) {

662 
	gbuf
 << " Ex‹Á " << 
	gi
;

663 iàĞ
	ge
 =ğ
_d‘as
->
ÿpEx‹Á
() )

664 
buf
 << " (capExtent)";

665 
	gbuf
 << ' ' << 
	ge
;

666 
	gbuf
 << '\n';

668 
	gbuf
 << " magic: " << 
	ghex
 << 
	g_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
e
 )->
	gmagic
 << 
	gdec


669 << "ƒx‹Á->ns: " << 
	g_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
e
 )->
	gnsDŸgno¡ic
.
toSŒšg
()

671 
	gbuf
 << " fr: " << 
	g_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
e
 )->
	gfœ¡RecÜd
.
toSŒšg
()

672 << "†r: " << 
	g_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
e
 )->
	gÏ¡RecÜd
.
toSŒšg
()

673 << "ƒx‹Á->Ën: " << 
	g_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
e
 )->
	gËngth
 << '\n';

676 
w¬nšg
(è<< 
	gbuf
.
¡r
();

679 
çs£¹
Ğ17438, 
Ën
 * 5 > 
_d‘as
->
Ï¡Ex‹ÁSize
() );

683 
DiskLoc
 
	gC­³dRecÜdStÜeV1
::
fœ¡RecÜd
ĞcÚ¡ DiskLoø&
¡¬tEx‹Á
 ) const {

684 
DiskLoc
 
i
 = 
¡¬tEx‹Á
.
isNuÎ
(è? 
_d‘as
->
fœ¡Ex‹Á
() : startExtent;

685 !
	gi
.
isNuÎ
();

686 
	gi
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
i
 )->
xÃxt
 ) {

688 
Ex‹Á
* 
e
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
i
 );

690 iàĞ!
	ge
->
	gfœ¡RecÜd
.
isNuÎ
() )

691  
	ge
->
	gfœ¡RecÜd
;

693  
DiskLoc
();

696 
DiskLoc
 
	gC­³dRecÜdStÜeV1
::
Ï¡RecÜd
ĞcÚ¡ DiskLoø&
¡¬tEx‹Á
 ) const {

697 
DiskLoc
 
i
 = 
¡¬tEx‹Á
.
isNuÎ
(è? 
_d‘as
->
Ï¡Ex‹Á
() : startExtent;

698 !
	gi
.
isNuÎ
();

699 
	gi
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
i
 )->
x´ev
 ) {

701 
Ex‹Á
* 
e
 = 
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
i
 );

702 iàĞ!
	ge
->
	gÏ¡RecÜd
.
isNuÎ
() )

703  
	ge
->
	gÏ¡RecÜd
;

705  
DiskLoc
();

	@record_store_v1_capped.h

31 #´agm¨
Úû


33 
	~"mÚgo/ba£/owÃd_poš‹r_veùÜ.h
"

34 
	~"mÚgo/db/diskloc.h
"

35 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

36 
	~"mÚgo/db/¡ruùu»/ÿµed_ÿÎback.h
"

37 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ba£.h
"

39 
Çme¥aû
 
	gmÚgo
 {

41 şas 
	cC­³dRecÜdStÜeV1
 : 
public
 
RecÜdStÜeV1Ba£
 {

42 
public
:

43 
C­³dRecÜdStÜeV1
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

44 
C­³dDocum’tD–‘eC®lback
* 
cŞËùiÚ
,

45 cÚ¡ 
SŒšgD©a
& 
ns
,

46 
RecÜdStÜeV1M‘aD©a
* 
d‘as
,

47 
Ex‹ÁMªag”
* 
em
,

48 
boŞ
 
isSy¡emIndexes
 );

50 
	gvœtu®
 ~
C­³dRecÜdStÜeV1
();

52 cÚ¡ * 
Çme
() const {  "CappedRecordStoreV1"; }

54 
vœtu®
 
Stus
 
Œunÿ‹
(
O³¿tiÚCÚ‹xt
* 
txn
);

63 
‹mp_ÿµedTrunÿ‹Aá”
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
DiskLoc
 
’d
, 
boŞ
 
šşusive
 );

65 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜ
ĞcÚ¡ 
DiskLoc
& 
¡¬t
, 
boŞ
 
abË
,

66 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const;

68 
vœtu®
 
	g¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
g‘MªyI‹¿tÜs
() const;

70 
vœtu®
 
boŞ
 
com·ùSuµÜ‹d
(ècÚ¡ {  
	gçl£
; }

72 
vœtu®
 
Stus
 
com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

73 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

74 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

75 
Com·ùSts
* 
¡©s
 );

78 
DiskLoc
 
fœ¡RecÜd
ĞcÚ¡ DiskLoø&
¡¬tEx‹Á
 = DiskLoc() ) const;

80 
DiskLoc
 
Ï¡RecÜd
ĞcÚ¡ DiskLoø&
¡¬tEx‹Á
 = DiskLoc() ) const;

82 
	g´Ùeùed
:

84 
vœtu®
 
boŞ
 
isC­³d
(ècÚ¡ {  
Œue
; }

86 
vœtu®
 
£tC­³dD–‘eC®lback
Ğ
C­³dDocum’tD–‘eC®lback
* 
cb
 ) {

87 
	g_d–‘eC®lback
 = 
cb
;

90 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
®locRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

91 
ËngthW™hH—d”s
,

92 
quÙaMax
 );

94 
vœtu®
 
addD–‘edRec
(
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dloc
);

96 
	g´iv©e
:

98 
com·ù
(
O³¿tiÚCÚ‹xt
* 
txn
);

99 cÚ¡ 
	gDiskLoc
& 
ÿµedFœ¡D–‘edInCurEx‹Á
() const;

100 
£tFœ¡D–‘edInCurEx‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

101 
ÿµedCheckMig¿‹
(
O³¿tiÚCÚ‹xt
* 
txn
);

102 
DiskLoc
 
__ÿpAÎoc
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
Ën
 );

103 
boŞ
 
šC­Ex‹Á
ĞcÚ¡ 
DiskLoc
 &
dl
 ) const;

104 cÚ¡ 
	gDiskLoc
& 
ÿµedLi¡OfAÎD–‘edRecÜds
() const;

105 cÚ¡ 
	gDiskLoc
& 
ÿµedLa¡D–RecLa¡Ex‹Á
() const;

106 
£tLi¡OfAÎD–‘edRecÜds
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

107 
£tLa¡D–RecLa¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

108 
Ex‹Á
 *
theC­Ex‹Á
() const;

109 
boŞ
 
ÃxtIsInC­Ex‹Á
ĞcÚ¡ 
DiskLoc
 &
dl
 ) const;

110 
advªûC­Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
SŒšgD©a
& 
ns
 );

111 
ÿµedTrunÿ‹La¡D–Upd©e
(
O³¿tiÚCÚ‹xt
* 
txn
);

119 
ÿµedTrunÿ‹Aá”
(
O³¿tiÚCÚ‹xt
* 
txn
,

120 cÚ¡ * 
ns
,

121 
DiskLoc
 
’d
,

122 
boŞ
 
šşusive
);

124 
_maybeCom¶aš
Ğ
Ën
 ) const;

128 
C­³dDocum’tD–‘eC®lback
* 
	g_d–‘eC®lback
;

130 
	gOwÃdPoš‹rVeùÜ
<
	gEx‹ÁMªag”
::
CacheHšt
> 
_ex‹ÁAdviû
;

132 
ä›nd
 
şass
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
;

	@record_store_v1_capped_iterator.cpp

29 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ÿµed_™”©Ü.h
"

31 
	~"mÚgo/db/ÿlog/cŞËùiÚ.h
"

32 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

33 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

34 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ÿµed.h
"

36 
Çme¥aû
 
	gmÚgo
 {

42 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
C­³dRecÜdStÜeV1I‹¿tÜ
ĞcÚ¡ 
C­³dRecÜdStÜeV1
* 
cŞËùiÚ
,

43 cÚ¡ 
DiskLoc
& 
¡¬t
, 
boŞ
 
abË
,

44 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
)

45 : 
_»cÜdStÜe
(
cŞËùiÚ
), 
_cu¼
(
¡¬t
), 
_abË
(
abË
),

46 
_dœeùiÚ
(
dœ
), 
_kËdByInv®id©e
(
çl£
) {

48 ià(
	g_cu¼
.
isNuÎ
()) {

50 cÚ¡ 
RecÜdStÜeV1M‘aD©a
* 
	gnsd
 = 
_»cÜdStÜe
->
d‘as
();

54 ià(
	gCŞËùiÚSÿnP¬ams
::
FORWARD
 =ğ
_dœeùiÚ
) {

56 ià(!
nsd
->
ÿpLoİed
()) {

58 
_cu¼
 = 
cŞËùiÚ
->
fœ¡RecÜd
();

64 
	g_cu¼
 = 
_g‘Ex‹Á
Ğ
nsd
->
ÿpEx‹Á
(è)->
fœ¡RecÜd
;

65 ià(!
	g_cu¼
.
isNuÎ
(è&& _cu¼ =ğ
nsd
->
ÿpFœ¡NewRecÜd
()) {

66 
_cu¼
 = 
_g‘Ex‹Á
Ğ
nsd
->
ÿpEx‹Á
(è)->
Ï¡RecÜd
;

67 
	g_cu¼
 = 
ÃxtLoİ
(
_cu¼
);

73 ià(!
	gnsd
->
ÿpLoİed
()) {

75 
	g_cu¼
 = 
cŞËùiÚ
->
Ï¡RecÜd
();

78 
	g_cu¼
 = 
_g‘Ex‹Á
Ğ
nsd
->
ÿpEx‹Á
(è)->
Ï¡RecÜd
;

84 
boŞ
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
isEOF
(è{  
_cu¼
.
isNuÎ
(); }

86 
DiskLoc
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
cu¼
(è{  
_cu¼
; }

88 
DiskLoc
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
g‘Next
() {

89 
DiskLoc
 
»t
 = 
_cu¼
;

92 ià(!
isEOF
()) {

93 
	g_´ev
 = 
_cu¼
;

94 
	g_cu¼
 = 
g‘NextC­³d
(
_cu¼
);

96 ià(
	g_abË
 && !
	g_´ev
.
isNuÎ
()) {

99 
DiskLoc
 
	gÃwCu¼
 = 
g‘NextC­³d
(
_´ev
);

101 ià(!
	gÃwCu¼
.
isNuÎ
()) {

104 
	g_´ev
 = 
»t
 = 
ÃwCu¼
;

105 
	g_cu¼
 = 
g‘NextC­³d
(
_´ev
);

109  
	g»t
;

112 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
) {

113 ià((
_abË
 && 
_cu¼
.
isNuÎ
(è&& 
dl
 =ğ
_´ev
) || (dl == _curr)) {

122 
_cu¼
 = 
_´ev
 = 
DiskLoc
();

123 
	g_kËdByInv®id©e
 = 
Œue
;

127 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
´•¬eToY›ld
() {

130 
boŞ
 
C­³dRecÜdStÜeV1I‹¿tÜ
::
»cov”FromY›ld
() {

132 ià(
_kËdByInv®id©e
) {

133 
_»cÜdStÜe
 = 
NULL
;

134  
	gçl£
;

137  
	gŒue
;

140 
DiskLoc
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
g‘NextC­³d
(cÚ¡ DiskLoc& 
dl
) {

141 
šv¬ŸÁ
(!
dl
.
isNuÎ
());

142 cÚ¡ 
RecÜdStÜeV1M‘aD©a
* 
	gd‘as
 = 
_»cÜdStÜe
->
d‘as
();

144 ià(
	gCŞËùiÚSÿnP¬ams
::
FORWARD
 =ğ
_dœeùiÚ
) {

146 ià(!
_»cÜdStÜe
->
d‘as
()->
ÿpLoİed
()) {

147  
_g‘NextRecÜd
Ğ
dl
 );

152 ià(
	gdl
 =ğ
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
Ï¡RecÜd
) {

153  
DiskLoc
();

156 
DiskLoc
 
	g»t
 = 
ÃxtLoİ
(
dl
);

159 ià(
	g»t
 =ğ
d‘as
->
ÿpFœ¡NewRecÜd
(è&& 
»t
 !ğ
_g‘Ex‹Á
Ğd‘as->
ÿpEx‹Á
(è)->
fœ¡RecÜd
) {

160 
»t
 = 
ÃxtLoİ
(
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
Ï¡RecÜd
);

164 ià(
	g»t
 =ğ
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
fœ¡RecÜd
è{ 
»t
 = d‘as->
ÿpFœ¡NewRecÜd
(); }

166  
	g»t
;

169 ià(!
	gd‘as
->
ÿpLoİed
()è{  
_g‘P»vRecÜd
Ğ
dl
 ); }

173 ià(
	gd‘as
->
ÿpFœ¡NewRecÜd
(è=ğ
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
fœ¡RecÜd
) {

174 ià(
dl
 =ğ
ÃxtLoİ
(
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
Ï¡RecÜd
)) {

175  
DiskLoc
();

179 ià(
	gdl
 =ğ
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
fœ¡RecÜd
è{  
DiskLoc
(); }

182 
DiskLoc
 
	g»t
;

184 ià(
	gdl
 =ğ
d‘as
->
ÿpFœ¡NewRecÜd
()) {

185 
»t
 = 
´evLoİ
(
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
fœ¡RecÜd
);

188 
	g»t
 = 
´evLoİ
(
dl
);

194 ià(
	g»t
 =ğ
_g‘Ex‹Á
Ğ
d‘as
->
ÿpEx‹Á
(è)->
Ï¡RecÜd
) {

195 
»t
 = 
_g‘P»vRecÜd
Ğ
d‘as
->
ÿpFœ¡NewRecÜd
() );

198  
	g»t
;

202 
DiskLoc
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
ÃxtLoİ
(cÚ¡ DiskLoc& 
´ev
) {

204 
DiskLoc
 
Ãxt
 = 
_g‘NextRecÜd
Ğ
´ev
 );

205 ià(!
	gÃxt
.
isNuÎ
()) {

206  
	gÃxt
;

208  
	g_»cÜdStÜe
->
fœ¡RecÜd
();

211 
DiskLoc
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
´evLoİ
(cÚ¡ DiskLoc& 
cu¼
) {

213 
DiskLoc
 
´ev
 = 
_g‘P»vRecÜd
Ğ
cu¼
 );

214 ià(!
	g´ev
.
isNuÎ
()) {

215  
	g´ev
;

217  
	g_»cÜdStÜe
->
Ï¡RecÜd
();

220 cÚ¡ 
RecÜd
* 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

221  
_»cÜdStÜe
->
»cÜdFÜ
Ğ
loc
 );

224 
Ex‹Á
* 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
_g‘Ex‹Á
ĞcÚ¡ 
DiskLoc
& 
loc
 ) {

225  
_»cÜdStÜe
->
_ex‹ÁMªag”
->
g‘Ex‹Á
Ğ
loc
 );

228 
DiskLoc
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
_g‘NextRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) {

229  
_»cÜdStÜe
->
g‘NextRecÜd
Ğ
loc
 );

232 
DiskLoc
 
	gC­³dRecÜdStÜeV1I‹¿tÜ
::
_g‘P»vRecÜd
ĞcÚ¡ DiskLoc& 
loc
 ) {

233  
_»cÜdStÜe
->
g‘P»vRecÜd
Ğ
loc
 );

	@record_store_v1_capped_iterator.h

29 #´agm¨
Úû


31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

33 
Çme¥aû
 
	gmÚgo
 {

35 
şass
 
	gC­³dRecÜdStÜeV1
;

37 
	gEx‹Á
;

48 şas 
	cC­³dRecÜdStÜeV1I‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

49 
public
:

50 
C­³dRecÜdStÜeV1I‹¿tÜ
ĞcÚ¡ 
C­³dRecÜdStÜeV1
* 
cŞËùiÚ
,

51 cÚ¡ 
DiskLoc
& 
¡¬t
,

52 
boŞ
 
abË
,

53 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
 );

54 
	gvœtu®
 ~
C­³dRecÜdStÜeV1I‹¿tÜ
() { }

57 
vœtu®
 
boŞ
 
isEOF
();

58 
vœtu®
 
DiskLoc
 
g‘Next
();

59 
vœtu®
 
DiskLoc
 
cu¼
();

61 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

62 
vœtu®
 
´•¬eToY›ld
();

63 
vœtu®
 
boŞ
 
»cov”FromY›ld
();

65 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

66 
	g´iv©e
:

70 
DiskLoc
 
g‘NextC­³d
(cÚ¡ DiskLoc& 
dl
);

71 
DiskLoc
 
´evLoİ
(cÚ¡ DiskLoc& 
cu¼
);

72 
DiskLoc
 
ÃxtLoİ
(cÚ¡ DiskLoc& 
´ev
);

75 
Ex‹Á
* 
_g‘Ex‹Á
ĞcÚ¡ 
DiskLoc
& 
loc
 );

76 
DiskLoc
 
_g‘NextRecÜd
ĞcÚ¡ DiskLoc& 
loc
 );

77 
DiskLoc
 
_g‘P»vRecÜd
ĞcÚ¡ DiskLoc& 
loc
 );

80 cÚ¡ 
C­³dRecÜdStÜeV1
* 
	g_»cÜdStÜe
;

83 
DiskLoc
 
	g_cu¼
;

86 
DiskLoc
 
	g_´ev
;

87 
boŞ
 
	g_abË
;

89 
	gCŞËùiÚSÿnP¬ams
::
DœeùiÚ
 
_dœeùiÚ
;

93 
boŞ
 
	g_kËdByInv®id©e
;

	@record_store_v1_capped_test.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ÿµed.h
"

33 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt_noİ.h
"

34 
	~"mÚgo/db/¡Üage/»cÜd.h
"

35 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_‹¡_h–p.h
"

36 
	~"mÚgo/un™‹¡/un™‹¡.h
"

38 
usšg
 
Çme¥aû
 
	gmÚgo
;

40 
	gÇme¥aû
 {

44 
	gz”os
[20*1024*1024] = {};

46 şas 
	cDummyC­³dDocum’tD–‘eC®lback
 : 
public
 
C­³dDocum’tD–‘eC®lback
 {

47 
public
:

48 
Stus
 
aboutToD–‘eC­³d
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 ) {

49 
	gd–‘ed
.
push_back
Ğ
loc
 );

50  
	gStus
::
OK
();

52 
	gveùÜ
<
	gDiskLoc
> 
	gd–‘ed
;

55 
	$sim¶eIn£¹Te¡
ĞcÚ¡ * 
buf
, 
size
 ) {

57 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

58 
DummyEx‹ÁMªag”
 
em
;

59 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

60 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

62 
¡ršg
 
myns
 = "test.simple1";

63 
C­³dRecÜdStÜeV1
 
	`rs
Ğ&
txn
, &
cb
, 
myns
, 
md
, &
em
, 
çl£
 );

65 
rs
.
	`šü—£StÜageSize
Ğ&
txn
, 1024, -1 );

67 
	`ASSERT_NOT_OK
Ğ
rs
.
	`š£¹RecÜd
Ğ&
txn
, 
buf
, 3, 1000 ).
	`g‘Stus
() );

69 
rs
.
	`š£¹RecÜd
Ğ&
txn
, 
buf
, 
size
, 10000 );

72 
BSONObjBud”
 
b
;

73 
št64_t
 
¡ÜageSize
 = 
rs
.
	`¡ÜageSize
Ğ&
b
 );

74 
BSONObj
 
obj
 = 
b
.
	`obj
();

75 
	`ASSERT_EQUALS
Ğ1, 
obj
["numEx‹Ás"].
	`numb”IÁ
() );

76 
	`ASSERT_EQUALS
Ğ
¡ÜageSize
, 
em
.
	`quªtizeEx‹ÁSize
( 1024 ) );

79  
i
 = 0; i < 1000; i++ ) {

80 
	`ASSERT_OK
Ğ
rs
.
	`š£¹RecÜd
Ğ&
txn
, 
buf
, 
size
, 10000 ).
	`g‘Stus
() );

83 
¡¬t
 = 
md
->
	`numRecÜds
();

84  
i
 = 0; i < 1000; i++ ) {

85 
	`ASSERT_OK
Ğ
rs
.
	`š£¹RecÜd
Ğ&
txn
, 
buf
, 
size
, 10000 ).
	`g‘Stus
() );

87 
	`ASSERT_EQUALS
Ğ
¡¬t
, 
md
->
	`numRecÜds
() );

88 
	`ASSERT_GREATER_THAN
Ğ
¡¬t
, 100 );

89 
	`ASSERT_LESS_THAN
Ğ
¡¬t
, 1000 );

90 
	}
}

92 
	$TEST
(
C­³dRecÜdStÜeV1
, 
Sim¶eIn£¹Size4
) {

93 
	`sim¶eIn£¹Te¡
("abcd", 4);

94 
	}
}

95 
	$TEST
(
C­³dRecÜdStÜeV1
, 
Sim¶eIn£¹Size8
) {

96 
	`sim¶eIn£¹Te¡
("abcdefgh", 8);

97 
	}
}

99 
	$TEST
(
C­³dRecÜdStÜeV1
, 
Em±ySšgËEx‹Á
) {

100 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

101 
DummyEx‹ÁMªag”
 
em
;

102 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

103 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

104 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

107 
LocAndSize
 
»cÜds
[] = {

110 
LocAndSize
 
d»cs
[] = {

111 {
	`DiskLoc
(0, 1000), 1000},

114 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

115 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
().
	`£tInv®id
());

116 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

119 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

122 
LocAndSize
 
»cs
[] = {

123 {
	`DiskLoc
(0, 1000), 100},

126 
LocAndSize
 
d»cs
[] = {

127 {
	`DiskLoc
(0, 1100), 900},

130 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

131 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(0, 0));

132 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
().
	`£tInv®id
());

134 
	}
}

136 
	$TEST
(
C­³dRecÜdStÜeV1
, 
Fœ¡LoİW™hSšgËEx‹ÁExaùSize
) {

137 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

138 
DummyEx‹ÁMªag”
 
em
;

139 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

140 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

141 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

144 
LocAndSize
 
»cÜds
[] = {

145 {
	`DiskLoc
(0, 1000), 100},

146 {
	`DiskLoc
(0, 1100), 100},

147 {
	`DiskLoc
(0, 1200), 100},

148 {
	`DiskLoc
(0, 1300), 100},

149 {
	`DiskLoc
(0, 1400), 100},

152 
LocAndSize
 
d»cs
[] = {

153 {
	`DiskLoc
(0, 1500), 50},

156 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

157 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
().
	`£tInv®id
());

158 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

161 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

164 
LocAndSize
 
»cs
[] = {

165 {
	`DiskLoc
(0, 1200), 100},

166 {
	`DiskLoc
(0, 1300), 100},

167 {
	`DiskLoc
(0, 1400), 100},

168 {
	`DiskLoc
(0, 1000), 100},

171 
LocAndSize
 
d»cs
[] = {

172 {
	`DiskLoc
(0, 1100), 100},

173 {
	`DiskLoc
(0, 1500), 50},

176 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

177 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(0, 0));

178 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
(0, 1000));

180 
	}
}

182 
	$TEST
(
C­³dRecÜdStÜeV1
, 
NÚFœ¡LoİW™hSšgËEx‹ÁExaùSize
) {

183 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

184 
DummyEx‹ÁMªag”
 
em
;

185 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

186 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

187 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

190 
LocAndSize
 
»cÜds
[] = {

191 {
	`DiskLoc
(0, 1000), 100},

192 {
	`DiskLoc
(0, 1100), 100},

193 {
	`DiskLoc
(0, 1200), 100},

194 {
	`DiskLoc
(0, 1300), 100},

195 {
	`DiskLoc
(0, 1400), 100},

198 
LocAndSize
 
d»cs
[] = {

199 {
	`DiskLoc
(0, 1500), 50},

202 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

203 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
(0, 1000));

204 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

207 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

210 
LocAndSize
 
»cs
[] = {

211 {
	`DiskLoc
(0, 1200), 100},

212 {
	`DiskLoc
(0, 1300), 100},

213 {
	`DiskLoc
(0, 1400), 100},

214 {
	`DiskLoc
(0, 1000), 100},

217 
LocAndSize
 
d»cs
[] = {

218 {
	`DiskLoc
(0, 1100), 100},

219 {
	`DiskLoc
(0, 1500), 50},

222 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

223 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(0, 0));

224 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
(0, 1000));

226 
	}
}

231 
	$TEST
(
C­³dRecÜdStÜeV1
, 
WlLoİW™hout24S·»By‹s
) {

232 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

233 
DummyEx‹ÁMªag”
 
em
;

234 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

235 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

236 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

239 
LocAndSize
 
»cÜds
[] = {

240 {
	`DiskLoc
(0, 1000), 100},

241 {
	`DiskLoc
(0, 1100), 100},

242 {
	`DiskLoc
(0, 1200), 100},

243 {
	`DiskLoc
(0, 1300), 100},

244 {
	`DiskLoc
(0, 1400), 100},

247 
LocAndSize
 
d»cs
[] = {

248 {
	`DiskLoc
(0, 1500), 123},

251 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

252 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
(0, 1000));

253 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

256 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

259 
LocAndSize
 
»cs
[] = {

260 {
	`DiskLoc
(0, 1200), 100},

261 {
	`DiskLoc
(0, 1300), 100},

262 {
	`DiskLoc
(0, 1400), 100},

263 {
	`DiskLoc
(0, 1000), 100},

266 
LocAndSize
 
d»cs
[] = {

267 {
	`DiskLoc
(0, 1100), 100},

268 {
	`DiskLoc
(0, 1500), 123},

271 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

272 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(0, 0));

273 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
(0, 1000));

275 
	}
}

277 
	$TEST
(
C­³dRecÜdStÜeV1
, 
WÚtLoİW™h24S·»By‹s
) {

278 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

279 
DummyEx‹ÁMªag”
 
em
;

280 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

281 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

282 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

285 
LocAndSize
 
»cÜds
[] = {

286 {
	`DiskLoc
(0, 1000), 100},

287 {
	`DiskLoc
(0, 1100), 100},

288 {
	`DiskLoc
(0, 1200), 100},

289 {
	`DiskLoc
(0, 1300), 100},

290 {
	`DiskLoc
(0, 1400), 100},

293 
LocAndSize
 
d»cs
[] = {

294 {
	`DiskLoc
(0, 1500), 124},

297 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

298 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
(0, 1000));

299 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

302 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

305 
LocAndSize
 
»cs
[] = {

306 {
	`DiskLoc
(0, 1000), 100},

307 {
	`DiskLoc
(0, 1100), 100},

308 {
	`DiskLoc
(0, 1200), 100},

309 {
	`DiskLoc
(0, 1300), 100},

310 {
	`DiskLoc
(0, 1400), 100},

311 {
	`DiskLoc
(0, 1500), 100},

314 
LocAndSize
 
d»cs
[] = {

315 {
	`DiskLoc
(0, 1600), 24},

318 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

319 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(0, 0));

320 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
(0, 1000));

322 
	}
}

324 
	$TEST
(
C­³dRecÜdStÜeV1
, 
MoveToSecÚdEx‹ÁUnLoİed
) {

325 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

326 
DummyEx‹ÁMªag”
 
em
;

327 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

328 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

329 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

333 
LocAndSize
 
»cÜds
[] = {

334 {
	`DiskLoc
(0, 1000), 500},

335 {
	`DiskLoc
(0, 1500), 300},

336 {
	`DiskLoc
(0, 1800), 100},

339 
LocAndSize
 
d»cs
[] = {

340 {
	`DiskLoc
(0, 1900), 100},

341 {
	`DiskLoc
(1, 1000), 1000},

344 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

345 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
().
	`£tInv®id
());

346 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

349 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

352 
LocAndSize
 
»cs
[] = {

353 {
	`DiskLoc
(0, 1000), 500},

354 {
	`DiskLoc
(0, 1500), 300},

355 {
	`DiskLoc
(0, 1800), 100},

357 {
	`DiskLoc
(1, 1000), 100},

360 
LocAndSize
 
d»cs
[] = {

361 {
	`DiskLoc
(0, 1900), 100},

362 {
	`DiskLoc
(1, 1100), 900},

365 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

366 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(1, 0));

367 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
().
	`£tInv®id
());

369 
	}
}

371 
	$TEST
(
C­³dRecÜdStÜeV1
, 
MoveToSecÚdEx‹ÁLoİed
) {

372 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

373 
DummyEx‹ÁMªag”
 
em
;

374 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

375 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

376 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

380 
LocAndSize
 
»cÜds
[] = {

381 {
	`DiskLoc
(0, 1800), 100},

382 {
	`DiskLoc
(0, 1000), 500},

383 {
	`DiskLoc
(0, 1500), 400},

385 {
	`DiskLoc
(1, 1000), 300},

386 {
	`DiskLoc
(1, 1300), 600},

389 
LocAndSize
 
d»cs
[] = {

390 {
	`DiskLoc
(0, 1900), 100},

391 {
	`DiskLoc
(1, 1900), 100},

394 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

395 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
(0, 1000));

396 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

399 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 200 - 
RecÜd
::
H—d”Size
, 0);

402 
LocAndSize
 
»cs
[] = {

403 {
	`DiskLoc
(0, 1000), 500},

404 {
	`DiskLoc
(0, 1500), 400},

406 {
	`DiskLoc
(1, 1300), 600},

407 {
	`DiskLoc
(1, 1000), 200},

410 
LocAndSize
 
d»cs
[] = {

411 {
	`DiskLoc
(0, 1800), 200},

412 {
	`DiskLoc
(1, 1200), 100},

413 {
	`DiskLoc
(1, 1900), 100},

416 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

417 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(1, 0));

418 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
(1, 1000));

420 
	}
}

431 
	$TEST
(
C­³dRecÜdStÜeV1SüambËr
, 
Mšim®
) {

432 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

433 
DummyEx‹ÁMªag”
 
em
;

434 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

435 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

436 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

440 
LocAndSize
 
»cÜds
[] = {

443 
LocAndSize
 
d»cs
[] = {

444 {
	`DiskLoc
(0, 1000), 1000},

447 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

448 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
().
	`£tInv®id
());

449 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

452 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 500 - 
RecÜd
::
H—d”Size
, 0);

453 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 300 - 
RecÜd
::
H—d”Size
, 0);

454 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 400 - 
RecÜd
::
H—d”Size
, 0);

455 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 120 - 
RecÜd
::
H—d”Size
, 0);

456 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 60 - 
RecÜd
::
H—d”Size
, 0);

459 
LocAndSize
 
»cs
[] = {

460 {
	`DiskLoc
(0, 1500), 300},

461 {
	`DiskLoc
(0, 1000), 400},

462 {
	`DiskLoc
(0, 1800), 120},

463 {
	`DiskLoc
(0, 1400), 60},

466 
LocAndSize
 
d»cs
[] = {

467 {
	`DiskLoc
(0, 1460), 40},

468 {
	`DiskLoc
(0, 1920), 80},

471 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

472 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(0, 0));

473 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
(0, 1000));

475 
	}
}

481 
	$TEST
(
C­³dRecÜdStÜeV1SüambËr
, 
FourD–‘edRecÜdsInSšgËEx‹Á
) {

482 
O³¿tiÚCÚ‹xtNoİ
 
txn
;

483 
DummyEx‹ÁMªag”
 
em
;

484 
DummyRecÜdStÜeV1M‘aD©a
* 
md
 = 
Ãw
 
	`DummyRecÜdStÜeV1M‘aD©a
Ğ
Œue
, 0 );

485 
DummyC­³dDocum’tD–‘eC®lback
 
cb
;

486 
C­³dRecÜdStÜeV1
 
	`rs
(&
txn
, &
cb
, "‹¡.foo", 
md
, &
em
, 
çl£
);

490 
LocAndSize
 
»cÜds
[] = {

493 
LocAndSize
 
d»cs
[] = {

494 {
	`DiskLoc
(0, 1000), 1000},

497 
md
->
	`£tC­Ex‹Á
(&
txn
, 
	`DiskLoc
(0, 0));

498 
md
->
	`£tC­Fœ¡NewRecÜd
(&
txn
, 
	`DiskLoc
().
	`£tInv®id
());

499 
	`š™ŸlizeV1RS
(&
txn
, 
»cÜds
, 
d»cs
, &
em
, 
md
);

504 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 500 - 
RecÜd
::
H—d”Size
, 0);

505 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 300 - 
RecÜd
::
H—d”Size
, 0);

506 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 304 - 
RecÜd
::
H—d”Size
, 0);

507 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 76 - 
RecÜd
::
H—d”Size
, 0);

508 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

509 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 96 - 
RecÜd
::
H—d”Size
, 0);

510 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 76 - 
RecÜd
::
H—d”Size
, 0);

511 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 200 - 
RecÜd
::
H—d”Size
, 0);

512 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

513 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

514 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 200 - 
RecÜd
::
H—d”Size
, 0);

515 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 56 - 
RecÜd
::
H—d”Size
, 0);

516 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

517 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 96 - 
RecÜd
::
H—d”Size
, 0);

518 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 104 - 
RecÜd
::
H—d”Size
, 0);

519 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 96 - 
RecÜd
::
H—d”Size
, 0);

520 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 60 - 
RecÜd
::
H—d”Size
, 0);

521 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 60 - 
RecÜd
::
H—d”Size
, 0);

522 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 146 - 
RecÜd
::
H—d”Size
, 0);

523 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 146 - 
RecÜd
::
H—d”Size
, 0);

524 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 40 - 
RecÜd
::
H—d”Size
, 0);

525 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 40 - 
RecÜd
::
H—d”Size
, 0);

526 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 36 - 
RecÜd
::
H—d”Size
, 0);

527 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

528 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 96 - 
RecÜd
::
H—d”Size
, 0);

529 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 200 - 
RecÜd
::
H—d”Size
, 0);

530 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 60 - 
RecÜd
::
H—d”Size
, 0);

531 
rs
.
	`š£¹RecÜd
(&
txn
, 
z”os
, 64 - 
RecÜd
::
H—d”Size
, 0);

534 
LocAndSize
 
»cs
[] = {

535 {
	`DiskLoc
(0, 1148), 148},

536 {
	`DiskLoc
(0, 1936), 40},

537 {
	`DiskLoc
(0, 1712), 40},

538 {
	`DiskLoc
(0, 1296), 36},

539 {
	`DiskLoc
(0, 1752), 100},

540 {
	`DiskLoc
(0, 1332), 96},

541 {
	`DiskLoc
(0, 1428), 200},

542 {
	`DiskLoc
(0, 1852), 60},

543 {
	`DiskLoc
(0, 1000), 64},

546 
LocAndSize
 
d»cs
[] = {

547 {
	`DiskLoc
(0, 1064), 84},

548 {
	`DiskLoc
(0, 1976), 24},

549 {
	`DiskLoc
(0, 1912), 24},

550 {
	`DiskLoc
(0, 1628), 84},

553 
	`as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

554 
	`ASSERT_EQUALS
(
md
->
	`ÿpEx‹Á
(), 
	`DiskLoc
(0, 0));

555 
	`ASSERT_EQUALS
(
md
->
	`ÿpFœ¡NewRecÜd
(), 
	`DiskLoc
(0, 1000));

557 
	}
}

	@record_store_v1_repair_iterator.cpp

29 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_»·œ_™”©Ü.h
"

31 
	~"mÚgo/db/ÿlog/cŞËùiÚ.h
"

32 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

33 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

34 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_sim¶e.h
"

36 
Çme¥aû
 
	gmÚgo
 {

38 
	gRecÜdStÜeV1R•aœI‹¿tÜ
::
RecÜdStÜeV1R•aœI‹¿tÜ
(cÚ¡ 
RecÜdStÜeV1Ba£
* 
»cÜdStÜe
)

39 : 
_»cÜdStÜe
(
»cÜdStÜe
), 
_¡age
(
FORWARD_SCAN
) {

43 
g‘Next
();

46 
boŞ
 
	gRecÜdStÜeV1R•aœI‹¿tÜ
::
isEOF
() {

47  
_cu¼RecÜd
.
isNuÎ
();

50 
DiskLoc
 
	gRecÜdStÜeV1R•aœI‹¿tÜ
::
cu¼
(è{  
_cu¼RecÜd
; }

52 
DiskLoc
 
	gRecÜdStÜeV1R•aœI‹¿tÜ
::
g‘Next
() {

53 
DiskLoc
 
»tV®
 = 
_cu¼RecÜd
;

55 cÚ¡ 
Ex‹ÁMªag”
* 
	gem
 = 
_»cÜdStÜe
->
_ex‹ÁMªag”
;

57 
	gŒue
) {

58 ià(
	g_cu¼RecÜd
.
isNuÎ
()) {

60 ià(!
_advªûToNextV®idEx‹Á
()) {

61  
	g»tV®
;

64 
	g_£’InCu¼’tEx‹Á
.
ş—r
();

68 
šv¬ŸÁ
(!
_cu¼Ex‹Á
.
isNuÎ
());

70 cÚ¡ 
Ex‹Á
* 
	ge
 = 
em
->
g‘Ex‹Á
(
_cu¼Ex‹Á
, 
çl£
);

71 
	g_cu¼RecÜd
 = (
FORWARD_SCAN
 =ğ
_¡age
 ? 
e
->
fœ¡RecÜd
 :ƒ->
Ï¡RecÜd
);

74 
	g_¡age
) {

75 
	gFORWARD_SCAN
:

76 
_cu¼RecÜd
 = 
_»cÜdStÜe
->
g‘NextRecÜdInEx‹Á
(_currRecord);

78 
	gBACKWARD_SCAN
:

79 
_cu¼RecÜd
 = 
_»cÜdStÜe
->
g‘P»vRecÜdInEx‹Á
(_currRecord);

82 
šv¬ŸÁ
(!"This should‚ever be„eached.");

87 ià(
	g_cu¼RecÜd
.
isNuÎ
()) {

93 ià(!
	g_£’InCu¼’tEx‹Á
.
š£¹
(
_cu¼RecÜd
).
	g£cÚd
) {

94 
”rÜ
(è<< "šfš™loİ iÀex‹Á, s“n: " << 
	g_cu¼RecÜd
 << " befÜe" << 
	g’dl
;

95 
	g_cu¼RecÜd
 = 
DiskLoc
();

99 ià(
	g_cu¼RecÜd
.
g‘Ofs
() <= 0){

100 
”rÜ
(è<< "off£ˆi 0 fÜ„ecÜd which should bimpossibË" << 
’dl
;

101 
	g_cu¼RecÜd
 = 
DiskLoc
();

105  
	g»tV®
;

109 
boŞ
 
	gRecÜdStÜeV1R•aœI‹¿tÜ
::
_advªûToNextV®idEx‹Á
() {

110 cÚ¡ 
Ex‹ÁMªag”
* 
em
 = 
_»cÜdStÜe
->
_ex‹ÁMªag”
;

112 
	gŒue
) {

113 ià(
	g_cu¼Ex‹Á
.
isNuÎ
()) {

114 
	g_¡age
) {

115 
	gFORWARD_SCAN
:

116 
_cu¼Ex‹Á
 = 
_»cÜdStÜe
->
d‘as
()->
fœ¡Ex‹Á
();

118 
	gBACKWARD_SCAN
:

119 
_cu¼Ex‹Á
 = 
_»cÜdStÜe
->
d‘as
()->
Ï¡Ex‹Á
();

122 
šv¬ŸÁ
(
DONE
 =ğ
_¡age
);

123  
	gçl£
;

130 cÚ¡ 
Ex‹Á
* 
	ge
 = 
em
->
g‘Ex‹Á
(
_cu¼Ex‹Á
, 
çl£
);

131 
	g_cu¼Ex‹Á
 = (
FORWARD_SCAN
 =ğ
_¡age
 ? 
e
->
xÃxt
 :ƒ->
x´ev
);

134 
boŞ
 
	ghasNextEx‹Á
 = !
_cu¼Ex‹Á
.
isNuÎ
();

138 ià(
	ghasNextEx‹Á
 && (!
	g_cu¼Ex‹Á
.
isV®id
(è|| (_cu¼Ex‹Á.
g‘Ofs
() <= 0))) {

139 
”rÜ
(è<< "Inv®idƒx‹Á†oÿtiÚ: " << 
_cu¼Ex‹Á
 << 
’dl
;

143 
	ghasNextEx‹Á
 = 
çl£
;

146 ià(
	ghasNextEx‹Á
) {

152 
	g_¡age
) {

153 
	gFORWARD_SCAN
:

154 
_¡age
 = 
BACKWARD_SCAN
;

156 
	gBACKWARD_SCAN
:

157 
_¡age
 = 
DONE
;

160 
šv¬ŸÁ
(!"This should‚ever be„eached.");

164 
	g_cu¼Ex‹Á
 = 
DiskLoc
();

171 cÚ¡ 
Ex‹Á
* 
	ge
 = 
em
->
g‘Ex‹Á
(
_cu¼Ex‹Á
, 
çl£
);

172 ià(!
	ge
->
isOk
()){

173 
w¬nšg
(è<< "Ex‹Á‚Ù ok magic: " << 
	ge
->
	gmagic
 << " goingoryo continue"

174 << 
	g’dl
;

177 
log
(è<< (
	gFORWARD_SCAN
 =ğ
_¡age
 ? "FORWARD" : "BACKWARD") << " Extent†oc: "

178 << 
_cu¼Ex‹Á
 << ",†’gth: " << 
e
->
Ëngth
 << 
’dl
;

180  
	gŒue
;

183 
	gRecÜdStÜeV1R•aœI‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
) {

184 
v”ify
(!"Invalidate is‚ot supported for RecordStoreV1RepairIterator.");

187 cÚ¡ 
RecÜd
* 
	gRecÜdStÜeV1R•aœI‹¿tÜ
::
»cÜdFÜ
(cÚ¡ 
DiskLoc
& 
loc
) const {

188  
_»cÜdStÜe
->
»cÜdFÜ
Ğ
loc
 );

	@record_store_v1_repair_iterator.h

29 #´agm¨
Úû


31 
	~<£t
>

33 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

34 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ba£.h
"

36 
Çme¥aû
 
	gmÚgo
 {

43 şas 
	cRecÜdStÜeV1R•aœI‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

44 
public
:

45 
RecÜdStÜeV1R•aœI‹¿tÜ
(cÚ¡ 
RecÜdStÜeV1Ba£
* 
»cÜdStÜe
);

46 
	gvœtu®
 ~
RecÜdStÜeV1R•aœI‹¿tÜ
() { }

48 
vœtu®
 
boŞ
 
isEOF
();

49 
vœtu®
 
DiskLoc
 
g‘Next
();

50 
vœtu®
 
DiskLoc
 
cu¼
();

52 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

53 
vœtu®
 
´•¬eToY›ld
() { }

54 
vœtu®
 
boŞ
 
»cov”FromY›ld
() {

55  
	gŒue
;

58 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

60 
	g´iv©e
:

69 
boŞ
 
_advªûToNextV®idEx‹Á
();

74 cÚ¡ 
RecÜdStÜeV1Ba£
* 
	g_»cÜdStÜe
;

76 
DiskLoc
 
	g_cu¼Ex‹Á
;

77 
DiskLoc
 
	g_cu¼RecÜd
;

79 
	eSge
 {

80 
	gFORWARD_SCAN
 = 0,

81 
	gBACKWARD_SCAN
 = 1,

82 
	gDONE
 = 2

85 
Sge
 
	g_¡age
;

89 
	g¡d
::
£t
<
DiskLoc
> 
_£’InCu¼’tEx‹Á
;

	@record_store_v1_simple.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_sim¶e.h
"

33 
	~"mÚgo/ba£/couÁ”.h
"

34 
	~"mÚgo/db/ÿlog/cŞËùiÚ.h
"

35 
	~"mÚgo/db/curİ.h
"

36 
	~"mÚgo/db/commªds/£rv”_¡©us_m‘ric.h
"

37 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

38 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

39 
	~"mÚgo/db/¡Üage/»cÜd.h
"

40 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt.h
"

41 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_sim¶e_™”©Ü.h
"

42 
	~"mÚgo/ut/´og»ss_m‘”.h
"

43 
	~"mÚgo/ut/tim”.h
"

44 
	~"mÚgo/ut/touch_·ges.h
"

46 
Çme¥aû
 
	gmÚgo
 {

48 
CouÁ”64
 
	gä“li¡AÎocs
;

49 
CouÁ”64
 
	gä“li¡Buck‘Exhau¡ed
;

50 
CouÁ”64
 
	gä“li¡I‹¿tiÚs
;

52 
	gS”v”StusM‘ricF›ld
<
	gCouÁ”64
> 
dF»–i¡1
( "storage.freelist.search.requests",

53 &
ä“li¡AÎocs
 );

55 
	gS”v”StusM‘ricF›ld
<
	gCouÁ”64
> 
dF»–i¡2
( "storage.freelist.search.bucketExhausted",

56 &
ä“li¡Buck‘Exhau¡ed
 );

58 
	gS”v”StusM‘ricF›ld
<
	gCouÁ”64
> 
dF»–i¡3
( "storage.freelist.search.scanned",

59 &
ä“li¡I‹¿tiÚs
 );

61 
	gSim¶eRecÜdStÜeV1
::
Sim¶eRecÜdStÜeV1
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

62 cÚ¡ 
SŒšgD©a
& 
ns
,

63 
RecÜdStÜeV1M‘aD©a
* 
d‘as
,

64 
Ex‹ÁMªag”
* 
em
,

65 
boŞ
 
isSy¡emIndexes
 )

66 : 
RecÜdStÜeV1Ba£
Ğ
ns
, 
d‘as
, 
em
, 
isSy¡emIndexes
 ) {

68 
šv¬ŸÁ
Ğ!
d‘as
->
isC­³d
() );

69 
	g_nÜm®CŞËùiÚ
 = 
Name¥aûSŒšg
::
nÜm®
Ğ
ns
 );

70 iàĞ
	g_d‘as
->
·ddšgFaùÜ
() == 0 ) {

71 
w¬nšg
(è<< "im¶ic™ updg¿doà·ddšgFaùÜ oàv”y old cŞËùiÚ" << 
’dl
;

72 
	g_d‘as
->
£tPaddšgFaùÜ
(
txn
, 1.0);

77 
	gSim¶eRecÜdStÜeV1
::~
Sim¶eRecÜdStÜeV1
() {

80 
DiskLoc
 
Sim¶eRecÜdStÜeV1
::
_®locFromExi¡šgEx‹Ás
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

81 
ËnToAÎoc
 ) {

83 
	gËnToAÎoc
 = (
ËnToAÎoc
 + (4-1)) & ~(4-1);

85 
	gä“li¡AÎocs
.
šüem’t
();

86 
DiskLoc
 
	gloc
;

88 
DiskLoc
 *
	g´ev
 = 0;

89 
DiskLoc
 *
	gbe¡´ev
 = 0;

90 
DiskLoc
 
	gbe¡m©ch
;

91 
	gbe¡m©chËn
 = 
INT_MAX
;

92 
	gb
 = 
buck‘
(
ËnToAÎoc
);

93 
DiskLoc
 
	gcur
 = 
_d‘as
->
d–‘edLi¡EÁry
(
b
);

94 
	gexŒa
 = 5;

95 
	gchaš
 = 0;

98 
	gfeNumb”
 = 
cur
.
a
();

99 
	gfeOff£t
 = 
cur
.
g‘Ofs
();

100 ià(
	gfeNumb”
 < -1 || feNumb” >ğ100000 || 
feOff£t
 < 0) {

101 
SŒšgBud”
 
sb
;

102 
	gsb
 << "D–‘ed„ecÜd†i¡ cÜru±ed iÀcŞËùiÚ " << 
	g_ns


103 << ", buck‘ " << 
	gb


104 << ",†šk‚umb” " << 
	gchaš


105 << ", inv®id†šk i " << 
	gcur
.
toSŒšg
()

107 
log
(è<< 
	gsb
.
¡r
(è<< 
	g’dl
;

108 
çs£¹Faed
(16469);

111 iàĞ
	gcur
.
isNuÎ
() ) {

113 iàĞ
	gbe¡m©chËn
 < 
	gINT_MAX
 )

116 iàĞ
	gchaš
 > 0 ) {

118 
	gä“li¡Buck‘Exhau¡ed
.
šüem’t
();

121 
	gb
++;

122 iàĞ
	gb
 > 
	gMaxBuck‘
 ) {

124 
	gä“li¡I‹¿tiÚs
.
šüem’t
Ğ1 + 
chaš
 );

125  
DiskLoc
();

127 
	gcur
 = 
_d‘as
->
d–‘edLi¡EÁry
(
b
);

128 
	g´ev
 = 0;

131 
D–‘edRecÜd
 *
	gr
 = 
d»c
(
cur
);

132 iàĞ
	gr
->
ËngthW™hH—d”s
(è>ğ
ËnToAÎoc
 &&

133 
r
->
ËngthW™hH—d”s
(è< 
be¡m©chËn
 ) {

134 
be¡m©chËn
 = 
r
->
ËngthW™hH—d”s
();

135 
	gbe¡m©ch
 = 
cur
;

136 
	gbe¡´ev
 = 
´ev
;

137 ià(
	gr
->
ËngthW™hH—d”s
(è=ğ
ËnToAÎoc
)

141 iàĞ
	gbe¡m©chËn
 < 
	gINT_MAX
 && --
	gexŒa
 <= 0 )

143 iàĞ++
	gchaš
 > 30 && 
	gb
 <ğ
MaxBuck‘
 ) {

146 
ä“li¡I‹¿tiÚs
.
šüem’t
Ğ
chaš
 );

147 
	gchaš
 = 0;

148 
	gcur
.
NuÎ
();

151 
	gcur
 = 
r
->
ÃxtD–‘ed
();

152 
	g´ev
 = &
r
->
ÃxtD–‘ed
();

157 
D–‘edRecÜd
 *
	gbmr
 = 
d»c
(
be¡m©ch
);

158 iàĞ
	gbe¡´ev
 ) {

159 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(
be¡´ev
èğ
bmr
->
ÃxtD–‘ed
();

163 
	gmyBuck‘
 = 
buck‘
(
bmr
->
ËngthW™hH—d”s
());

164 
šv¬ŸÁ
Ğ
_d‘as
->
d–‘edLi¡EÁry
(
myBuck‘
è=ğ
be¡m©ch
 );

165 
	g_d‘as
->
£tD–‘edLi¡EÁry
(
txn
, 
myBuck‘
, 
bmr
->
ÃxtD–‘ed
());

167 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
bmr
->
ÃxtD–‘ed
()èğ
DiskLoc
().
£tInv®id
();

168 
šv¬ŸÁ
(
bmr
->
ex‹ÁOfs
(è< 
be¡m©ch
.
g‘Ofs
());

170 
	gä“li¡I‹¿tiÚs
.
šüem’t
Ğ1 + 
chaš
 );

171 
	gloc
 = 
be¡m©ch
;

174 iàĞ
	gloc
.
isNuÎ
() )

175  
	gloc
;

179 
D–‘edRecÜd
 *
	gr
 = 
d»c
(
loc
);

183 
	g»giÚËn
 = 
r
->
ËngthW™hH—d”s
();

184 
šv¬ŸÁ
Ğ
r
->
ex‹ÁOfs
(è< 
loc
.
g‘Ofs
() );

186 
	gËá
 = 
»giÚËn
 - 
ËnToAÎoc
;

187 iàĞ
	gËá
 < 24 ||†eá < (
	gËnToAÎoc
 / 8) ) {

189  
	gloc
;

194 iàĞ
	g_nÜm®CŞËùiÚ
 ) {

197 
	gËnToAÎoc
 = 
¡d
::
mš
Ğ
r
->
ËngthW™hH—d”s
(),

198 
quªtizeAÎoÿtiÚS·û
Ğ
ËnToAÎoc
 ) );

199 
	gËá
 = 
»giÚËn
 - 
ËnToAÎoc
;

201 iàĞ
	gËá
 < 24 ) {

203  
	gloc
;

208 
	gtxn
->
»cov”yUn™
()->
wr™šgIÁ
(
r
->
ËngthW™hH—d”s
()èğ
ËnToAÎoc
;

209 
DiskLoc
 
	gÃwD–Loc
 = 
loc
;

210 
	gÃwD–Loc
.
šc
(
ËnToAÎoc
);

211 
D–‘edRecÜd
* 
	gÃwD–
 = 
d»c
(
ÃwD–Loc
);

212 
D–‘edRecÜd
* 
	gÃwD–W
 = 
txn
->
»cov”yUn™
()->
wr™šg
(
ÃwD–
);

213 
	gÃwD–W
->
ex‹ÁOfs
(èğ
r
->extentOfs();

214 
	gÃwD–W
->
ËngthW™hH—d”s
(èğ
Ëá
;

215 
	gÃwD–W
->
ÃxtD–‘ed
().
NuÎ
();

217 
addD–‘edRec
Ğ
txn
, 
ÃwD–Loc
 );

219  
	gloc
;

223 
	gStusW™h
<
	gDiskLoc
> 
	gSim¶eRecÜdStÜeV1
::
®locRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

224 
ËngthW™hH—d”s
,

225 
quÙaMax
 ) {

226 
DiskLoc
 
	gloc
 = 
_®locFromExi¡šgEx‹Ás
Ğ
txn
, 
ËngthW™hH—d”s
 );

227 iàĞ!
	gloc
.
isNuÎ
() )

228  
	gStusW™h
<
	gDiskLoc
>Ğ
	gloc
 );

230 
LOG
(1) << "allocating‚ewƒxtent";

232 
šü—£StÜageSize
Ğ
txn
,

233 
_ex‹ÁMªag”
->
fŞlowupSize
Ğ
ËngthW™hH—d”s
,

234 
_d‘as
->
Ï¡Ex‹ÁSize
()),

235 
quÙaMax
 );

237 
	gloc
 = 
_®locFromExi¡šgEx‹Ás
Ğ
txn
, 
ËngthW™hH—d”s
 );

238 iàĞ!
	gloc
.
isNuÎ
() ) {

240  
	gStusW™h
<
	gDiskLoc
>Ğ
	gloc
 );

243 
log
() << "warning:‡lloc() failed‡fter‡llocating‚ewƒxtent. "

244 << "ËngthW™hH—d”s: " << 
	gËngthW™hH—d”s
 << "†astƒxtent size:"

245 << 
	g_d‘as
->
Ï¡Ex‹ÁSize
() << ";rying‡gain";

247  
	gz
 = 0; z < 10 && 
	gËngthW™hH—d”s
 > 
	g_d‘as
->
Ï¡Ex‹ÁSize
(); z++ ) {

248 
log
(è<< "Œy #" << 
	gz
 << 
	g’dl
;

250 
šü—£StÜageSize
Ğ
txn
,

251 
_ex‹ÁMªag”
->
fŞlowupSize
Ğ
ËngthW™hH—d”s
,

252 
_d‘as
->
Ï¡Ex‹ÁSize
()),

253 
quÙaMax
 );

255 
	gloc
 = 
_®locFromExi¡šgEx‹Ás
Ğ
txn
, 
ËngthW™hH—d”s
 );

256 iàĞ! 
	gloc
.
isNuÎ
() )

257  
	gStusW™h
<
	gDiskLoc
>Ğ
	gloc
 );

260  
	gStusW™h
<
	gDiskLoc
>Ğ
	gE¼ÜCodes
::
IÁ”ÇlE¼Ü
, "cannot‡llocate space" );

263 
Stus
 
	gSim¶eRecÜdStÜeV1
::
Œunÿ‹
(
O³¿tiÚCÚ‹xt
* 
txn
) {

264  
Stus
Ğ
E¼ÜCodes
::
IÁ”ÇlE¼Ü
,

268 
	gSim¶eRecÜdStÜeV1
::
addD–‘edRec
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
dloc
 ) {

269 
D–‘edRecÜd
* 
	gd
 = 
d»c
Ğ
dloc
 );

271 
DEBUGGING
 
log
(è<< "TEMP:‡dd d–‘ed„eø" << 
	gdloc
.
toSŒšg
(è<< ' ' << 
	ghex
 << 
	gd
->
ex‹ÁOfs
(è<< 
	g’dl
;

273 
	gb
 = 
buck‘
(
d
->
ËngthW™hH—d”s
());

274 *
	gtxn
->
»cov”yUn™
()->
wr™šg
(&
d
->
ÃxtD–‘ed
()èğ
_d‘as
->
d–‘edLi¡EÁry
(
b
);

275 
	g_d‘as
->
£tD–‘edLi¡EÁry
(
txn
, 
b
, 
dloc
);

278 
RecÜdI‹¿tÜ
* 
	gSim¶eRecÜdStÜeV1
::
g‘I‹¿tÜ
ĞcÚ¡ 
DiskLoc
& 
¡¬t
, 
boŞ
 
abË
,

279 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const {

280  
Ãw
 
Sim¶eRecÜdStÜeV1I‹¿tÜ
Ğ
this
, 
¡¬t
, 
dœ
 );

283 
	gveùÜ
<
	gRecÜdI‹¿tÜ
*> 
	gSim¶eRecÜdStÜeV1
::
g‘MªyI‹¿tÜs
() const {

284 
OwÃdPoš‹rVeùÜ
<
RecÜdI‹¿tÜ
> 
™”©Üs
;

285 cÚ¡ 
Ex‹Á
* 
	gext
;

286 
DiskLoc
 
	gextLoc
 = 
d‘as
()->
fœ¡Ex‹Á
(); !extLoc.
isNuÎ
();ƒxtLoøğ
ext
->
xÃxt
) {

287 
ext
 = 
_g‘Ex‹Á
(
extLoc
);

288 ià(
	gext
->
	gfœ¡RecÜd
.
isNuÎ
())

291 
	g™”©Üs
.
push_back
(
Ãw
 
RecÜdStÜeV1Ba£
::
IÁ¿Ex‹ÁI‹¿tÜ
(
ext
->
fœ¡RecÜd
, 
this
));

294  
	g™”©Üs
.
»Ëa£
();

297 şas 
	cCom·ùDocWr™”
 : 
public
 
DocWr™”
 {

298 
public
:

302 
Com·ùDocWr™”
ĞcÚ¡ 
RecÜd
* 
»c
, 
d©aSize
, 
size_t
 
®loÿtiÚSize
 )

303 : 
_»c
Ğ
»c
 ),

304 
_d©aSize
Ğ
d©aSize
 ),

305 
_®loÿtiÚSize
Ğ
®loÿtiÚSize
 ) {

308 
	gvœtu®
 ~
Com·ùDocWr™”
() {}

310 
vœtu®
 
wr™eDocum’t
Ğ* 
buf
 ) const {

311 
memıy
Ğ
buf
, 
_»c
->
d©a
(), 
_d©aSize
 );

314 
vœtu®
 
size_t
 
docum’tSize
() const {

315  
	g_®loÿtiÚSize
 - 
	gRecÜd
::
H—d”Size
;

318 
vœtu®
 
boŞ
 
addPaddšg
() const {

319  
	gçl£
;

322 
	g´iv©e
:

323 cÚ¡ 
RecÜd
* 
_»c
;

324 
size_t
 
	g_d©aSize
;

325 
size_t
 
	g_®loÿtiÚSize
;

328 
	gSim¶eRecÜdStÜeV1
::
	$_com·ùEx‹Á
(
O³¿tiÚCÚ‹xt
* 
txn
,

329 cÚ¡ 
DiskLoc
 
diskloc
,

330 
ex‹ÁNumb”
,

331 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

332 cÚ¡ 
Com·ùO±iÚs
* 
com·ùO±iÚs
,

333 
Com·ùSts
* 
¡©s
 ) {

335 
	`log
(è<< "com·ù begšƒx‹Á #" << 
ex‹ÁNumb”


336 << " fÜ‚ame¥aû " << 
_ns
 << " " << 
diskloc
;

338 
ŞdObjSize
 = 0;

339 
ŞdObjSizeW™hPaddšg
 = 0;

341 
Ex‹Á
 *
e
 = 
_ex‹ÁMªag”
->
	`g‘Ex‹Á
Ğ
diskloc
 );

342 
e
->
	`as£¹Ok
();

343 
	`çs£¹
Ğ17437, 
e
->
	`v®id©es
(
diskloc
) );

348 
	`log
(è<< "com·ù…agšg iÀËn=" << 
e
->
Ëngth
/1000000.0 << "MB" << 
’dl
;

349 
Tim”
 
t
;

350 
size_t
 
Ëngth
 = 
e
->length;

352 
	`touch_·ges
Ğ
»š‹½»t_ÿ¡
<cÚ¡ *>(
e
), 
Ëngth
 );

353 
ms
 = 
t
.
	`mlis
();

354 ifĞ
ms
 > 1000 )

355 
	`log
(è<< "com·ùƒnd…agšg iÀ" << 
ms
 << "ms "

356 << 
e
->
Ëngth
/1000000.0/
t
.
	`£cÚds
(è<< "MB/£c" << 
’dl
;

360 
	`log
(è<< "com·ù cİyšg„ecÜds" << 
’dl
;

361 
d©asize
 = 0;

362 
ÄecÜds
 = 0;

363 
DiskLoc
 
L
 = 
e
->
fœ¡RecÜd
;

364 ifĞ!
L
.
	`isNuÎ
() ) {

366 
RecÜd
 *
»cOld
 = 
	`»cÜdFÜ
(
L
);

367 
L
 = 
	`g‘NextRecÜdInEx‹Á
(L);

369 iàĞ
com·ùO±iÚs
->
v®id©eDocum’ts
 && !
ad­tÜ
->
	`isD©aV®id
(
»cOld
) ) {

371 
	`log
() << "compact skipping corrupt document!";

372 
¡©s
->
cÜru±Docum’ts
++;

375 
d©aSize
 = 
ad­tÜ
->
	`d©aSize
Ğ
»cOld
 );

376 
docSize
 = 
d©aSize
;

378 
ÄecÜds
++;

379 
ŞdObjSize
 +ğ
docSize
;

380 
ŞdObjSizeW™hPaddšg
 +ğ
»cOld
->
	`ÃtL’gth
();

382 
ËnWHdr
 = 
docSize
 + 
RecÜd
::
H—d”Size
;

383 
ËnWPaddšg
 = 
ËnWHdr
;

385  
com·ùO±iÚs
->
·ddšgMode
 ) {

386 
Com·ùO±iÚs
::
NONE
:

387 iàĞ
_d‘as
->
	`isU£rFÏgS‘
(
FÏg_U£Pow”Of2Sizes
) )

388 
ËnWPaddšg
 = 
	`quªtizePow”Of2AÎoÿtiÚS·û
(lenWPadding);

390 
Com·ùO±iÚs
::
PRESERVE
:

392 
ËnWPaddšg
 = 
»cOld
->
	`ËngthW™hH—d”s
();

394 
Com·ùO±iÚs
::
MANUAL
:

395 
ËnWPaddšg
 = 
com·ùO±iÚs
->
	`compu‹RecÜdSize
(lenWPadding);

396 ià(
ËnWPaddšg
 < 
ËnWHdr
 ||†’WPaddšg > 
BSONObjMaxU£rSize
 / 2 ) {

397 
ËnWPaddšg
 = 
ËnWHdr
;

402 
Com·ùDocWr™”
 
	`wr™”
Ğ
»cOld
, 
d©aSize
, 
ËnWPaddšg
 );

403 
StusW™h
<
DiskLoc
> 
¡©us
 = 
	`š£¹RecÜd
Ğ
txn
, &
wr™”
, 0 );

404 
	`uas£¹StusOK
Ğ
¡©us
.
	`g‘Stus
() );

405 
d©asize
 +ğ
	`»cÜdFÜ
Ğ
¡©us
.
	`g‘V®ue
(è)->
	`ÃtL’gth
();

407 
ad­tÜ
->
	`š£¹ed
Ğ
	`»cÜdFÜ
Ğ
¡©us
.
	`g‘V®ue
() ), status.getValue() );

410 ifĞ
L
.
	`isNuÎ
() ) {

417 
boŞ
 
¡İpšg
 = 
çl£
;

418 
RARELY
 
¡İpšg
 = !
txn
->
	`checkFÜIÁ”ru±NoAs£¹
().
	`isOK
();

419 ifĞ
¡İpšg
 || 
txn
->
	`»cov”yUn™
()->
	`isComm™N“ded
() ) {

420 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
(&
e
->
fœ¡RecÜd
èğ
L
;

421 
RecÜd
 *
r
 = 
	`»cÜdFÜ
(
L
);

422 
txn
->
	`»cov”yUn™
()->
	`wr™šgIÁ
(
r
->
	`´evOfs
()èğ
DiskLoc
::
NuÎOfs
;

423 
txn
->
	`»cov”yUn™
()->
	`comm™IfN“ded
();

424 
txn
->
	`checkFÜIÁ”ru±
();

429 
	`šv¬ŸÁ
Ğ
_d‘as
->
	`fœ¡Ex‹Á
(è=ğ
diskloc
 );

430 
	`šv¬ŸÁ
Ğ
_d‘as
->
	`Ï¡Ex‹Á
(è!ğ
diskloc
 );

431 
DiskLoc
 
ÃwFœ¡
 = 
e
->
xÃxt
;

432 
_d‘as
->
	`£tFœ¡Ex‹Á
Ğ
txn
, 
ÃwFœ¡
 );

433 *
txn
->
	`»cov”yUn™
()->
	`wr™šg
(&
_ex‹ÁMªag”
->
	`g‘Ex‹Á
Ğ
ÃwFœ¡
 )->
x´ev
èğ
	`DiskLoc
();

434 
_ex‹ÁMªag”
->
	`ä“Ex‹Á
Ğ
txn
, 
diskloc
 );

436 
txn
->
	`»cov”yUn™
()->
	`comm™IfN“ded
();

439 
İ
 = 1.0;

440 ifĞ
ŞdObjSize
 )

441 
İ
 = 
¡©ic_ÿ¡
<>(
ŞdObjSizeW™hPaddšg
)/
ŞdObjSize
;

442 
	`log
(è<< "com·ù fšishedƒx‹Á #" << 
ex‹ÁNumb”
 << " cÚššg " << 
ÄecÜds


443 << " docum’t (" << 
d©asize
/1000000.0 << "MB)"

444 << " oldPaddšg: " << 
İ
 << ' ' << 
¡©ic_ÿ¡
<>(op*100.0)/100;

448 
	}
}

450 
Stus
 
	gSim¶eRecÜdStÜeV1
::
	$com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

451 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

452 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

453 
Com·ùSts
* 
¡©s
 ) {

456 
txn
->
	`»cov”yUn™
()->
	`comm™IfN“ded
();

458 
li¡
<
DiskLoc
> 
ex‹Ás
;

459  
DiskLoc
 
extLoÿtiÚ
 = 
_d‘as
->
	`fœ¡Ex‹Á
();

460 !
extLoÿtiÚ
.
	`isNuÎ
();

461 
extLoÿtiÚ
 = 
_ex‹ÁMªag”
->
	`g‘Ex‹Á
ĞextLoÿtiÚ )->
xÃxt
 ) {

462 
ex‹Ás
.
	`push_back
Ğ
extLoÿtiÚ
 );

464 
	`log
(è<< "com·ù " << 
ex‹Ás
.
	`size
() << "ƒxtents";

466 
	`log
(è<< "com·ù o½hª d–‘ed†i¡s" << 
’dl
;

467 
_d‘as
->
	`ÜphªD–‘edLi¡
(
txn
);

470 
_d‘as
->
	`£tLa¡Ex‹ÁSize
Ğ
txn
, 0 );

473 
	`šü—£StÜageSize
Ğ
txn
, 
_d‘as
->
	`Ï¡Ex‹ÁSize
(), 
Œue
 );

477 
_d‘as
->
	`£tSts
Ğ
txn
, 0, 0 );

479 
Prog»ssM‘”HŞd”
 
	`pm
(*
txn
->
	`£tMes§ge
("compactƒxtent",

481 
ex‹Ás
.
	`size
()));

483 
ex‹ÁNumb”
 = 0;

484  
li¡
<
DiskLoc
>::
™”©Ü
 
i
 = 
ex‹Ás
.
	`begš
(); i !ğex‹Ás.
	`’d
(); i++ ) {

485 
	`_com·ùEx‹Á
(
txn
, *
i
, 
ex‹ÁNumb”
++, 
ad­tÜ
, 
İtiÚs
, 
¡©s
 );

486 
pm
.
	`h™
();

489 
	`šv¬ŸÁ
Ğ
_ex‹ÁMªag”
->
	`g‘Ex‹Á
Ğ
_d‘as
->
	`fœ¡Ex‹Á
(è)->
x´ev
.
	`isNuÎ
() );

490 
	`šv¬ŸÁ
Ğ
_ex‹ÁMªag”
->
	`g‘Ex‹Á
Ğ
_d‘as
->
	`Ï¡Ex‹Á
(è)->
xÃxt
.
	`isNuÎ
() );

493 
pm
.
	`fšished
();

495  
Stus
::
	`OK
();

496 
	}
}

	@record_store_v1_simple.h

31 #´agm¨
Úû


33 
	~"mÚgo/db/diskloc.h
"

34 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ba£.h
"

36 
Çme¥aû
 
	gmÚgo
 {

38 
şass
 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
;

41 şas 
	cSim¶eRecÜdStÜeV1
 : 
public
 
RecÜdStÜeV1Ba£
 {

42 
public
:

43 
Sim¶eRecÜdStÜeV1
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

44 cÚ¡ 
SŒšgD©a
& 
ns
,

45 
RecÜdStÜeV1M‘aD©a
* 
d‘as
,

46 
Ex‹ÁMªag”
* 
em
,

47 
boŞ
 
isSy¡emIndexes
 );

49 
	gvœtu®
 ~
Sim¶eRecÜdStÜeV1
();

51 cÚ¡ * 
Çme
() const {  "SimpleRecordStoreV1"; }

53 
vœtu®
 
RecÜdI‹¿tÜ
* 
g‘I‹¿tÜ
ĞcÚ¡ 
DiskLoc
& 
¡¬t
, 
boŞ
 
abË
,

54 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
) const;

56 
vœtu®
 
	g¡d
::
veùÜ
<
RecÜdI‹¿tÜ
*> 
g‘MªyI‹¿tÜs
() const;

58 
vœtu®
 
Stus
 
Œunÿ‹
(
O³¿tiÚCÚ‹xt
* 
txn
);

60 
vœtu®
 
boŞ
 
com·ùSuµÜ‹d
(ècÚ¡ {  
	gŒue
; }

61 
vœtu®
 
Stus
 
com·ù
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

62 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

63 cÚ¡ 
Com·ùO±iÚs
* 
İtiÚs
,

64 
Com·ùSts
* 
¡©s
 );

66 
	g´Ùeùed
:

67 
vœtu®
 
boŞ
 
isC­³d
(ècÚ¡ {  
çl£
; }

69 
vœtu®
 
	gStusW™h
<
	gDiskLoc
> 
®locRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

70 
ËngthW™hH—d”s
,

71 
quÙaMax
 );

73 
vœtu®
 
addD–‘edRec
(
O³¿tiÚCÚ‹xt
* 
txn
,

74 cÚ¡ 
DiskLoc
& 
dloc
);

75 
	g´iv©e
:

76 
DiskLoc
 
_®locFromExi¡šgEx‹Ás
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

77 
ËngthW™hH—d”s
 );

79 
_com·ùEx‹Á
(
O³¿tiÚCÚ‹xt
* 
txn
,

80 cÚ¡ 
DiskLoc
 
diskloc
,

81 
ex‹ÁNumb”
,

82 
RecÜdStÜeCom·ùAd­tÜ
* 
ad­tÜ
,

83 cÚ¡ 
Com·ùO±iÚs
* 
com·ùO±iÚs
,

84 
Com·ùSts
* 
¡©s
 );

86 
boŞ
 
	g_nÜm®CŞËùiÚ
;

88 
ä›nd
 
şass
 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
;

	@record_store_v1_simple_iterator.cpp

29 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_sim¶e_™”©Ü.h
"

31 
	~"mÚgo/db/ÿlog/cŞËùiÚ.h
"

32 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

33 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

34 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_sim¶e.h
"

36 
Çme¥aû
 
	gmÚgo
 {

42 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
::
Sim¶eRecÜdStÜeV1I‹¿tÜ
(cÚ¡ 
Sim¶eRecÜdStÜeV1
* 
cŞËùiÚ
,

43 cÚ¡ 
DiskLoc
& 
¡¬t
,

44 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
)

45 : 
_cu¼
(
¡¬t
), 
_»cÜdStÜe
(
cŞËùiÚ
), 
_dœeùiÚ
(
dœ
) {

47 ià(
	g_cu¼
.
isNuÎ
()) {

49 cÚ¡ 
Ex‹ÁMªag”
* 
	gem
 = 
_»cÜdStÜe
->
_ex‹ÁMªag”
;

51 iàĞ
	g_»cÜdStÜe
->
d‘as
()->
fœ¡Ex‹Á
().
isNuÎ
() ) {

53 
v”ify
Ğ
_»cÜdStÜe
->
d‘as
()->
Ï¡Ex‹Á
().
isNuÎ
() );

55 ià(
	gCŞËùiÚSÿnP¬ams
::
FORWARD
 =ğ
_dœeùiÚ
) {

58 
Ex‹Á
* 
e
 = 
em
->
g‘Ex‹Á
Ğ
_»cÜdStÜe
->
d‘as
()->
fœ¡Ex‹Á
() );

60 
	ge
->
	gfœ¡RecÜd
.
isNuÎ
(è&& !e->
	gxÃxt
.isNull()) {

61 
	ge
 = 
em
->
g‘Ex‹Á
Ğ
e
->
xÃxt
 );

66 
	g_cu¼
 = 
e
->
fœ¡RecÜd
;

71 
Ex‹Á
* 
	ge
 = 
em
->
g‘Ex‹Á
Ğ
_»cÜdStÜe
->
d‘as
()->
Ï¡Ex‹Á
() );

75 
	ge
->
	gÏ¡RecÜd
.
isNuÎ
(è&& !e->
	gx´ev
.isNull()) {

76 
	ge
 = 
em
->
g‘Ex‹Á
Ğ
e
->
x´ev
 );

81 
	g_cu¼
 = 
e
->
Ï¡RecÜd
;

86 
boŞ
 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
::
isEOF
() {

87  
_cu¼
.
isNuÎ
();

90 
DiskLoc
 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
::
cu¼
(è{  
_cu¼
; }

92 
DiskLoc
 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
::
g‘Next
() {

93 
DiskLoc
 
»t
 = 
_cu¼
;

96 ià(!
isEOF
()) {

97 ià(
	gCŞËùiÚSÿnP¬ams
::
FORWARD
 =ğ
_dœeùiÚ
) {

98 
_cu¼
 = 
_»cÜdStÜe
->
g‘NextRecÜd
( _curr );

101 
	g_cu¼
 = 
_»cÜdStÜe
->
g‘P»vRecÜd
Ğ
_cu¼
 );

105  
	g»t
;

108 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
::
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
) {

110 ià(
dl
 =ğ
_cu¼
) {

113 
g‘Next
();

117 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
::
´•¬eToY›ld
() {

120 
boŞ
 
Sim¶eRecÜdStÜeV1I‹¿tÜ
::
»cov”FromY›ld
() {

122  
Œue
;

125 cÚ¡ 
RecÜd
* 
	gSim¶eRecÜdStÜeV1I‹¿tÜ
::
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

126  
_»cÜdStÜe
->
»cÜdFÜ
Ğ
loc
 );

	@record_store_v1_simple_iterator.h

29 #´agm¨
Úû


31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe.h
"

33 
Çme¥aû
 
	gmÚgo
 {

35 
şass
 
	gSim¶eRecÜdStÜeV1
;

43 şas 
	cSim¶eRecÜdStÜeV1I‹¿tÜ
 : 
public
 
RecÜdI‹¿tÜ
 {

44 
public
:

45 
Sim¶eRecÜdStÜeV1I‹¿tÜ
ĞcÚ¡ 
Sim¶eRecÜdStÜeV1
* 
»cÜds
,

46 cÚ¡ 
DiskLoc
& 
¡¬t
,

47 cÚ¡ 
CŞËùiÚSÿnP¬ams
::
DœeùiÚ
& 
dœ
 );

48 
	gvœtu®
 ~
Sim¶eRecÜdStÜeV1I‹¿tÜ
() { }

50 
vœtu®
 
boŞ
 
isEOF
();

51 
vœtu®
 
DiskLoc
 
g‘Next
();

52 
vœtu®
 
DiskLoc
 
cu¼
();

54 
vœtu®
 
šv®id©e
(cÚ¡ 
DiskLoc
& 
dl
);

55 
vœtu®
 
´•¬eToY›ld
();

56 
vœtu®
 
boŞ
 
»cov”FromY›ld
();

58 
vœtu®
 cÚ¡ 
RecÜd
* 
»cÜdFÜ
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

60 
	g´iv©e
:

62 
DiskLoc
 
_cu¼
;

64 cÚ¡ 
Sim¶eRecÜdStÜeV1
* 
	g_»cÜdStÜe
;

66 
	gCŞËùiÚSÿnP¬ams
::
DœeùiÚ
 
_dœeùiÚ
;

	@record_store_v1_simple_test.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_sim¶e.h
"

33 
	~"mÚgo/db/İ”©iÚ_cÚ‹xt_noİ.h
"

34 
	~"mÚgo/db/¡Üage/»cÜd.h
"

35 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_‹¡_h–p.h
"

36 
	~"mÚgo/un™‹¡/un™‹¡.h
"

38 
usšg
 
Çme¥aû
 
	gmÚgo
;

40 
	gÇme¥aû
 {

44 
	gz”os
[20*1024*1024] = {};

46 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
quªtizeAÎoÿtiÚS·ûSim¶e
 ) {

47 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(33), 36);

48 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(1000), 1024);

49 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(10001), 10240);

50 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(100000), 106496);

51 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(1000001), 1048576);

52 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(10000000), 10223616);

55 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
quªtizeAÎoÿtiÚMšMaxBound
 ) {

56 cÚ¡ 
	gmaxSize
 = 16 * 1024 * 1024;

57 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(1), 2);

58 
ASSERT_EQUALS
(
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(
maxSize
), maxSize);

65 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
quªtizeAÎoÿtiÚBound¬y
 ) {

66 
	giBuck‘
 = 0; iBuck‘ <ğ
RecÜdStÜeV1Ba£
::
MaxBuck‘
; ++iBucket) {

68 cÚ¡ 
	gbuck‘Size
 = 
RecÜdStÜeV1Ba£
::
buck‘Sizes
[
iBuck‘
];

69 cÚ¡ 
	g´evBuck‘Size
 =

70 (
iBuck‘
 - 1 >ğ0è? 
RecÜdStÜeV1Ba£
::
buck‘Sizes
[iBucket - 1] : 0;

71 cÚ¡ 
	gš‹rv®Size
 = 
buck‘Size
 / 16;

72 
	giBound¬y
 = 
´evBuck‘Size
;

73 
	giBound¬y
 < 
	gbuck‘Size
;

74 
	giBound¬y
 +ğ
š‹rv®Size
) {

76 
iSize
 = 
iBound¬y
 - 1; 
	giSize
 <= iBoundary; ++iSize) {

78 cÚ¡ 
	gquªtized
 =

79 
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(
iSize
);

81 
ASSERT
(
quªtized
 >ğ
iSize
);

84 
ASSERT
(
quªtized
 - 
iSize
 <ğ
š‹rv®Size
);

86 
ASSERT
(
quªtized
 ==

87 
RecÜdStÜeV1Ba£
::
quªtizeAÎoÿtiÚS·û
(
quªtized
));

97 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
quªtizePow”Of2Sm®l
 ) {

99 
	gbuck‘
 = 0; buck‘ < 
	gRecÜdStÜeV1Ba£
::
MaxBuck‘
; bucket++) {

100 cÚ¡ 
	gsize
 = 
RecÜdStÜeV1Ba£
::
buck‘Sizes
[
buck‘
];

101 cÚ¡ 
	gÃxtSize
 = 
RecÜdStÜeV1Ba£
::
buck‘Sizes
[
buck‘
 + 1];

104 
ASSERT_EQUALS
Ğ
size
,

105 
RecÜdStÜeV1Ba£
::
quªtizePow”Of2AÎoÿtiÚS·û
Ğ
size
 - 1 ) );

108 
ASSERT_EQUALS
Ğ
size
,

109 
RecÜdStÜeV1Ba£
::
quªtizePow”Of2AÎoÿtiÚS·û
Ğ
size
 ) );

112 ià(
	gsize
 < 4*1024*1024) {

113 
ASSERT_EQUALS
Ğ
ÃxtSize
,

114 
RecÜdStÜeV1Ba£
::
quªtizePow”Of2AÎoÿtiÚS·û
Ğ
size
 + 1 ) );

123 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
Sim¶eRecÜdL¬gePow”Of2ToMegaby‹Bound¬y
 ) {

126  
	giSize
 = 
RecÜdStÜeV1Ba£
::
buck‘Sizes
[ RecÜdStÜeV1Ba£::
MaxBuck‘
 - 1 ];

127 
	giSize
 <ğ
RecÜdStÜeV1Ba£
::
buck‘Sizes
[ RecÜdStÜeV1Ba£::
MaxBuck‘
 ] + 0x100000;

128 
	giSize
 += 0x100000 ) {

131 
ASSERT_EQUALS
Ğ
iSize
,

132 
RecÜdStÜeV1Ba£
::
quªtizePow”Of2AÎoÿtiÚS·û
Ğ
iSize
 - 1 ) );

135 
ASSERT_EQUALS
Ğ
iSize
,

136 
RecÜdStÜeV1Ba£
::
quªtizePow”Of2AÎoÿtiÚS·û
Ğ
iSize
 ) );

139 
ASSERT_EQUALS
Ğ
iSize
 + 0x100000,

140 
RecÜdStÜeV1Ba£
::
quªtizePow”Of2AÎoÿtiÚS·û
Ğ
iSize
 + 1 ) );

144 
BSONObj
 
docFÜRecÜdSize
Ğ
size
 ) {

145 
BSONObjBud”
 
	gb
;

146 
	gb
.
­³nd
( "_id", 5 );

147 
	gb
.
­³nd
Ğ"x", 
¡ršg
Ğ
size
 - 
RecÜd
::
H—d”Size
 - 22, 'x' ) );

148 
BSONObj
 
	gx
 = 
b
.
obj
();

149 
ASSERT_EQUALS
Ğ
RecÜd
::
H—d”Size
 + 
x
.
objsize
(), 
size
 );

150  
	gx
;

154 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocQuªtized
) {

155 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

156 
DummyEx‹ÁMªag”
 
	gem
;

157 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

159 
¡ršg
 
	gmyns
 = "test.AllocQuantized";

160 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, 
myns
, 
md
, &
em
, 
çl£
 );

162 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 300 );

163 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
Ğ&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0 );

164 
ASSERT
Ğ
»suÉ
.
isOK
() );

167 
ASSERT_EQUALS
Ğ320, 
rs
.
»cÜdFÜ
Ğ
»suÉ
.
g‘V®ue
(è)->
ËngthW™hH—d”s
() );

174 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocIndexName¥aûNÙQuªtized
) {

175 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

176 
DummyEx‹ÁMªag”
 
	gem
;

177 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

179 
¡ršg
 
	gmyns
 = "test.AllocIndexNamespaceNotQuantized";

180 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, 
myns
 + "$x", 
md
, &
em
, 
çl£
 );

182 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 300 );

183 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
(&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0 );

184 
ASSERT
Ğ
»suÉ
.
isOK
() );

187 
ASSERT_EQUALS
Ğ300, 
rs
.
»cÜdFÜ
Ğ
»suÉ
.
g‘V®ue
(è)->
ËngthW™hH—d”s
() );

192 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocIndexName¥aûSlighyQuªtized
) {

193 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

194 
DummyEx‹ÁMªag”
 
	gem
;

195 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

197 
¡ršg
 
	gmyns
 = "test.AllocIndexNamespaceNotQuantized";

198 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, 
myns
 + "$x", 
md
, &
em
, 
çl£
 );

200 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 298 );

201 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
Ğ&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0 );

202 
ASSERT
Ğ
»suÉ
.
isOK
() );

204 
ASSERT_EQUALS
Ğ300, 
rs
.
»cÜdFÜ
Ğ
»suÉ
.
g‘V®ue
(è)->
ËngthW™hH—d”s
() );

208 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocU£NÚQuªtizedD–‘edRecÜd
) {

209 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

210 
DummyEx‹ÁMªag”
 
	gem
;

211 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

212 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

215 
LocAndSize
 
	gd»cs
[] = {

216 {
DiskLoc
(0, 1000), 310},

219 
š™ŸlizeV1RS
(&
txn
, 
NULL
, 
d»cs
, &
em
, 
md
);

222 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 300 );

223 
	gStusW™h
<
	gDiskLoc
> 
	gaùu®LoÿtiÚ
 = 
rs
.
š£¹RecÜd
(&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0);

224 
ASSERT_OK
Ğ
aùu®LoÿtiÚ
.
g‘Stus
() );

227 
LocAndSize
 
	g»cs
[] = {

228 {
DiskLoc
(0, 1000), 310},

231 
LocAndSize
 
	gd»cs
[] = {

234 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

239 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocExaùSizeNÚQuªtizedD–‘edRecÜd
) {

240 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

241 
DummyEx‹ÁMªag”
 
	gem
;

242 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

243 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

246 
LocAndSize
 
	gd»cs
[] = {

247 {
DiskLoc
(0, 1000), 300},

250 
š™ŸlizeV1RS
(&
txn
, 
NULL
, 
d»cs
, &
em
, 
md
);

253 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 300 );

254 
	gStusW™h
<
	gDiskLoc
> 
	gaùu®LoÿtiÚ
 = 
rs
.
š£¹RecÜd
(&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0);

255 
ASSERT_OK
Ğ
aùu®LoÿtiÚ
.
g‘Stus
() );

258 
LocAndSize
 
	g»cs
[] = {

259 {
DiskLoc
(0, 1000), 300},

262 
LocAndSize
 
	gd»cs
[] = {

265 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

273 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocQuªtizedW™hExŒa
) {

274 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

275 
DummyEx‹ÁMªag”
 
	gem
;

276 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

277 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

280 
LocAndSize
 
	gd»cs
[] = {

281 {
DiskLoc
(0, 1000), 343},

284 
š™ŸlizeV1RS
(&
txn
, 
NULL
, 
d»cs
, &
em
, 
md
);

287 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 300 );

288 
	gStusW™h
<
	gDiskLoc
> 
	gaùu®LoÿtiÚ
 = 
rs
.
š£¹RecÜd
(&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0);

289 
ASSERT_OK
Ğ
aùu®LoÿtiÚ
.
g‘Stus
() );

292 
LocAndSize
 
	g»cs
[] = {

293 {
DiskLoc
(0, 1000), 343},

296 
LocAndSize
 
	gd»cs
[] = {

299 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

307 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocQuªtizedW™houtExŒa
) {

308 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

309 
DummyEx‹ÁMªag”
 
	gem
;

310 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

311 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

314 
LocAndSize
 
	gd»cs
[] = {

315 {
DiskLoc
(0, 1000), 344},

318 
š™ŸlizeV1RS
(&
txn
, 
NULL
, 
d»cs
, &
em
, 
md
);

322 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 300 );

323 
	gStusW™h
<
	gDiskLoc
> 
	gaùu®LoÿtiÚ
 = 
rs
.
š£¹RecÜd
(&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0);

324 
ASSERT_OK
Ğ
aùu®LoÿtiÚ
.
g‘Stus
() );

327 
LocAndSize
 
	g»cs
[] = {

329 {
DiskLoc
(0, 1000), 320},

332 
LocAndSize
 
	gd»cs
[] = {

334 {
DiskLoc
(0, 1320), 24},

337 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

345 
TEST
(
Sim¶eRecÜdStÜeV1
, 
AÎocNÙQuªtizedN—rD–‘edSize
) {

346 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

347 
DummyEx‹ÁMªag”
 
	gem
;

348 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

349 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

352 
LocAndSize
 
	gd»cs
[] = {

353 {
DiskLoc
(0, 1000), 344},

356 
š™ŸlizeV1RS
(&
txn
, 
NULL
, 
d»cs
, &
em
, 
md
);

359 
BSONObj
 
	gobj
 = 
docFÜRecÜdSize
( 319 );

360 
	gStusW™h
<
	gDiskLoc
> 
	gaùu®LoÿtiÚ
 = 
rs
.
š£¹RecÜd
(&
txn
, 
obj
.
objd©a
(), obj.
objsize
(), 0);

361 
ASSERT_OK
Ğ
aùu®LoÿtiÚ
.
g‘Stus
() );

368 
LocAndSize
 
	g»cs
[] = {

369 {
DiskLoc
(0, 1000), 344},

372 
LocAndSize
 
	gd»cs
[] = {

375 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

380 
TEST
(
Sim¶eRecÜdStÜeV1
, 
G‘RecÜdAÎoÿtiÚSizeNoPaddšg
) {

381 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

382 
DummyEx‹ÁMªag”
 
	gem
;

383 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

384 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

385 
ASSERT_EQUALS
Ğ1.0, 
md
->
·ddšgFaùÜ
() );

386 
ASSERT_EQUALS
Ğ300, 
rs
.
g‘RecÜdAÎoÿtiÚSize
( 300 ) );

390 
TEST
(
Sim¶eRecÜdStÜeV1
, 
G‘RecÜdAÎoÿtiÚSizeW™hPaddšg
) {

391 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

392 
DummyEx‹ÁMªag”
 
	gem
;

393 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

394 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

395 
	g·ddšgFaùÜ
 = 1.2;

396 
	gmd
->
£tPaddšgFaùÜ
Ğ&
txn
, 
·ddšgFaùÜ
 );

397 
ASSERT_EQUALS
Ğ
·ddšgFaùÜ
, 
md
->paddingFactor() );

398 
ASSERT_EQUALS
Ğ(300 * 
·ddšgFaùÜ
), 
rs
.
g‘RecÜdAÎoÿtiÚSize
( 300 ) );

405 
TEST
(
Sim¶eRecÜdStÜeV1
, 
G‘RecÜdAÎoÿtiÚSizePow”Of2
) {

406 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

407 
DummyEx‹ÁMªag”
 
	gem
;

408 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecordStoreV1MetaData(

409 
çl£
,

410 
RecÜdStÜeV1Ba£
::
FÏg_U£Pow”Of2Sizes
 );

412 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

413 
ASSERT_EQUALS
Ğ512, 
rs
.
g‘RecÜdAÎoÿtiÚSize
( 300 ) );

420 
TEST
(
Sim¶eRecÜdStÜeV1
, 
G‘RecÜdAÎoÿtiÚSizePow”Of2PaddšgIgnÜed
) {

421 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

422 
DummyEx‹ÁMªag”
 
	gem
;

423 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecordStoreV1MetaData(

424 
çl£
,

425 
RecÜdStÜeV1Ba£
::
FÏg_U£Pow”Of2Sizes
 );

427 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

428 
	gmd
->
£tPaddšgFaùÜ
Ğ&
txn
, 2.0 );

429 
ASSERT_EQUALS
Ğ2.0, 
md
->
·ddšgFaùÜ
() );

430 
ASSERT_EQUALS
Ğ512, 
rs
.
g‘RecÜdAÎoÿtiÚSize
( 300 ) );

436 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
FuÎSim¶e1
 ) {

437 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

438 
DummyEx‹ÁMªag”
 
	gem
;

439 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

440 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
,

442 
md
,

443 &
em
,

444 
çl£
 );

447 
ASSERT_EQUALS
Ğ0, 
md
->
numRecÜds
() );

448 
	gStusW™h
<
	gDiskLoc
> 
	g»suÉ
 = 
rs
.
š£¹RecÜd
Ğ&
txn
, "abc", 4, 1000 );

449 
ASSERT_TRUE
Ğ
»suÉ
.
isOK
() );

450 
ASSERT_EQUALS
Ğ1, 
md
->
numRecÜds
() );

451 
RecÜd
* 
	g»cÜd
 = 
rs
.
»cÜdFÜ
Ğ
»suÉ
.
g‘V®ue
() );

452 
ASSERT_EQUALS
Ğ
¡ršg
("abc"), sŒšg(
»cÜd
->
d©a
()) );

460 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
In£¹TakesFœ¡D–‘edW™hExaùSize
 ) {

461 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

462 
DummyEx‹ÁMªag”
 
	gem
;

463 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

464 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

467 
LocAndSize
 
	g»cs
[] = {

468 {
DiskLoc
(0, 1000), 100},

469 {
DiskLoc
(0, 1100), 100},

470 {
DiskLoc
(0, 1300), 100},

471 {
DiskLoc
(2, 1100), 100},

474 
LocAndSize
 
	gd»cs
[] = {

475 {
DiskLoc
(0, 1200), 100},

476 {
DiskLoc
(2, 1000), 100},

477 {
DiskLoc
(1, 1000), 1000},

481 
š™ŸlizeV1RS
(&
txn
, 
»cs
, 
d»cs
, &
em
, 
md
);

484 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 100 - 
RecÜd
::
H—d”Size
, 0);

487 
LocAndSize
 
	g»cs
[] = {

488 {
DiskLoc
(0, 1000), 100},

489 {
DiskLoc
(0, 1100), 100},

490 {
DiskLoc
(0, 1300), 100},

491 {
DiskLoc
(0, 1200), 100},

492 {
DiskLoc
(2, 1100), 100},

495 
LocAndSize
 
	gd»cs
[] = {

496 {
DiskLoc
(2, 1000), 100},

497 {
DiskLoc
(1, 1000), 1000},

500 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

509 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
In£¹LooksFÜB‘‹rM©chUpTo5Lšks
 ) {

510 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

511 
DummyEx‹ÁMªag”
 
	gem
;

512 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

513 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

516 
LocAndSize
 
	g»cs
[] = {

519 
LocAndSize
 
	gd»cs
[] = {

521 {
DiskLoc
(0, 1000), 75},

522 {
DiskLoc
(0, 1100), 100},

523 {
DiskLoc
(0, 1200), 100},

524 {
DiskLoc
(0, 1300), 100},

525 {
DiskLoc
(0, 1400), 100},

526 {
DiskLoc
(0, 1500), 100},

527 {
DiskLoc
(0, 1600), 80},

528 {
DiskLoc
(0, 1700), 999},

531 
š™ŸlizeV1RS
(&
txn
, 
»cs
, 
d»cs
, &
em
, 
md
);

534 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

535 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

536 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

539 
LocAndSize
 
	g»cs
[] = {

540 {
DiskLoc
(0, 1100), 100},

541 {
DiskLoc
(0, 1600), 80},

542 {
DiskLoc
(0, 1200), 100},

545 
LocAndSize
 
	gd»cs
[] = {

546 {
DiskLoc
(0, 1000), 75},

547 {
DiskLoc
(0, 1300), 100},

548 {
DiskLoc
(0, 1400), 100},

549 {
DiskLoc
(0, 1500), 100},

550 {
DiskLoc
(0, 1700), 999},

553 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

561 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
In£¹LooksFÜM©chUpTo31Lšks
 ) {

562 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

563 
DummyEx‹ÁMªag”
 
	gem
;

564 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

565 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

568 
LocAndSize
 
	g»cs
[] = {

571 
LocAndSize
 
	gd»cs
[] = {

573 {
DiskLoc
(0, 1000), 50},

575 {
DiskLoc
(0, 1100), 75},

576 {
DiskLoc
(0, 1200), 75},

577 {
DiskLoc
(0, 1300), 75},

578 {
DiskLoc
(0, 1400), 75},

579 {
DiskLoc
(0, 1500), 75},

580 {
DiskLoc
(0, 1600), 75},

581 {
DiskLoc
(0, 1700), 75},

582 {
DiskLoc
(0, 1800), 75},

583 {
DiskLoc
(0, 1900), 75},

584 {
DiskLoc
(0, 2000), 75},

585 {
DiskLoc
(0, 2100), 75},

586 {
DiskLoc
(0, 2200), 75},

587 {
DiskLoc
(0, 2300), 75},

588 {
DiskLoc
(0, 2400), 75},

589 {
DiskLoc
(0, 2500), 75},

590 {
DiskLoc
(0, 2600), 75},

591 {
DiskLoc
(0, 2700), 75},

592 {
DiskLoc
(0, 2800), 75},

593 {
DiskLoc
(0, 2900), 75},

594 {
DiskLoc
(0, 3000), 75},

595 {
DiskLoc
(0, 3100), 75},

596 {
DiskLoc
(0, 3200), 75},

597 {
DiskLoc
(0, 3300), 75},

598 {
DiskLoc
(0, 3400), 75},

599 {
DiskLoc
(0, 3500), 75},

600 {
DiskLoc
(0, 3600), 75},

601 {
DiskLoc
(0, 3700), 75},

602 {
DiskLoc
(0, 3800), 75},

603 {
DiskLoc
(0, 3900), 75},

604 {
DiskLoc
(0, 4000), 75},

605 {
DiskLoc
(0, 4100), 75},

607 {
DiskLoc
(0, 8000), 80},

608 {
DiskLoc
(0, 9000), 140},

611 
š™ŸlizeV1RS
(&
txn
, 
»cs
, 
d»cs
, &
em
, 
md
);

614 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

615 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 70 - 
RecÜd
::
H—d”Size
, 0);

616 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

619 
LocAndSize
 
	g»cs
[] = {

620 {
DiskLoc
(0, 9000), 80},

621 {
DiskLoc
(0, 1100), 75},

622 {
DiskLoc
(0, 8000), 80},

625 
LocAndSize
 
	gd»cs
[] = {

626 {
DiskLoc
(0, 9000 + 80), 140 - 80},

627 {
DiskLoc
(0, 1000), 50},

628 {
DiskLoc
(0, 1200), 75},

629 {
DiskLoc
(0, 1300), 75},

630 {
DiskLoc
(0, 1400), 75},

631 {
DiskLoc
(0, 1500), 75},

632 {
DiskLoc
(0, 1600), 75},

633 {
DiskLoc
(0, 1700), 75},

634 {
DiskLoc
(0, 1800), 75},

635 {
DiskLoc
(0, 1900), 75},

636 {
DiskLoc
(0, 2000), 75},

637 {
DiskLoc
(0, 2100), 75},

638 {
DiskLoc
(0, 2200), 75},

639 {
DiskLoc
(0, 2300), 75},

640 {
DiskLoc
(0, 2400), 75},

641 {
DiskLoc
(0, 2500), 75},

642 {
DiskLoc
(0, 2600), 75},

643 {
DiskLoc
(0, 2700), 75},

644 {
DiskLoc
(0, 2800), 75},

645 {
DiskLoc
(0, 2900), 75},

646 {
DiskLoc
(0, 3000), 75},

647 {
DiskLoc
(0, 3100), 75},

648 {
DiskLoc
(0, 3200), 75},

649 {
DiskLoc
(0, 3300), 75},

650 {
DiskLoc
(0, 3400), 75},

651 {
DiskLoc
(0, 3500), 75},

652 {
DiskLoc
(0, 3600), 75},

653 {
DiskLoc
(0, 3700), 75},

654 {
DiskLoc
(0, 3800), 75},

655 {
DiskLoc
(0, 3900), 75},

656 {
DiskLoc
(0, 4000), 75},

657 {
DiskLoc
(0, 4100), 75},

660 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

671 
TEST
Ğ
Sim¶eRecÜdStÜeV1
, 
In£¹LooksFÜM©chUpTo31LšksEv’IfFoundOv”sizedF™
 ) {

672 
O³¿tiÚCÚ‹xtNoİ
 
	gtxn
;

673 
DummyEx‹ÁMªag”
 
	gem
;

674 
DummyRecÜdStÜeV1M‘aD©a
* 
	gmd
 = 
Ãw
 DummyRecÜdStÜeV1M‘aD©aĞ
çl£
, 0 );

675 
Sim¶eRecÜdStÜeV1
 
rs
Ğ&
txn
, "‹¡.foo", 
md
, &
em
, 
çl£
 );

678 
LocAndSize
 
	g»cs
[] = {

681 
LocAndSize
 
	gd»cs
[] = {

683 {
DiskLoc
(0, 1000), 50},

685 {
DiskLoc
(0, 1100), 75},

686 {
DiskLoc
(0, 1200), 75},

687 {
DiskLoc
(0, 1300), 75},

688 {
DiskLoc
(0, 1400), 75},

689 {
DiskLoc
(0, 1500), 75},

690 {
DiskLoc
(0, 1600), 75},

691 {
DiskLoc
(0, 1700), 75},

692 {
DiskLoc
(0, 1800), 75},

693 {
DiskLoc
(0, 1900), 75},

694 {
DiskLoc
(0, 2000), 75},

695 {
DiskLoc
(0, 2100), 75},

696 {
DiskLoc
(0, 2200), 75},

697 {
DiskLoc
(0, 2300), 75},

698 {
DiskLoc
(0, 2400), 75},

699 {
DiskLoc
(0, 2500), 75},

700 {
DiskLoc
(0, 2600), 75},

701 {
DiskLoc
(0, 2700), 75},

702 {
DiskLoc
(0, 2800), 75},

703 {
DiskLoc
(0, 2900), 75},

704 {
DiskLoc
(0, 3000), 75},

705 {
DiskLoc
(0, 3100), 75},

706 {
DiskLoc
(0, 3200), 75},

707 {
DiskLoc
(0, 3300), 75},

708 {
DiskLoc
(0, 3400), 75},

709 {
DiskLoc
(0, 3500), 75},

710 {
DiskLoc
(0, 3600), 75},

711 {
DiskLoc
(0, 3700), 75},

713 {
DiskLoc
(0, 7000), 95},

714 {
DiskLoc
(0, 7100), 95},

716 {
DiskLoc
(0, 3800), 75},

717 {
DiskLoc
(0, 3900), 75},

719 {
DiskLoc
(0, 8000), 80},

721 {
DiskLoc
(0, 9000), 140},

724 
š™ŸlizeV1RS
(&
txn
, 
»cs
, 
d»cs
, &
em
, 
md
);

727 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

728 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

729 
	grs
.
š£¹RecÜd
(&
txn
, 
z”os
, 80 - 
RecÜd
::
H—d”Size
, 0);

732 
LocAndSize
 
	g»cs
[] = {

733 {
DiskLoc
(0, 7000), 95},

734 {
DiskLoc
(0, 8000), 80},

735 {
DiskLoc
(0, 7100), 95},

738 
LocAndSize
 
	gd»cs
[] = {

739 {
DiskLoc
(0, 1000), 50},

740 {
DiskLoc
(0, 1100), 75},

741 {
DiskLoc
(0, 1200), 75},

742 {
DiskLoc
(0, 1300), 75},

743 {
DiskLoc
(0, 1400), 75},

744 {
DiskLoc
(0, 1500), 75},

745 {
DiskLoc
(0, 1600), 75},

746 {
DiskLoc
(0, 1700), 75},

747 {
DiskLoc
(0, 1800), 75},

748 {
DiskLoc
(0, 1900), 75},

749 {
DiskLoc
(0, 2000), 75},

750 {
DiskLoc
(0, 2100), 75},

751 {
DiskLoc
(0, 2200), 75},

752 {
DiskLoc
(0, 2300), 75},

753 {
DiskLoc
(0, 2400), 75},

754 {
DiskLoc
(0, 2500), 75},

755 {
DiskLoc
(0, 2600), 75},

756 {
DiskLoc
(0, 2700), 75},

757 {
DiskLoc
(0, 2800), 75},

758 {
DiskLoc
(0, 2900), 75},

759 {
DiskLoc
(0, 3000), 75},

760 {
DiskLoc
(0, 3100), 75},

761 {
DiskLoc
(0, 3200), 75},

762 {
DiskLoc
(0, 3300), 75},

763 {
DiskLoc
(0, 3400), 75},

764 {
DiskLoc
(0, 3500), 75},

765 {
DiskLoc
(0, 3600), 75},

766 {
DiskLoc
(0, 3700), 75},

767 {
DiskLoc
(0, 3800), 75},

768 {
DiskLoc
(0, 3900), 75},

769 {
DiskLoc
(0, 9000), 140},

772 
as£¹S‹V1RS
(
»cs
, 
d»cs
, &
em
, 
md
);

	@record_store_v1_test_help.cpp

31 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_‹¡_h–p.h
"

33 
	~<®gÜ™hm
>

34 
	~<m­
>

35 
	~<£t
>

36 
	~<veùÜ
>

38 
	~"mÚgo/db/¡Üage/ex‹Á.h
"

39 
	~"mÚgo/db/¡Üage/»cÜd.h
"

40 
	~"mÚgo/un™‹¡/un™‹¡.h
"

42 
Çme¥aû
 
	gmÚgo
 {

44 
	gDummyRecÜdStÜeV1M‘aD©a
::
DummyRecÜdStÜeV1M‘aD©a
Ğ
boŞ
 
ÿµed
, 
u£rFÏgs
 ) {

45 
	g_d©aSize
 = 0;

46 
	g_numRecÜds
 = 0;

47 
	g_ÿµed
 = 
ÿµed
;

48 
	g_u£rFÏgs
 = 
u£rFÏgs
;

49 
	g_Ï¡Ex‹ÁSize
 = 0;

50 
	g_·ddšgFaùÜ
 = 1;

51 
	g_maxC­³dDocs
 = 
num”ic_lim™s
<>::
max
();

52 
	g_ÿpFœ¡NewRecÜd
.
£tInv®id
();

53 iàĞ
	g_ÿµed
 ) {

55 
£tD–‘edLi¡EÁry
Ğ
NULL
, 1, 
DiskLoc
().
£tInv®id
() );

59 cÚ¡ 
	gDiskLoc
& 
	gDummyRecÜdStÜeV1M‘aD©a
::
ÿpEx‹Á
() const {

60  
_ÿpEx‹Á
;

63 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tC­Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

64 cÚ¡ 
DiskLoc
& 
loc
 ) {

65 
	g_ÿpEx‹Á
 = 
loc
;

68 cÚ¡ 
	gDiskLoc
& 
	gDummyRecÜdStÜeV1M‘aD©a
::
ÿpFœ¡NewRecÜd
() const {

69  
_ÿpFœ¡NewRecÜd
;

72 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tC­Fœ¡NewRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

73 cÚ¡ 
DiskLoc
& 
loc
 ) {

74 
	g_ÿpFœ¡NewRecÜd
 = 
loc
;

77 
	gDummyRecÜdStÜeV1M‘aD©a
::
d©aSize
() const {

78  
_d©aSize
;

81 
	gDummyRecÜdStÜeV1M‘aD©a
::
numRecÜds
() const {

82  
_numRecÜds
;

85 
	gDummyRecÜdStÜeV1M‘aD©a
::
šüem’tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

86 
d©aSizeInüem’t
,

87 
numRecÜdsInüem’t
 ) {

88 
	g_d©aSize
 +ğ
d©aSizeInüem’t
;

89 
	g_numRecÜds
 +ğ
numRecÜdsInüem’t
;

92 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

93 
d©aSizeInüem’t
,

94 
numRecÜdsInüem’t
 ) {

95 
	g_d©aSize
 = 
d©aSizeInüem’t
;

96 
	g_numRecÜds
 = 
numRecÜdsInüem’t
;

99 
	gÇme¥aû
 {

100 
DiskLoc
 
	gmyNuÎ
;

103 cÚ¡ 
	gDiskLoc
& 
	gDummyRecÜdStÜeV1M‘aD©a
::
d–‘edLi¡EÁry
Ğ
buck‘
 ) const {

104 
šv¬ŸÁ
Ğ
buck‘
 >= 0 );

105 iàĞ
	g¡©ic_ÿ¡
<
	gsize_t
>Ğ
	gbuck‘
 ) >ğ
_d–‘edLi¡s
.
size
() )

106  
myNuÎ
;

107  
	g_d–‘edLi¡s
[
buck‘
];

110 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tD–‘edLi¡EÁry
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

111 
buck‘
,

112 cÚ¡ 
DiskLoc
& 
loc
 ) {

113 
šv¬ŸÁ
Ğ
buck‘
 >= 0 );

114 
šv¬ŸÁ
Ğ
buck‘
 < 1000 );

115  
	g¡©ic_ÿ¡
<
	gsize_t
>Ğ
	gbuck‘
 ) >ğ
_d–‘edLi¡s
.
size
() )

116 
_d–‘edLi¡s
.
push_back
Ğ
DiskLoc
() );

117 
	g_d–‘edLi¡s
[
buck‘
] = 
loc
;

120 
	gDummyRecÜdStÜeV1M‘aD©a
::
ÜphªD–‘edLi¡
(
O³¿tiÚCÚ‹xt
* 
txn
) {

121 
šv¬ŸÁ
Ğ
çl£
 );

124 cÚ¡ 
	gDiskLoc
& 
	gDummyRecÜdStÜeV1M‘aD©a
::
fœ¡Ex‹Á
() const {

125  
_fœ¡Ex‹Á
;

128 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tFœ¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

129 cÚ¡ 
DiskLoc
& 
loc
 ) {

130 
	g_fœ¡Ex‹Á
 = 
loc
;

133 cÚ¡ 
	gDiskLoc
& 
	gDummyRecÜdStÜeV1M‘aD©a
::
Ï¡Ex‹Á
() const {

134  
_Ï¡Ex‹Á
;

137 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tLa¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

138 cÚ¡ 
DiskLoc
& 
loc
 ) {

139 
	g_Ï¡Ex‹Á
 = 
loc
;

142 
boŞ
 
	gDummyRecÜdStÜeV1M‘aD©a
::
isC­³d
() const {

143  
_ÿµed
;

146 
boŞ
 
	gDummyRecÜdStÜeV1M‘aD©a
::
isU£rFÏgS‘
Ğ
æag
 ) const {

147  
_u£rFÏgs
 & 
æag
;

150 
boŞ
 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 ) {

151 iàĞĞ
	g_u£rFÏgs
 & 
	gæag
 ) =ğ
æag
 )

152  
çl£
;

154 
	g_u£rFÏgs
 |ğ
æag
;

155  
	gŒue
;

158 
boŞ
 
	gDummyRecÜdStÜeV1M‘aD©a
::
ş—rU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 ) {

159 iàĞĞ
	g_u£rFÏgs
 & 
	gæag
 ) == 0 )

160  
çl£
;

162 
	g_u£rFÏgs
 &ğ~
æag
;

163  
	gŒue
;

166 
boŞ
 
	gDummyRecÜdStÜeV1M‘aD©a
::
»¶aûU£rFÏgs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æags
 ) {

167 iàĞ
	g_u£rFÏgs
 =ğ
æags
 )

168  
çl£
;

169 
	g_u£rFÏgs
 = 
æags
;

170  
	gŒue
;

174 
	gDummyRecÜdStÜeV1M‘aD©a
::
Ï¡Ex‹ÁSize
() const {

175  
_Ï¡Ex‹ÁSize
;

178 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tLa¡Ex‹ÁSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
ÃwMax
 ) {

179 
	g_Ï¡Ex‹ÁSize
 = 
ÃwMax
;

182 
	gDummyRecÜdStÜeV1M‘aD©a
::
maxC­³dDocs
() const {

183  
_maxC­³dDocs
;

186 
	gDummyRecÜdStÜeV1M‘aD©a
::
·ddšgFaùÜ
() const {

187  
_·ddšgFaùÜ
;

190 
	gDummyRecÜdStÜeV1M‘aD©a
::
£tPaddšgFaùÜ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

191 
·ddšgFaùÜ
 ) {

192 
	g_·ddšgFaùÜ
 = 
·ddšgFaùÜ
;

197 
	gDummyEx‹ÁMªag”
::~
DummyEx‹ÁMªag”
() {

198  
size_t
 
i
 = 0; 
	gi
 < 
	g_ex‹Ás
.
size
(); i++ ) {

199 iàĞ
	g_ex‹Ás
[
i
].
	gd©a
 )

200 
ä“
Ğ
_ex‹Ás
[
i
].
d©a
 );

204 
Stus
 
	gDummyEx‹ÁMªag”
::
š™
(
O³¿tiÚCÚ‹xt
* 
txn
) {

205  
Stus
::
OK
();

208 
size_t
 
	gDummyEx‹ÁMªag”
::
numFes
() const {

209  
_ex‹Ás
.
size
();

212 
	gDummyEx‹ÁMªag”
::
feSize
() const {

213 
šv¬ŸÁ
Ğ
çl£
 );

217 
DiskLoc
 
	gDummyEx‹ÁMªag”
::
®loÿ‹Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

218 
boŞ
 
ÿµed
,

219 
size
,

220 
quÙaMax
 ) {

221 
	gsize
 = 
quªtizeEx‹ÁSize
Ğ
size
 );

223 
Ex‹ÁInfo
 
	gšfo
;

224 
	gšfo
.
	gd©a
 = 
¡©ic_ÿ¡
<*>Ğ
m®loc
Ğ
size
 ) );

225 
	gšfo
.
	gËngth
 = 
size
;

227 
DiskLoc
 
loc
Ğ
_ex‹Ás
.
size
(), 0 );

228 
	g_ex‹Ás
.
push_back
Ğ
šfo
 );

230 
Ex‹Á
* 
	ge
 = 
g‘Ex‹Á
Ğ
loc
, 
çl£
 );

231 
	ge
->
	gmagic
 = 
Ex‹Á
::
ex‹ÁSigÇtu»
;

232 
	ge
->
	gmyLoc
 = 
loc
;

233 
	ge
->
	gxÃxt
.
NuÎ
();

234 
	ge
->
	gx´ev
.
NuÎ
();

235 
	ge
->
	gËngth
 = 
size
;

236 
	ge
->
	gfœ¡RecÜd
.
NuÎ
();

237 
	ge
->
	gÏ¡RecÜd
.
NuÎ
();

239  
	gloc
;

243 
	gDummyEx‹ÁMªag”
::
ä“Ex‹Ás
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

244 
DiskLoc
 
fœ¡Ext
, DiskLoø
Ï¡Ext
 ) {

248 
	gDummyEx‹ÁMªag”
::
ä“Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
DiskLoc
 
ex‹Á
 ) {

251 
	gDummyEx‹ÁMªag”
::
ä“Li¡Sts
Ğ* 
numEx‹Ás
, 
št64_t
* 
tÙ®F»eSize
 ) const {

252 
šv¬ŸÁ
Ğ
çl£
 );

255 
RecÜd
* 
	gDummyEx‹ÁMªag”
::
»cÜdFÜV1
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

256 
šv¬ŸÁ
Ğ
¡©ic_ÿ¡
<
size_t
>Ğ
loc
.
a
(èè< 
_ex‹Ás
.
size
() );

257 
šv¬ŸÁ
Ğ
¡©ic_ÿ¡
<
size_t
>Ğ
loc
.
g‘Ofs
(èè< 
_ex‹Ás
[loc.
a
()].
Ëngth
 );

258 * 
	groÙ
 = 
_ex‹Ás
[
loc
.
a
()].
d©a
;

259  
	g»š‹½»t_ÿ¡
<
	gRecÜd
*>Ğ
	groÙ
 + 
	gloc
.
g‘Ofs
() );

262 
Ex‹Á
* 
	gDummyEx‹ÁMªag”
::
ex‹ÁFÜV1
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const {

263 
šv¬ŸÁ
Ğ
çl£
 );

266 
DiskLoc
 
	gDummyEx‹ÁMªag”
::
ex‹ÁLocFÜV1
ĞcÚ¡ DiskLoc& 
loc
 ) const {

267  
DiskLoc
Ğ
loc
.
a
(), 0 );

270 
Ex‹Á
* 
	gDummyEx‹ÁMªag”
::
g‘Ex‹Á
ĞcÚ¡ 
DiskLoc
& 
loc
, 
boŞ
 
doSª™yCheck
 ) const {

271 
šv¬ŸÁ
Ğ!
loc
.
isNuÎ
() );

272 
šv¬ŸÁ
Ğ
¡©ic_ÿ¡
<
size_t
>Ğ
loc
.
a
(èè< 
_ex‹Ás
.
size
() );

273 
šv¬ŸÁ
Ğ
loc
.
g‘Ofs
() == 0 );

274 
Ex‹Á
* 
	gext
 = 
»š‹½»t_ÿ¡
<Ex‹Á*>Ğ
_ex‹Ás
[
loc
.
a
()].
d©a
 );

275 ià(
	gdoSª™yCheck
)

276 
	gext
->
as£¹Ok
();

277  
	gext
;

280 
	gDummyEx‹ÁMªag”
::
maxSize
() const {

284 
	gDummyEx‹ÁMªag”
::
CacheHšt
* 
DummyEx‹ÁMªag”
::
ÿcheHšt
ĞcÚ¡ 
DiskLoc
& 
ex‹ÁLoc
, cÚ¡ 
HštTy³
& 
hšt
 ) {

285  
Ãw
 
CacheHšt
();

288 
	gÇme¥aû
 {

289 
accumuÏ‹Ex‹ÁSizeRequœem’ts
(cÚ¡ 
LocAndSize
* 
Ïs
, 
¡d
::
m­
<, 
size_t
>* 
sizes
) {

290 ià(!
	gÏs
)

293 !
	gÏs
->
	gloc
.
isNuÎ
()) {

295 
šv¬ŸÁ
(
Ex‹Á
::
H—d”Size
() < 1000);

296 
šv¬ŸÁ
(
Ïs
->
loc
.
g‘Ofs
() >= 1000);

298 cÚ¡ 
size_t
 
	g’d
 = 
Ïs
->
loc
.
g‘Ofs
(è+†as->
size
;

299 
	gsize_t
& 
	gsizeN“ded
 = (*
sizes
)[
Ïs
->
loc
.
a
()];

300 
	gsizeN“ded
 = 
¡d
::
max
(
sizeN“ded
, 
’d
);

301 
	gÏs
++;

305 
´štRecLi¡
(cÚ¡ 
Ex‹ÁMªag”
* 
em
, cÚ¡ 
RecÜdStÜeV1M‘aD©a
* 
md
) {

306 
log
() << " *** BEGIN ACTUAL RECORD LIST *** ";

307 
DiskLoc
 
	gextLoc
 = 
md
->
fœ¡Ex‹Á
();

308 
	g¡d
::
£t
<
DiskLoc
> 
£’Locs
;

309 !
	gextLoc
.
isNuÎ
()) {

310 
Ex‹Á
* 
	gext
 = 
em
->
g‘Ex‹Á
(
extLoc
, 
Œue
);

311 
DiskLoc
 
	gaùu®Loc
 = 
ext
->
fœ¡RecÜd
;

312 !
	gaùu®Loc
.
isNuÎ
()) {

313 cÚ¡ 
RecÜd
* 
	gaùu®Rec
 = 
em
->
»cÜdFÜV1
(
aùu®Loc
);

314 cÚ¡ 
	gaùu®Size
 = 
aùu®Rec
->
ËngthW™hH—d”s
();

316 
log
(è<< "loc: " << 
	gaùu®Loc


317 << " (" << 
	gaùu®Loc
.
g‘Ofs
() << ")"

318 << " size: " << 
	gaùu®Size


319 << "…»v: " << 
	gaùu®Rec
->
´evOfs
()

320 << "‚ext: " << 
	gaùu®Rec
->
ÃxtOfs
()

321 << (
	gaùu®Loc
 =ğ
md
->
ÿpFœ¡NewRecÜd
() ? " (CAP_FIRST_NEW)" : "")

324 cÚ¡ 
boŞ
 
	gfoundCyşe
 = !
£’Locs
.
š£¹
(
aùu®Loc
).
£cÚd
;

325 
šv¬ŸÁ
(!
foundCyşe
);

327 cÚ¡ 
	gÃxtOfs
 = 
aùu®Rec
->
ÃxtOfs
();

328 
	gaùu®Loc
 = (
ÃxtOfs
 =ğ
DiskLoc
::
NuÎOfs
 ? DiskLoc()

329 : 
DiskLoc
(
aùu®Loc
.
a
(), 
ÃxtOfs
));

331 
	gextLoc
 = 
ext
->
xÃxt
;

333 
log
() << " *** END ACTUAL RECORD LIST *** ";

336 
´štDRecLi¡
(cÚ¡ 
Ex‹ÁMªag”
* 
em
, cÚ¡ 
RecÜdStÜeV1M‘aD©a
* 
md
) {

337 
log
() << " *** BEGIN ACTUAL DELETED RECORD LIST *** ";

338 
	g¡d
::
£t
<
DiskLoc
> 
£’Locs
;

339 
	gbuck‘Idx
 = 0; buck‘Idx < 
	gRecÜdStÜeV1Ba£
::
Buck‘s
; bucketIdx++) {

340 
DiskLoc
 
	gaùu®Loc
 = 
md
->
d–‘edLi¡EÁry
(
buck‘Idx
);

341 !
	gaùu®Loc
.
isNuÎ
()) {

342 cÚ¡ 
D–‘edRecÜd
* 
	gaùu®D»c
 = &
em
->
»cÜdFÜV1
(
aùu®Loc
)->
asD–‘ed
();

343 cÚ¡ 
	gaùu®Size
 = 
aùu®D»c
->
ËngthW™hH—d”s
();

345 
log
(è<< "loc: " << 
	gaùu®Loc


346 << " (" << 
	gaùu®Loc
.
g‘Ofs
() << ")"

347 << " size: " << 
	gaùu®Size


348 << " buck‘: " << 
	gbuck‘Idx


349 << "‚ext: " << 
	gaùu®D»c
->
ÃxtD–‘ed
();

351 cÚ¡ 
boŞ
 
	gfoundCyşe
 = !
£’Locs
.
š£¹
(
aùu®Loc
).
£cÚd
;

352 
šv¬ŸÁ
(!
foundCyşe
);

354 
	gaùu®Loc
 = 
aùu®D»c
->
ÃxtD–‘ed
();

358 ià(
	gmd
->
isC­³d
())

361 
log
() << " *** END ACTUAL DELETED RECORD LIST *** ";

365 
š™ŸlizeV1RS
(
O³¿tiÚCÚ‹xt
* 
txn
,

366 cÚ¡ 
LocAndSize
* 
»cÜds
,

367 cÚ¡ 
LocAndSize
* 
d»cs
,

368 
DummyEx‹ÁMªag”
* 
em
,

369 
DummyRecÜdStÜeV1M‘aD©a
* 
md
) {

370 
šv¬ŸÁ
(
»cÜds
 || 
d»cs
);

373 
šv¬ŸÁ
(
em
->
numFes
() == 0);

374 
šv¬ŸÁ
(
md
->
fœ¡Ex‹Á
().
isNuÎ
());

378 
	g¡d
::
	tm­
<, 
	tsize_t
> 
	tEx‹ÁSizes
;

379 
Ex‹ÁSizes
 
	gex‹ÁSizes
;

380 
accumuÏ‹Ex‹ÁSizeRequœem’ts
(
»cÜds
, &
ex‹ÁSizes
);

381 
accumuÏ‹Ex‹ÁSizeRequœem’ts
(
d»cs
, &
ex‹ÁSizes
);

382 
šv¬ŸÁ
(!
ex‹ÁSizes
.
em±y
());

384 cÚ¡ 
	gmaxEx‹Á
 = 
ex‹ÁSizes
.
rbegš
()->
fœ¡
;

385 
	gi
 = 0; i <ğ
maxEx‹Á
; i++) {

386 cÚ¡ 
size_t
 
	gsize
 = 
ex‹ÁSizes
.
couÁ
(
i
) ?ƒxtentSizes[i] : 0;

387 cÚ¡ 
DiskLoc
 
	gloc
 = 
em
->
®loÿ‹Ex‹Á
(
txn
, 
md
->
isC­³d
(), 
size
, 0);

390 
šv¬ŸÁ
(
loc
.
a
(è=ğ
i
);

391 
šv¬ŸÁ
(
loc
.
g‘Ofs
() == 0);

395 
	gmd
->
£tFœ¡Ex‹Á
(
txn
, 
DiskLoc
(
ex‹ÁSizes
.
begš
()->
fœ¡
, 0));

396 
	gmd
->
£tLa¡Ex‹Á
(
txn
, 
DiskLoc
(
ex‹ÁSizes
.
rbegš
()->
fœ¡
, 0));

397 
	gEx‹ÁSizes
::
™”©Ü
 
™
 = 
ex‹ÁSizes
.
begš
();

398 
	gboo¡
::
Ãxt
(
™
è!ğ
ex‹ÁSizes
.
’d
(); ) {

399 cÚ¡ 
	ga
 = 
™
->
fœ¡
;

400 ++
	g™
;

401 cÚ¡ 
	gb
 = 
™
->
fœ¡
;

402 
	gem
->
g‘Ex‹Á
(
DiskLoc
(
a
, 0))->
	gxÃxt
 = DiskLoc(
b
, 0);

403 
	gem
->
g‘Ex‹Á
(
DiskLoc
(
b
, 0))->
	gx´ev
 = DiskLoc(
a
, 0);

407 ià(
	gmd
->
isC­³d
())

408 
	gmd
->
£tD–‘edLi¡EÁry
(
txn
, 1, 
DiskLoc
());

411 ià(
	g»cÜds
 && !»cÜds[0].
	gloc
.
isNuÎ
()) {

412 
	g»cIdx
 = 0;

413 
DiskLoc
 
	gextLoc
 = 
md
->
fœ¡Ex‹Á
();

414 !
	gextLoc
.
isNuÎ
()) {

415 
Ex‹Á
* 
	gext
 = 
em
->
g‘Ex‹Á
(
extLoc
);

416 
	g´evOfs
 = 
DiskLoc
::
NuÎOfs
;

417 
	gextLoc
.
a
(è=ğ
»cÜds
[
»cIdx
].
loc
.a()) {

418 cÚ¡ 
DiskLoc
 
loc
 = 
»cÜds
[
»cIdx
].loc;

419 cÚ¡ 
	gsize
 = 
»cÜds
[
»cIdx
].
size
;;

420 
šv¬ŸÁ
(
size
 >ğ
RecÜd
::
H—d”Size
);

422 
	gmd
->
šüem’tSts
(
txn
, 
size
 - 
RecÜd
::
H—d”Size
, 1);

424 ià(
	gext
->
	gfœ¡RecÜd
.
isNuÎ
())

425 
	gext
->
	gfœ¡RecÜd
 = 
loc
;

427 
RecÜd
* 
	g»c
 = 
em
->
»cÜdFÜV1
(
loc
);

428 
	g»c
->
ËngthW™hH—d”s
(èğ
size
;

429 
	g»c
->
ex‹ÁOfs
() = 0;

431 
	g»c
->
´evOfs
() =…revOfs;

432 
	g´evOfs
 = 
loc
.
g‘Ofs
();

434 cÚ¡ 
DiskLoc
 
	gÃxtLoc
 = 
»cÜds
[
»cIdx
 + 1].
loc
;

435 ià(
	gÃxtLoc
.
a
(è=ğ
loc
.a()) {

436 
»c
->
ÃxtOfs
(èğ
ÃxtLoc
.
g‘Ofs
();

439 
	g»c
->
ÃxtOfs
(èğ
DiskLoc
::
NuÎOfs
;

440 
	gext
->
	gÏ¡RecÜd
 = 
loc
;

443 
	g»cIdx
++;

445 
	gextLoc
 = 
ext
->
xÃxt
;

447 
šv¬ŸÁ
(
»cÜds
[
»cIdx
].
loc
.
isNuÎ
());

450 ià(
	gd»cs
 && !d»cs[0].
	gloc
.
isNuÎ
()) {

451 
	gd»cIdx
 = 0;

452 
DiskLoc
* 
	g´evNextPŒ
 = 
NULL
;

453 
	gÏ¡Buck‘
 = -1;

454 !
	gd»cs
[
d»cIdx
].
	gloc
.
isNuÎ
()) {

455 cÚ¡ 
DiskLoc
 
	gloc
 = 
d»cs
[
d»cIdx
].
loc
;

456 cÚ¡ 
	gsize
 = 
d»cs
[
d»cIdx
].
size
;

457 
šv¬ŸÁ
(
size
 >ğ
RecÜd
::
H—d”Size
);

458 cÚ¡ 
	gbuck‘
 = 
RecÜdStÜeV1Ba£
::
buck‘
(
size
);

460 ià(
	gmd
->
isC­³d
()) {

462 ià(
	g´evNextPŒ
 =ğ
NULL
) {

463 
md
->
£tD–‘edLi¡EÁry
(
txn
, 0, 
loc
);

466 *
	g´evNextPŒ
 = 
loc
;

469 ià(
	gloc
.
a
(è< 
	gmd
->
ÿpEx‹Á
().a()

470 && 
	gd»cs
[
d»cIdx
 + 1].
	gloc
.
a
(è=ğ
md
->
ÿpEx‹Á
().a()) {

472 
md
->
£tD–‘edLi¡EÁry
(
txn
, 1, 
loc
);

475 ià(
	gbuck‘
 !ğ
Ï¡Buck‘
) {

476 
šv¬ŸÁ
(
buck‘
 > 
Ï¡Buck‘
);

477 
	gmd
->
£tD–‘edLi¡EÁry
(
txn
, 
buck‘
, 
loc
);

478 
	gÏ¡Buck‘
 = 
buck‘
;

481 *
	g´evNextPŒ
 = 
loc
;

484 
D–‘edRecÜd
* 
	gd»c
 = &
em
->
»cÜdFÜV1
(
loc
)->
asD–‘ed
();

485 
	gd»c
->
ËngthW™hH—d”s
(èğ
size
;

486 
	gd»c
->
ex‹ÁOfs
() = 0;

487 
	gd»c
->
ÃxtD–‘ed
(èğ
DiskLoc
();

488 
	g´evNextPŒ
 = &
d»c
->
ÃxtD–‘ed
();

490 
	gd»cIdx
++;

495 
as£¹S‹V1RS
(
»cÜds
, 
d»cs
, 
em
, 
md
);

498 
as£¹S‹V1RS
(cÚ¡ 
LocAndSize
* 
»cÜds
,

499 cÚ¡ 
LocAndSize
* 
d»cs
,

500 cÚ¡ 
Ex‹ÁMªag”
* 
em
,

501 cÚ¡ 
DummyRecÜdStÜeV1M‘aD©a
* 
md
) {

502 
šv¬ŸÁ
(
»cÜds
 || 
d»cs
);

504 
	gŒy
 {

505 ià(
	g»cÜds
) {

506 
	gd©aSize
 = 0;

507 
	gnumRecs
 = 0;

509 
	g»cIdx
 = 0;

511 
DiskLoc
 
	gextLoc
 = 
md
->
fœ¡Ex‹Á
();

512 !
	gextLoc
.
isNuÎ
()) {

513 
Ex‹Á
* 
	gext
 = 
em
->
g‘Ex‹Á
(
extLoc
, 
Œue
);

514 
	gex³ùedP»vOfs
 = 
DiskLoc
::
NuÎOfs
;

515 
DiskLoc
 
	gaùu®Loc
 = 
ext
->
fœ¡RecÜd
;

516 !
	gaùu®Loc
.
isNuÎ
()) {

517 cÚ¡ 
RecÜd
* 
	gaùu®Rec
 = 
em
->
»cÜdFÜV1
(
aùu®Loc
);

518 cÚ¡ 
	gaùu®Size
 = 
aùu®Rec
->
ËngthW™hH—d”s
();

520 
	gd©aSize
 +ğ
aùu®Size
 - 
RecÜd
::
H—d”Size
;

521 
	gnumRecs
 += 1;

523 
ASSERT_EQUALS
(
aùu®Loc
, 
»cÜds
[
»cIdx
].
loc
);

524 
ASSERT_EQUALS
(
aùu®Size
, 
»cÜds
[
»cIdx
].
size
);

526 
ASSERT_EQUALS
(
aùu®Rec
->
ex‹ÁOfs
(), 
extLoc
.
g‘Ofs
());

527 
ASSERT_EQUALS
(
aùu®Rec
->
´evOfs
(), 
ex³ùedP»vOfs
);

528 
	gex³ùedP»vOfs
 = 
aùu®Loc
.
g‘Ofs
();

530 
	g»cIdx
++;

531 cÚ¡ 
	gÃxtOfs
 = 
aùu®Rec
->
ÃxtOfs
();

532 
	gaùu®Loc
 = (
ÃxtOfs
 =ğ
DiskLoc
::
NuÎOfs
 ? DiskLoc()

533 : 
DiskLoc
(
aùu®Loc
.
a
(), 
ÃxtOfs
));

536 ià(
	gext
->
	gxÃxt
.
isNuÎ
()) {

537 
ASSERT_EQUALS
(
md
->
Ï¡Ex‹Á
(), 
extLoc
);

540 
	gextLoc
 = 
ext
->
xÃxt
;

544 
ASSERT_EQUALS
(
»cÜds
[
»cIdx
].
loc
, 
DiskLoc
());

546 
ASSERT_EQUALS
(
d©aSize
, 
md
->dataSize());

547 
ASSERT_EQUALS
(
numRecs
, 
md
->
numRecÜds
());

550 ià(
	gd»cs
) {

551 
	gd»cIdx
 = 0;

552 
	gbuck‘Idx
 = 0; buck‘Idx < 
	gRecÜdStÜeV1Ba£
::
Buck‘s
; bucketIdx++) {

553 
DiskLoc
 
	gaùu®Loc
 = 
md
->
d–‘edLi¡EÁry
(
buck‘Idx
);

555 ià(
	gmd
->
isC­³d
(è&& 
	gbuck‘Idx
 == 1) {

560 ià(
md
->
ÿpEx‹Á
(è=ğmd->
fœ¡Ex‹Á
()) {

561 
ASSERT_EQUALS
(
aùu®Loc
, 
DiskLoc
());

564 
ASSERT_NOT_EQUALS
(
aùu®Loc
.
a
(), 
md
->
ÿpEx‹Á
().a());

565 cÚ¡ 
D–‘edRecÜd
* 
	gaùu®D»c
 =

566 &
em
->
»cÜdFÜV1
(
aùu®Loc
)->
asD–‘ed
();

567 
ASSERT_EQUALS
(
aùu®D»c
->
ÃxtD–‘ed
().
a
(), 
md
->
ÿpEx‹Á
().a());

575 !
	gaùu®Loc
.
isNuÎ
()) {

576 cÚ¡ 
D–‘edRecÜd
* 
	gaùu®D»c
 = &
em
->
»cÜdFÜV1
(
aùu®Loc
)->
asD–‘ed
();

577 cÚ¡ 
	gaùu®Size
 = 
aùu®D»c
->
ËngthW™hH—d”s
();

579 
ASSERT_EQUALS
(
aùu®Loc
, 
d»cs
[
d»cIdx
].
loc
);

580 
ASSERT_EQUALS
(
aùu®Size
, 
d»cs
[
d»cIdx
].
size
);

583 
ASSERT_EQUALS
(
aùu®D»c
->
ex‹ÁOfs
(), 0);

586 
ASSERT_EQUALS
(
buck‘Idx
, 
md
->
isC­³d
()

588 : 
RecÜdStÜeV1Ba£
::
buck‘
(
aùu®Size
));

590 
	gd»cIdx
++;

591 
	gaùu®Loc
 = 
aùu®D»c
->
ÃxtD–‘ed
();

595 
ASSERT_EQUALS
(
d»cs
[
d»cIdx
].
loc
, 
DiskLoc
());

598 
ÿtch
 (...) {

600 
´štRecLi¡
(
em
, 
md
);

601 
´štDRecLi¡
(
em
, 
md
);

602 
	gthrow
;

	@record_store_v1_test_help.h

31 #´agm¨
Úû


33 
	~<veùÜ
>

35 
	~"mÚgo/db/¡Üage/ex‹Á_mªag”.h
"

36 
	~"mÚgo/db/¡ruùu»/»cÜd_¡Üe_v1_ba£.h
"

38 
Çme¥aû
 
	gmÚgo
 {

40 şas 
	cDummyRecÜdStÜeV1M‘aD©a
 : 
public
 
RecÜdStÜeV1M‘aD©a
 {

41 
public
:

42 
DummyRecÜdStÜeV1M‘aD©a
Ğ
boŞ
 
ÿµed
, 
u£rFÏgs
 );

43 
	gvœtu®
 ~
DummyRecÜdStÜeV1M‘aD©a
(){}

45 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
ÿpEx‹Á
() const;

46 
vœtu®
 
£tC­Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

48 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
ÿpFœ¡NewRecÜd
() const;

49 
vœtu®
 
£tC­Fœ¡NewRecÜd
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

51 
vœtu®
 
d©aSize
() const;

52 
vœtu®
 
numRecÜds
() const;

54 
vœtu®
 
šüem’tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

55 
d©aSizeInüem’t
,

56 
numRecÜdsInüem’t
 );

58 
vœtu®
 
£tSts
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

59 
d©aSizeInüem’t
,

60 
numRecÜdsInüem’t
 );

62 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
d–‘edLi¡EÁry
Ğ
buck‘
 ) const;

63 
vœtu®
 
£tD–‘edLi¡EÁry
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

64 
buck‘
,

65 cÚ¡ 
DiskLoc
& 
loc
 );

66 
vœtu®
 
ÜphªD–‘edLi¡
(
O³¿tiÚCÚ‹xt
* 
txn
);

68 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
fœ¡Ex‹Á
() const;

69 
vœtu®
 
£tFœ¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

71 
vœtu®
 cÚ¡ 
	gDiskLoc
& 
Ï¡Ex‹Á
() const;

72 
vœtu®
 
£tLa¡Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, cÚ¡ 
DiskLoc
& 
loc
 );

74 
vœtu®
 
boŞ
 
isC­³d
() const;

76 
vœtu®
 
boŞ
 
isU£rFÏgS‘
Ğ
æag
 ) const;

77 
vœtu®
 
u£rFÏgs
(ècÚ¡ {  
	g_u£rFÏgs
; }

78 
vœtu®
 
boŞ
 
£tU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 );

79 
vœtu®
 
boŞ
 
ş—rU£rFÏg
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æag
 );

80 
vœtu®
 
boŞ
 
»¶aûU£rFÏgs
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
æags
 );

83 
vœtu®
 
Ï¡Ex‹ÁSize
() const;

84 
vœtu®
 
£tLa¡Ex‹ÁSize
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
ÃwMax
 );

86 
vœtu®
 
maxC­³dDocs
() const;

88 
vœtu®
 
·ddšgFaùÜ
() const;

90 
vœtu®
 
£tPaddšgFaùÜ
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
·ddšgFaùÜ
 );

92 
	g´Ùeùed
:

94 
DiskLoc
 
_ÿpEx‹Á
;

95 
DiskLoc
 
	g_ÿpFœ¡NewRecÜd
;

97 
	g_d©aSize
;

98 
	g_numRecÜds
;

100 
DiskLoc
 
	g_fœ¡Ex‹Á
;

101 
DiskLoc
 
	g_Ï¡Ex‹Á
;

103 
boŞ
 
	g_ÿµed
;

104 
	g_u£rFÏgs
;

105 
	g_maxC­³dDocs
;

107 
	g_Ï¡Ex‹ÁSize
;

108 
	g_·ddšgFaùÜ
;

110 
	g¡d
::
veùÜ
<
DiskLoc
> 
_d–‘edLi¡s
;

113 şas 
	cDummyEx‹ÁMªag”
 : 
public
 
Ex‹ÁMªag”
 {

114 
public
:

115 
vœtu®
 ~
DummyEx‹ÁMªag”
();

117 
vœtu®
 
Stus
 
š™
(
O³¿tiÚCÚ‹xt
* 
txn
);

119 
vœtu®
 
size_t
 
numFes
() const;

120 
vœtu®
 
feSize
() const;

122 
vœtu®
 
DiskLoc
 
®loÿ‹Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

123 
boŞ
 
ÿµed
,

124 
size
,

125 
quÙaMax
 );

127 
vœtu®
 
ä“Ex‹Ás
Ğ
O³¿tiÚCÚ‹xt
* 
txn
,

128 
DiskLoc
 
fœ¡Ext
, DiskLoø
Ï¡Ext
 );

130 
vœtu®
 
ä“Ex‹Á
Ğ
O³¿tiÚCÚ‹xt
* 
txn
, 
DiskLoc
 
ex‹Á
 );

132 
vœtu®
 
ä“Li¡Sts
Ğ* 
numEx‹Ás
, 
št64_t
* 
tÙ®F»eSize
 ) const;

134 
vœtu®
 
RecÜd
* 
»cÜdFÜV1
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

136 
vœtu®
 
Ex‹Á
* 
ex‹ÁFÜV1
ĞcÚ¡ 
DiskLoc
& 
loc
 ) const;

138 
vœtu®
 
DiskLoc
 
ex‹ÁLocFÜV1
ĞcÚ¡ DiskLoc& 
loc
 ) const;

140 
vœtu®
 
Ex‹Á
* 
g‘Ex‹Á
ĞcÚ¡ 
DiskLoc
& 
loc
, 
boŞ
 
doSª™yCheck
 = 
Œue
 ) const;

142 
vœtu®
 
maxSize
() const;

144 
vœtu®
 
CacheHšt
* 
ÿcheHšt
ĞcÚ¡ 
DiskLoc
& 
ex‹ÁLoc
, cÚ¡ 
HštTy³
& 
hšt
 );

146 
	g´Ùeùed
:

147 
	sEx‹ÁInfo
 {

148 * 
d©a
;

149 
size_t
 
	gËngth
;

152 
	g¡d
::
veùÜ
<
Ex‹ÁInfo
> 
_ex‹Ás
;

155 
	sLocAndSize
 {

156 
DiskLoc
 
	gloc
;

157 
	gsize
;

179 
š™ŸlizeV1RS
(
O³¿tiÚCÚ‹xt
* 
txn
,

180 cÚ¡ 
LocAndSize
* 
»cÜds
,

181 cÚ¡ 
LocAndSize
* 
d»cs
,

182 
DummyEx‹ÁMªag”
* 
em
,

183 
DummyRecÜdStÜeV1M‘aD©a
* 
md
);

192 
as£¹S‹V1RS
(cÚ¡ 
LocAndSize
* 
»cÜds
,

193 cÚ¡ 
LocAndSize
* 
d»cs
,

194 cÚ¡ 
Ex‹ÁMªag”
* 
em
,

195 cÚ¡ 
DummyRecÜdStÜeV1M‘aD©a
* 
md
);

	@
1
.
1
/usr/include
53
1428
btree/btree_builder_test.cpp
btree/btree_interface.cpp
btree/btree_interface.h
btree/btree_logic.cpp
btree/btree_logic.h
btree/btree_logic_test.cpp
btree/btree_ondisk.h
btree/btree_test_help.cpp
btree/btree_test_help.h
btree/bucket_deletion_notification.h
btree/key.cpp
btree/key.h
capped_callback.h
catalog/hashtab.h
catalog/index_details.cpp
catalog/index_details.h
catalog/namespace-inl.h
catalog/namespace.cpp
catalog/namespace.h
catalog/namespace_details.cpp
catalog/namespace_details.h
catalog/namespace_details_collection_entry.cpp
catalog/namespace_details_collection_entry.h
catalog/namespace_details_rsv1_metadata.cpp
catalog/namespace_details_rsv1_metadata.h
catalog/namespace_index.cpp
catalog/namespace_index.h
catalog/namespace_test.cpp
collection_compact.cpp
head_manager.h
record_store.cpp
record_store.h
record_store_berkeley.cpp
record_store_berkeley.h
record_store_berkeley_test.cpp
record_store_heap.cpp
record_store_heap.h
record_store_v1_base.cpp
record_store_v1_base.h
record_store_v1_capped.cpp
record_store_v1_capped.h
record_store_v1_capped_iterator.cpp
record_store_v1_capped_iterator.h
record_store_v1_capped_test.cpp
record_store_v1_repair_iterator.cpp
record_store_v1_repair_iterator.h
record_store_v1_simple.cpp
record_store_v1_simple.h
record_store_v1_simple_iterator.cpp
record_store_v1_simple_iterator.h
record_store_v1_simple_test.cpp
record_store_v1_test_help.cpp
record_store_v1_test_help.h
